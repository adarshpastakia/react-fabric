import{a as I}from"./WGLContainer.js";import{E as r,pp as _,bD as Le,An as Re,dF as de,b6 as X,uE as Be,F as w,V as J,kK as Qt,mI as Fe,Ao as pe,rT as Y,Ap as Oe,bJ as Ie,Aq as vt,a5 as wt,er as ce,Ar as gt,As as De,gr as qe,fb as Ne,w1 as he,bL as Ge,At as Ze,Au as Ve,ld as It,fB as rt,Av as Ue,fD as We,Aw as He,Ax as je,Ay as Dt,Az as Qe,zo as Ye,bl as lt,AA as Yt}from"./ShadowCastClear.glsl.js";import{P as K,_ as h,d as v,p as M,b as A,C as m,v as z,q as B,Y as g,Q as ye,X as qt,t as P,G as ft,x as D,y as ge,A as ve,B as Xt,w as we,D as fe,f as O,m as p,n as _t,i as tt,j as k,c as x,U as f,g as b,I as et,e as bt,E as _e,F as Xe,H as Je,J as Ke,r as be,K as ti,W as ei,L as ii,M as oi,u as si,T as ni,N as Nt,O as Jt,S as Kt,R as ai}from"./GraphShaderModule.js";import{g as xe,E as y,I as ri,F as te}from"./utils5.js";import{t as li}from"./CircularArray.js";import{n as ui}from"./SymbolFader.js";import{I as mi}from"./constants.js";const Pi={vertexShader:I("bitBlit/bitBlit.vert"),fragmentShader:I("bitBlit/bitBlit.frag")},Ai={vertexShader:I("stencil/stencil.vert"),fragmentShader:I("stencil/stencil.frag")};class Ce extends tt{}r([O(0,x)],Ce.prototype,"position",void 0);class di extends et{}class ot extends k{}r([p(f)],ot.prototype,"layerTexture",void 0),r([p(f)],ot.prototype,"backbufferTexture",void 0),r([p(m)],ot.prototype,"opacity",void 0),r([p(m)],ot.prototype,"inFadeOpacity",void 0);let ut=class extends K{constructor(){super(...arguments),this.type="BlendShader"}vertex(t){return{uv:t.position,glPosition:new h(xe(t.position),0,1)}}fragment(t){const e=new z,i=v(this.config.layerTexture,t.uv),a=v(this.config.backbufferTexture,t.uv),s=M(A(i.a,new m(0)),i.rgb,i.rgb.divide(i.a)),n=M(A(a.a,new m(0)),a.rgb,a.rgb.divide(a.a)),l=this.config.opacity.multiply(i.a),u=a.a;switch(this.blendMode){case"destination-over":e.fragColor=new h(s.multiply(l).multiply(y(u)).add(n.multiply(u)),l.add(u).subtract(l.multiply(u)));break;case"source-in":{const d=new h(s.multiply(l).multiply(u),l.multiply(u)),c=new h(n.multiply(u),u).multiply(y(this.config.opacity)).multiply(this.config.inFadeOpacity);e.fragColor=d.add(c)}break;case"destination-in":{const d=new h(n.multiply(u).multiply(l),u.multiply(l)),c=new h(n.multiply(u),u).multiply(new h(y(this.config.opacity).multiply(this.config.inFadeOpacity)));e.fragColor=d.add(c)}break;case"source-out":e.fragColor=new h(s.multiply(l).multiply(y(u)),l.multiply(y(u)));break;case"destination-out":e.fragColor=new h(n.multiply(u).multiply(y(l)),u.multiply(y(l)));break;case"source-atop":e.fragColor=new h(s.multiply(l).multiply(u).add(n.multiply(u.multiply(y(l)))),u);break;case"destination-atop":e.fragColor=new h(s.multiply(l.multiply(y(u))).add(n.multiply(u).multiply(l)),l);break;case"xor":e.fragColor=new h(s.multiply(l.multiply(y(u))).add(n.multiply(u.multiply(y(l)))),l.multiply(y(u)).add(u.multiply(y(l))));break;case"multiply":e.fragColor=new h(s.multiply(l).multiply(n.multiply(u)).add(s.multiply(l).multiply(y(u))).add(n.multiply(u).multiply(y(l))),l.add(u.multiply(y(l))));break;case"screen":e.fragColor=new h(s.add(n).subtract(s.multiply(n)).multiply(l.multiply(u)).add(s.multiply(l).multiply(y(u))).add(n.multiply(u).multiply(y(l))),l.add(u.multiply(y(l))));break;case"overlay":{const d=new g(Ct(n.r,s.r),Ct(n.g,s.g),Ct(n.b,s.b));e.fragColor=T(d,s,n,l,u)}break;case"darken":{const d=P(s,n);e.fragColor=T(d,s,n,l,u)}break;case"lighter":e.fragColor=new h(s.multiply(l).add(n.multiply(u)),l.add(u));break;case"lighten":{const d=qt(s,n);e.fragColor=T(d,s,n,l,u)}break;case"color-dodge":{const d=B(new g(ct(n.r,s.r),ct(n.g,s.g),ct(n.b,s.b)),new g(0),new g(1));e.fragColor=T(d,s,n,l,u)}break;case"color-burn":{const d=new g(ht(n.r,s.r),ht(n.g,s.g),ht(n.b,s.b));e.fragColor=T(d,s,n,l,u)}break;case"hard-light":{const d=new g(Tt(n.r,s.r),Tt(n.g,s.g),Tt(n.b,s.b));e.fragColor=T(d,s,n,l,u)}break;case"soft-light":{const d=new g($t(n.r,s.r),$t(n.g,s.g),$t(n.b,s.b));e.fragColor=T(d,s,n,l,u)}break;case"difference":{const d=ye(n.subtract(s));e.fragColor=T(d,s,n,l,u)}break;case"exclusion":{const d=s.add(n).subtract(new m(2).multiply(s).multiply(n));e.fragColor=T(d,s,n,l,u)}break;case"invert":e.fragColor=new h(new g(1).subtract(n).multiply(l).multiply(u).add(n.multiply(u).multiply(y(l))),u);break;case"vivid-light":{const d=new g(B(Mt(n.r,s.r),new m(0),new m(1)),B(Mt(n.g,s.g),new m(0),new m(1)),B(Mt(n.b,s.b),new m(0),new m(1)));e.fragColor=T(d,s,n,l,u)}break;case"hue":{const d=ie(s,n,n);e.fragColor=T(d,s,n,l,u)}break;case"saturation":{const d=ie(n,s,n);e.fragColor=T(d,s,n,l,u)}break;case"color":{const d=Zt(s,n);e.fragColor=T(d,s,n,l,u)}break;case"luminosity":{const d=Zt(n,s);e.fragColor=T(d,s,n,l,u)}break;case"plus":e.fragColor=B(new h(i.r.add(n.r),i.g.add(n.g),i.b.add(n.b),l.add(u)),new h(0),new h(1));break;case"minus":e.fragColor=new h(B(new g(n.r.subtract(i.r),n.g.subtract(i.g),n.b.subtract(i.b)),new g(0),new g(1)),u.multiply(l));break;case"average":{const d=n.add(s).divide(2);e.fragColor=T(d,s,n,l,u)}break;case"reflect":{const d=B(new g(St(n.r,s.r),St(n.g,s.g),St(n.b,s.b)),new g(0),new g(1));e.fragColor=T(d,s,n,l,u)}break;default:e.fragColor=i.multiply(this.config.opacity)}return e}};function T(o,t,e,i,a){return new h(o.multiply(i).multiply(a).add(t.multiply(i).multiply(y(a))).add(e.multiply(a).multiply(y(i))),i.add(a.multiply(y(i))))}function Ct(o,t){return new m(1).subtract(D(new m(.5),t)).multiply(y(new m(2).multiply(y(t).multiply(y(o))))).add(D(new m(.5),t).multiply(new m(2).multiply(t).multiply(o)))}function ct(o,t){return M(A(o,new m(0)),new m(0),M(A(t,new m(1)),new m(1),P(new m(1),o.divide(new m(1).subtract(t)))))}function ht(o,t){return M(A(o,new m(1)),new m(1),M(A(t,new m(0)),new m(0),y(P(new m(1),y(o).divide(t)))))}function Tt(o,t){return new m(1).subtract(D(new m(.5),t)).multiply(new m(2).multiply(t).multiply(o)).add(D(new m(.5),t).multiply(y(new m(2).multiply(y(t).multiply(y(o))))))}function $t(o,t){return ge([Xt(t,new m(.5)),()=>{const e=new m(2).multiply(t),i=y(e),a=y(o);return o.subtract(i.multiply(o).multiply(a))}],[Xt(o,new m(.25)),()=>{const e=new m(2).multiply(t),i=te(e).multiply(o),a=new m(16).multiply(o).subtract(new m(12)).multiply(o).add(new m(3));return o.add(i.multiply(a))}],[!0,()=>{const e=new m(2).multiply(t),i=te(e),a=ve(o).subtract(o);return o.add(i.multiply(a))}])}function Mt(o,t){const e=y(D(new m(.5),t)).multiply(ht(o,new m(2).multiply(t))),i=D(new m(.5),t).multiply(ct(o,new m(2).multiply(ri(t,.5))));return e.add(i)}function Ht(o){return P(P(o.r,o.g),o.b)}function Te(o){return qt(qt(o.r,o.g),o.b)}function Gt(o){return we(o,new g(.3,.59,.11))}function ee(o){return Te(o).subtract(Ht(o))}function pi(o){const t=Gt(o),e=Ht(o),i=Te(o);return ge([fe(e,new m(0)),()=>{const a=o.subtract(t).multiply(t),s=t.subtract(e);return t.add(a.divide(s))}],[ft(i,new m(1)),()=>{const a=o.subtract(t),s=y(t),n=a.multiply(s),l=i.subtract(t);return t.add(n.divide(l))}],[!0,o])}function Zt(o,t){const e=Gt(o),i=Gt(t).subtract(e);return pi(o.add(new g(i)))}function ie(o,t,e){const i=Ht(o),a=ee(o),s=ee(t);return Zt(M(ft(a,new m(0)),()=>o.subtract(i).multiply(s).divide(a),new g(0)),e)}function St(o,t){return M(A(t,new m(1)),t,()=>{const e=y(t),i=o.multiply(o).divide(e);return P(i,new m(1))})}r([_t],ut.prototype,"blendMode",void 0),r([p(ot)],ut.prototype,"config",void 0),r([_(0,b(Ce))],ut.prototype,"vertex",null),r([_(0,b(di))],ut.prototype,"fragment",null);let $e=class extends tt{};r([O(0,x)],$e.prototype,"position",void 0);let ci=class extends et{},Vt=class extends k{};r([p(f)],Vt.prototype,"layerTexture",void 0),r([p(m)],Vt.prototype,"opacity",void 0);let kt=class extends K{constructor(){super(...arguments),this.type="OpacityShader"}vertex(t){return{uv:t.position,glPosition:new h(t.position.subtract(new x(.5)).multiply(2),0,1)}}fragment(t){const e=new z;return e.fragColor=v(this.config.layerTexture,t.uv).multiply(this.config.opacity),e}};r([p(Vt)],kt.prototype,"config",void 0),r([_(0,b($e))],kt.prototype,"vertex",null),r([_(0,b(ci))],kt.prototype,"fragment",null);const Ii={vertexShader:I("highlight/textured.vert"),fragmentShader:I("highlight/highlight.frag")},Di={vertexShader:I("highlight/textured.vert"),fragmentShader:I("highlight/blur.frag")};let Me=class extends tt{};r([O(0,x)],Me.prototype,"position",void 0);let Z=class extends et{};class q extends K{constructor(){super(...arguments),this.type="PostProcessingShader"}vertex(t){return{uv:t.position,glPosition:new h(xe(t.position),0,1)}}}r([_(0,b(Me))],q.prototype,"vertex",null);class Se extends k{}r([p(f)],Se.prototype,"blitTexture",void 0);let oe=class extends q{fragment(t){const e=new z;return e.fragColor=v(this.blitConfig.blitTexture,t.uv),e}};r([p(Se)],oe.prototype,"blitConfig",void 0),r([_(0,b(Z))],oe.prototype,"fragment",null);class W extends k{}r([p(f)],W.prototype,"luminosityTexture",void 0),r([p(g)],W.prototype,"defaultColor",void 0),r([p(m)],W.prototype,"defaultOpacity",void 0),r([p(m)],W.prototype,"luminosityThreshold",void 0),r([p(m)],W.prototype,"smoothWidth",void 0);let se=class extends q{constructor(){super(...arguments),this.type="LuminosityHighPassShader"}fragment(t){const e=new z,i=v(this.luminosityHighPassConfig.luminosityTexture,t.uv),a=new g(.299,.587,.114),s=we(i.xyz,a),n=new h(this.luminosityHighPassConfig.defaultColor.rgb,this.luminosityHighPassConfig.defaultOpacity),l=_e(this.luminosityHighPassConfig.luminosityThreshold,this.luminosityHighPassConfig.luminosityThreshold.add(this.luminosityHighPassConfig.smoothWidth),s);return e.fragColor=bt(n,i,l),e}};r([p(W)],se.prototype,"luminosityHighPassConfig",void 0),r([_(0,b(Z))],se.prototype,"fragment",null);let L=class extends k{};r([p(f)],L.prototype,"blurTexture1",void 0),r([p(f)],L.prototype,"blurTexture2",void 0),r([p(f)],L.prototype,"blurTexture3",void 0),r([p(f)],L.prototype,"blurTexture4",void 0),r([p(f)],L.prototype,"blurTexture5",void 0),r([p(m)],L.prototype,"bloomStrength",void 0),r([p(m)],L.prototype,"bloomRadius",void 0),r([p(Xe.ofType(m,5))],L.prototype,"bloomFactors",void 0),r([p(g)],L.prototype,"bloomTintColor",void 0);let Et=class extends q{constructor(){super(...arguments),this.type="CompositeShader"}fragment(t){const e=new z,{blurTexture1:i,blurTexture2:a,blurTexture3:s,blurTexture4:n,blurTexture5:l,bloomStrength:u,bloomFactors:d,bloomTintColor:c}=this.compositeConfig,C=this._lerpBloomFactor(d[0]).multiply(new h(c,1).multiply(v(i,t.uv))),$=this._lerpBloomFactor(d[1]).multiply(new h(c,1).multiply(v(a,t.uv))),E=this._lerpBloomFactor(d[2]).multiply(new h(c,1).multiply(v(s,t.uv))),N=this._lerpBloomFactor(d[3]).multiply(new h(c,1).multiply(v(n,t.uv))),V=this._lerpBloomFactor(d[4]).multiply(new h(c,1).multiply(v(l,t.uv))),xt=u.multiply(C.add($.add(E.add(N.add(V)))));return e.fragColor=B(xt,new m(0),new m(1)),e}_lerpBloomFactor(t){const e=new m(1.2).subtract(t);return bt(t,e,this.compositeConfig.bloomRadius)}};r([_t],Et.prototype,"numMips",void 0),r([p(L)],Et.prototype,"compositeConfig",void 0),r([_(0,b(Z))],Et.prototype,"fragment",null);let st=class extends k{};r([p(f)],st.prototype,"texture",void 0),r([p(x)],st.prototype,"texSize",void 0),r([p(x)],st.prototype,"direction",void 0),r([p(m)],st.prototype,"sigma",void 0);let zt=class extends q{constructor(){super(...arguments),this.type="GaussianBlurShader"}fragment(t){const e=new z,i=new m(1).divide(this.gaussianBlurConfig.texSize),a=this.gaussianBlurConfig.sigma;let s=ne(new m(0),a),n=v(this.gaussianBlurConfig.texture,t.uv).multiply(s);for(let l=1;l<this.kernelRadius;l++){const u=new m(l),d=ne(u,a),c=this.gaussianBlurConfig.direction.multiply(i).multiply(u),C=v(this.gaussianBlurConfig.texture,t.uv.add(c)),$=v(this.gaussianBlurConfig.texture,t.uv.subtract(c));n=n.add(C.multiply(d)).add($.multiply(d)),s=s.add(new m(2).multiply(d))}return e.fragColor=n.divide(s),e}};function ne(o,t){return new m(.39894).multiply(Je(new m(-.5).multiply(o).multiply(o).divide(t.multiply(t))).divide(t))}r([_t],zt.prototype,"kernelRadius",void 0),r([p(st)],zt.prototype,"gaussianBlurConfig",void 0),r([_(0,b(Z))],zt.prototype,"fragment",null);class ke extends k{}r([p(f)],ke.prototype,"texture",void 0);const hi=1,yi=2.2,gi=[-.08,-.05,-.03,-.02,-.01,.01,.02,.03,.05,.08];class Pt extends q{constructor(){super(...arguments),this.type="RadialBlurShader"}fragment(t){const e=new z;let i=new m(.5).subtract(t.uv);const a=ve(i.x.multiply(i.y).add(i.y.multiply(i.y)));i=i.divide(a);const s=v(this.radialBlurConfig.texture,t.uv);let n=s;for(let d=0;d<10;d++){const c=v(this.radialBlurConfig.texture,t.uv.add(i).multiply(new m(gi[d]).multiply(hi)));n=n.add(c)}const l=new m(1).divide(new m(11));n=n.multiply(l);let u=a.multiply(yi);return u=B(u,new m(0),new m(1)),e.fragColor=bt(s,n,u),e}}r([_t],Pt.prototype,"kernelRadius",void 0),r([p(ke)],Pt.prototype,"radialBlurConfig",void 0),r([_(0,b(Z))],Pt.prototype,"fragment",null);let Ut=class extends k{};r([p(f)],Ut.prototype,"colorTexture",void 0),r([p(Ke)],Ut.prototype,"coefficients",void 0);let ae=class extends q{constructor(){super(...arguments),this.type="FilterEffectShader"}fragment(t){const e=new z,i=v(this.filterEffectConfig.colorTexture,t.uv),a=M(ft(i.a,new m(0)),i.rgb.divide(i.a),new g(0)),s=this.filterEffectConfig.coefficients.multiply(new h(a,1)),n=i.a;return e.fragColor=new h(n.multiply(s.rgb),n),e}};r([p(Ut)],ae.prototype,"filterEffectConfig",void 0),r([_(0,b(Z))],ae.prototype,"fragment",null);let H=class extends k{};r([p(f)],H.prototype,"layerFBOTexture",void 0),r([p(f)],H.prototype,"blurTexture",void 0),r([p(h)],H.prototype,"shadowColor",void 0),r([p(x)],H.prototype,"shadowOffset",void 0),r([p(be)],H.prototype,"displayViewMat3",void 0);let re=class extends q{constructor(){super(...arguments),this.type="CompositeShader"}fragment(t){const e=new z,{layerFBOTexture:i,blurTexture:a,shadowColor:s,shadowOffset:n,displayViewMat3:l}=this.compositeConfig,u=l.multiply(new g(n,new m(0))),d=v(i,t.uv),c=v(a,t.uv.subtract(u.xy.divide(2)));return e.fragColor=c.a.multiply(s).multiply(new m(1).subtract(d.a)).add(d),e}};r([p(H)],re.prototype,"compositeConfig",void 0),r([_(0,b(Z))],re.prototype,"fragment",null);const S=!!de("esri-2d-profiler");class Ji{constructor(t,e){if(this._events=new Le,this._entries=new Map,this._timings=new li(10),this._currentContainer=null,this._currentPass=null,this._currentBrush=null,this._currentSummary=null,!S)return;this._ext=Re(t.gl,{}),this._debugOutput=e;const i=t.gl;if(!this.enableCommandLogging)return;let a;for(a in i)if(typeof i[a]=="function"){const s=i[a],n=a.includes("draw");i[a]=(...l)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:a,args:l,isDrawCommand:n}),this._currentSummary&&(this._currentSummary.commands++,n&&this._currentSummary.drawCommands++),s.apply(i,l))}}get enableCommandLogging(){return typeof S=="object"&&S.commandLogging}get enableTimeLogging(){return typeof S=="object"&&S.timeLogging}get lastTime(){return this._timings.peekLast()}recordContainerStart(t){S&&(this._currentContainer=t)}recordContainerEnd(){S&&(this._currentContainer=null)}recordPassStart(t){S&&(this._currentPass=t,this._initSummary())}recordPassEnd(){S&&(this._currentPass=null,this._emitSummary())}recordBrushStart(t){S&&(this._currentBrush=t)}recordBrushEnd(){S&&(this._currentBrush=null)}recordStart(t){if(S&&this._ext!=null){if(this._entries.has(t)){const i=this._entries.get(t),a=this._ext.resultAvailable(i.query),s=this._ext.disjoint();if(a&&!s){const n=this._ext.getResult(i.query)/1e6;let l=0;if(this._timings.enqueue(n)!=null&&this.enableTimeLogging){const c=this._timings.entries,C=c.length;let $=0;for(const E of c)$+=E;l=$/C}const u=n.toFixed(2),d=l?l.toFixed(2):"--";this.enableCommandLogging?(this.enableTimeLogging?console.groupCollapsed(`Frame report for ${t}, ${u} ms (${d} last 10 avg)
              ${i.commandsLen} Commands (${i.drawCommands} draw)`):console.groupCollapsed(`Frame report for ${t}
              ${i.commandsLen} Commands (${i.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(i.summaries),console.log("Commands: ",i.commands),console.groupEnd()):this.enableTimeLogging&&console.log(`Frame report for ${t}, ${u} ms (${d} last 10 avg)`),this.enableTimeLogging&&(this._debugOutput.innerHTML=`${u} (${d})`)}for(const n of i.handles)n.remove();this._ext.deleteQuery(i.query),this._entries.delete(t)}const e={name:t,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(e.handles.push(this._events.on("command",i=>{e.commandsLen++,e.commands.push(i),i.isDrawCommand&&e.drawCommands++})),e.handles.push(this._events.on("summary",i=>{e.summaries.push(i)}))),this._ext.beginTimeElapsed(e.query),this._entries.set(t,e)}}recordEnd(t){S&&this._ext!=null&&this._entries.has(t)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._currentSummary&&this._events.emit("summary",this._currentSummary)}}let yt=class extends tt{};r([O(0,x)],yt.prototype,"position",void 0),r([O(1,x)],yt.prototype,"texcoord",void 0),r([O(2,m)],yt.prototype,"w",void 0);let vi=class extends et{};class Wt extends k{}r([p(f)],Wt.prototype,"texture",void 0),r([p(m)],Wt.prototype,"opacity",void 0);let At=class extends K{constructor(){super(...arguments),this.type="VideoScreenShader"}vertex(t){const{position:e,texcoord:i,w:a}=t;return{glPosition:new h(e,0,a),texcoord:i}}fragment(t){const e=new z;return e.fragColor=v(this.config.texture,t.texcoord).multiply(this.config.opacity),e}};r([p(Wt)],At.prototype,"config",void 0),r([_(0,b(yt))],At.prototype,"vertex",null),r([_(0,b(vi))],At.prototype,"fragment",null);const wi=7e6;let fi=class{constructor(){this.styles=new Map,this.layerContexts=new Map}get cachedStyles(){return this.styles}setLabelClassStyle(t,e,i){this.layerContexts.set(t,e),this.styles.set(t,i)}removeContainer(t){for(const[e,i]of this.layerContexts.entries())i===t&&this.layerContexts.delete(e)}},it=class extends X{constructor(t){super(t),this._faderWorkingSet=[],this._styleRepository=new fi,this.lastUpdateId=-1,this.updateRequested=!1,this.view=null;const e=(i,a)=>{i.updateLabelVisibility(),i.requestRender(),i.isReady&&(i.decluttered=!0)};this.symbolFader=new ui("feature-tile",this._styleRepository,e,this._faderWorkingSet,Be,wi)}get updating(){return de("esri-2d-log-updating")&&console.log(`Updating LabelManager ${this.updateRequested}:
-> updateRequested: ${this.updateRequested}`),this.updateRequested}viewChange(){this.requestUpdate()}requestUpdate(){var t;this.updateRequested||(this.updateRequested=!0,(t=this.view)==null||t.requestUpdate())}processUpdate(t){var e;this.doUpdate(t)?this.updateRequested=!1:(this.updateRequested=!0,(e=this.view)==null||e.requestUpdate())}setLabelSchemaStyles(t,e){let i;switch(t.type){case"label":i=t.classes;break;case"subtype":i=Array.from(Object.values(t.renderers).flatMap(a=>a.classes));break;case"cluster":i=[...t.cluster.classes,...t.feature.classes];break;case"track":i=[...t.latestObservation.classes,...t.previousObservation.classes,...t.trackLine.classes]}for(const a of i){const s=_i(a);this._styleRepository.setLabelClassStyle(a.labelClassId,e,s)}}removeContainer(t){this._styleRepository.removeContainer(t),this.requestUpdate()}doUpdate(t){this._faderWorkingSet.length=0;const e=this.view;if(!e)return!1;const i=e.allLayerViews.map(a=>a.featureContainer).filter(a=>!!a&&(a==null?void 0:a.hasLabels));if(i.length>0){for(const n of i)for(const l of n.tiles||[])l.setTransform(t.state),this._faderWorkingSet.push(l);const a=t.state.scale,s=e.featuresTilingScheme.scaleToZoom(a);return this.symbolFader.update(s,t.state)}return!0}};function _i(o){const t=o.geometryType==="esriGeometryPolyline"?0:1,e=o.geometryType==="esriGeometryPolyline"?0:1;return{geometryType:o.geometryType,iconAllowOverlap:!o.deconflictionEnabled,iconIgnorePlacement:!1,textAllowOverlap:!o.deconflictionEnabled,textIgnorePlacement:!1,iconRotationAlignment:t,textRotationAlignment:t,iconTranslateAnchor:e,iconTranslate:[0,0],textTranslateAnchor:e,textTranslate:[0,0]}}r([w()],it.prototype,"updateRequested",void 0),r([w()],it.prototype,"updating",null),r([w()],it.prototype,"view",void 0),it=r([J("esri.views.2d.LabelManager")],it);const mt="esri-zoom-box",dt={container:`${mt}__container`,overlay:`${mt}__overlay`,background:`${mt}__overlay-background`,box:`${mt}__outline`},Lt={zoom:"Shift",counter:"Control"};let nt=class extends X{constructor(t){super(t),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._rafId=null,this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(t){this.removeAllHandles(),this._destroyOverlay(),this._set("view",t),t&&this.addHandles([t.on("drag",[Lt.zoom],e=>this._handleDrag(e,1),Qt.INTERNAL),t.on("drag",[Lt.zoom,Lt.counter],e=>this._handleDrag(e,-1),Qt.INTERNAL)])}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(t,e,i,a){this._box.x=t,this._box.y=e,this._box.width=i,this._box.height=a,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(t,e,i,a,s){const n=this.view,l=n.toMap(Fe(t+.5*i,e+.5*a));let u=Math.max(i/n.width,a/n.height);s===-1&&(u=1/u),this._destroyOverlay(),this.navigation.end(),n.goTo({center:l,scale:n.scale*u},{animationMode:"always",duration:pe()})}_updateBox(t,e,i,a){const s=this._boxShape;s.setAttributeNS(null,"x",""+t),s.setAttributeNS(null,"y",""+e),s.setAttributeNS(null,"width",""+i),s.setAttributeNS(null,"height",""+a),s.setAttributeNS(null,"class",dt.box)}_updateBackground(t,e,i,a){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(t,e,i,a,this.view.width,this.view.height))}_createContainer(){const t=document.createElement("div");t.className=dt.container,this.view.root.appendChild(t),this._container=t}_createOverlay(){const t=this.view.width,e=this.view.height,i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttributeNS(null,"d","M 0 0 L "+t+" 0 L "+t+" "+e+" L 0 "+e+" Z"),i.setAttributeNS(null,"class",dt.background);const a=document.createElementNS("http://www.w3.org/2000/svg","rect"),s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),s.setAttributeNS(null,"class",dt.overlay),s.appendChild(i),s.appendChild(a),this._container.appendChild(s),this._backgroundShape=i,this._boxShape=a,this._overlay=s}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(t,e,i,a,s,n){const l=t+i,u=e+a;return"M 0 0 L "+s+" 0 L "+s+" "+n+" L 0 "+n+" ZM "+t+" "+e+" L "+t+" "+u+" L "+l+" "+u+" L "+l+" "+e+" Z"}_handleDrag(t,e){const i=t.x,a=t.y,s=t.origin.x,n=t.origin.y;let l,u,d,c;switch(i>s?(l=s,d=i-s):(l=i,d=s-i),a>n?(u=n,c=a-n):(u=a,c=n-a),t.action){case"start":this._start();break;case"update":this._update(l,u,d,c);break;case"end":this._end(l,u,d,c,e)}t.stopPropagation()}_redraw(){if(!this._rafId||(this._rafId=null,!this._overlay))return;const{x:t,y:e,width:i,height:a}=this._box;this._updateBox(t,e,i,a),this._updateBackground(t,e,i,a),this._rafId=requestAnimationFrame(this._redraw)}};r([w()],nt.prototype,"navigation",void 0),r([w()],nt.prototype,"view",null),nt=r([J("esri.views.2d.navigation.ZoomBox")],nt);let j=class extends X{constructor(t){super(t),this.animationTime=Y(0),this.momentumEstimator=new Oe(500,6,.92),this.momentum=null,this.tmpMomentum=Ie(),this.momentumFinished=!1,this.viewpoint=new vt({targetGeometry:new wt,scale:0,rotation:0}),this._previousDrag=null,this.addHandles(ce(()=>this.momentumFinished,()=>this.navigation.stop()))}begin(t,e){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(e),this._previousDrag=e}update(t,e){this.addToEstimator(e);let i=e.center.x,a=e.center.y;const s=this._previousDrag;i=s?s.center.x-i:-i,a=s?a-s.center.y:a,t.viewpoint=gt(this.viewpoint,t.viewpoint,[i||0,a||0]),this._previousDrag=e}end(t,e){this.addToEstimator(e);const i=t.navigation.momentumEnabled&&!De();this.momentum=i?this.momentumEstimator.evaluateMomentum():null,this.animationTime=Y(0),this.momentum&&this.onAnimationUpdate(t),this._previousDrag=null,this.navigation.end()}addToEstimator(t){const e=t.center.x,i=t.center.y,a=qe(-e,i),s=Ne(-e,i,0);this.momentumEstimator.add(a,s,.001*t.timestamp)}onAnimationUpdate(t){var e;(e=this.navigation.animationManager)==null||e.animateContinuous(t.viewpoint,(i,a)=>{const{momentum:s,animationTime:n,tmpMomentum:l}=this,u=this.momentumFinished=!s||s.isFinished(n),d=he(a);if(!u){const c=s.valueDelta(n,d);Ge(l,s.direction,c),gt(i,i,l),t.constraints.constrainByGeometry(i)}this.animationTime=Y(this.animationTime+d)})}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};r([w()],j.prototype,"momentumFinished",void 0),r([w()],j.prototype,"viewpoint",void 0),r([w()],j.prototype,"navigation",void 0),j=r([J("esri.views.2d.navigation.actions.Pan")],j);let Q=class extends X{constructor(t){super(t),this._animationTime=Y(0),this._momentumFinished=!1,this._previousAngle=0,this._previousRadius=0,this._previousCenter=null,this._rotationMomentumEstimator=new Ze(.6,.15,.95),this._rotationDirection=1,this._startAngle=0,this._startRadius=0,this._updateTimestamp=null,this._zoomDirection=1,this._zoomMomentumEstimator=new Ve,this._zoomOnly=null,this.viewpoint=new vt({targetGeometry:new wt,scale:0,rotation:0}),this.zoomMomentum=null,this.rotateMomentum=null,this.addHandles(ce(()=>this._momentumFinished,()=>this.navigation.stop()))}begin(t,e){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=e.angle,this._previousRadius=this._startRadius=e.radius,this._previousCenter=e.center,this._updateTimestamp=null,t.constraints.rotationEnabled&&this.addToRotateEstimator(0,e.timestamp),this.addToZoomEstimator(e,1)}update(t,e){this._updateTimestamp===null&&(this._updateTimestamp=e.timestamp);const i=e.angle,a=e.radius,s=e.center,n=Math.abs(180*(i-this._startAngle)/Math.PI),l=Math.abs(a-this._startRadius),u=this._startRadius/a;if(this._previousRadius&&this._previousCenter){const d=a/this._previousRadius;let c=180*(i-this._previousAngle)/Math.PI;this._rotationDirection=c>=0?1:-1,this._zoomDirection=d>=1?1:-1,t.constraints.rotationEnabled?(this._zoomOnly===null&&e.timestamp-this._updateTimestamp>200&&(this._zoomOnly=l-n>0),this._zoomOnly===null||this._zoomOnly?c=0:this.addToRotateEstimator(i-this._startAngle,e.timestamp)):c=0,this.addToZoomEstimator(e,u),this.navigation.setViewpoint([s.x,s.y],1/d,c,[this._previousCenter.x-s.x,s.y-this._previousCenter.y])}this._previousAngle=i,this._previousRadius=a,this._previousCenter=s}end(t){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=Y(0),(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(t),this.navigation.end()}addToRotateEstimator(t,e){this._rotationMomentumEstimator.add(t,.001*e)}addToZoomEstimator(t,e){this._zoomMomentumEstimator.add(e,.001*t.timestamp)}canZoomIn(t){const e=t.scale,i=t.constraints.effectiveMaxScale;return i===0||e>i}canZoomOut(t){const e=t.scale,i=t.constraints.effectiveMinScale;return i===0||e<i}onAnimationUpdate(t){var e;(e=this.navigation.animationManager)==null||e.animateContinuous(t.viewpoint,(i,a)=>{const s=!this.canZoomIn(t)&&this._zoomDirection>1||!this.canZoomOut(t)&&this._zoomDirection<1,n=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),l=s||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),u=he(a);if(this._momentumFinished=n&&l,!this._momentumFinished){const d=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,u))*this._rotationDirection*180/Math.PI:0;let c=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,u)):1;const C=rt(),$=rt();if(this._previousCenter){It(C,this._previousCenter.x,this._previousCenter.y),Ue($,t.size,t.padding),We(C,C,$);const{constraints:E,scale:N}=t,V=N*c;c<1&&!E.canZoomInTo(V)?(c=N/E.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):c>1&&!E.canZoomOutTo(V)&&(c=N/E.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),He(i,t.viewpoint,c,d,C,t.size),t.constraints.constrainByGeometry(i)}}this._animationTime=Y(this._animationTime+u)})}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};r([w()],Q.prototype,"_momentumFinished",void 0),r([w()],Q.prototype,"viewpoint",void 0),r([w()],Q.prototype,"navigation",void 0),Q=r([J("esri.views.2d.navigation.actions.Pinch")],Q);const Rt=rt(),le=rt();let at=class extends X{constructor(t){super(t),this._previousCenter=rt(),this.viewpoint=new vt({targetGeometry:new wt,scale:0,rotation:0})}begin(t,e){this.navigation.begin(),It(this._previousCenter,e.center.x,e.center.y)}update(t,e){const{state:{size:i,padding:a}}=t;It(Rt,e.center.x,e.center.y),je(le,i,a),t.viewpoint=Dt(this.viewpoint,t.state.paddedViewState.viewpoint,Qe(le,this._previousCenter,Rt)),Ye(this._previousCenter,Rt)}end(){this.navigation.end()}};r([w()],at.prototype,"viewpoint",void 0),r([w()],at.prototype,"navigation",void 0),at=r([J("esri.views.2d.navigation.actions.Rotate")],at);const U=10,ue=1,Bt=new vt({targetGeometry:new wt}),Ft=[0,0],me=250;let R=class extends X{constructor(o){super(o),this._endTimer=null,this._lastEventTimestamp=null,this.animationManager=null,this.interacting=!1}initialize(){this.pan=new j({navigation:this}),this.rotate=new at({navigation:this}),this.pinch=new Q({navigation:this}),this.zoomBox=new nt({view:this.view,navigation:this})}destroy(){this.pan=lt(this.pan),this.rotate=lt(this.rotate),this.pinch=lt(this.pinch),this.zoomBox=lt(this.zoomBox),this.animationManager=null}begin(){this.stop(),this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(me)}async zoom(o,t=this._getDefaultAnchor()){if(this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return o<1?this.zoomIn(t):this.zoomOut(t);this.setViewpoint(t,o,0,[0,0])}async zoomIn(o){const t=this.view,e=t.constraints.snapToNextScale(t.scale);return this._zoomToScale(e,o)}async zoomOut(o){const t=this.view,e=t.constraints.snapToPreviousScale(t.scale);return this._zoomToScale(e,o)}setViewpoint(o,t,e,i){this.begin(),this.view.stateManager.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,o,t,e,i),this.end()}setViewpointImmediate(o,t=0,e=[0,0],i=this._getDefaultAnchor()){this.view.stateManager.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,i,o,t,e)}continuousRotateClockwise(){var t;const o=this.view.viewpoint;(t=this.animationManager)==null||t.animateContinuous(o,e=>{Dt(e,e,-ue)})}continuousRotateCounterclockwise(){var t;const o=this.view.viewpoint;(t=this.animationManager)==null||t.animateContinuous(o,e=>{Dt(e,e,ue)})}resetRotation(){this.view.constraints.rotationEnabled&&(this.view.rotation=0)}continuousPanLeft(){this._continuousPan([-U,0])}continuousPanRight(){this._continuousPan([U,0])}continuousPanUp(){this._continuousPan([0,U])}continuousPanDown(){this._continuousPan([0,-U])}continuousPanVector({x:o,y:t}){this._continuousPan([o*U,t*U])}stop(){var o;this.pan.stopMomentumNavigation(),(o=this.animationManager)==null||o.stop(),this.end(),this._endTimer!==null&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(o){var e;const t=this.view.viewpoint;(e=this.animationManager)==null||e.animateContinuous(t,i=>{gt(i,i,o),this.view.constraints.constrainByGeometry(i)})}_startTimer(o){return this._endTimer!==null||(this._endTimer=setTimeout(()=>{this._endTimer=null;const t=performance.now()-(this._lastEventTimestamp??0);t<me?this._endTimer=this._startTimer(t):this._set("interacting",!1)},o)),this._endTimer}_getDefaultAnchor(){const{size:o,padding:{left:t,right:e,top:i,bottom:a}}=this.view;return Ft[0]=.5*(o[0]-e+t),Ft[1]=.5*(o[1]-a+i),Ft}async _zoomToScale(o,t=this._getDefaultAnchor()){const{view:e}=this,{constraints:i,scale:a,viewpoint:s,size:n,padding:l}=e,u=i.canZoomInTo(o),d=i.canZoomOutTo(o);if(!(o<a&&!u||o>a&&!d))return Yt(Bt,s,o/a,0,t,n,l),i.constrainByGeometry(Bt),e.goTo(Bt,{animate:!0,animationMode:"always",duration:pe(),pickClosestTarget:!1})}_scaleRotateTranslateViewpoint(o,t,e,i,a){const{view:s}=this,{size:n,padding:l,constraints:u,scale:d,viewpoint:c}=s,C=d*e,$=u.canZoomInTo(C),E=u.canZoomOutTo(C);return(e<1&&!$||e>1&&!E)&&(e=1),gt(c,c,a),Yt(o,c,e,i,t,n,l),u.constrainByGeometry(o)}};r([w()],R.prototype,"animationManager",void 0),r([w({type:Boolean,readOnly:!0})],R.prototype,"interacting",void 0),r([w()],R.prototype,"pan",void 0),r([w()],R.prototype,"pinch",void 0),r([w()],R.prototype,"rotate",void 0),r([w()],R.prototype,"view",void 0),r([w()],R.prototype,"zoomBox",void 0),R=r([J("esri.views.2d.navigation.MapViewNavigation")],R);const lo=R;class Ee extends tt{}r([O(0,x)],Ee.prototype,"position",void 0);class bi extends et{}class F extends k{}r([p(f)],F.prototype,"readbackTexture",void 0),r([p(f)],F.prototype,"maskTexture",void 0),r([p(f)],F.prototype,"overlayTexture",void 0),r([p(h)],F.prototype,"background",void 0),r([p(h)],F.prototype,"drawPos",void 0),r([p(m)],F.prototype,"maskEnabled",void 0),r([p(m)],F.prototype,"overlayEnabled",void 0);class Ot extends K{constructor(){super(...arguments),this.type="MagnifierShader"}vertex(t){const e=t.position,i=t.position.subtract(new x(.5)).multiply(this.config.drawPos.zw),a=this.config.drawPos.xy.add(i);return{glPosition:new h(a,0,1),texCoord:e}}fragment(t){let e=v(this.config.readbackTexture,xi(t.texCoord));e=e.add(new m(1).subtract(e.a)).multiply(this.config.background);const i=M(A(this.config.maskEnabled,new m(1)),v(this.config.maskTexture,t.texCoord).a,new m(1));e=e.multiply(i);const a=M(A(this.config.overlayEnabled,new m(1)),v(this.config.overlayTexture,t.texCoord),new h(0)),s=new z;return s.fragColor=a.add(new m(1).subtract(a.a).multiply(e)),s}}function xi(o){const t=o.multiply(new x(2)).subtract(1);return M(A(t.x,new m(0)).and(A(t.y,new m(0))),new x(.5),()=>{const e=ti(t.y,t.x),i=ei(ii(t),new m(mi)),a=new x(oi(e),si(e));return i.multiply(a).multiply(new x(.5)).add(new m(.5))})}r([p(F)],Ot.prototype,"config",void 0),r([_(0,b(Ee))],Ot.prototype,"vertex",null),r([_(0,b(bi))],Ot.prototype,"fragment",null);class ze extends tt{}r([O(0,x)],ze.prototype,"position",void 0);class Ci extends et{}class Pe extends k{}r([p(be)],Pe.prototype,"dvs",void 0);class G extends k{}r([p(m)],G.prototype,"halfWidth",void 0),r([p(m)],G.prototype,"aaWidth",void 0),r([p(m)],G.prototype,"pxPerCell",void 0),r([p(h)],G.prototype,"minorLineColor",void 0),r([p(h)],G.prototype,"majorLineColor",void 0),r([p(Nt)],G.prototype,"majorLineInterval",void 0);class pt extends K{constructor(){super(...arguments),this.type="GridShader"}vertex(t){const e=t.position.multiply(2).subtract(1);return{gridPos:this.transform.dvs.multiply(new g(e,1)).xy,glPosition:new h(e,0,1)}}fragment(t){const e=ye(t.gridPos),i=ni(e),a=P(i.x,new m(1).subtract(i.x)),s=P(i.y,new m(1).subtract(i.y)),n=new x(a,s).multiply(this.config.pxPerCell).subtract(this.config.halfWidth),l=P(n.x,n.y),u=new m(1).subtract(_e(new m(0),this.config.aaWidth,l)),d=new Nt(Jt(e.x)),c=new Nt(Jt(e.y)),C=new m(Kt(d,this.config.majorLineInterval)),$=new m(Kt(c,this.config.majorLineInterval)),E=M(fe(n.x,n.y),C,$),N=ft(ai(D(n.x,this.config.aaWidth),D(n.y,this.config.aaWidth)),new m(.5)),V=P(C,$),xt=M(N,V,E),Ae=bt(this.config.majorLineColor,this.config.minorLineColor,P(xt,new m(1))),jt=new z;return jt.fragColor=Ae.multiply(u),jt}}r([p(Pe)],pt.prototype,"transform",void 0),r([p(G)],pt.prototype,"config",void 0),r([_(0,b(ze))],pt.prototype,"vertex",null),r([_(0,b(Ci))],pt.prototype,"fragment",null);export{Et as C,ut as E,Ot as P,Pt as R,Ai as a,zt as b,re as c,Ji as d,Ii as e,oe as f,At as g,Di as h,lo as i,it as l,pt as q,Pi as r,kt as v,se as x,ae as y};
