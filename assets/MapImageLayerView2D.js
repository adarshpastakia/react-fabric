import{ex as g,bi as n,l as d,eq as l,bj as c,bn as o,E as p,F as u,V as _}from"./ShadowCastClear.glsl.js";import{s as f}from"./BitmapContainer.js";import{b as H}from"./LayerView2D.js";import{O as y}from"./GraphicsView2D.js";import{o as w}from"./HighlightGraphicContainer.js";import{M as $}from"./ExportStrategy.js";import{d as v}from"./LayerView.js";import{i as b}from"./MapImageLayerView.js";import{i as x}from"./RefreshableLayerView.js";import{i as G}from"./highlightUtils2.js";import{P as U}from"./MapServiceLayerViewHelper.js";import{r as V}from"./highlightOptionsUtils.js";import"./iframe-DpfJK_wQ.js";import"./index.js";import"./Viewport.js";import"./debounce.js";import"./index2.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";import"./WGLContainer.js";import"./Utils8.js";import"./BoundingBox.js";import"./WGLBrushVTLSymbol.js";import"./ShaderCompiler.js";import"./ProgramTemplate.js";import"./Container.js";import"./EffectView.js";import"./earcut.js";import"./BitmapTechnique.js";import"./GraphShaderModule.js";import"./bitmapUtils.js";import"./CIMSymbolHelper.js";import"./BidiEngine.js";import"./labelPoint.js";import"./rasterizingUtils.js";import"./Rect.js";import"./OverrideHelper.js";import"./callExpressionWithFeature.js";import"./AttributeStore.js";import"./UpdateTracking2D.js";import"./FeatureStoreQueryAdapter.js";import"./constants.js";import"./queryUtils.js";import"./timeSupport2.js";import"./FeatureCommandQueue.js";import"./utils5.js";import"./heatmapTextureUtils.js";import"./QueueProcessor.js";import"./FeatureMetadata.js";import"./normalizeUtilsSync.js";import"./densifyCurvedGeometry.js";import"./AGraphicContainer.js";import"./TechniqueInstance.js";import"./TileContainer.js";import"./ExportImageParameters.js";import"./floorFilterUtils.js";import"./sublayerUtils.js";import"./timeSupport.js";import"./popupUtils.js";let h=class extends b(x(H(v))){constructor(){super(...arguments),this._highlightGraphics=new g,this._updateHash=""}fetchPopupFeaturesAtLocation(t,i){return this._popupHighlightHelper.fetchPopupFeaturesAtLocation(t,i)}update(t){const i=`${this.exportImageVersion}/${t.state.id}/${t.pixelRatio}/${t.stationary}`;this._updateHash!==i&&(this._updateHash=i,this.strategy.update(t).catch(e=>{n(e)||d.getLogger(this).error(e)}),t.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(t.state.resolution)),this._highlightView.processUpdate(t)}attach(){const{imageMaxWidth:t,imageMaxHeight:i,version:e}=this.layer,r=e>=10.3,m=e>=10;this._bitmapContainer=new f,this.container.addChild(this._bitmapContainer),this._highlightView=new y({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new w(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1}),this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new U({createFetchPopupFeaturesQueryGeometry:(s,a)=>l(s,a,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:({graphic:s,property:a})=>this._highlightView.graphicUpdateHandler({graphic:s,property:a}),layerView:this,updatingHandles:this._updatingHandles}),this.strategy=new $({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:t,imageMaxHeight:i,imageRotationSupported:r,imageNormalizationSupported:m,hidpi:!0}),this.addAttachHandles(c(()=>this.exportImageVersion,()=>this.requestUpdate())),this.requestUpdate()}detach(){this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy(),this._popupHighlightHelper.destroy()}viewChange(){}moveEnd(){this.requestUpdate()}supportsSpatialReference(t){return this.layer.serviceSupportsSpatialReference(t)}async doRefresh(){this._updateHash="",this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(t,i,e,r){return this.layer.fetchImage(t,i,e,{timeExtent:this.timeExtent,floors:this.floors,...r})}fetchImageBitmap(t,i,e,r){return this.layer.fetchImageBitmap(t,i,e,{timeExtent:this.timeExtent,floors:this.floors,...r})}highlight(t,i){const e=G(t);if(e.length===0)return o();const r=V(i);return this._addHighlightGraphics(e,r),o(()=>!this.destroyed&&this._removeHighlightGraphics(e,r))}_processHighlight(){var i;const t=this._getHighlights();(i=this._highlightView)==null||i.setHighlight(t)}_addHighlightGraphics(t,i){this._highlightGraphics.addMany(t),this._addHighlights(t.map(e=>e.uid),i)}_removeHighlightGraphics(t,i){this._highlightGraphics.removeMany(t),this._removeHighlights(t.map(e=>e.uid),i)}};p([u()],h.prototype,"strategy",void 0),h=p([_("esri.views.2d.layers.MapImageLayerView2D")],h);const Rt=h;export{Rt as default};
