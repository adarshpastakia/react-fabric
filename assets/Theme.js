import{e as u,a as v,f as g,i as m,D as _,M as b,b as o,c as p,r as w,d as y,k as E,g as D}from"./Disposer.js";class P{constructor(){Object.defineProperty(this,"_listeners",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_killed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_disabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_iterating",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_enabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_disposed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._listeners=[],this._killed=[],this._disabled={},this._iterating=0,this._enabled=!0,this._disposed=!1}isDisposed(){return this._disposed}dispose(){if(!this._disposed){this._disposed=!0;const e=this._listeners;this._iterating=1,this._listeners=null,this._disabled=null;try{u(e,t=>{t.disposer.dispose()})}finally{this._killed=null,this._iterating=null}}}hasListeners(){return this._listeners.length!==0}hasListenersByType(e){return v(this._listeners,t=>(t.type===null||t.type===e)&&!t.killed)}enable(){this._enabled=!0}disable(){this._enabled=!1}enableType(e){delete this._disabled[e]}disableType(e,t=1/0){this._disabled[e]=t}_removeListener(e){if(this._iterating===0){const t=this._listeners.indexOf(e);if(t===-1)throw new Error("Invalid state: could not remove listener");this._listeners.splice(t,1)}else this._killed.push(e)}_removeExistingListener(e,t,s,r){if(this._disposed)throw new Error("EventDispatcher is disposed");this._eachListener(i=>{i.once===e&&i.type===t&&(s===void 0||i.callback===s)&&i.context===r&&i.disposer.dispose()})}isEnabled(e){if(this._disposed)throw new Error("EventDispatcher is disposed");return this._enabled&&this._listeners.length>0&&this.hasListenersByType(e)&&this._disabled[e]===void 0}removeType(e){if(this._disposed)throw new Error("EventDispatcher is disposed");this._eachListener(t=>{t.type===e&&t.disposer.dispose()})}has(e,t,s){return g(this._listeners,i=>i.once!==!0&&i.type===e&&(t===void 0||i.callback===t)&&i.context===s)!==-1}_shouldDispatch(e){if(this._disposed)throw new Error("EventDispatcher is disposed");const t=this._disabled[e];return m(t)?(t<=1?delete this._disabled[e]:--this._disabled[e],!1):this._enabled}_eachListener(e){++this._iterating;try{u(this._listeners,e)}finally{--this._iterating,this._iterating===0&&this._killed.length!==0&&(u(this._killed,t=>{this._removeListener(t)}),this._killed.length=0)}}dispatch(e,t){this._shouldDispatch(e)&&this._eachListener(s=>{!s.killed&&(s.type===null||s.type===e)&&(s._debounceDelay?(s._debounceTimeout&&window.clearTimeout(s._debounceTimeout),s._debounceTimeout=window.setTimeout(()=>{s._debounceTimeout=void 0,s.killed||s.dispatch(e,t)},s._debounceDelay)):s.dispatch(e,t))})}_on(e,t,s,r,i,n,l){if(this._disposed)throw new Error("EventDispatcher is disposed");this._removeExistingListener(e,t,s,r);const h={type:t,callback:s,context:r,shouldClone:i,dispatch:n,killed:!1,once:e,disposer:new _(()=>{h.killed=!0,h._debounceTimeout&&window.clearTimeout(h._debounceTimeout),this._removeListener(h)}),_debounceDelay:l};return this._listeners.push(h),h}onAll(e,t,s=!0){return this._on(!1,null,e,t,s,(r,i)=>e.call(t,i)).disposer}on(e,t,s,r=!0){return this._on(!1,e,t,s,r,(i,n)=>t.call(s,n)).disposer}onDebounced(e,t,s,r,i=!0){return this._on(!1,e,t,r,i,(n,l)=>t.call(r,l),s).disposer}once(e,t,s,r=!0){const i=this._on(!0,e,t,s,r,(n,l)=>{i.disposer.dispose(),t.call(s,l)});return i.disposer}off(e,t,s){this._removeExistingListener(!1,e,t,s)}copyFrom(e){if(this._disposed)throw new Error("EventDispatcher is disposed");if(e===this)throw new Error("Cannot copyFrom the same TargetedEventDispatcher");const t=[];return u(e._listeners,s=>{!s.killed&&s.shouldClone&&(s.type===null?t.push(this.onAll(s.callback,s.context)):s.once?t.push(this.once(s.type,s.callback,s.context)):t.push(this.on(s.type,s.callback,s.context)))}),new b(t)}}function d(a,e){return a===e?0:a<e?-1:1}function O(a,e,t){const s=a.length,r=e.length,i=Math.min(s,r);for(let n=0;n<i;++n){const l=t(a[n],e[n]);if(l!==0)return l}return d(s,r)}function L(a,e){return a===e?0:a<e?-1:1}function c(a){o(a,(e,t)=>{y(t)&&typeof t.dispose=="function"&&(t.enableDispose=!0,t.dispose())})}class j{constructor(e,t,s){Object.defineProperty(this,"_settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._name=e,this._template=t,this._settings=s}_dispose(){c(this._settings)}get(e,t){const s=this._settings[e];return s!==void 0?s:t}set(e,t){this._settings[e]=t,this._template._stateChanged(this._name)}remove(e){delete this._settings[e],this._template._stateChanged(this._name)}setAll(e){E(e).forEach(t=>{this._settings[t]=e[t]}),this._template._stateChanged(this._name)}_apply(e,t){o(this._settings,(s,r)=>{!t[s]&&!e._userSettings[s]&&(t[s]=!0,e.setRaw(s,r))})}}class T{constructor(e){Object.defineProperty(this,"_template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_states",{enumerable:!0,configurable:!0,writable:!0,value:{}}),this._template=e}_dispose(){o(this._states,(e,t)=>{t._dispose()})}lookup(e){return this._states[e]}create(e,t){const s=this._states[e];if(s)return s.setAll(t),s;{const r=new j(e,this._template,t);return this._states[e]=r,this._template._stateChanged(e),r}}remove(e){delete this._states[e],this._template._stateChanged(e)}_apply(e,t){o(this._states,(s,r)=>{let i=t.states[s];i==null&&(i=t.states[s]={});const n=e.states.create(s,{});r._apply(n,i)})}}class k{constructor(){Object.defineProperty(this,"_callbacks",{enumerable:!0,configurable:!0,writable:!0,value:{}})}add(e,t){let s=this._callbacks[e];return s===void 0&&(s=this._callbacks[e]=[]),s.push(t),new _(()=>{p(s,t),s.length===0&&delete this._callbacks[e]})}remove(e){this._callbacks[e]!==void 0&&delete this._callbacks[e]}_apply(e){const t=[];return o(this._callbacks,(s,r)=>{u(r,i=>{t.push(e.adapters.add(s,i))})}),new b(t)}}class f{constructor(e,t){if(Object.defineProperty(this,"_disposed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"_settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_privateSettings",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"_settingEvents",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"_privateSettingEvents",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"_entities",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"states",{enumerable:!0,configurable:!0,writable:!0,value:new T(this)}),Object.defineProperty(this,"adapters",{enumerable:!0,configurable:!0,writable:!0,value:new k}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:new P}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!t)throw new Error("You cannot use `new Class()`, instead use `Class.new()`");this._settings=e}static new(e){return new f(e,!0)}_dispose(){c(this._settings),c(this._privateSettings)}isDisposed(){return this._disposed}dispose(){this._disposed||(this._disposed=!0,this._dispose())}_checkDisposed(){if(this._disposed)throw new Error("Template is disposed")}get entities(){return this._entities}get(e,t){this._checkDisposed();const s=this._settings[e];return s!==void 0?s:t}setRaw(e,t){this._checkDisposed(),this._settings[e]=t}set(e,t){this._checkDisposed(),this._settings[e]!==t&&(this.setRaw(e,t),this._entities.forEach(s=>{s._setTemplateProperty(this,e,t)}))}remove(e){this._checkDisposed(),e in this._settings&&(delete this._settings[e],this._entities.forEach(t=>{t._removeTemplateProperty(e)}))}removeAll(){this._checkDisposed(),o(this._settings,(e,t)=>{this.remove(e)})}getPrivate(e,t){this._checkDisposed();const s=this._privateSettings[e];return s!==void 0?s:t}setPrivateRaw(e,t){return this._checkDisposed(),this._privateSettings[e]=t,t}setPrivate(e,t){return this._checkDisposed(),this._privateSettings[e]!==t&&(this.setPrivateRaw(e,t),this._entities.forEach(s=>{s._setTemplatePrivateProperty(this,e,t)})),t}removePrivate(e){this._checkDisposed(),e in this._privateSettings&&(delete this._privateSettings[e],this._entities.forEach(t=>{t._removeTemplatePrivateProperty(e)}))}setAll(e){this._checkDisposed(),o(e,(t,s)=>{this.set(t,s)})}on(e,t){this._checkDisposed();let s=this._settingEvents[e];return s===void 0&&(s=this._settingEvents[e]=[]),s.push(t),new _(()=>{p(s,t),s.length===0&&delete this._settingEvents[e]})}onPrivate(e,t){this._checkDisposed();let s=this._privateSettingEvents[e];return s===void 0&&(s=this._privateSettingEvents[e]=[]),s.push(t),new _(()=>{p(s,t),s.length===0&&delete this._privateSettingEvents[e]})}_apply(e,t){this._checkDisposed();const s=[];return o(this._settingEvents,(r,i)=>{u(i,n=>{s.push(e.on(r,n))})}),o(this._privateSettingEvents,(r,i)=>{u(i,n=>{s.push(e.onPrivate(r,n))})}),this.states._apply(e,t),s.push(this.adapters._apply(e)),s.push(e.events.copyFrom(this.events)),new b(s)}_setObjectTemplate(e){this._checkDisposed(),this._entities.push(e)}_removeObjectTemplate(e){w(this._entities,e)}_stateChanged(e){this._checkDisposed(),this._entities.forEach(t=>{t._applyStateByKey(e)})}}class C{constructor(e,t){if(Object.defineProperty(this,"_root",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_rules",{enumerable:!0,configurable:!0,writable:!0,value:{}}),this._root=e,!t)throw new Error("You cannot use `new Class()`, instead use `Class.new()`")}static new(e){const t=new this(e,!0);return t.setupDefaultRules(),t}setupDefaultRules(){}_lookupRules(e){return this._rules[e]}ruleRaw(e,t=[]){let s=this._rules[e];s||(s=this._rules[e]=[]),t.sort(d);const{index:r,found:i}=D(s,n=>{const l=d(n.tags.length,t.length);return l===0?O(n.tags,t,d):l});if(i)return s[r].template;{const n=f.new({});return s.splice(r,0,{tags:t,template:n}),n}}rule(e,t=[]){return this.ruleRaw(e,t)}}export{P as E,C as T,f as a,L as b,d as c,O as d};
