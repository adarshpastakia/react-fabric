import{b6 as Nt,O as _t,b4 as jt,ef as wt,E as s,F as r,V as $,fq as xt,l1 as dt,bI as qt,bJ as we,x_ as xe,vY as Oe,e_ as nt,fc as be,fe as $e,bK as et,hz as Te,bC as ht,K as Bt,Ae as ke,vE as ot,hx as Pe,Af as Ve,Ag as Wt,vf as Yt,vh as W,kt as M,gH as Se,X as Me,Ah as Ce,a5 as Kt,kM as Ie,f7 as De,bj as I,Ai as Ot,bo as X,bk as Ee,bl as U,_ as Ue,bn as K,bD as Ge,ev as Re,fZ as He,kP as bt,Aj as ze,hd as Ae,bh as Ze,es as $t,i as Tt,mI as Jt,gJ as Qt,gr as Le,x$ as Xt,gq as Fe,st as Ne,ld as Z,gv as L,fF as kt,Ak as je,Al as qe,fA as Be,fD as We,fH as Pt,Am as st,fb as Ye,kx as Vt,oO as St,bL as Mt,zv as Ct}from"./ShadowCastClear.glsl.js";import{r as C,V as Ke,R as Je,E as Qe,c as Xe,H as ti}from"./SketchTooltipInfo.js";import{a as tt,i as ct}from"./dehydratedFeatureComparison.js";import{W as ei,k as It,v as ii,b as Dt,U as ni,T as oi,j as Et,R as si}from"./createUtils.js";import{h as Y,M as ri,j as ai,I as te,w as ee,Q as li,U as ci}from"./TooltipInfoWithCoordinates.js";import{R as G,j as ie,U as pi,x as ui}from"./angularMeasurementUtils.js";import{f as R,$ as gt,a0 as di,a1 as ne,a2 as hi,a3 as oe,a4 as gi,F as mi,a5 as yi,r as fi,a6 as vi,O as _i,a7 as wi,W as xi}from"./euclideanLengthMeasurementUtils.js";import{r as Oi,p as pt,U as bi}from"./InteractiveToolBase.js";import{l as se,c as re}from"./SketchOptions.js";import{a as $i,g as Ti,w as ki,V as Pi,t as Vi,b as Si,o as Mi,l as Ci}from"./EditGeometryOperations.js";import{e as Ut}from"./SnappingContext.js";import{f as Ii}from"./SnappingDragPipelineStep.js";import{p as Di}from"./SnappingOperation.js";const mt={UndoRedoUpdating:"Cannot perform operation whilst undo redo is updating",UndoInvalidError:"There are no items to Undo",RedoInvalidError:"There are no items to Redo"};class F extends Error{constructor(){super(mt.UndoRedoUpdating),this.type="undo-redo-updating-error"}}let Ei=class extends Error{constructor(){super(mt.UndoInvalidError),this.type="undo-redo-undo-error"}};class Gt extends Error{constructor(){super(mt.RedoInvalidError),this.type="undo-redo-redo-error"}}let k=class extends Nt{constructor(){super(...arguments),this._stack=new _t,this._stackPosition=-1,this._updatingHandles=new jt}get updating(){return this._updatingHandles.updating}get canUndo(){return this.hasUndo&&!this.updating}get hasUndo(){return this._stackPosition>=0}get canRedo(){return this.hasRedo&&!this.updating}get hasRedo(){return this._stackPosition<this._stack.length-1}_truncateForwardStack(){this._stack.splice(this._stackPosition+1,this._stack.length-this._stackPosition).forEach(t=>t.destroy())}_drainStack(){this._stack.drain(t=>t.destroy()),this._stackPosition=-1}async undo(){if(!this.hasUndo)throw new Ei;if(this.updating)throw new F;const t=this._stack.getItemAt(this._stackPosition);t&&await this._updatingHandles.addPromise((async()=>{await t.executeUndoRedoOperation(1),--this._stackPosition,t.canRedo||this._truncateForwardStack()})())}async redo(){if(!this.hasRedo)throw new Gt;if(this.updating)throw new F;const t=this._stack.getItemAt(this._stackPosition+1);if(!t)throw new Gt;await this._updatingHandles.addPromise((async()=>{await t.executeUndoRedoOperation(2),++this._stackPosition})())}peekUndo(){if(this.canUndo)return this._stack.getItemAt(this._stackPosition)}peekRedo(){if(this.canRedo)return this._stack.getItemAt(this._stackPosition+1)}async inject(t){if(this.updating)throw new F;await this._updatingHandles.addPromise((async()=>{t.status===0&&await t.executeUndoRedoOperation(0),t.canUndo?(this._stack.splice(this._stackPosition+1,0,t),this._stackPosition++):this._stackPosition>-1&&(this._stack.splice(0,this._stackPosition+1).forEach(i=>i.destroy()),this._stackPosition=-1)})())}async add(t){if(this.updating)throw new F;await this._updatingHandles.addPromise((async()=>{t.status===0&&await t.executeUndoRedoOperation(0),this._stackPosition>=-1&&this._truncateForwardStack(),t.canUndo?(this._stack.push(t),this._stackPosition=this._stack.length-1):this._drainStack()})())}async removeTagged(t,i=!1){if(this.updating&&!i)return;await wt(()=>!this.updating);const n=new _t;for(let o=0;o<this._stack.length;o++){const l=this._stack.getItemAt(o);l&&(l.tag===t?(l.destroy(),o===this._stackPosition&&(this._stackPosition=n.length-1)):n.push(l))}this._stack=n,this._stackPosition>n.length-1&&(this._stackPosition=n.length-1)}async clear(t=!1){if(this.updating&&!t)throw new F;await wt(()=>!this.updating),this._drainStack()}};s([r()],k.prototype,"_stack",void 0),s([r()],k.prototype,"_stackPosition",void 0),s([r()],k.prototype,"updating",null),s([r({readOnly:!0})],k.prototype,"canUndo",null),s([r({readOnly:!0})],k.prototype,"hasUndo",null),s([r({readOnly:!0})],k.prototype,"canRedo",null),s([r({readOnly:!0})],k.prototype,"hasRedo",null),k=s([$("esri.UndoRedo")],k);let Ui=class{constructor(){this.committedVertices=null,this.cursorVertex=null,this.full=null,this.outline=null,this.cursorEdge=null,this.circle=null,this.rectangle=null}};function H(e,t,i){if(e==null)return"noTool";switch(e){case"point":return Gi();case"multipoint":return"multipoint";case"polyline":return Ri(t,i);case"polygon":return Hi(t,i);case"rectangle":case"circle":return zi(t,i);default:return}}function Gi(e){return"point"}function Ri(e,t){const i=e!=null&&e.type==="polyline"&&e.paths.length?e.paths[0].length:0;return t==="freehand"?i<2?"freehandStart":"freehandEnd":i<2?"polylineZeroVertices":"polylineOneVertex"}function Hi(e,t){const i=e!=null&&e.type==="polygon"&&e.rings.length?e.rings[0].length:0;if(i<3)switch(t){case"freehand":return"freehandStart";case"hybrid":return"polygonZeroVerticesHybrid";default:return"polygonZeroVertices"}else if(i<4)return t==="freehand"?"freehandEnd":"polygonOneVertex";return"polygonTwoVertices"}function zi(e,t){if((e!=null&&e.type==="polygon"&&e.rings.length?e.rings[0].length:0)<3)switch(t){case"freehand":return"freehandStart";case"click":return"shapeStartClick";default:return"shapeStartHybrid"}switch(t){case"freehand":return"freehandEnd";case"click":return"shapeEndClick";default:return"shapeEndHybrid"}}function Ai(e,t){const i=e==null?void 0:e.geometry;if(!e||(i==null?void 0:i.type)!=="mesh"||!t)return;const{renderCoordsHelper:n,elevationProvider:o}=t,{camera:l}=t.state,{extent:p}=i,{center:a,spatialReference:c}=p,u=xt(c),h=dt(c),y=xt(n.spatialReference),_=p.width*u,f=p.height*h,g=(p.zmax??0)*h,w=g-(p.zmin??0)*h,T=Math.max(_,f,w)/y,{x:v,y:x}=a,S=a.z??0;qt(J,v,x,S),n.toRenderCoords(J,c,J);const A=T/l.computeScreenPixelSizeAt(J);if(A>Math.min(l.width,l.height)/l.pixelRatio*Li)return"meshTooClose";if(A<Zi)return"meshTooFar";const ve=xe(e),{absoluteZ:_e}=Oe(v,x,g,c,t,ve);return _e<(o.getElevation(v,x,S,c,"ground")??0)*h+w*Fi?"meshUnderground":"mesh"}const Zi=20,Li=1,Fi=.1,J=we();function Ni(e,t,i,n,o,l){let p="geodesic",a=Te(i);const c=R();return gt(e,t,n,c),c[2]=0,a&&nt(c,i,c,a)||(p="euclidean",a=i),{mode:p,view:t,elevationInfo:n,hasZ:o,directionMode:l,spatialReference:e.spatialReference,measurementSR:a,origin:c}}function ji(e,t,i){if(t==null||e==null)return;const n=ke(i.measurementSR);if(n==null)return;const o=rt(e,i);if(o==null)return;const l=ot(t,n);return new hi(o,l)}function qi(e,t,i,n){if(i==null||e==null)return;const o=rt(e,n);if(o==null)return;const l=G(i),p=10,a=u=>{if(u==null)return;const h=R(),y=Pe(u,"degrees","geographic");return pi(h,o,n.measurementSR,p,y,n.mode)?new mi(o,h):void 0},c=()=>{if(t!=null&&e!=null)return G(ie(t,e))};switch(n.directionMode){case"absolute":return a(l);case"relative":{const u=c();return u==null?void 0:a(u+l)}case"relative-bilateral":{const u=c();return u==null?void 0:oe([a(u+l),a(u-l)])}}}function ae(e,t){const i=at(e,t);return i!=null?new gi(i):void 0}function le(e,t,i){const{context:n,longitude:o,latitude:l,direction:p,distance:a,elevation:c}=i;if(o!=null||l!=null||a!=null||c!=null||p!=null){if(o!=null||l!=null){const u=G(o),h=G(l),y=at(c,n);return new ne(u,h,y)}return Bi(e,t,i)}}function Bi(e,t,{context:i,direction:n,distance:o,elevation:l}){if(t==null)return ae(l,i);const{view:p,elevationInfo:a,measurementSR:c}=i,u=gt(t,p,a);if(!c||!nt(u,t.spatialReference,Rt,c))return;const[h,y]=Rt,_=o!=null?ot(o,"meters"):void 0,f=G(n),g=at(l,i),w=v=>{const x=new yi([h,y],c,_,g,v);return _==null||v==null||g==null&&i.hasZ?x:new fi(x.closestTo(u))};if(f==null)return w(void 0);const T=()=>{if(e!=null&&t!=null)return G(ie(e,t))};switch(i.directionMode){case"absolute":return w(f);case"relative":{const v=T();return v==null?void 0:w(v+f)}case"relative-bilateral":{const v=T();return v==null?void 0:oe([w(v+f),w(v-f)])}}}function Wi(e){return e.context.mode==="geodesic"?le(null,null,e):ce(e)}function Yi(e,t,i){const{context:n,x:o,y:l,distance:p,direction:a,elevation:c}=i;return n.mode==="geodesic"?le(t,e,i):o!=null||l!=null?ce(i):Ki([ji(e,p,n),qi(e,t,a,n),ae(c,n)])}function ce({x:e,y:t,elevation:i,context:n}){Q.x=(e==null?void 0:e.value)??0,Q.y=(t==null?void 0:t.value)??0,Q.spatialReference=n.spatialReference;const o=rt(Q,n,Xi);return new ne(e!=null&&o!=null?o[0]:void 0,t!=null&&o!=null?o[1]:void 0,at(i,n))}function Ki(e){let t;for(const i of e)i&&(t=(t==null?void 0:t.intersect(i))??i);return t}function rt(e,t,i=R()){const{view:n,elevationInfo:o,measurementSR:l,origin:p,mode:a}=t;if(gt(e,n,o,i),nt(i,e.spatialReference,i,l))return a!=="geodesic"&&be(i,i,p),i}function Ji(e,t,i,n){const{view:o,measurementSR:l,spatialReference:p,origin:a,mode:c}=i;if(c==="geodesic"?$e(N,e):et(N,e,a),nt(N,l,N,p))return di(N,o,t,i,n)}function at(e,t){var i;return((i=Qi(e,t))==null?void 0:i.value)??void 0}function Qi(e,{view:t,origin:i,elevationInfo:n,hasZ:o,measurementSR:l}){if(e==null||!o)return;const p=Ve(l);if(p==null)return;const[a,c]=i,u=ot(e,p),h=(t==null?void 0:t.type)==="3d"?Wt(t,a,c,u,l,n):u;return h!=null?Yt(h,p):void 0}const Rt=R(),Xi=R(),N=R(),Q=ht(0,0,0,Bt.WGS84);let P=class extends C{constructor(e){super(e),this.type="draw-circle",this.radius=null,this.xSize=null,this.ySize=null,this.area=W}get allFields(){return[]}};s([r()],P.prototype,"type",void 0),s([r()],P.prototype,"radius",void 0),s([r()],P.prototype,"xSize",void 0),s([r()],P.prototype,"ySize",void 0),s([r()],P.prototype,"area",void 0),s([r()],P.prototype,"helpMessage",void 0),s([r()],P.prototype,"allFields",null),P=s([$("esri.views.interactive.tooltip.infos.DrawCircleTooltipInfo")],P);let j=class extends Y(C){constructor(t){super(t),this.type="draw-mesh",this.orientation=ri({lockable:!1}),this.scale=ai({lockable:!1})}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation,this.orientation,this.scale]}};s([r()],j.prototype,"helpMessage",void 0),s([r()],j.prototype,"allFields",null),j=s([$("esri.views.interactive.tooltip.infos.DrawMeshTooltipInfo")],j);let q=class extends Y(C){constructor(t){super(t),this.type="draw-multipoint"}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};s([r()],q.prototype,"helpMessage",void 0),s([r()],q.prototype,"allFields",null),q=s([$("esri.views.interactive.tooltip.infos.DrawMultipointTooltipInfo")],q);let B=class extends Y(C){constructor(t){super(t),this.type="draw-point"}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};s([r()],B.prototype,"helpMessage",void 0),s([r()],B.prototype,"allFields",null),B=s([$("esri.views.interactive.tooltip.infos.DrawPointTooltipInfo")],B);let D=class extends Y(C){constructor(t){super(t),this.type="draw-polygon",this.direction=te(),this.distance=ee(),this.area=li(),this.xyMode="direction-distance"}get allFields(){return[this.direction,this.distance,this.longitude,this.latitude,this.x,this.y,this.elevation,this.area]}};s([r()],D.prototype,"xyMode",void 0),s([r()],D.prototype,"helpMessage",void 0),s([r()],D.prototype,"allFields",null),D=s([$("esri.views.interactive.tooltip.infos.DrawPolygonTooltipInfo")],D);let E=class extends Y(C){constructor(t){super(t),this.type="draw-polyline",this.direction=te(),this.distance=ee(),this.totalLength=ci(),this.xyMode="direction-distance"}get allFields(){return[this.direction,this.distance,this.longitude,this.latitude,this.x,this.y,this.elevation,this.totalLength]}};s([r()],E.prototype,"helpMessage",void 0),s([r()],E.prototype,"xyMode",void 0),s([r()],E.prototype,"allFields",null),E=s([$("esri.views.interactive.tooltip.infos.DrawPolylineTooltipInfo")],E);let V=class extends C{constructor(e){super(e),this.type="draw-rectangle",this.xSize=M,this.ySize=M,this.area=W}get allFields(){return[]}};s([r()],V.prototype,"type",void 0),s([r()],V.prototype,"xSize",void 0),s([r()],V.prototype,"ySize",void 0),s([r()],V.prototype,"area",void 0),s([r()],V.prototype,"helpMessage",void 0),s([r()],V.prototype,"allFields",null),V=s([$("esri.views.interactive.tooltip.infos.DrawRectangleTooltipInfo")],V);function tn(e,t){return{point:new B({sketchOptions:t,viewType:e}),multipoint:new q({sketchOptions:t,viewType:e}),polyline:new E({sketchOptions:t,viewType:e}),polygon:new D({sketchOptions:t,viewType:e}),mesh:new j({sketchOptions:t,viewType:e}),rectangle:new V({sketchOptions:t}),circle:new P({sketchOptions:t})}}function Ht(e){const{directionOptions:t,geometryType:i,sketchOptions:n,tooltipInfos:o}=e,l=a=>{const c=lt(e).mode,u=o[a].elevation;c==="relative-to-ground"||c==="relative-to-scene"||c==="on-the-ground"?u.lock(vt(e)):u.unlock()},p=a=>{if(t){const c=o[a].direction;c.committed=t.angle,c.unlockOnVertexPlacement=!1,n.values.directionMode=t.mode}};switch(i){case"polygon":case"polyline":l(i),p(i);break;case"point":case"mesh":l(i)}}function en(e,t){const{drawOperation:i,view:n}=t,o=yt(t),l=lt(t);if(n.type==="2d"||!e||l.mode!=="absolute-height"||(i==null?void 0:i.numCommittedVertices)!==1||!o||o.type!=="draw-polyline"&&o.type!=="draw-polygon"||o.elevation.locked)return;const[p,a,c]=e,u=mn(p,a,c,l,t);u!=null&&o.elevation.lock(u)}function zt(e){var t;(t=yt(e))==null||t.allFields.forEach(i=>{i.unlockOnVertexPlacement&&i.unlock()})}function yt({geometryType:e,graphic:t,tooltipInfos:i}){var n;return((n=t==null?void 0:t.geometry)==null?void 0:n.type)!==nn[e]?e==="circle"||e==="rectangle"?i[e]:null:i[e]}const nn={point:"point",multipoint:"multipoint",mesh:"mesh",polyline:"polyline",polygon:"polygon",circle:"polygon",rectangle:"polygon",freehandPolygon:"polygon",freehandPolyline:"polyline",text:"point"};function on(e,t){switch(e==null?void 0:e.type){case"draw-point":sn(e,t);break;case"draw-multipoint":rn(e,t);break;case"draw-polyline":ln(e,t);break;case"draw-polygon":cn(e,t);break;case"draw-rectangle":un(e,t);break;case"draw-circle":dn(e,t);break;case"draw-mesh":an(e,t)}}function sn(e,t){var n;const i=(n=t.graphic)==null?void 0:n.geometry;(i==null?void 0:i.type)==="point"&&(ft(e,i,t),e.helpMessage=H("point",i,t.drawOperation.drawingMode))}function rn(e,t){var n;const i=(n=t.graphic)==null?void 0:n.geometry;(i==null?void 0:i.type)==="multipoint"&&(ft(e,i,t),e.helpMessage=H("multipoint",i,t.drawOperation.drawingMode))}function an(e,t){const{graphic:i,view:n}=t,o=i==null?void 0:i.geometry;n.type!=="3d"||o&&o.type!=="mesh"||(ft(e,o==null?void 0:o.origin,t),o&&Ke(e,o),e.helpMessage=Ai(i,n))}function ft(e,t,i){const{drawOperation:n,view:o,sketchOptions:l}=i,{cursorVertex:p}=n;e.sketchOptions=l,e.viewType=o.type;const a=(t==null?void 0:t.type)==="multipoint"?t.getPoint(t.points.length-1):t;if(e.setLocationFromPoint(a,z(i)),ue(e.elevation,i),!p)return void(n.constraints=void 0);const c=p;n.constraints={context:me(c,i),x:e.x.committed,y:e.y.committed,longitude:e.longitude.committed,latitude:e.latitude.committed,elevation:e.elevation.committed,distance:null,direction:null}}function ln(e,t){const{createOperationGeometry:i,drawOperation:n,automaticLengthMeasurementUtils:o}=t,l=i!=null?i.full:null;l&&l.type!=="polyline"||(pe(e,t),e.totalLength.actual=n.lastVertex?(l?o.autoLength2D(l):null)??M:null,e.helpMessage=H("polyline",l,t.drawOperation.drawingMode))}function cn(e,t){const{createOperationGeometry:i,drawOperation:n}=t,o=i!=null?i.full:null;o&&o.type!=="polygon"||(pe(e,t),e.area.actual=n.lastVertex?(o?t.automaticAreaMeasurementUtils.autoArea2D(o):null)??W:null,e.helpMessage=H("polygon",o,t.drawOperation.drawingMode))}const At=Me(Kt);function pe(e,t){const{drawOperation:i,sketchOptions:n,view:o,automaticLengthMeasurementUtils:l}=t,{cursorVertex:p,lastVertex:a,secondToLastVertex:c}=i,u=n.values.effectiveDirectionMode;e.sketchOptions=n,e.viewType=o.type;const h=a&&p?l.autoDistanceBetweenPoints2D(At(a),At(p))??M:null;if(e.distance.actual=h,e.distance.readOnly=a==null,e.direction.actual=null,e.direction.readOnly=!0,a&&p&&(u==="absolute"||c)){const f=ui(c,a,p,u);e.direction.actual=f??Ce,e.direction.readOnly=!1}e.setLocationFromPoint(p,z(t)),ue(e.elevation,t);const y=pn(a,t);e.xyMode=y,e.direction.visible=y==="direction-distance",e.distance.visible=y==="direction-distance",e.effectiveX.visible=y==="coordinates",e.effectiveY.visible=y==="coordinates";const _=p??a;i.constraints=_?{context:me(_,t),x:e.x.committed,y:e.y.committed,longitude:e.longitude.committed,latitude:e.latitude.committed,elevation:e.elevation.committed,distance:e.distance.committed,direction:e.direction.committed}:void 0}function pn(e,{sketchOptions:t}){const i=t.tooltips.xyMode;return i==="auto"?e?"direction-distance":"coordinates":i}function un(e,t){var i;e.sketchOptions=t.sketchOptions,e.xSize=he(t),e.ySize=ge(t),e.area=de(t),e.helpMessage=H("rectangle",(i=t.graphic)==null?void 0:i.geometry,t.drawOperation.drawingMode)}function dn(e,t){var o;const{forceUniformSize:i,sketchOptions:n}=t;e.sketchOptions=n,e.radius=i?hn(t):null,e.xSize=i?null:he(t),e.ySize=i?null:ge(t),e.area=de(t),e.helpMessage=H("circle",(o=t.graphic)==null?void 0:o.geometry,t.drawOperation.drawingMode)}function ue(e,t){const{drawOperation:i}=t,n=(i==null?void 0:i.cursorVertex)??(i==null?void 0:i.lastVertex);e.actual=_i(n)??vt(t),e.visible=i.hasZ,e.readOnly=!1,e.showAsZ=!0}function de(e){var i;const t=(i=e.createOperationGeometry)==null?void 0:i.full;return(t==null?void 0:t.type)!=="polygon"?W:e.automaticAreaMeasurementUtils.autoArea2D(t)??W}function he({createOperationGeometry:e,automaticLengthMeasurementUtils:t}){var n;const i=(n=e==null?void 0:e.rectangle)==null?void 0:n.midpoints;return(i!=null?t.autoDistanceBetweenPoints2D(i.left,i.right):null)??M}function ge({createOperationGeometry:e,automaticLengthMeasurementUtils:t}){var n;const i=(n=e==null?void 0:e.rectangle)==null?void 0:n.midpoints;return(i!=null?t.autoDistanceBetweenPoints2D(i.top,i.bottom):null)??M}function hn({createOperationGeometry:e,automaticLengthMeasurementUtils:t}){var i;return(((i=e==null?void 0:e.circle)==null?void 0:i.center)!=null&&e.circle.edge!=null?t.autoDistanceBetweenPoints2D(e.circle.center,e.circle.edge):null)??M}function gn(e){const{geometryType:t,tooltipInfos:i}=e;switch(t){case"point":case"multipoint":case"mesh":case"polyline":case"polygon":{const n=i[t].elevation.committed;return n?ot(n,"meters")/dt(z(e)):void 0}default:return}}function mn(e,t,i,n,o){const{view:l,drawOperation:p}=o;if(l.type!=="3d"||!p)return;i??(i=0);const a=z(o),c=lt(o),u=Wt(l,e,t,i,a,c,n);return vi(u,a)??vt(o)}function lt(e){return e.drawOperation.elevationInfo??Se}function z(e){return e.drawOperation.coordinateHelper.spatialReference}function vt(e){const t=dt(z(e));return Yt(e.defaultZ*t,"meters")}function me(e,t){return Ni(e,t.view,z(t),lt(t),t.drawOperation.coordinateHelper.hasZ(),t.sketchOptions.values.effectiveDirectionMode)}let m=class extends Oi{constructor(t){super(t),this._graphic=null,this._coordinateFormatterLoadTask=null,this._createOperationGeometry=null,this.defaultZ=0,this.directionOptions=null,this.elevationLockOnVertexAddDisabled=!1,this.geometryType=null,this.hasZ=!0,this.geometryToPlace=null,this.snappingManager=null,this.snapToScene=!1,this.sketchOptions=new se}initialize(){const{view:t}=this;this.internalGraphicsLayer=new Ie({listMode:"hide",internal:!0,title:"DrawGraphicTool layer"}),this.view.map.layers.add(this.internalGraphicsLayer);const i=this.drawOperation=this.makeDrawOperation();this.tooltipInfos=tn(t.type,this.sketchOptions);const n=Je(()=>({view:t,options:this.sketchOptions.tooltips}));this.tooltip=n,Ht(this._tooltipsContext),this._coordinateFormatterLoadTask=De(()=>Qe()),this.addHandles([i.on("vertex-add",o=>this.onVertexAdd(o)),i.on("vertex-remove",o=>this.onVertexRemove(o)),i.on("vertex-update",o=>this.onVertexUpdate(o)),i.on("cursor-update",o=>this.onCursorUpdate(o)),i.on("cursor-remove",()=>this._updateGraphic()),i.on("complete",o=>this.onComplete(o)),this._coordinateFormatterLoadTask,n.on("paste",o=>Xe(o,this.activeTooltipInfo)),I(()=>this.cursor,o=>{i.cursor=o},X),Ot(()=>{const{activeTooltipInfo:o,sketchOptions:l}=this;on(o,this._tooltipsContext),n.info=l.tooltips.effectiveEnabled?o:null}),Ot(()=>{i.constraintZ=gn(this._tooltipsContext)},Ee)]),this.finishToolCreation(),i.initializePointer()}destroy(){this.drawOperation=U(this.drawOperation),this.tooltip=U(this.tooltip),this._destroyAllVisualizations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=U(this.internalGraphicsLayer),this._set("view",null)}get _drawSpatialReference(){return this.drawOperation.coordinateHelper.spatialReference}get _tooltipsContext(){const{defaultZ:t,directionOptions:i,drawOperation:n,forceUniformSize:o,geometryType:l,graphic:p,sketchOptions:a,tooltipInfos:c,view:u,automaticAreaMeasurementUtils:h,automaticLengthMeasurementUtils:y}=this;return{createOperationGeometry:this._createOperationGeometry,defaultZ:t,directionOptions:i,drawOperation:n,forceUniformSize:o,geometryType:l,graphic:p,sketchOptions:a,tooltipInfos:c,view:u,automaticAreaMeasurementUtils:h,automaticLengthMeasurementUtils:y}}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(t){this._set("centered",t),this._updateGraphic()}get cursor(){return this._get("cursor")}set cursor(t){this._set("cursor",t)}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}set forceUniformSize(t){this._set("forceUniformSize",t),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(t){this._set("graphicSymbol",t),this._graphic!=null&&(this._graphic.symbol=t)}set mode(t){const i=this.drawOperation;i&&(i.drawingMode=t),this._set("mode",t)}get updating(){var t;return((t=this.drawOperation)==null?void 0:t.updating)??!1}get undoRedo(){const{view:{type:t,map:i}}=this;return t==="2d"&&i&&"undoRedo"in i&&i.undoRedo instanceof k?i.undoRedo:null}set undoRedo(t){this._override("undoRedo",t)}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(t){this.destroyed||ti(t,this.tooltip)||this.drawOperation.onInputEvent(t)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo(),this.drawOperation.numCommittedVertices===0&&Ht(this._tooltipsContext)}_destroyAllVisualizations(){this.removeHandles(b.outline),this.removeHandles(b.regularVertices),this.removeHandles(b.activeVertex),this.removeHandles(b.activeEdge),this.removeHandles(ut)}_createOrUpdateGraphic(t){if(this._graphic!=null)return this.updateGraphicGeometry(t),this._graphic;const i=new Ue({...this.graphicProperties,symbol:this.graphicSymbol});return this._graphic=i,this.updateGraphicGeometry(t),this.internalGraphicsLayer.add(i),this.addHandles(this.initializeGraphic(i)),this.notifyChange("graphic"),this.addHandles(K(()=>{this.internalGraphicsLayer.remove(i),this._graphic===i&&(this._graphic=null)}),ut),i}updateGraphicGeometry(t){this._graphic.geometry=t}_getCreateOperationGeometry(t={operationComplete:!1}){var T,v;if(this.drawOperation==null)return;const{coordinateHelper:i,view:n,visualizationCursorVertex:o,lastVertex:l,committedVertices:p,geometryIncludingUncommittedVertices:a,numCommittedVertices:c}=this.drawOperation;if(!(c>0||o!=null))return;const u=t.operationComplete?p:a,h=u.length,y=o!=null?i.pointToArray(o):null,_=this._drawSpatialReference,f=n.type==="3d"&&n.viewingMode==="global",g=new Ui;g.committedVertices=p,g.cursorVertex=y;const{geometryType:w}=this;switch(w){case"point":case"mesh":g.full=i.arrayToPoint(u[0]);break;case"multipoint":g.full=h>0?si(u,_):null;break;case"polyline":case"polygon":h>0&&(g.full=w==="polygon"?oi([u],_,f,!0):Et([u],_,f),g.cursorEdge=y!=null&&l&&!tt(o,l)?Et([[y,i.pointToArray(l)]],_,f):null,g.outline=h>1?g.full:null);break;case"circle":case"rectangle":{if(g.committedVertices=g.cursorVertex=null,!h)break;const x=ei(n,u[0]),S=u[0],A=x.makeMapPoint(S[0]+yn*n.resolution,S[1]);w==="circle"?h===1&&t.operationComplete?g.circle=It([S,A],x,!0):h===2&&(this.forceUniformSize?g.circle=It(u,x,this.centered):g.rectangle=ii(u,x,this.centered)):h===1&&t.operationComplete?g.rectangle=Dt([S,A],x,!0):h===2&&(g.rectangle=this.forceUniformSize?Dt(u,x,this.centered):ni(u,x,this.centered)),g.full=g.circle!=null?g.circle.geometry:(T=g.rectangle)==null?void 0:T.geometry,g.outline=((v=g.full)==null?void 0:v.type)==="polygon"?g.full:null;break}default:return null}return g}initializeGraphic(t){return K()}onComplete(t){if(!this.drawOperation)return;this._updateGraphic();let i=null;if(this.drawOperation.isCompleted){const n=this._getCreateOperationGeometry({operationComplete:!0});n!=null&&(i=this._createOrUpdateGraphic(n.full))}this._createOperationGeometry=null,this.emit("complete",{graphic:i,...t})}onCursorUpdate(t){this._updateGraphic(),this.emit("cursor-update",t)}onDeactivate(){const{drawOperation:t}=this;t&&(t.isCompleted||t.cancel())}onOutlineChanged(t){return K()}onCursorEdgeChanged(t){return K()}onVertexAdd(t){var i;zt(this._tooltipsContext),this._updateGraphic(),this.elevationLockOnVertexAddDisabled||en((i=t.vertices.at(0))==null?void 0:i.coordinates,this._tooltipsContext),this.emit("vertex-add",t)}onVertexRemove(t){zt(this._tooltipsContext),this._updateGraphic(),this.emit("vertex-remove",t)}onVertexUpdate(t){this._updateGraphic(),this.emit("vertex-update",t)}_updateGraphic(){const t=this._getCreateOperationGeometry();this._createOperationGeometry=t,t!=null?(t.cursorEdge!=null?this.addHandles(this.onCursorEdgeChanged(t.cursorEdge),b.activeEdge):this.removeHandles(b.activeEdge),t.outline!=null?this.addHandles(this.onOutlineChanged(t.outline),b.outline):this.removeHandles(b.outline),t.committedVertices!=null?this.addHandles(this.onRegularVerticesChanged(t.committedVertices),b.regularVertices):this.removeHandles(b.regularVertices),t.cursorVertex!=null?this.addHandles(this.onActiveVertexChanged(t.cursorVertex),b.activeVertex):this.removeHandles(b.activeVertex),t.full!=null?this._createOrUpdateGraphic(t.full):this.removeHandles(ut)):this._destroyAllVisualizations()}get activeTooltipInfo(){var t;return(t=this._coordinateFormatterLoadTask)!=null&&t.finished?yt(this._tooltipsContext):null}};s([r()],m.prototype,"_coordinateFormatterLoadTask",void 0),s([r()],m.prototype,"_createOperationGeometry",void 0),s([r()],m.prototype,"_tooltipsContext",null),s([r({value:!0})],m.prototype,"centered",null),s([r()],m.prototype,"cursor",null),s([r({nonNullable:!0})],m.prototype,"defaultZ",void 0),s([r({constructOnly:!0})],m.prototype,"directionOptions",void 0),s([r()],m.prototype,"drawOperation",void 0),s([r()],m.prototype,"elevationLockOnVertexAddDisabled",void 0),s([r({value:!0})],m.prototype,"enabled",null),s([r({value:!0})],m.prototype,"forceUniformSize",null),s([r({constructOnly:!0})],m.prototype,"geometryType",void 0),s([r()],m.prototype,"graphic",null),s([r({constructOnly:!0})],m.prototype,"graphicProperties",void 0),s([r()],m.prototype,"graphicSymbol",null),s([r({constructOnly:!0})],m.prototype,"hasZ",void 0),s([r({constructOnly:!0})],m.prototype,"geometryToPlace",void 0),s([r()],m.prototype,"mode",null),s([r()],m.prototype,"snappingManager",void 0),s([r()],m.prototype,"snapToScene",void 0),s([r()],m.prototype,"tooltip",void 0),s([r()],m.prototype,"tooltipInfos",void 0),s([r({constructOnly:!0,type:se})],m.prototype,"sketchOptions",void 0),s([r()],m.prototype,"updating",null),s([r({constructOnly:!0,nonNullable:!0})],m.prototype,"view",void 0),s([r({constructOnly:!0})],m.prototype,"automaticAreaMeasurementUtils",void 0),s([r({constructOnly:!0})],m.prototype,"automaticLengthMeasurementUtils",void 0),s([r({constructOnly:!0})],m.prototype,"undoRedo",null),s([r()],m.prototype,"activeTooltipInfo",null),m=s([$("esri.views.draw.DrawGraphicTool")],m);const ut=Symbol("create-operation-graphic"),b={outline:Symbol("outline-visual"),regularVertices:Symbol("regular-vertices-visual"),activeVertex:Symbol("active-vertex-visual"),activeEdge:Symbol("active-edge-visual")};function jn(e){switch(e){case"point":case"polyline":case"polygon":case"multipoint":return e;case"circle":case"rectangle":return"segment";case"mesh":return"point"}}const yn=48,ye="click";let O=class extends Nt{constructor(e){super(e),this.events=new Ge,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0}intersectionDistance(e,t){return 0}attach(){}detach(){}onElevationChange(){}onViewChange(){}};s([r()],O.prototype,"interactive",void 0),s([r()],O.prototype,"selectable",void 0),s([r()],O.prototype,"cursor",void 0),s([r()],O.prototype,"grabbing",void 0),s([r()],O.prototype,"grabbable",void 0),s([r()],O.prototype,"consumesClicks",void 0),s([r()],O.prototype,"grabbableForEvent",void 0),s([r()],O.prototype,"dragging",void 0),s([r()],O.prototype,"hovering",void 0),s([r()],O.prototype,"selected",void 0),O=s([$("esri.views.draw.LegacyDrawManipulator")],O);const fn="crosshair",vn="progress",Zt=Symbol(),Lt=Symbol();let d=class extends Re{constructor(e){super(e),this._createOperationCompleted=!1,this._hideDefaultCursor=!1,this._pointerDownStates=new He,this._stagedScreenPoint=null,this._stagedPointerType=null,this._updatingHandles=new jt,this._stagedPointerId=null,this.constraintsEnabled=!1,this.constraints=void 0,this._getPointConstraint=bt(Wi),this._getPolylineOrPolygonConstraint=bt(Yi),this.constraintZ=null,this.defaultZ=null,this.isDraped=!0,this.labelOptions=new re,this.cursor=null,this.loading=!1,this.snapToSceneEnabled=null,this.firstVertex=null,this.lastVertex=null,this.secondToLastVertex=null,e.elevationInfo==null&&(this.elevationInfo=ze(!!e.hasZ))}initializePointer(){var t;const e=(t=this.view.inputManager)==null?void 0:t.latestPointerInfo;e!=null&&this._updatePointer(e.location,e.id,e.type)}initialize(){const{geometryType:e,view:t}=this,i=t.spatialReference,n="viewingMode"in t.state?t.state.viewingMode:2,o=e==="segment"||e==="multipoint"?"polyline":e;this.coordinateHelper=$i(this.hasZ,this.hasM,i),this._editGeometryOperations=new Ti(new ki(o,this.coordinateHelper),n),this._snappingOperation=new Di({view:t}),this.addHandles([I(()=>({stagedPoint:this._snappingOperation.stagedPoint,constraint:this._constraint}),({stagedPoint:a,constraint:c},u)=>{const{snappingOptions:h}=this;if(h&&(h.forceDisabled=c!=null&&wi(c)),u!=null&&a===u.stagedPoint&&c!==u.constraint)return this._onKeyboardBasedChange();this._processCursor(a??this._screenToMap(this._stagedScreenPoint))},{equals:(a,c)=>a.stagedPoint===c.stagedPoint&&Ae(a.constraint,c.constraint)}),I(()=>this.view.viewpoint,(a,c)=>{a&&c&&Ze(a,c)&&this._onKeyboardBasedChange()})]),this._activePart=new Pi(i,n),this._editGeometryOperations.data.parts.push(this._activePart);const l=this.segmentLabels;l!=null&&(l.context={view:t,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions,automaticLengthMeasurementUtils:this.automaticLengthMeasurementUtils},this.addHandles(I(()=>this.labelOptions.enabled,a=>{l.visible=a},X))),this.addHandles(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],a=>{var f,g,w,T;const c=a.vertices.map(v=>({componentIndex:0,vertexIndex:v.index,coordinates:this.coordinateHelper.vectorToArray(v.pos)})),u=c.map(v=>v.coordinates),h=this.coordinateHelper.vectorToDehydratedPoint((f=this._activePart.getFirstVertex())==null?void 0:f.pos)??null;tt(h,this.firstVertex)||(this.firstVertex=h);const y=this.coordinateHelper.vectorToDehydratedPoint((g=this._activePart.getLastVertex())==null?void 0:g.pos)??null;tt(y,this.lastVertex)||(this.lastVertex=y);const _=this.coordinateHelper.vectorToDehydratedPoint((T=(w=this._activePart.segments.at(-1))==null?void 0:w.leftVertex)==null?void 0:T.pos)??null;switch(tt(_,this.secondToLastVertex)||(this.secondToLastVertex=_),this._processCursor(this.cursorVertex),a.type){case"vertex-add":this.emit(a.type,{...a,added:u,vertices:c});break;case"vertex-update":this.emit(a.type,{...a,updated:u,vertices:c});break;case"vertex-remove":this.emit(a.type,{...a,removed:u,vertices:c})}}));const p=this._manipulator=new O({consumesClicks:!1,grabbableForEvent:a=>this.drawingMode!=="click"||a.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1});this.manipulators.add(p),p.grabbable=e!=="point"&&e!=="multipoint",this.addHandles([p.events.on("immediate-click",a=>this._onImmediateClick(a)),p.events.on("immediate-double-click",a=>this._onImmediateDoubleClick(a)),I(()=>this.drawingMode,()=>{this.removeHandles(Zt),this.addHandles(this._createManipulatorDragPipeline(p),Zt)},X),I(()=>({effectiveCursor:this.effectiveCursor}),({effectiveCursor:a})=>{p.cursor=a},X)]),xi(this,()=>{var u;const a=((u=this.view.inputManager.latestPointerInfo)==null?void 0:u.type)??"mouse",c=this._getSnappingContext(a);if(this.snappingManager!=null){const h=this._snappingOperation.snapAgainNearPreviousMapPoint(this.snappingManager,c);this._updatingHandles.addPromise($t(h))}})}destroy(){U(this.segmentLabels),U(this._snappingOperation),this._editGeometryOperations=U(this._editGeometryOperations),this._updatingHandles.destroy()}get _isDragging(){const{_stagedPointerId:e,_manipulator:t}=this;return e!=null&&this._pointerDownStates.has(e)||t.grabbing||!t.interactive}get _snappingEnabled(){return this.snappingManager!=null&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const e=this._updateAndGetEffectiveDrawSurface();return this.view.type==="3d"&&this.drawSurface!==e}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activePart.vertices.map(e=>this.coordinateHelper.vectorToArray(e.pos))}get _constraint(){const{constraints:e,constraintsEnabled:t}=this;if(e&&t)switch(this.geometryType){case"point":case"multipoint":return this._getPointConstraint(e);case"polygon":case"polyline":return this._getPolylineOrPolygonConstraint(this.lastVertex,this.secondToLastVertex,e)}}set drawingMode(e){this._set("drawingMode",e??ye)}get effectiveCursor(){return this.loading?vn:this._hideDefaultCursor?null:this.cursor||fn}get interactive(){return this._manipulator.interactive}set interactive(e){this._manipulator.interactive=e}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activePart.vertices.length}get snappingOptions(){return this.snappingManager!=null?this.snappingManager.options:null}get cursorVertex(){return this._get("cursorVertex")}get visualizationCursorVertex(){return this._stagedPointerType==="mouse"?this.cursorVertex:null}get committableVertex(){const{cursorVertex:e,lastVertex:t,firstVertex:i,geometryType:n}=this;return n==="polygon"&&ct(e,i)||ct(e,t)?null:e}get updating(){return this._updatingHandles.updating}get geometryIncludingUncommittedVertices(){const{committedVertices:e,committableVertex:t,coordinateHelper:i}=this,n=e.slice();return t!=null&&n.push(i.pointToArray(t)),n}cancel(){this.complete({aborted:!0})}commitStagedVertex(){this._snappingOperation.abort();const{committableVertex:e}=this;e!=null&&this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(e),this._activePart)}complete(e){var l;const t=(e==null?void 0:e.aborted)||!1;this._snappingOperation.abort(),(l=this.snappingManager)==null||l.doneSnapping();const{geometryType:i,numCommittedVertices:n}=this,o=i==="multipoint"&&n===0||i==="polyline"&&n<2||i==="polygon"&&n<3;i!=="segment"&&i!=="point"||this.commitStagedVertex(),this._createOperationCompleted=!o,(this.isCompleted||t)&&(this._stagedScreenPoint=null,this._stagedPointerId=null,this._stagedPointerType=null,this._processCursor(null),this.emit("complete",{vertices:this.committedVertices.map((p,a)=>({componentIndex:0,vertexIndex:a,coordinates:p})),aborted:t,type:"complete"}))}onInputEvent(e){switch(e.type){case"pointer-down":this._pointerDownStates.add(e.pointerId);break;case"pointer-up":this._pointerDownStates.delete(e.pointerId)}switch(e.type){case"pointer-move":return this._onPointerMove(e);case"hold":return this._onHold(e)}}redo(){this._editGeometryOperations.redo()}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_processCursor(e){var p,a;const t=Tt(this.cursorVertex),i=Tt(e),n=i&&(((p=this._updateAndGetEffectiveDrawSurface())==null?void 0:p.constrainZ(i))??i),o=this._snapToClosingVertex(n),l=this._applyConstraints(o);ct(t,l)||(this._set("cursorVertex",l),(a=this.segmentLabels)==null||a.set("stagedVertex",l!=null?this.coordinateHelper.pointToVector(l):null),l==null||this._stagedPointerType!=="mouse"?this.emit("cursor-remove"):this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activePart.vertices.length,coordinates:this.coordinateHelper.pointToArray(l)}],operation:"apply",type:"vertex-update"}))}_snapToClosingVertex(e){if(e==null||this._isDragging||this.geometryType!=="polygon"||this.numCommittedVertices<=2)return e;const t=this._mapToScreen(e);if(!t)return e;const i=this._activePart;return this._vertexWithinPointerDistance(i.vertices[0].pos,t)?this.firstVertex:this._vertexWithinPointerDistance(i.vertices.at(-1).pos,t)?this.lastVertex:e}_createManipulatorDragPipeline(e){switch(this.drawingMode){case"click":return this._createManipulatorDragPipelineClick(e);case"freehand":return this._createManipulatorDragPipelineFreehand(e);case"hybrid":return this._createManipulatorDragPipelineHybrid(e)}}_createManipulatorDragPipelineClick(e){return pt(e,(t,i,n,o)=>{const l=o==="touch"&&this._snappingEnabled;if(this.isCompleted||!l)return;const{snappingStep:p,cancelSnapping:a}=Ii({predicate:()=>l,snappingManager:this.snappingManager,snappingContext:new Ut({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,feature:this.graphic,pointer:o,visualizer:this.snappingVisualizer,drawConstraints:this.constraints}),updatingHandles:this._updatingHandles,useZ:!this._requiresScenePoint});n=n.next(c=>(l&&this.snappingManager!=null&&this.snappingManager.doneSnapping(),c)).next(a),i.next(this._screenToMapDragEventStep()).next(c=>(c.action==="start"&&(this._processCursor(c.mapStart),(this.geometryType==="segment"||l&&!this.numCommittedVertices)&&this.commitStagedVertex()),c)).next(bi(this.view,this.elevationInfo)).next(...p).next(c=>(l&&(this._processCursor(c.mapEnd),c.action==="end"&&this.commitStagedVertex()),c)).next(c=>(c.action==="end"&&(this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),c))})}_createManipulatorDragPipelineFreehand(e){return pt(e,(t,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(n=>(n.action==="start"&&(this._snappingOperation.abort(),this.committableVertex==null&&this._processCursor(n.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),n)).next(n=>{switch(n.action){case"start":case"update":this._processCursor(n.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return n})})}_createManipulatorDragPipelineHybrid(e){return pt(e,(t,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(n=>(n.action==="start"&&(this._snappingOperation.abort(),this.addHandles(this._editGeometryOperations.createUndoGroup(),Lt),this._processCursor(n.mapStart),this.commitStagedVertex()),n)).next(n=>{switch(n.action){case"start":case"update":this._processCursor(n.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.removeHandles(Lt),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return n})})}get _drawAtFixedElevation(){const{constraintsEnabled:e,constraintZ:t,geometryType:i,numCommittedVertices:n}=this;return e?t!=null||i==="segment"&&n>0:(i==="segment"||i==="polygon")&&n>0}_updateAndGetEffectiveDrawSurface(){var c;const{constraintsEnabled:e,coordinateHelper:t,drawSurface:i,elevationDrawSurface:n,snapToSceneEnabled:o}=this;if(n==null)return i;if(!this.hasZ)return n.defaultZ=null,n;const l=(c=this.elevationInfo)==null?void 0:c.mode;let p=this.defaultZ,a=e||l==="absolute-height";return o!=null&&(a=o),l==="on-the-ground"&&(a=!1),this._drawAtFixedElevation&&(p=(e?this.constraintZ:null)??t.getZ(this._activePart.vertices[0].pos),a=!1),a?i:(n.defaultZ=p,n)}_mapToScreen(e){var t;return(t=this._updateAndGetEffectiveDrawSurface())==null?void 0:t.mapToScreen(e)}_onHold(e){this._snappingOperation.abort(),this.drawingMode==="click"&&e.pointerType==="touch"&&this._snappingEnabled&&this._processCursor(e.mapPoint),e.stopPropagation()}_onImmediateClick(e){if(!(e.pointerType==="mouse"&&e.button===2||this._manipulator.dragging))try{const{drawingMode:t,geometryType:i}=this;this._stagedPointerType=e.pointerType,this._stagedScreenPoint=e.screenPoint;const n=this._screenToMap(e.screenPoint);if(n==null||n==null||t==="freehand"&&i!=="point"&&i!=="multipoint")return;if(this._snappingEnabled&&this.cursorVertex!=null||this._processCursor(n),this.committableVertex==null)return void this.complete();this.commitStagedVertex(),e.pointerType!=="mouse"&&this._processCursor(null),(t==="freehand"&&this.geometryType!=="multipoint"||i==="point"||i==="segment"&&this.numCommittedVertices===2||i==="segment"&&t==="hybrid"&&this.numCommittedVertices===1)&&this.complete()}finally{e.stopPropagation()}}_onImmediateDoubleClick(e){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),e.stopPropagation())}_onPointerMove(e){const t=Jt(e.x,e.y);this._updatePointer(t,e.pointerId,e.pointerType)&&e.stopPropagation()}_updatePointer(e,t,i){return this._stagedScreenPoint=e,this._stagedPointerType=i,this._stagedPointerId=t,this._isDragging?(this._snappingOperation.abort(),!1):(this._processCursorMovementRelativeToSurface(e,i),!0)}_onKeyboardBasedChange(){this._stagedPointerType==="mouse"&&this._stagedScreenPoint&&this._stagedPointerId!=null&&!this._isDragging?this._processCursorMovementRelativeToSurface(this._stagedScreenPoint,this._stagedPointerType):this._snappingOperation.abort()}_processCursorMovementRelativeToSurface(e,t){var a;const i=this._snappingOperation,n=this._screenToMap(e),o=this._requiresScenePoint?(a=this.drawSurface)==null?void 0:a.screenToMap(e):null;if(n==null)return this._hideDefaultCursor=!0,this._processCursor(null),void i.abort();this._hideDefaultCursor=!1;const l=this.snappingManager;if(l==null)return this._processCursor(n),void i.abort();const p=this._getSnappingContext(t);this._updatingHandles.addPromise($t(i.snap({point:n,scenePoint:o},l,p)))}_applyConstraints(e){const{_constraint:t,constraints:i}=this;if(!e||!i||!t)return e;const{context:n}=i,o=rt(e,n),l=o?t.closestTo(o):void 0;if(!l)return e;const p=Ji(l,e,n),a=this.view.type==="2d"||n.elevationInfo.mode!=="absolute-height";return p!=null&&a&&this.constraintZ!=null&&this.hasZ&&(p.z=this.constraintZ),p}_screenToMap(e){var t;return e?(t=this._updateAndGetEffectiveDrawSurface())==null?void 0:t.screenToMap(e):null}_screenToMapDragEventStep(){let e=null;return t=>{if(t.action==="start"&&(e=this._screenToMap(t.screenStart)),e==null)return null;const i=this._screenToMap(t.screenEnd);return i!=null?{...t,mapStart:e,mapEnd:i}:null}}_vertexWithinPointerDistance(e,t){const n=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(e));return n!=null&&_n(n,t,25)}_getSnappingContext(e){var i;const t=this._drawAtFixedElevation?(i=this.elevationDrawSurface)==null?void 0:i.defaultZ:null;return new Ut({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:e,feature:this.graphic,visualizer:this.snappingVisualizer,selfSnappingZ:t!=null?{value:t,elevationInfo:this.elevationInfo}:null,drawConstraints:this.constraints})}};function _n(e,t,i){const n=e.x-t.x,o=e.y-t.y;return n*n+o*o<=i}s([r()],d.prototype,"_hideDefaultCursor",void 0),s([r()],d.prototype,"_stagedPointerId",void 0),s([r()],d.prototype,"_isDragging",null),s([r()],d.prototype,"_snappingOperation",void 0),s([r()],d.prototype,"_snappingEnabled",null),s([r({constructOnly:!0})],d.prototype,"graphic",void 0),s([r()],d.prototype,"constraintsEnabled",void 0),s([r()],d.prototype,"constraints",void 0),s([r()],d.prototype,"_constraint",null),s([r()],d.prototype,"constraintZ",void 0),s([r()],d.prototype,"defaultZ",void 0),s([r()],d.prototype,"isDraped",void 0),s([r({constructOnly:!0})],d.prototype,"automaticLengthMeasurementUtils",void 0),s([r({value:ye})],d.prototype,"drawingMode",null),s([r({constructOnly:!0})],d.prototype,"elevationDrawSurface",void 0),s([r({constructOnly:!0})],d.prototype,"elevationInfo",void 0),s([r({constructOnly:!0,type:re})],d.prototype,"labelOptions",void 0),s([r({constructOnly:!0})],d.prototype,"geometryType",void 0),s([r({constructOnly:!0})],d.prototype,"hasM",void 0),s([r({constructOnly:!0})],d.prototype,"hasZ",void 0),s([r()],d.prototype,"cursor",void 0),s([r()],d.prototype,"effectiveCursor",null),s([r()],d.prototype,"loading",void 0),s([r({constructOnly:!0})],d.prototype,"manipulators",void 0),s([r({constructOnly:!0})],d.prototype,"drawSurface",void 0),s([r({constructOnly:!0})],d.prototype,"segmentLabels",void 0),s([r({constructOnly:!0})],d.prototype,"snappingManager",void 0),s([r({constructOnly:!0})],d.prototype,"snappingVisualizer",void 0),s([r()],d.prototype,"snapToSceneEnabled",void 0),s([r({readOnly:!0})],d.prototype,"cursorVertex",null),s([r({readOnly:!0})],d.prototype,"visualizationCursorVertex",null),s([r()],d.prototype,"committableVertex",null),s([r()],d.prototype,"firstVertex",void 0),s([r()],d.prototype,"lastVertex",void 0),s([r()],d.prototype,"secondToLastVertex",void 0),s([r()],d.prototype,"updating",null),s([r({constructOnly:!0})],d.prototype,"view",void 0),d=s([$("esri.views.draw.DrawOperation")],d);class qn{constructor(t,i,n,o=null){this._elevationInfo=t,this.defaultZ=i,this._view=n,this._excludeGraphics=o}screenToMap(t){const{defaultZ:i,_view:n}=this,o=n.sceneIntersectionHelper.intersectElevationFromScreen(Le(t.x,t.y),this._elevationInfo,i??0,this._excludeGraphics);return i==null&&o!=null&&(o.z=void 0),o}mapToScreen(t){const i=ht(t.x,t.y,Xt(this._view,t,this._elevationInfo),t.spatialReference);return this._view.toScreen(i)}constrainZ(t){const{defaultZ:i}=this;return i!=null&&t.z!==i&&((t=Qt(t)).z=i),t}}class Bn{constructor(t,i,n=[]){this.view=t,this.elevationInfo=i,this.exclude=n}screenToMap(t){const i=this.view.toMap(t,{exclude:this.exclude,excludeLabels:!0});return i!=null&&(i.z=Fe(i,this.view,this.elevationInfo)),i}mapToScreen(t){let i=t;return this.elevationInfo!=null&&(i=ht(t.x,t.y,Xt(this.view,t,this.elevationInfo),t.spatialReference)),this.view.toScreen(i)}constrainZ(t){return t}}let Wn=class{constructor(t,i=!1,n=0){this.view=t,this.hasZ=i,this.defaultZ=n,this.mapToScreen=o=>t.toScreen(o),this.screenToMap=i?o=>{const l=t.toMap(o);return l.z=n,l}:o=>t.toMap(o)}constrainZ(t){const{defaultZ:i}=this;return this.hasZ&&t.z!==i&&((t=Qt(t)).z=i),t}};const it=class it{screenToMap(t){const{x:i,y:n}=t;return new Kt({x:i,y:n,spatialReference:it.spatialReference})}mapToScreen(t){return Jt(t.x,t.y)}constrainZ(t){return t}};it.spatialReference=new Bt;let Ft=it;function Kn(e,t){return fe(e,t,!1)}function Jn(e,t){return fe(e,t,!0)}function fe(e,t,i){if(e instanceof Vi){if(e.operation instanceof Si)return wn(e.operation,t,i),!0;if(e.operation instanceof Mi)return xn(e.operation,t,i),!0;if(e.operation instanceof Ci)return On(e.operation,t,i),!0}return!1}function wn(e,t,i=!1){const n=i?-1:1,o=Ye(n*e.dx,n*e.dy,n*e.dz);et(t.origin,t.origin,o),st(t)}function xn(e,t,i=!1){const n=i?-e.angle:e.angle;Vt(t.basis1,t.basis1,St,n),Vt(t.basis2,t.basis2,St,n),st(t)}function On(e,t,i=!1){const n=i?1/e.factor1:e.factor1,o=i?1/e.factor2:e.factor2;Mt(t.basis1,t.basis1,n),Mt(t.basis2,t.basis2,o),Ct(t.origin,t.origin,e.origin,e.axis1,n),Ct(t.origin,t.origin,e.origin,e.axis2,o),st(t)}function Qn(e,t,i,n,o=!1){n||(n=Ne());const l=Z(L.get(),e[1],-e[0]),p=Z(L.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),a=Z(L.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),c=L.get(),u=t.allVerticesUnordered;u.forEach(({pos:f})=>{Z(c,kt(e,f),kt(l,f)),je(p,p,c),qe(a,a,c)});const h=1e-6,y=Z(L.get(),a[0]-p[0]<h?i/2:0,a[1]-p[1]<h?i/2:0);Be(p,p,y),We(a,a,y);const _=o?u.reduce((f,g)=>f+(g.pos[2]??0),0)/u.length:0;return Pt(n.basis1,e,(a[0]-p[0])/2),Pt(n.basis2,l,(a[1]-p[1])/2),qt(n.origin,p[0]*e[0]+p[1]*l[0],p[0]*e[1]+p[1]*l[1],_),et(n.origin,n.origin,n.basis1),et(n.origin,n.origin,n.basis2),st(n),n}export{m as A,jn as M,Qn as S,Jn as T,Kn as V,d as a,qn as c,Wn as h,Bn as l};
