import{eQ as U,hn as z,lz as B,b$ as D,bJ as b,H as Q,b as w,K as H,lA as Z,dF as j,ec as N,fP as K,lB as V,fn as X,hs as Y,lC as ee,lD as F,lE as te,b_ as G,f6 as L,bI as ne,e_ as P,fd as M,lF as W,eH as re,i_ as oe,fe as ae,lG as se}from"./ShadowCastClear.glsl.js";import{n as ie}from"./featurePopupQueryUtils.js";import{S as le,v as ce}from"./I3SBinaryReader.js";function ue(e,t,n,r,o){const a=n==="east-north-up"?U(e):fe(e,t,r),i=z();return B(r,a,i,o),i}const J=1,q=5-J;function fe(e,t,n){const r=b(),o=e[3],a=2**(Math.ceil(Math.log(o)*Math.LOG2E/q)*q+J);if(n.isGeographic){const l=a/D(n).radius*180/Math.PI,f=Math.round(e[1]/l),m=Math.max(-90,Math.min(90,f*l)),u=l/Math.cos((Math.abs(m)-l/2)/180*Math.PI),p=Math.round(e[0]/u)*u;r[0]=p,r[1]=m}else{const l=Math.round(e[0]/a),f=Math.round(e[1]/a);r[0]=l*a,r[1]=f*a}const i=e[2]+t,c=Math.round(i/a);return r[2]=c*a,r}function _(e){return e?parseInt(e.slice(e.lastIndexOf("/")+1),10):void 0}function Ge(e){var t;if(j("disable-feature:i3s-draco")||!e)return!1;for(const n of e)for(const r of n.geometryBuffers)if(((t=r.compressedAttributes)==null?void 0:t.encoding)==="draco")return!0;return!1}function Ke(e,t,n,r){n.traverse(t,o=>{const a=o.serviceMbsInIndexSR;return(a!=null&&de(e,a))!==0&&(r(o),!0)})}function Fe(e,t,n){let r=0,o=0;for(let a=0;a<t.length&&r<e.length;a++)e[r]===t[a]&&(n(a)&&(e[o]=e[r],o++),r++);e.length=o}function Le(e,t,n){let r=0,o=0;for(;r<n.length;)Z(e,n[r])>=0===t&&(n[o]=n[r],o++),r++;n.length=o}function Pe(e,t){if(t.rotationScale[1]===0&&t.rotationScale[2]===0&&t.rotationScale[3]===0&&t.rotationScale[5]===0&&t.rotationScale[6]===0&&t.rotationScale[7]===0)return v[0]=(e[0]-t.position[0])/t.rotationScale[0],v[1]=(e[1]-t.position[1])/t.rotationScale[4],v[2]=(e[2]-t.position[0])/t.rotationScale[0],v[3]=(e[3]-t.position[1])/t.rotationScale[4],v}const v=G();function de(e,t){const n=t[0],r=t[1],o=t[3],a=e[0]-n,i=n-e[2],c=e[1]-r,l=r-e[3],f=Math.max(a,i,0),m=Math.max(c,l,0),u=f*f+m*m;return u>o*o?0:u>0?1:-Math.max(a,i,c,l)>o?3:2}function he(e,t,n){const r=[],o=n==null?void 0:n.missingFields,a=n==null?void 0:n.originalFields;let i=!1;for(const c of e){const l=t.get(c);l?(a==null||a.push(c),r.push(l.name),c!==l.name&&(i=!0)):o==null||o.push(c)}return n&&"hasMismatchedCasing"in n&&(n.hasMismatchedCasing=i),r}async function qe(e,t,n,r,o,a){if(t.length===0)return[];const i=e.attributeStorageInfo;if(e.associatedLayer!=null)try{return await ye(e.associatedLayer,t,r,a)}catch(c){if(e.associatedLayer.loaded)throw c}if(i){const c=pe(e,t,n,o),l=e.parsedUrl.path;return await Promise.allSettled(c.map(f=>ge(l,i,f.node,f.indices,r,e.apiKey,e.customParameters,a).then(m=>{for(let u=0;u<f.graphics.length;u++){const p=f.graphics[u],g=m[u];if(p.attributes)for(const s in p.attributes)s in g||(g[s]=p.attributes[s]);p.attributes=g}}))),t}throw new w("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function pe({globalIdField:e},t,n,r){var c;const o=new Map,a=[],i=r();for(const l of t){const f=(c=l.attributes)==null?void 0:c[n],m=f==null?l.getGlobalId():void 0;for(let u=0;u<i.length;u++){const p=i[u],g=me(p,f,e,m);if(g<0)continue;let s=o.get(p.node);s||(s={node:p.node,indices:[],graphics:[]},a.push(s),o.set(p.node,s)),s.indices.push(g),s.graphics.push(l);for(let d=u;d>0;d--)i[d]=i[d-1];i[0]=p;break}}return a}function me(e,t,n,r){var a,i;if(t!=null&&typeof t=="number")return e.featureIds.indexOf(t);if(r==null||n==null)return-1;const o=(i=(a=e.attributeInfo)==null?void 0:a.attributeData)==null?void 0:i[n];return o?o.indexOf(r):-1}async function ye(e,t,n,r){const o=[],a={hasMismatchedCasing:!1,originalFields:o},i=he(n,e.fieldsIndex,a),c=new X({outFields:[...i]});if(await ie(e,t,c,{updateSourceAttributes:!0,...r}),!a.hasMismatchedCasing)return t;for(let l=0;l<t.length;l++){const f=t[l];if(f.attributes)for(let m=0;m<o.length;m++){const u=o[m],p=i[m];p in f.attributes&&(f.attributes[u]=f.attributes[p],delete f.attributes[p])}}return t}function ge(e,t,n,r,o,a,i,c){return be(e,t,n.resources.attributes,r,o,a,i,c)}async function be(e,t,n,r,o,a,i,c){const l=[];for(const u of t)if(u&&o.includes(u.name)){const p=`${e}/nodes/${n}/attributes/${u.key}/0`;l.push({url:p,storageInfo:u})}const f=await Promise.allSettled(l.map(u=>Q(u.url,{responseType:"array-buffer",query:{...i,token:a},signal:c==null?void 0:c.signal}).then(p=>le(u.storageInfo,p.data)))),m=[];for(const u of r){const p={};for(let g=0;g<f.length;g++){const s=f[g];if(s.status==="fulfilled"){const d=s.value;p[l[g].storageInfo.name]=ce(d,u)}}m.push(p)}return m}function we(e){const t=e.store,n=t.indexCRS||t.geographicCRS,r=n===void 0?t.indexWKT:void 0;if(r){if(!e.spatialReference)throw new w("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new w("layerview:store-spatial-reference-wkt-index-incompatible","The indexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const o=n?new H(_(n)):e.spatialReference;return o.equals(e.spatialReference)?e.spatialReference:o}function Me(e){const t=e.store,n=t.vertexCRS||t.projectedCRS,r=n===void 0?t.vertexWKT:void 0;if(r){if(!e.spatialReference)throw new w("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new w("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const o=n?new H(_(n)):e.spatialReference;return o.equals(e.spatialReference)?e.spatialReference:o}function C(e,t,n){if(!N(e,t))throw K("scene layer",e==null?void 0:e.wkid,t==null?void 0:t.wkid);if(n==="local"&&!ve(e,t))throw K("scene layer",e==null?void 0:e.wkid,t==null?void 0:t.wkid)}function Ee(e,t,n){var r,o,a,i;if(((r=e.serviceUpdateTimeStamp)==null?void 0:r.lastUpdate)!==((o=t.serviceUpdateTimeStamp)==null?void 0:o.lastUpdate)||!n.isEmpty||((a=e.associatedLayer)==null?void 0:a.url)!==((i=t.associatedLayer)==null?void 0:i.url))throw new w("layerview:recycle-failed","Could not recycle layerview")}function ve(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function Se(e,t,n){const r=we(e),o=Me(e);C(r,t,n),C(o,t,n)}function xe(e){var t;return(e.geometryType==null||e.geometryType==="triangles")&&(e.topology==null||e.topology==="PerAttributeArray")&&((t=e.vertexAttributes)==null?void 0:t.position)!=null}function Oe(e){var t;if(((t=e.store)==null?void 0:t.defaultGeometrySchema)==null||!xe(e.store.defaultGeometrySchema))throw new w("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function Ue(e,t){Se(e,t.spatialReference,t.viewingMode)}function Ie(e){var t;return e.geometryType!=null&&e.geometryType==="points"&&(e.topology==null||e.topology==="PerAttributeArray")&&(e.encoding==null||e.encoding===""||e.encoding==="lepcc-xyz")&&((t=e.vertexAttributes)==null?void 0:t.position)!=null}function ze(e){var t;if(((t=e.store)==null?void 0:t.defaultGeometrySchema)==null||!Ie(e.store.defaultGeometrySchema))throw new w("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function He(e,t){C(e.spatialReference,t.spatialReference,t.viewingMode)}function $e(e){return e.type==="simple"||e.type==="class-breaks"||e.type==="unique-value"}function Re(e){return e.type==="mesh-3d"}function Je(e){var n;if(e==null||!$e(e)||(e.type==="unique-value"||e.type==="class-breaks")&&e.defaultSymbol==null)return!0;const t=e.symbols;if(t.length===0)return!0;for(const r of t){if(!Re(r)||r.symbolLayers.length===0)return!0;for(const o of r.symbolLayers.items)if(o.type!=="fill"||((n=o.material)==null?void 0:n.color)==null||o.material.colorMixMode!=="replace")return!0}return!1}const _e=V({color:[0,0,0,0],opacity:0});class Te{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function Be(e){var o,a;const t=new Te;let n=!1,r=!1;for(const i of e.symbolLayers.items)if(i.type==="fill"&&i.enabled){const c=i.material,l=i.edges;if(c!=null&&!n){const f=c.color,m=ee(c.colorMixMode),u={strength:((o=c.emissive)==null?void 0:o.strength)??F,source:((a=c.emissive)==null?void 0:a.source)==="color"?1:0};t.material=f!=null?{color:[f.r/255,f.g/255,f.b/255],alpha:f.a,colorMixMode:m,emissive:u}:{color:[1,1,1],alpha:1,colorMixMode:1,emissive:u},t.castShadows=i.castShadows,n=!0}l==null||r||(t.edgeMaterial=te(l,{}),r=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1,emissive:{strength:F,source:0}}),t}function De(e,t){return(0|e)+(0|t)|0}function Qe(e,t,n,r,o,a,i){if(!a||a.length===0||t==null||!e.serviceMbsInIndexSR)return null;const c=ue(e.serviceMbsInIndexSR,o,"none",n,t);Y($,c);let l=null;const f=()=>{if(!l)if(l=ke,L(I),e.serviceObbInIndexSR!=null){e.serviceObbInIndexSR.transform(E,n,t,o,i),E.getCorners(l);for(const s of l)M(s,s,$),W(I,s)}else{const s=e.serviceMbsInIndexSR;if(!s)return;const d=s[3];P(U(s),n,h,t),M(h,h,$),h[2]+=o;for(let y=0;y<8;++y){const S=1&y?d:-d,R=2&y?d:-d,T=4&y?d:-d,x=l[y];ae(x,[h[0]+S,h[1]+R,h[2]+T]),W(I,x)}}};let m=1/0,u=-1/0;const p=s=>{if(s.type!=="replace")return;const d=s.geometry;if(!(d!=null&&d.hasZ))return;L(A);const y=d.spatialReference||r,S=d.rings.reduce((R,T)=>T.reduce((x,k)=>(ne(h,k[0],k[1],k[2]),P(h,y,h,t),M(h,h,$),W(A,h),Math.min(h[2],x)),R),1/0);f(),re(I,A)&&(m=Math.min(m,S),u=Math.max(u,S))};if(a.forEach(s=>p(s)),m===1/0)return null;const g=(s,d,y)=>{M(h,y,c),s[d]=h[0],s[d+1]=h[1],s[d+2]=h[2],d+=24,y[2]=m,M(h,y,c),s[d]=h[0],s[d+1]=h[1],s[d+2]=h[2],d+=24,y[2]=u,M(h,y,c),s[d]=h[0],s[d+1]=h[1],s[d+2]=h[2]};for(let s=0;s<8;++s)g(O.data,3*s,l[s]);return se(O)}function Ze(e){return e[3]>=0}function je(e){e!=null&&(e[3]=-1)}const ke=[b(),b(),b(),b(),b(),b(),b(),b()],A=G(),I=G(),E=new oe,h=b(),O={data:new Array(72),size:3,exclusive:!0,stride:3},$=z();export{be as $,Fe as A,Ke as C,C as D,de as F,he as G,Se as J,Le as K,Pe as L,qe as P,Me as Q,Ge as W,Oe as X,Ue as Y,Ee as Z,Be as a,Qe as c,ze as e,je as f,ue as i,De as l,Je as n,_e as s,He as t,Ze as u,we as z};
