import{ie as B,ar as z,b_ as F,si as j,sj as $,sk as A,sl as U,mC as D,dF as k,b as W,sm as Z,sn as G,ef as O,bj as J,bo as K,so as I,eo as N,f8 as Q,bl as P,E as g,F as y,V as X}from"./ShadowCastClear.glsl.js";import{h as Y,t as ee}from"./TileInfoViewPOT.js";import{c as te,m as ie,a as le,b as se,r as ae}from"./WGLBrushVTLSymbol.js";import{o as re}from"./VTLMaterialManager.js";import{l as ne}from"./LayerView3D.js";import{p as oe}from"./TiledLayerView3D.js";import{d as he}from"./LayerView.js";import"./iframe-DpfJK_wQ.js";import"./index.js";import"./Viewport.js";import"./debounce.js";import"./index2.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";import"./Rect.js";import"./rasterizingUtils.js";import"./ShaderCompiler.js";import"./programUtils.js";class ce{constructor(e,t,l){this._scale=e,this._shift=t,this._levelShift=l}getLevelRowColumn(e){const t=this.getLevelShift(e[0]),l=this._shift+t;return l?[e[0]-t,e[1]>>l,e[2]>>l]:e}getLevelShift(e){return Math.min(e,this._levelShift)}getOffset(e,t){let l=0,s=0;const i=this._shift+this.getLevelShift(e[0]);if(i){const o=(1<<i)-1,a=t/(this._scale*(1<<i-1));l=(e[2]&o)*a,s=(e[1]&o)*a}return[l,s]}getScale(e){return this._scale*(1<<this._shift+this.getLevelShift(e))}}class E extends Y{constructor(e,t,l,s){super(e,t,l,e.tileInfo.lods.length-1),this._memCache=s,this._vectorTiles=new Map,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map,this._tileInfoView=new ee(e.tileInfo,e.fullExtent)}destroy(){super.destroy(),this._ongoingRequestToController.forEach(e=>e.abort()),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear(),this._vectorTiles.clear()}async getVectorTile(e,t){const l=new B(e[0],e[1],e[2],0);let s=this._vectorTiles.get(l.id)??this._memCache.get(l.id);if(s)return s.retain(),s;const i=await this._getVectorTileData(l);if(z(t),!this._layer)return null;if(s=this._vectorTiles.get(l.id)??this._memCache.get(l.id),s)return s.retain(),s;const o=this._layer.tileInfo.getTileBounds(F(),l),a=this._tileInfoView.getTileResolution(e[0]);return s=new j(l,a,o[0],o[3],$,$,this._styleRepository,this),s.setData(i),i&&(s.retain(),this._memCache.put(l.id,s,A),this._vectorTiles.set(l.id,s)),s.neededForCoverage=!0,s.transforms.tileUnitsToPixels=U(1/8,0,0,0,1/8,0,0,0,1),s}updateTileSize(e){this._memCache.updateSize(e.id)}onDisposeTile(e){this._vectorTiles.delete(e.id)}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const l=new AbortController,s={signal:l.signal},i=this._getParsedVectorTileData(e,s).then(o=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),o)).catch(()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null));return this._ongoingTileRequests.set(t,i),this._ongoingRequestToController.set(t,l),i}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then(l=>this.parseTileData({key:e,data:l},t))}}const p={vtlBackground:ie,vtlFill:ae,vtlLine:se,vtlCircle:le,vtlSymbol:te},_=1e-6;class V{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache={vtlBackground:null,vtlFill:null,vtlLine:null,vtlCircle:null,vtlSymbol:null},this._vtlMaterialManager=new re}dispose(){var e,t,l,s,i;(e=this._brushCache.vtlBackground)==null||e.dispose(),(t=this._brushCache.vtlFill)==null||t.dispose(),(l=this._brushCache.vtlLine)==null||l.dispose(),(s=this._brushCache.vtlCircle)==null||s.dispose(),(i=this._brushCache.vtlSymbol)==null||i.dispose(),this._brushCache=null,this._vtlMaterialManager=D(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(e,t,l){const s=l.layers;e.renderPass="translucent";let i=this._brushCache.vtlSymbol;i==null&&(i=new p.vtlSymbol,this._brushCache.vtlSymbol=i),m[0]=t;for(let o=0;o<s.length;o++){const a=s[o];if(a.type!==3)continue;const h=a.getLayoutProperty("visibility");if(h&&h.getValue()===1)continue;const r=e.displayLevel;a.minzoom!==void 0&&a.minzoom>r+_||a.maxzoom!==void 0&&a.maxzoom<=r-_||(e.styleLayerUID=a.uid,e.styleLayer=a,i.drawMany(e,m))}m[0]=null}drawBackground(e,t,l){if(l.backgroundBucketIds.length===0)return;const{context:s,displayLevel:i,requiredLevel:o}=e;t.key.level=o,s.setBlendingEnabled(!0),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!1),e.renderPass="background";let a=this._brushCache.vtlBackground;a==null&&(a=new p.vtlBackground,this._brushCache.vtlBackground=a),m[0]=t,l.backgroundBucketIds.forEach(h=>{const r=l.getLayerById(h);if(r.type!==0)return;const f=r.getLayoutProperty("visibility");f&&f.getValue()===1||r.minzoom!==void 0&&r.minzoom>i+_||r.maxzoom!==void 0&&r.maxzoom<=i-_||(e.styleLayerUID=r.uid,e.styleLayer=r,a.drawMany(e,m))}),m[0]=null}drawTile(e,t,l,s){const{context:i}=e,o=l.layers;i.setBlendingEnabled(!1),i.setDepthTestEnabled(!0),i.setDepthWriteEnabled(!0),i.setDepthFunction(515);const a=o.filter(h=>{if(s!=null&&s!==h.type||!t.layerData.has(h.uid))return!1;const r=h.getLayoutProperty("visibility");return(r==null?void 0:r.getValue())!==1});e.renderPass="opaque";for(let h=a.length-1;h>=0;--h)this._renderStyleLayer(a[h],e,t);i.setDepthWriteEnabled(!1),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(1,771,1,771),e.renderPass="translucent",a.forEach(h=>this._renderStyleLayer(h,e,t)),i.setDepthTestEnabled(!1),i.bindVAO(null)}_renderStyleLayer(e,t,l){const{renderPass:s}=t;let i;switch(e.type){case 0:if(s!=="background")return;i=this._brushCache.vtlBackground,i||(i=new p.vtlBackground,this._brushCache.vtlBackground=i);break;case 1:if(s!=="opaque"&&t.renderPass!=="translucent")return;i=this._brushCache.vtlFill,i==null&&(i=new p.vtlFill,this._brushCache.vtlFill=i);break;case 2:if(s!=="translucent")return;i=this._brushCache.vtlLine,i==null&&(i=new p.vtlLine,this._brushCache.vtlLine=i);break;case 4:if(s!=="translucent")return;i=this._brushCache.vtlCircle,i==null&&(i=new p.vtlCircle,this._brushCache.vtlCircle=i);break;case 3:if(s!=="translucent")return;i=this._brushCache.vtlSymbol,i==null&&(i=new p.vtlSymbol,this._brushCache.vtlSymbol=i)}const{displayLevel:o}=t,{minzoom:a,maxzoom:h}=e;if(a!==void 0&&a>o+_||h!==void 0&&h<=o-_)return;const{context:r}=t;r.setStencilTestEnabled(!1),r.setStencilWriteMask(0),t.styleLayerUID=e.uid,t.styleLayer=e,m[0]=l,i.drawMany(t,m),m[0]=null}}const m=[null];let u=class extends oe(ne(he)){constructor(){super(...arguments),this._tileHandlerController=null,this.type="vector-tile-3d",this.levelShift=k("disable-feature:vtl-level-shift")?0:1}initialize(){if(this.layer.fullExtent==null)return void this.addResolvingPromise(Promise.reject(new W("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:n,spatialReference:e,state:t,viewingMode:l}=this.view,s=l==="local"&&!Z(e)||G.force512VTL?this.layer.tileInfo:this.layer.tileInfo.getCompatibleForVTL(256),i=this._getTileInfoSupportError(s,this.layer.fullExtent);if(i!=null)return this.addResolvingPromise(Promise.reject(i));const o=O(()=>{var c,d;return(d=(c=this.view)==null?void 0:c.basemapTerrain)==null?void 0:d.tilingSchemeLocked}).then(()=>{var w,T;const c=n.tilingScheme,d=c.pixelSize,R=d===256?1:2,v=(w=n.spatialReference)!=null&&w.isGeographic&&d===256?1:0,S=(T=n.spatialReference)!=null&&T.isGeographic||d!==256?0:1;let b;this.schemaHelper=new ce(R,v,this.levelShift+S),b=d===256||d===512?this.layer.tileInfo.getCompatibleForVTL(d):this.layer.tileInfo;const C=this._getTileInfoCompatibilityError(b,c);if(C)throw C;this.tileInfo=b});this._tileHandlerController=new AbortController;const a=this.view.resourceController;this._memCache=a.memoryController.newCache(`vtl-${this.layer.uid}`,c=>c.release()),this.addHandles(J(()=>this.view.qualitySettings.memoryLimit,c=>this._memCache.maxSize=Math.ceil(c/10*1048576),K));const h=new I(this.layer.currentStyleInfo.style);this._tileHandler=new E(this.layer,h,t.contentPixelRatio,this._memCache);const r=this._tileHandlerController.signal,f=de(a),x=this._tileHandler.start({signal:r,schedule:f}),H=this._tileHandler.spriteMosaic;H.then(c=>{!N(r)&&this._tileHandler&&(this.painter=new V(c,this._tileHandler.glyphMosaic))}),x.then(()=>this._tileHandlerController=null);const L=()=>{var C;this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const c=this.layer.currentStyleInfo.style,d=((C=this.view.state)==null?void 0:C.contentPixelRatio)??1,R=new I(c),v=new E(this.layer,R,d,this._memCache),S=v.start({signal:this._tileHandlerController.signal,schedule:f}),b=v.spriteMosaic;S.then(()=>this._tileHandlerController=null),this._updatingHandles.addPromise(Promise.all([S,b]).then(([,w])=>{const T=this._tileHandler,M=this.painter;this.painter=new V(w,v.glyphMosaic),this._tileHandler=v,this.emit("data-changed"),T.destroy(),M&&M.dispose()}))};this._updatingHandles.add(()=>{var c;return{style:this.layer.currentStyleInfo.style,pixelRatio:(c=this.view.state)==null?void 0:c.contentPixelRatio}},L),this.addHandles([this.layer.on("paint-change",()=>this.emit("data-changed")),this.layer.on("style-layer-change",L),this.layer.on("delete-style-layer",L),this.layer.on("spriteSource-change",()=>this.emit("data-changed")),this.layer.on("layout-change",()=>this.emit("data-changed")),this.layer.on("style-layer-visibility-change",()=>this.emit("data-changed"))]);const q=Promise.all([o,x,H]);this.addResolvingPromise(q)}destroy(){this.painter=D(this.painter),this._tileHandlerController=Q(this._tileHandlerController),this._tileHandler=P(this._tileHandler),this._memCache=P(this._memCache)}get contentZoom(){return k("disable-feature:vtl-level-shift")?1:this.view.qualitySettings.tiledSurface.vtlContentZoom}get displayLevelRange(){const n=this.tileInfo.lods,e=this.layer.minScale||n[0].scale,t=this.layer.maxScale||n[n.length-1].scale,l=this.levelRangeFromScaleRange(e,t);return this.layer.maxScale?l.maxLevel++:l.maxLevel+=this.levelShift,l}get dataScaleRange(){const n=this.tileInfo.lods;return{minScale:n[0].scale,maxScale:n[n.length-1].scale}}get dataLevelRange(){const{minScale:n,maxScale:e}=this.dataScaleRange,t=this.levelRangeFromScaleRange(n,e);return t.minLevel===1&&this.tileInfo.size[0]===256&&(t.minLevel=0),t.maxLevel+=this.levelShift,t}async fetchTile(n,e){const t=this.schemaHelper.getLevelRowColumn(n);return this._tileHandler.getVectorTile(t,e)}get hasVisibleFeatures(){return!0}};g([y()],u.prototype,"layer",void 0),g([y()],u.prototype,"levelShift",void 0),g([y()],u.prototype,"contentZoom",null),g([y()],u.prototype,"displayLevelRange",null),g([y()],u.prototype,"tileInfo",void 0),g([y()],u.prototype,"dataScaleRange",null),g([y()],u.prototype,"dataLevelRange",null),g([y()],u.prototype,"updatingProgressValue",void 0),u=g([X("esri.views.3d.layers.VectorTileLayerView3D")],u);const Pe=u;function de(n){return e=>n.immediate.schedule(e)}export{Pe as default};
