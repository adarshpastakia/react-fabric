import{bj as T,bk as b,oV as D,oW as R,oX as v,E as p,F as _,V as S,mC as c,oY as P,b as L,ef as G,eq as F,oZ as M}from"./ShadowCastClear.glsl.js";import{u as C}from"./rasterProjectionHelper.js";import{l as O}from"./LayerView3D.js";import{p as A}from"./TiledLayerView3D.js";import{y as V}from"./dataUtils.js";import{r as U,c as $}from"./FlowSubView3D.js";import{h as y,c as k}from"./loadUtils2.js";import{i as j,m as E,l as q,c as H,f as W,u as B,o as x}from"./rasterUtils.js";import{f as J}from"./ImageryTileLayerView.js";import{d as N}from"./LayerView.js";import{i as Q}from"./RefreshableLayerView.js";import"./iframe-DpfJK_wQ.js";import"./index.js";import"./Viewport.js";import"./debounce.js";import"./index2.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";import"./utils6.js";import"./SubView3D.js";import"./line.js";import"./FeatureTileDescriptor.js";import"./rasterFieldUtils.js";import"./timeSupport.js";import"./datasetUtils.js";import"./popupUtils.js";const f={type:"delete"},X={type:"waiting"},Y={type:"on-worker",upsampled:!1},Z={type:"on-worker",upsampled:!0};let g=class extends U{constructor(t){super(t),this._resetTileData=!0,this._throttledTriggerLoad=null,this._throttling=!1}initialize(){this.addHandles([this.surface.on("tile-data-changed",({tile:t,layerIndex:e,layerClass:r})=>{this.renderedTiles!=null&&(this.loadByTileTreesAllowed||this._tileIsUpsampled(t))&&e===this._layerIndex&&r===1&&this._updateFlowDataTile(t)}),T(()=>this.renderedTiles,t=>{const e=this.frameTask.scheduleGenerator(r=>this._updateFlowDataTiles(t,r));this.updatingHandles.addPromise(e)},b),T(()=>this._pixelSize,()=>{this.invalidateTileData(),this._resetTileData=!0},b)]),this._throttledTriggerLoad=D(()=>{super.triggerLoad(),this._throttling=!1},()=>this._throttling=!0,$,this),this.addHandles(this._throttledTriggerLoad)}async*_updateFlowDataTiles(t,e){var s;const r=w();for(const i of t??[]){const a=(s=this._flowDataTiles)==null?void 0:s.get(y(i)),l=a==null||a.type==="delete"||a.type==="waiting"?this._getLoadedState(i):a;l!=null&&r.set(y(i),l),e.madeProgress(),e.done&&(e=yield)}this._flowDataTiles=r,this._resetTileData=!0,this.triggerLoad()}abort(){super.abort(),this._throttling=!1}get _layerIndex(){return this.surface.getLayerIndexByUID(1,this.layerView.uid)}get loadByTileTreesAllowed(){return super.loadByTileTreesAllowed||!this._allTilesLoaded}get _pixelSize(){return this.surface.tilingScheme.pixelSize}doRefresh(){this.invalidateTileData(),super.doRefresh()}triggerLoad(){const{_throttledTriggerLoad:t}=this;this._allTilesLoaded?(t.hasPendingUpdates()||t(),t.forceUpdate()):t()}async fetchDataAndGenerateStreamlines(t,e){const{_flowDataTiles:r,needsMagnitude:s,workerHandle:i}=this,a=this.getSimulationSettings(t);if(a==null||i==null||r==null)return;const l=this._resetTileData;this._resetTileData=!1;const u=w();r.forEach((n,o)=>{n.type==="delete"?(u.set(o,f),r.delete(o)):(l||n.type!=="on-worker"&&n.type!=="waiting")&&(u.set(o,n),r.set(o,n.type!=="waiting"&&n.upsampled?Z:Y))});const d={simulationSettings:a,flowExtentInfo:t.flowExtentInfo,flowDataTiles:u,reset:l,needsMagnitude:s,startPositions:this.startPositions(t)},{streamlines:h}=await i.generateTiledStreamlines(d,e);return h}getUpdating(){return super.getUpdating()||this._throttling}_getLoadedState(t){const{_layerIndex:e}=this,r=t.surface==null;if(e==null||r)return f;const s=t.getLayerInfo(e,1);if(s==null)return f;if(!t.visible&&s.requestAbort==null)return s.requestAbort=new AbortController,this.surface.requestTileData(t,e,1,s.requestAbort),f;const i=this._getRasterTile(s,t,e);return i==null?this._upsampleFlowData(e,s.upsampleInfo,t.lij,t.extent):{type:"loaded",data:this._createFlowDataTile(i,t.lij,t.extent,this._pixelSize),upsampled:!1}}_upsampleFlowData(t,e,r,s){if(e==null)return f;const i=e.tile;if(i==null)return f;const a=i.getLayerInfo(t,1);if(a==null)return f;const l=this._getRasterTile(a,i,t);if(l==null)return f;const{scale:u,offset:d}=e,h=Math.max(Math.floor(this._pixelSize*u),1),n=l.source,o=Math.floor(d[0]*n.width),z=Math.floor((1-d[1]-u)*n.height);return{type:"loaded",data:this._createFlowDataTile(l,r,s,h,o,z),upsampled:!0}}_getRasterTile(t,e,r){const{data:s}=t;return!t.dataMissing&&e.hasLayerData(r,1)&&R(s)?s:null}_createFlowDataTile(t,e,r,s,i,a){const l=V(this.layer.serviceRasterInfo.dataType,t.source,s,s,i,a),u=l.mask.slice();return new k(l.data,u,l.width,l.height,e,v(r))}_updateFlowDataTile(t){var i;const{renderedTiles:e,_layerIndex:r}=this;if(e==null||r==null)return;if(e.has(t)){const a=this._getLoadedState(t);return void(this._setTileData(t,a)&&this.triggerLoad())}let s=this._setTileData(t,f);for(const a of e.values()){const l=a.getLayerInfo(r,1);if(l==null||this._getRasterTile(l,a,r)!=null||((i=l.upsampleInfo)==null?void 0:i.tile)!==t)continue;const d=this._getLoadedState(a),h=this._setTileData(a,d);s||(s=h)}s&&this.triggerLoad()}_setTileData(t,e){const{_flowDataTiles:r}=this;if(r==null)return!1;const s=y(t);return(r.get(s)!=null||e.type!=="delete")&&(r.set(s,e),!0)}get _allTilesLoaded(){var e,r;let t=0;for(const s of((e=this._flowDataTiles)==null?void 0:e.values())??[])s.type!=="delete"&&s.type!=="waiting"&&t++;return t===((r=this.renderedTiles)==null?void 0:r.size)}invalidateTileData(){const{_flowDataTiles:t}=this;t==null||t.forEach((e,r)=>{t.set(r,X)})}_tileIsUpsampled(t){var r;const e=(r=this._flowDataTiles)==null?void 0:r.get(y(t));return e!=null&&(e.type==="loaded"||e.type==="on-worker")&&e.upsampled}get usedMemory(){var r;const t=9*this._pixelSize**2,e=(((r=this._flowDataTiles)==null?void 0:r.size)??0)*t;return super.usedMemory+e}get test(){return{...super.test,loadedTiles:this._flowDataTiles??w()}}};function w(){return new Map}p([_()],g.prototype,"_throttling",void 0),g=p([S("esri.views.3d.support.flow.FlowSubViewTiles3D")],g);const I={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class K{constructor(e,r,s=null,i=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=r,this.width=s||r.width,this.height=i||r.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=c(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...I,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||I}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){e!=null&&e.length>0?this._bandIds&&e.every((r,s)=>{var i;return!!((i=this._bandIds)!=null&&i[s])&&r===this._bandIds[s]})||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture!=null){const r=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(r==="bilinear"?9729:9728)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=c(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(e,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(e),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=j(e,this.transformGrid))),!0)}getUniforms(e){const{symbolizerParameters:r,transformGrid:s,width:i,height:a,opacity:l}=this,u=E(s,[i,a],[this.source.width,this.source.height],l),d=q(r.colormap,r.colormapOffset),h=this.symbolizerParameters.type==="stretch"?H(this.symbolizerParameters):null,n=this.symbolizerParameters.type==="hillshade"?W(this.symbolizerParameters):null,o=e.emptyTexture;return new P(u,d,h||n,this._rasterTexture??o,this._transformGridTexture??o,this._colormapTexture??o)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return this.interpolation==="bilinear"&&e.colormap!=null&&e.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(r=>r!=null?r.descriptor.width*r.descriptor.height*4:0).reduce((r,s)=>r+s,0)}return this._memoryUsed}release(){return this._rasterTexture=c(this._rasterTexture),this._transformGridTexture=c(this._transformGridTexture),this._colormapTexture=c(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,r){const s=this.source?this.source.extractBands(r):null;if(!(s!=null&&s.pixels&&s.pixels.length>0))return void(this._rasterTexture=c(this._rasterTexture));const i=r==null&&this.bandIds==null||r!=null&&this.bandIds!=null&&r.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&i)return;this._rasterTexture=c(this._rasterTexture);const a=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=B(e,s,a,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const r=this._colormap,s=this.symbolizerParameters.colormap;return s?r?s.length!==r.length||s.some((i,a)=>i!==r[a])?(this._colormapTexture=c(this._colormapTexture),this._colormapTexture=x(e,s),void(this._colormap=s)):void 0:(this._colormapTexture=x(e,s),void(this._colormap=s)):(this._colormapTexture=c(this._colormapTexture),void(this._colormap=null))}}let m=class extends J(Q(A(O(N)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0,this._flowSubView=null,this.ignoresMemoryFactor=!1,this.unloadedMemory=0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new L("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const t=G(()=>{var e,r;return(r=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:r.tilingSchemeLocked}).then(()=>{const e=this.view.basemapTerrain.tilingScheme,r=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(r.format)&&e.compatibleWith(r),this.tileInfo=this._isAlignedMapTile?r:e.toTileInfo(),this.addHandles([T(()=>this.layer.renderer,s=>{this._setSubView(s),this._updatingHandles.addPromise(this.doRefresh())},b),T(()=>[this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this._updatingHandles.addPromise(this.doRefresh()),b)])});this._setSubView(this.layer.renderer),this.addResolvingPromise(t)}destroy(){var t;this.layer.decreaseRasterJobHandlerUsage(),(t=this._flowSubView)==null||t.destroy()}_setSubView(t){if(this.layer.type==="wcs")return;const e=(t==null?void 0:t.type)==="flow",r=this._flowSubView;e&&r!=null||(r==null||r.destroy(),this._flowSubView=e?new g({layerView:this}):null)}get _blankTile(){const t=document.createElement("canvas"),e=t.getContext("2d"),[r,s]=this.tileInfo.size;return t.width=r,t.height=s,e.clearRect(0,0,r,s),e.getImageData(0,0,r,s)}get _hasFlow(){return this._flowSubView!=null}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){var s,i;const t=this.layer.tileInfo,e=(s=this.tileInfo.lodAt(0))==null?void 0:s.scale,r=(i=t.lodAt(t.lods.length-1))==null?void 0:i.scale;return this.levelRangeFromScaleRange(e,r)}get visibleAtCurrentScale(){var t;return((t=this._flowSubView)==null?void 0:t.visibleAtCurrentScale)??this.tilesVisibleAtCurrentScale()}_getFullExtent(){var t;return C(this.layer.serviceRasterInfo,((t=this.view.basemapTerrain)==null?void 0:t.spatialReference)??this.view.spatialReference)}async fetchTile(t,e){const r=this.tileInfo,s=this._canSymbolizeInWebGL(),i={tileInfo:r,requestRawData:s&&!this._hasFlow,signal:e.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,requestProjectedLocalDirections:this._hasFlow,noClip:!1},{layer:a}=this,[l,u,d]=t,h=await a.fetchTile(l,u,d,i);if(h instanceof HTMLImageElement)return h;let n=h==null?void 0:h.pixelBlock;if(n==null)return this._blankTile;if(!s&&!this._hasFlow&&(n=await a.applyRenderer(h),n==null))return this._blankTile;const o=new K([l,u,d],n,r.size[0],r.size[1]);return s?(o.symbolizerRenderer=a.symbolizer.rendererJSON,o.symbolizerParameters=a.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(l)),o.transformGrid=h.transformGrid,o.bandIds=a.bandIds):(o.isRendereredSource=!0,o.bandIds=null),o.interpolation=a.interpolation,o}_getSymbolizerOptions(t){var r;const e=this.tileInfo.lodAt(t).resolution;return{pixelBlock:null,isGCS:((r=this.view.basemapTerrain)==null?void 0:r.spatialReference)!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(t){this._canSymbolizeInWebGL()&&JSON.stringify(t.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(t.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(t.lij[0])))}createFetchPopupFeaturesQueryGeometry(t,e){return F(t,e,this.view)}async doRefresh(){var t;this.suspended||((t=this._flowSubView)==null||t.doRefresh(),this.emit("data-changed"))}isUpdating(){var t;return((t=this._flowSubView)==null?void 0:t.updating)??!1}_canSymbolizeInWebGL(){var a,l;const t=M(),{symbolizer:e}=this.layer,r=(a=e.lookup.colormapLut)==null?void 0:a.indexedColormap,s=!!((l=this.layer.rasterFunction)!=null&&l.hasClipFunction),i=r&&r.length>4*(t.maxTextureSize||4096);return e.canRenderInWebGL&&!i&&!s}get usedMemory(){var t;return((t=this._flowSubView)==null?void 0:t.usedMemory)??0}get test(){}};p([_({readOnly:!0})],m.prototype,"_blankTile",null),p([_()],m.prototype,"_hasFlow",null),p([_({readOnly:!0})],m.prototype,"imageFormatIsOpaque",null),p([_({readOnly:!0})],m.prototype,"hasMixedImageFormats",null),p([_()],m.prototype,"_flowSubView",void 0),p([_({readOnly:!0})],m.prototype,"dataLevelRange",null),p([_({readOnly:!0})],m.prototype,"visibleAtCurrentScale",null),m=p([S("esri.views.3d.layers.ImageryTileLayerView3D")],m);const Pe=m;export{Pe as default};
