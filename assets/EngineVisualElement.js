import{et as l,b6 as y,E as o,F as u,V as R,of as p,o6 as m,bj as b,b5 as v}from"./ShadowCastClear.glsl.js";import{t as G}from"./VisualElement.js";class f{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1,this._renderGroup=2}destroy(){this._destroyResources()}get resources(){var e;return(e=this._resources)==null?void 0:e.external}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}get renderGroup(){return this._renderGroup}set renderGroup(e){var s;this._renderGroup=e;const r=(s=this._resources)==null?void 0:s.layerView;r&&(r.renderGroup=e)}recreate(){this.attached&&this._createResources()}recreateGeometry(){this._resourceFactory.recreateGeometry?this._resources!=null&&(this._ensureRenderGeometriesRemoved(),this._resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}forEachMaterial(e){this._resources&&this._resourceFactory.forEachMaterial(this._resources.external,e)}_createOrDestroyResources(){this._attached?this._resources==null&&this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory.createResources(),r=new t({view:this._resourceFactory.view,renderGroup:this._renderGroup}),s=this._resourceFactory.view.overlayManager;this._resources={layerView:r,external:e,geometriesAdded:!1},s&&(this._resources.drapeSourceRenderer=s.registerGeometryDrapeSource(r)),this._syncGeometriesToRenderer()}_destroyResources(){if(this._resources==null)return;this._ensureRenderGeometriesRemoved();const e=this._resourceFactory.view.overlayManager;e&&e.unregisterDrapeSource(this._resources.layerView),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){var e;((e=this._resources)==null?void 0:e.drapeSourceRenderer)!=null&&this._resources.geometriesAdded&&(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,1),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){var e;((e=this._resources)==null?void 0:e.drapeSourceRenderer)!=null&&(this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,1),this._resources.geometriesAdded=!0))}}let t=class extends l(y){constructor(e){super(e),this.drapeSourceType=1,this.updatePolicy=1,this.renderGroup=2}};o([u({constructOnly:!0})],t.prototype,"view",void 0),o([u({readOnly:!0})],t.prototype,"drapeSourceType",void 0),o([u()],t.prototype,"renderGroup",void 0),t=o([R("esri.views.3d.interactive.visualElements.DrapedVisualElementResources")],t);class g{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return this._resources!=null?this._resources.object:null}get resources(){return this._resources!=null?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this._resourceFactory.recreateGeometry)return void this.recreate();const e=this._resourceFactory.view.stage;if(this._resources==null||!e)return;const r=this._resources.object;r.removeAllGeometries(),this._resourceFactory.recreateGeometry(this._resources.external,r,this._resources.layer)}forEachMaterial(e){this._resources&&this._resourceFactory.forEachMaterial(this._resources.external,e)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory,r=e.view,s=r.stage;if(!s)return;const c=new p(s,{pickable:!1,updatePolicy:1}),a=new m({castShadow:!1}),d=e.createResources(a,c);c.add(a);const h=e.cameraChanged,_=h?b(()=>r.state.camera,n=>h(n),v):null;this._resources={layer:c,object:a,external:d,cameraHandle:_},this._syncVisible()}_destroyResources(){var e;this._resources!=null&&(this._resources.layer.destroy(),this._resources.object.dispose(),(e=this._resources.cameraHandle)==null||e.remove(),this._resourceFactory.destroyResources(this._resources.external),this._resources=null)}_syncVisible(){this._resources!=null&&(this._resources.object.visible=this._visible)}}class j extends G{constructor(e){super(e),this._isDraped=!1,this.object3dResources=new g(this.createObject3DResourceFactory(e.view)),this.drapedResources=new f(this.createDrapedResourceFactory(e.view)),this.isDraped=e.isDraped??!1}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this.object3dResources.attached=this.attached&&!e,this.drapedResources.attached=this.attached&&e)}get renderGroup(){return this.drapedResources.renderGroup}set renderGroup(e){this.drapedResources.renderGroup=e}createResources(){this.object3dResources.attached=!this._isDraped,this.drapedResources.attached=this._isDraped}destroyResources(){this.object3dResources.attached=!1,this.drapedResources.attached=!1}recreate(){this.object3dResources.recreate(),this.drapedResources.recreate()}recreateGeometry(){this.object3dResources.recreateGeometry(),this.drapedResources.recreateGeometry()}destroy(){this.object3dResources.destroy(),this.drapedResources.destroy(),super.destroy()}updateVisibility(e){this.object3dResources.visible=e,this.drapedResources.visible=e}forEachMaterial(e){var r,s;(r=this.object3dResources)==null||r.forEachMaterial(e),(s=this.drapedResources)==null||s.forEachMaterial(e)}}export{j as t};
