const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ShadowCastClear.glsl.js","./iframe-DpfJK_wQ.js","./iframe-DPR8S5X3.css","./index.js","./Viewport.js","./debounce.js","./index2.js","./Section.js","./ErrorBoundary.js","./createClass.js","./Global.js","./useIsDark.js","./ShadowCastClear-BxU8WlBI.css"])))=>i.map(i=>d[i]);
import{b6 as Z}from"./iframe-DpfJK_wQ.js";import{iI as K,jN as W,jM as X,eM as H,D as J,e4 as Y,E as n,F as u,L as ee,N as te,e1 as Q,b0 as B,K as re,O as ie,U as se,V as R,_ as q,rl as oe,at as ae,e5 as ne,P as le,e7 as ue,e6 as pe,H as ye,b6 as ce,e$ as he,ew as de,b as A,ey as M,b8 as fe,cd as me,fq as ge,dF as we,s8 as T,kw as be,ar as L,m0 as ve,bx as xe,es as $e,a2 as Se}from"./ShadowCastClear.glsl.js";import{n as U}from"./floorFilterUtils.js";import{e as _e}from"./sublayerUtils.js";import{p as Fe,n as Pe}from"./popupUtils.js";function Ve(a,e){const{dpi:r,gdbVersion:t,geometry:i,geometryPrecision:s,height:f,historicMoment:o,layerOption:y,mapExtent:c,maxAllowableOffset:l,returnFieldName:h,returnGeometry:p,returnUnformattedValues:w,returnZ:S,spatialReference:_,timeExtent:m,tolerance:P,width:v}=a.toJSON(),{dynamicLayers:g,layerDefs:x,layerIds:E}=Oe(a),O=(e==null?void 0:e.geometry)!=null?e.geometry:null,b={historicMoment:o,geometryPrecision:s,maxAllowableOffset:l,returnFieldName:h,returnGeometry:p,returnUnformattedValues:w,returnZ:S,tolerance:P},$=(O==null?void 0:O.toJSON())||i;b.imageDisplay=`${v},${f},${r}`,t&&(b.gdbVersion=t),$&&(delete $.spatialReference,b.geometry=JSON.stringify($),b.geometryType=K($));const G=_??($==null?void 0:$.spatialReference)??(c==null?void 0:c.spatialReference);if(G&&(b.sr=W(G)),b.time=m?[m.start,m.end].join(","):null,c){const{xmin:j,ymin:D,xmax:k,ymax:C}=c;b.mapExtent=`${j},${D},${k},${C}`}return x&&(b.layerDefs=x),g&&!x&&(b.dynamicLayers=g),b.layers=y==="popup"?"visible":y,E&&!g&&(b.layers+=`:${E.join(",")}`),b}function Oe(a){var S,_;const{mapExtent:e,floors:r,width:t,sublayers:i,layerIds:s,layerOption:f,gdbVersion:o}=a,y=(_=(S=i==null?void 0:i.find(m=>m.layer!=null))==null?void 0:S.layer)==null?void 0:_.serviceSublayers,c=f==="popup",l={},h=X({extent:e,width:t,spatialReference:e==null?void 0:e.spatialReference}),p=[],w=m=>{const P=h===0,v=m.minScale===0||h<=m.minScale,g=m.maxScale===0||h>=m.maxScale;if(m.visible&&(P||v&&g))if(m.sublayers)m.sublayers.forEach(w);else{if((s==null?void 0:s.includes(m.id))===!1||c&&(!m.popupTemplate||!m.popupEnabled))return;p.unshift(m)}};if(i==null||i.forEach(w),i&&!p.length)l.layerIds=[];else{const m=_e(p,y,o),P=p.map(v=>{const g=U(r,v);return v.toExportImageJSON(g)});if(m)l.dynamicLayers=JSON.stringify(P);else{if(i){let g=p.map(({id:x})=>x);s&&(g=g.filter(x=>s.includes(x))),l.layerIds=g}else s!=null&&s.length&&(l.layerIds=s);const v=Ee(r,p);if(v!=null&&v.length){const g={};for(const x of v)x.definitionExpression&&(g[x.id]=x.definitionExpression);Object.keys(g).length&&(l.layerDefs=JSON.stringify(g))}}}return l}function Ee(a,e){const r=!!(a!=null&&a.length),t=e.filter(i=>i.definitionExpression!=null||r&&i.floorInfo!=null);return t.length?t.map(i=>{const s=U(a,i),f=H(s,i.definitionExpression);return{id:i.id,definitionExpression:f??void 0}}):null}var I;let d=I=class extends J{static from(a){return Y(I,a)}constructor(a){super(a),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(a,e){e.historicMoment=a&&a.getTime()}};n([u({type:Number,json:{write:!0}})],d.prototype,"dpi",void 0),n([u()],d.prototype,"floors",void 0),n([u({type:String,json:{write:!0}})],d.prototype,"gdbVersion",void 0),n([u({types:te,json:{read:ee,write:!0}})],d.prototype,"geometry",void 0),n([u({type:Number,json:{write:!0}})],d.prototype,"geometryPrecision",void 0),n([u({type:Number,json:{write:!0}})],d.prototype,"height",void 0),n([u({type:Date})],d.prototype,"historicMoment",void 0),n([Q("historicMoment")],d.prototype,"writeHistoricMoment",null),n([u({type:[Number],json:{write:!0}})],d.prototype,"layerIds",void 0),n([u({type:["top","visible","all","popup"],json:{write:!0}})],d.prototype,"layerOption",void 0),n([u({type:B,json:{write:!0}})],d.prototype,"mapExtent",void 0),n([u({type:Number,json:{write:!0}})],d.prototype,"maxAllowableOffset",void 0),n([u({type:Boolean,json:{write:!0}})],d.prototype,"returnFieldName",void 0),n([u({type:Boolean,json:{write:!0}})],d.prototype,"returnGeometry",void 0),n([u({type:Boolean,json:{write:!0}})],d.prototype,"returnM",void 0),n([u({type:Boolean,json:{write:!0}})],d.prototype,"returnUnformattedValues",void 0),n([u({type:Boolean,json:{write:!0}})],d.prototype,"returnZ",void 0),n([u({type:re,json:{write:!0}})],d.prototype,"spatialReference",void 0),n([u({type:ie})],d.prototype,"sublayers",void 0),n([u({type:se,json:{write:!0}})],d.prototype,"timeExtent",void 0),n([u({type:Number,json:{write:!0}})],d.prototype,"tolerance",void 0),n([u({type:Number,json:{write:!0}})],d.prototype,"width",void 0),d=I=n([R("esri.rest.support.IdentifyParameters")],d);const z=d;let F=class extends J{constructor(a){super(a),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(a,e){return q.fromJSON({attributes:{...e.attributes},geometry:{...e.geometry}})}writeFeature(a,e){if(!a)return;const{attributes:r,geometry:t}=a;r&&(e.attributes={...r}),t!=null&&(e.geometry=t.toJSON(),e.geometryType=oe.toJSON(t.type))}};n([u({type:String,json:{write:!0}})],F.prototype,"displayFieldName",void 0),n([u({type:q})],F.prototype,"feature",void 0),n([ae("feature",["attributes","geometry"])],F.prototype,"readFeature",null),n([Q("feature")],F.prototype,"writeFeature",null),n([u({type:Number,json:{write:!0}})],F.prototype,"layerId",void 0),n([u({type:String,json:{write:!0}})],F.prototype,"layerName",void 0),F=n([R("esri.rest.support.IdentifyResult")],F);const Ge=F;async function je(a,e,r){const t=(e=Ie(e)).geometry?[e.geometry]:[],i=ne(a);return i.path+="/identify",le(t).then(s=>{const f=Ve(e,{geometry:s==null?void 0:s[0]}),o=ue({...i.query,f:"json",...f}),y=pe(o,r);return ye(i.path,y).then(Ne).then(c=>Re(c,e.sublayers))})}function Ne(a){const e=a.data;return e.results=e.results||[],e.exceededTransferLimit=!!e.exceededTransferLimit,e.results=e.results.map(r=>Ge.fromJSON(r)),e}function Ie(a){return a=z.from(a)}function Re(a,e){if(!(e!=null&&e.length))return a;const r=new Map;function t(i){r.set(i.id,i),i.sublayers&&i.sublayers.forEach(t)}e.forEach(t);for(const i of a.results)i.feature.sourceLayer=r.get(i.layerId);return a}let N=null;function qe(a,e){return e.type==="tile"||e.type==="map-image"}let V=class extends ce{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=he(async r=>{this.destroyed||await this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(r).catch(()=>{}))})}initialize(){const e=r=>{var t;for(const i of r){const{sourceLayer:s}=i;s!=null&&"geometryType"in s&&s.geometryType==="point"&&i.visible&&(i.visible=!1,(t=this.highlightGraphicUpdated)==null||t.call(this,{graphic:i,property:"visible",oldValue:!0,newValue:!1}))}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(r).catch(()=>{})),$e(this.updateHighlightedFeatures(this._highlightGeometriesResolution))};this.addHandles([de(()=>this.highlightGraphics,"change",r=>e(r.added),{onListenerAdd:r=>e(r)})])}async fetchPopupFeaturesAtLocation(e,r){var o,y;const{layerView:{layer:t,view:{scale:i}}}=this;if(!e)throw new A("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:t});const s=Ue(t.sublayers,i,r);if(!s.length)return[];const f=await Me(t,s);if(!((((y=(o=t.capabilities)==null?void 0:o.operations)==null?void 0:y.supportsIdentify)??!0)&&t.version>=10.5)&&!f)throw new A("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:t});return f?this._fetchPopupFeaturesUsingQueries(e,s,r):this._fetchPopupFeaturesUsingIdentify(e,s,r)}clearHighlights(){var e;(e=this.highlightGraphics)==null||e.removeAll()}async _updateHighlightedFeaturesSymbols(e){for(const r of e)this._updateSymbology(r)}_updateSymbology(e){var r;if(((r=e.geometry)==null?void 0:r.type)==="point")return this._updatePointSymbology(e)}_setGraphicSymbol(e,r){var i;if(!r)return;const t=e.symbol;e.symbol=r,(i=this.highlightGraphicUpdated)==null||i.call(this,{graphic:e,property:"symbol",oldValue:t,newValue:r})}_updatePointSymbology(e){const r=e.sourceLayer&&"renderer"in e.sourceLayer&&e.sourceLayer.renderer,{highlightGraphicUpdated:t,highlightGraphics:i,layerView:{view:s}}=this,f=o=>{o.visible||(o.visible=!0,t==null||t({graphic:o,property:"visible",oldValue:!1,newValue:!0}))};r&&"getSymbolAsync"in r?r.getSymbolAsync(e).then(async o=>{var l;o||(o=new M);let y=null;const c="visualVariables"in r?(l=r.visualVariables)==null?void 0:l.find(h=>h.type==="size"):void 0;c&&(N||(N=(await Z(async()=>{const{getSize:h}=await import("./ShadowCastClear.glsl.js").then(p=>p.Jy);return{getSize:h}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12]),import.meta.url)).getSize),y=N(c,e,{view:s.type,scale:s.scale,shape:o.type==="simple-marker"?o.style:null})),y||(y="width"in o&&"height"in o&&o.width!=null&&o.height!=null?Math.max(o.width,o.height):"size"in o?o.size:16),i!=null&&i.includes(e)&&(this._setGraphicSymbol(e,new M({style:"square",size:y,color:new fe([255,255,255,1/255]),xoffset:"xoffset"in o?o.xoffset:0,yoffset:"yoffset"in o?o.yoffset:0})),f(e))}):f(e)}get _updateContext(){const{layerView:{layer:e},highlightGraphics:r,highlightGraphicUpdated:t}=this;return t&&(r!=null&&r.length)&&e.capabilities.operations.supportsQuery?{highlightGraphicUpdated:t,highlightGraphics:r}:null}get highlightFeaturesActive(){return!!this._updateContext}async _updateHighlightedFeaturesGeometries(e){this._highlightGeometriesResolution=e;const r=this._updateContext;if(!r)return;const t=this._getTargetResolution(e),i=new Map,{highlightGraphics:s,highlightGraphicUpdated:f}=r;for(const l of s)if(!this._featuresResolutions.has(l)||this._featuresResolutions.get(l)>t){const h=l.sourceLayer;me(i,h,()=>new Map).set(l.getObjectId(),l)}const{layerView:{view:o}}=this,y=Array.from(i,([l,h])=>{const p=l.createQuery();return p.objectIds=[...h.keys()],p.outFields=[l.objectIdField],p.returnGeometry=!0,p.maxAllowableOffset=t,p.outSpatialReference=o.spatialReference,l.queryFeatures(p)}),c=await Promise.all(y);if(!this.destroyed)for(const{features:l}of c)for(const h of l){const p=h.sourceLayer,w=i.get(p).get(h.getObjectId());if(w&&s.includes(w)){const S=w.geometry;w.geometry=h.geometry,f({graphic:w,property:"geometry",oldValue:S,newValue:w.geometry}),this._featuresResolutions.set(w,t)}}}_getTargetResolution(e){const r=e*ge(this.layerView.view.spatialReference),t=r/16;return t<=10?0:e/r*t}async _fetchPopupFeaturesUsingIdentify(e,r,t){const i=await this._createIdentifyParameters(e,r,t);if(i==null)return[];const{results:s}=await je(this.layerView.layer.parsedUrl,i,t);return s.map(f=>f.feature)}async _createIdentifyParameters(e,r,t){const{floors:i,layer:s,timeExtent:f,view:{spatialReference:o,scale:y}}=this.layerView;if(!r.length)return null;await Promise.all(r.map(({sublayer:S})=>S.load(t).catch(()=>{})));const c=Math.min(we("mapservice-popup-identify-max-tolerance"),s.allSublayers.reduce((S,_)=>_.renderer?T({renderer:_.renderer,pointerType:t==null?void 0:t.pointerType}):S,2)),l=this.createFetchPopupFeaturesQueryGeometry(e,c),h=be(y,o),p=Math.round(l.width/h),w=new B({xmin:l.center.x-h*p,ymin:l.center.y-h*p,xmax:l.center.x+h*p,ymax:l.center.y+h*p,spatialReference:l.spatialReference});return new z({floors:i,gdbVersion:"gdbVersion"in s?s.gdbVersion:void 0,geometry:e,height:p,layerOption:"popup",mapExtent:w,returnGeometry:!0,spatialReference:o,sublayers:s.sublayers,timeExtent:f,tolerance:c,width:p})}async _fetchPopupFeaturesUsingQueries(e,r,t){const{layerView:{floors:i,timeExtent:s}}=this,f=r.map(async({sublayer:o,popupTemplate:y})=>{var E,O,b;if(await o.load(t).catch(()=>{}),o.capabilities&&!o.capabilities.operations.supportsQuery)return[];const c=o.createQuery(),l=T({renderer:o.renderer,pointerType:t==null?void 0:t.pointerType}),h=this.createFetchPopupFeaturesQueryGeometry(e,l),p=new Set,[w]=await Promise.all([Fe(o,y),(E=o.renderer)==null?void 0:E.collectRequiredFields(p,o.fieldsIndex)]);L(t),ve(p,o.fieldsIndex,w);const S=Array.from(p).sort();c.geometry=h,c.outFields=S,c.timeExtent=s;const _=U(i,o);if(c.where=H(c.where,_),((O=o.capabilities)==null?void 0:O.query.supportsOrderBy)&&((b=o.orderBy)==null?void 0:b[0])){const $=o.orderBy[0],G=!$.valueExpression&&$.field,j=$.order==="ascending"?"asc":"desc";G&&(c.orderByFields=[`${G} ${j}`])}const m=this._getTargetResolution(h.width/l),P=await Ae(y);L(t);const v=o.geometryType==="point"||P&&P.arcadeUtils.hasGeometryOperations(y);v||(c.maxAllowableOffset=m);let{features:g}=await o.queryFeatures(c,t);const x=v?0:m;g=await Te(o,g,t);for(const $ of g)this._featuresResolutions.set($,x);return g});return(await Promise.allSettled(f)).reduce((o,y)=>y.status==="fulfilled"?[...o,...y.value]:o,[]).filter(xe)}};function Ue(a,e,r){const t=[];if(!a)return t;const i=s=>{const f=s.minScale===0||e<=s.minScale,o=s.maxScale===0||e>=s.maxScale;if(s.visible&&f&&o){if(s.sublayers)s.sublayers.forEach(i);else if(s.popupEnabled){const y=Pe(s,{...r,defaultPopupTemplateEnabled:!1});y!=null&&t.unshift({sublayer:s,popupTemplate:y})}}};return a.map(i),t}function Ae(a){var e;return(e=a.expressionInfos)!=null&&e.length||Array.isArray(a.content)&&a.content.some(r=>r.type==="expression")?Se():Promise.resolve()}async function Me(a,e){var r,t;if((t=(r=a.capabilities)==null?void 0:r.operations)!=null&&t.supportsQuery)return!0;try{return await Promise.any(e.map(({sublayer:i})=>i.load().then(()=>i.capabilities.operations.supportsQuery)))}catch{return!1}}async function Te(a,e,r){const t=a.renderer;return t&&"defaultSymbol"in t&&!t.defaultSymbol&&(e=t.valueExpression?await Promise.all(e.map(i=>t.getSymbolAsync(i,r).then(s=>s?i:null))).then(i=>i.filter(s=>s!=null)):e.filter(i=>t.getSymbol(i)!=null)),e}n([u({constructOnly:!0})],V.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),n([u({constructOnly:!0})],V.prototype,"layerView",void 0),n([u({constructOnly:!0})],V.prototype,"highlightGraphics",void 0),n([u({constructOnly:!0})],V.prototype,"highlightGraphicUpdated",void 0),n([u({constructOnly:!0})],V.prototype,"updatingHandles",void 0),n([u()],V.prototype,"_updateContext",null),V=n([R("esri.views.layers.support.MapServiceLayerViewHelper")],V);export{V as P,qe as S};
