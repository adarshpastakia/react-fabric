import{c9 as p,k4 as C,ck as Te,k6 as v,k8 as De,M as de,aj as xe,k9 as ue,ka as Ee,cm as he,cb as R,kb as X,kc as Ne,e0 as Ae,kd as ve,_ as Se}from"./ShadowCastClear.glsl.js";import{t as Le,l as $}from"./arcade2.js";import{o as E,i as ke,c as ee,B as S,p as U,g as N,Z as Ce,K as ce,f as me,X as pe,z as Z,A as G,H as B,t as _,L as Ze,S as V,h as Pe,Y as q}from"./Dictionary.js";import{I as Re}from"./Feature.js";import{v as Ue,R as ye,y as je,h as ne,e as Me,i as Oe,s as ze,F as J,E as He,k as We,O as _e,a as W,I as Ge,D as Q,b as P,x as te}from"./featureSetUtils.js";import{t as Ve}from"./ImmutableArray.js";import{l as Ke}from"./portalUtils.js";import{s as Be,v as we}from"./SpatialFilter.js";import{L as T}from"./WhereClause.js";import{queryAssociations as qe}from"./queryAssociations.js";import"./iframe-DwvN93Ge.js";import"./index.js";import"./Viewport.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";import"./debounce.js";import"./index2.js";import"./arcadeEnvironment.js";import"./aiServices.js";import"./commonProperties.js";import"./unitConversion.js";import"./number.js";import"./hash.js";import"./operatorsWorkerConnection.js";import"./Association.js";function Qe(i){if(i.length===1){if(v(i[0]))return $("distinct",i[0],-1);if(_(i[0]))return $("distinct",i[0].toArray(),-1)}return $("distinct",i,-1)}function ie(i,y,n){const a=i.getVariables();if(a.length>0){const I={};for(const h of a)I[h]=y.evaluateIdentifier(n,{name:h});i.parameters=I}return i}function u(i,y,n=null){for(const a in i)if(a.toLowerCase()===y.toLowerCase())return i[a];return n}function Ie(i){if(i===null)return null;const y={type:u(i,"type",""),name:u(i,"name","")};if(y.type==="range")y.range=u(i,"range",[]);else{y.codedValues=[];for(const n of u(i,"codedValues",[]))y.codedValues.push({name:u(n,"name",""),code:u(n,"code",null)})}return y}function ae(i){if(i===null)return null;const y={},n=u(i,"wkt");n!==null&&(y.wkt=n);const a=u(i,"wkid");return a!==null&&(y.wkid=a),y}function ge(i){if(i===null)return null;const y={hasZ:u(i,"hasz",!1),hasM:u(i,"hasm",!1)},n=u(i,"spatialreference");n!=null&&(y.spatialReference=ae(n));const a=u(i,"x",null);if(a!==null)return y.x=a,y.y=u(i,"y",null),y.hasZ&&(y.z=u(i,"z",null)),y.hasM&&(y.m=u(i,"m",null)),y;const I=u(i,"rings",null);if(I!==null)return y.rings=I,y;const h=u(i,"paths",null);if(h!==null)return y.paths=h,y;const e=u(i,"points",null);if(e!==null)return y.points=e,y;for(const t of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const l=u(i,t,null);l!==null&&(y[t]=l)}return y}function Je(i,y){for(const n of y)if(n===i)return!0;return!1}function Ye(i){return!!i.layerDefinition&&!!i.featureSet&&Je(i.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&v(i.layerDefinition.fields)!==!1&&v(i.featureSet.features)!==!1}function K(i){return(i==null?void 0:i.toLowerCase())==="utc"?"UTC":(i==null?void 0:i.toLowerCase())==="unknown"?"Unknown":i}async function Xe(i,y,n,a,I,h,e){var f,c,D;const t=await i.getFeatureSetInfo();if(((t==null?void 0:t.layerId)??null)===null||!I.layerIdLookup.get(t.layerId))return null;const l=i.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),o=[];switch(n){case"connected":o.push("connectivity"),o.push("junction-edge-from-connectivity"),o.push("junction-edge-to-connectivity"),o.push("junction-edge-midspan-connectivity"),o.push("junction-junction-connectivity");break;case"container":case"content":o.push("containment");break;case"structure":case"attached":o.push("attachment");break;case"junctionedge":o.push("junction-edge-from-connectivity"),o.push("junction-edge-to-connectivity");break;case"midspan":o.push("junction-edge-midspan-connectivity");break;default:throw new p(h,"InvalidParameter",e)}let m=null,d=!1;if(a!==null&&a!==""&&a!==void 0){for(const w of I.terminals)w.terminalName===a&&(m=w.terminalId);m===null&&(d=!0)}const s=[];if(!d){const w=new Ae({globalId:y.field(i.globalIdField),networkSourceId:I.layerIdLookup.get(t.layerId).sourceId,...m?{terminalId:m}:""}),b=await qe(l,new ve({types:o,elements:[w]}));let x=0;for(const A of b.associations){let j=null,M="",L="";if(((f=A.fromNetworkElement)==null?void 0:f.globalId)===w.globalId?(j=A.toNetworkElement,L="to"):((c=A.toNetworkElement)==null?void 0:c.globalId)===w.globalId&&(j=A.fromNetworkElement,L="from"),!j)continue;switch(n){case"attached":if(A.associationType!=="attachment"||L!=="to")continue;break;case"structure":if(A.associationType!=="attachment"||L!=="from")continue;break;case"container":if(A.associationType!=="containment"||L!=="from")continue;break;case"content":if(A.associationType!=="containment"||L!=="to")continue;break;case"connected":break;case"junctionedge":A.associationType==="junction-edge-to-connectivity"?M="to":A.associationType==="junction-edge-from-connectivity"&&(M="from");break;case"midspan":if(A.associationType!=="junction-edge-midspan-connectivity")continue}const O=((D=I.sourceIdLookup.get(j.networkSourceId))==null?void 0:D.className)??"";s.push(new Se({geometry:null,attributes:{objectId:x++,globalId:j.globalId,percentAlong:A.percentAlong??0,isContentVisible:A.isContentVisible?0:1,className:O,side:M}}))}}const r=new he({source:s,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new R({name:"objectId",alias:"objectId",type:"oid"}),new R({name:"globalId",alias:"globalId",type:"global-id"}),new R({name:"percentAlong",alias:"percentAlong",type:"double"}),new R({name:"side",alias:"side",type:"string"}),new R({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new R({name:"className",alias:"className",type:"string"})]});return J(r)}function vn(i){if(i.mode==="async"){i.functions.timezone=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{var o,m;if(E(e,1,2,n,a),ke(e[0])||ee(e[0]))return"Unknown";if(S(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?K("unknown"):K(e[0].dateFieldsTimeZone);if(!(e[1]instanceof U)||e[1].hasField("type")===!1)throw new p(n,"InvalidParameter",a);const d=e[1].field("type");if(C(d)===!1)throw new p(n,"InvalidParameter",a);switch(N(d).toLowerCase()){case"preferredtimezone":return K(e[0].preferredTimeZone);case"editfieldsinfo":return K(((o=e[0].editFieldsInfo)==null?void 0:o.timeZone)??null);case"timeinfo":return K(((m=e[0].timeInfo)==null?void 0:m.timeZone)??null);case"field":if(e[1].hasField("fieldname")&&C(e[1].field("fieldname")))return K(e[0].fieldTimeZone(N(e[1].field("fieldname"))))}throw new p(n,"InvalidParameter",a)}const t=Ce(e[0],ce(n));if(t===null)return null;const l=t.timeZone;return l==="system"?Te.systemTimeZoneCanonicalName:l.toLowerCase()==="utc"?"UTC":l.toLowerCase()==="unknown"?"Unknown":l})},i.functions.sqltimestamp=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{E(e,1,3,n,a);const t=e[0];if(me(t)){if(e.length===1)return t.toSQLWithKeyword();if(e.length===2)return t.changeTimeZone(N(e[1])).toSQLWithKeyword();throw new p(n,"InvalidParameter",a)}if(ee(t))return t.toSQLWithKeyword();if(S(t)){if(e.length!==3)throw new p(n,"InvalidParameter",a);await t.load();const l=N(e[1]);if(ee(e[2]))return e[2].toSQLWithKeyword();if(me(e[2])===!1)throw new p(n,"InvalidParameter",a);const o=t.fieldTimeZone(l);return o==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(o).toSQLWithKeyword()}throw new p(n,"InvalidParameter",a)})},i.signatures.push({name:"sqltimestamp",min:2,max:4}),i.functions.featuresetbyid=function(n,a){return i.standardFunctionAsync(n,a,(I,h,e)=>{if(E(e,2,4,n,a),pe(e[0])){const t=N(e[1]);let l=Z(e[2],null);const o=G(Z(e[3],!0));if(l===null&&(l=["*"]),v(l)===!1)throw new p(n,"InvalidParameter",a);return e[0].featureSetById(t,o,l)}throw new p(n,"InvalidParameter",a)})},i.signatures.push({name:"featuresetbyid",min:2,max:4});const y=new De(["datasource","parent","root"]);i.functions.getfeatureset=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{if(E(e,1,2,n,a),B(e[0])){const t=e[1]==null?"datasource":y.lookup(N(e[1]));return Ue(e[0].fullSchema(),t,n.lrucache,n.interceptor,n.spatialReference)}throw new p(n,"InvalidParameter",a)})},i.signatures.push({name:"getfeatureset",min:1,max:2}),i.functions.featuresetbyportalitem=function(n,a){return i.standardFunctionAsync(n,a,(I,h,e)=>{var d,s;if(E(e,2,5,n,a),e[0]===null)throw new p(n,"PortalRequired",a);if(e[0]instanceof Le){const r=N(e[1]),f=N(e[2]);let c=Z(e[3],null);const D=G(Z(e[4],!0));if(c===null&&(c=["*"]),v(c)===!1)throw new p(n,"InvalidParameter",a);let w;return w=(d=n.services)!=null&&d.portal?n.services.portal:de.getDefault(),w=Ke(e[0],w),ye(r,f,n.spatialReference,c,D,w,n.lrucache,n.interceptor)}if(C(e[0])===!1)throw new p(n,"PortalRequired",a);const t=N(e[0]),l=N(e[1]);let o=Z(e[2],null);const m=G(Z(e[3],!0));if(o===null&&(o=["*"]),v(o)===!1)throw new p(n,"InvalidParameter",a);return ye(t,l,n.spatialReference,o,m,((s=n.services)==null?void 0:s.portal)??de.getDefault(),n.lrucache,n.interceptor)})},i.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),i.functions.featuresetbyname=function(n,a){return i.standardFunctionAsync(n,a,(I,h,e)=>{if(E(e,2,4,n,a),pe(e[0])){const t=N(e[1]);let l=Z(e[2],null);const o=G(Z(e[3],!0));if(l===null&&(l=["*"]),v(l)===!1)throw new p(n,"InvalidParameter",a);return e[0].featureSetByName(t,o,l)}throw new p(n,"InvalidParameter",a)})},i.signatures.push({name:"featuresetbyname",min:2,max:4}),i.functions.featureset=function(n,a){return i.standardFunction(n,a,(I,h,e)=>{E(e,1,1,n,a);const t={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(C(e[0])){const l=JSON.parse(e[0]);l.layerDefinition!==void 0?(t.layerDefinition=l.layerDefinition,t.featureSet=l.featureSet,l.layerDefinition.spatialReference&&(t.layerDefinition.spatialReference=l.layerDefinition.spatialReference)):(t.featureSet.features=l.features,t.featureSet.geometryType=l.geometryType,t.layerDefinition.geometryType=t.featureSet.geometryType,t.layerDefinition.objectIdField=l.objectIdFieldName??"",t.layerDefinition.typeIdField=l.typeIdFieldName,t.layerDefinition.globalIdField=l.globalIdFieldName,t.layerDefinition.fields=l.fields,l.spatialReference&&(t.layerDefinition.spatialReference=l.spatialReference))}else{if(!(e[0]instanceof U))throw new p(n,"InvalidParameter",a);{const l=JSON.parse(e[0].castToText(!0)),o=u(l,"layerdefinition");if(o!==null){t.layerDefinition.geometryType=u(o,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.globalIdField=u(o,"globalidfield",""),t.layerDefinition.objectIdField=u(o,"objectidfield",""),t.layerDefinition.typeIdField=u(o,"typeidfield",""),t.layerDefinition.hasZ=u(o,"hasz",!1)===!0,t.layerDefinition.hasM=u(o,"hasm",!1)===!0;const m=u(o,"spatialreference");m&&(t.layerDefinition.spatialReference=ae(m));const d=[];for(const r of u(o,"fields",[])){const f={name:u(r,"name",""),alias:u(r,"alias",""),type:u(r,"type",""),nullable:u(r,"nullable",!0),editable:u(r,"editable",!0),length:u(r,"length",null),domain:Ie(u(r,"domain"))};d.push(f)}t.layerDefinition.fields=d;const s=u(l,"featureset");if(s){const r={};for(const f of d)r[f.name.toLowerCase()]=f.name;for(const f of u(s,"features",[])){const c={},D=u(f,"attributes",{});for(const w in D)c[r[w.toLowerCase()]]=D[w];t.featureSet.features.push({attributes:c,geometry:ge(u(f,"geometry"))})}}}else{t.layerDefinition.hasZ=u(l,"hasz",!1)===!0,t.layerDefinition.hasM=u(l,"hasm",!1)===!0,t.layerDefinition.geometryType=u(l,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.objectIdField=u(l,"objectidfieldname",""),t.layerDefinition.typeIdField=u(l,"typeidfieldname","");const m=u(l,"spatialreference");m&&(t.layerDefinition.spatialReference=ae(m));const d=[],s=u(l,"fields",null);if(!v(s))throw new p(n,"InvalidParameter",a);for(const c of s){const D={name:u(c,"name",""),alias:u(c,"alias",""),type:u(c,"type",""),nullable:u(c,"nullable",!0),editable:u(c,"editable",!0),length:u(c,"length",null),domain:Ie(u(c,"domain"))};d.push(D)}t.layerDefinition.fields=d;const r={};for(const c of d)r[c.name.toLowerCase()]=c.name;let f=u(l,"features",null);if(v(f))for(const c of f){const D={},w=u(c,"attributes",{});for(const b in w)D[r[b.toLowerCase()]]=w[b];t.featureSet.features.push({attributes:D,geometry:ge(u(c,"geometry",null))})}else f=null,t.featureSet.features=f}}}if(Ye(t)===!1)throw new p(n,"InvalidParameter",a);return t.layerDefinition.geometryType||(t.layerDefinition.geometryType="esriGeometryNull"),je.create(t,n.spatialReference)})},i.signatures.push({name:"featureset",min:1,max:1}),i.functions.filter=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{if(E(e,2,2,n,a),v(e[0])||_(e[0])){const t=[];let l,o=e[0];if(o instanceof Ve&&(o=o.toArray()),!Ze(e[1]))throw new p(n,"InvalidParameter",a);l=e[1].createFunction(n);for(const m of o){const d=l(m);xe(d)?await d===!0&&t.push(m):d===!0&&t.push(m)}return t}if(S(e[0])){const t=await e[0].load(),l=T.create(e[1],{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),o=l.getVariables();if(o.length>0){const m={};for(const d of o)m[d]=i.evaluateIdentifier(n,{name:d});l.parameters=m}return new ne({parentfeatureset:e[0],whereclause:l})}throw new p(n,"InvalidParameter",a)})},i.signatures.push({name:"filter",min:2,max:2}),i.functions.orderby=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{if(E(e,2,2,n,a),S(e[0])){const t=new Me(e[1]);return new Oe({parentfeatureset:e[0],orderbyclause:t})}throw new p(n,"InvalidParameter",a)})},i.signatures.push({name:"orderby",min:2,max:2}),i.functions.top=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{if(E(e,2,2,n,a),S(e[0]))return new ze({parentfeatureset:e[0],topnum:e[1]});if(v(e[0]))return V(e[1])>=e[0].length?e[0].slice():e[0].slice(0,V(e[1]));if(_(e[0]))return V(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,V(e[1]));throw new p(n,"InvalidParameter",a)})},i.signatures.push({name:"top",min:2,max:2}),i.functions.first=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{if(E(e,1,1,n,a),S(e[0])){const t=await e[0].first(I.abortSignal);if(t!==null){const l=Re.createFromGraphicLikeObject(t.geometry,t.attributes,e[0],n.timeZone);return l._underlyingGraphic=t,l}return t}return v(e[0])?e[0].length===0?null:e[0][0]:_(e[0])?e[0].length()===0?null:e[0].get(0):null})},i.signatures.push({name:"first",min:1,max:1}),i.functions.attachments=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{E(e,1,2,n,a);const t={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof U){if(e[1].hasField("minsize")&&(t.minsize=V(e[1].field("minsize"))),e[1].hasField("metadata")&&(t.returnMetadata=G(e[1].field("metadata"))),e[1].hasField("maxsize")&&(t.maxsize=V(e[1].field("maxsize"))),e[1].hasField("types")){const l=Pe(e[1].field("types"),!1);l.length>0&&(t.types=l)}}else if(e[1]!==null)throw new p(n,"InvalidParameter",a)}if(B(e[0])){const l=e[0]._layer;let o;if(S(l))o=l;else{if(l==null||!ue(l))return[];o=J(l,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)}return await o.load(),o.queryAttachments(e[0].field(o.objectIdField),t.minsize,t.maxsize,t.types,t.returnMetadata)}if(e[0]===null)return[];throw new p(n,"InvalidParameter",a)})},i.signatures.push({name:"attachments",min:1,max:2}),i.functions.featuresetbyrelationshipname=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{E(e,2,4,n,a);const t=e[0],l=N(e[1]);let o=Z(e[2],null);const m=G(Z(e[3],!0));if(o===null&&(o=["*"]),v(o)===!1)throw new p(n,"InvalidParameter",a);if(e[0]===null)return null;if(!B(e[0]))throw new p(n,"InvalidParameter",a);const d=t._layer;let s;if(S(d))s=d;else{if(d==null||!ue(d))return null;s=J(d,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)}s=await s.load();const r=s.relationshipMetaData().filter(b=>b.name===l);if(r.length===0)return null;if(r[0].relationshipTableId!==void 0&&r[0].relationshipTableId!==null&&r[0].relationshipTableId>-1)return He(s,r[0],t.field(s.objectIdField),s.spatialReference,o,m,n.lrucache,n.interceptor);let f=s.serviceUrl();if(!f)return null;f=f.endsWith("/")?f+r[0].relatedTableId.toString():f+"/"+r[0].relatedTableId.toString();const c=await We(f,s.spatialReference,o,m,n.lrucache,n.interceptor);await c.load();let D=c.relationshipMetaData();if(D=D.filter(b=>b.id===r[0].id),t.hasField(r[0].keyField)===!1||t.field(r[0].keyField)===null){const b=await s.getFeatureByObjectId(t.field(s.objectIdField),[r[0].keyField]);if(b){const x=T.create(D[0].keyField+"= @id",{fieldsIndex:c.getFieldsIndex(),timeZone:c.dateFieldsTimeZoneDefaultUTC});return x.parameters={id:b.attributes[r[0].keyField]},c.filter(x)}return new Be({parentfeatureset:c})}const w=T.create(D[0].keyField+"= @id",{fieldsIndex:c.getFieldsIndex(),timeZone:c.dateFieldsTimeZoneDefaultUTC});return w.parameters={id:t.field(r[0].keyField)},c.filter(w)})},i.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),i.functions.featuresetbyassociation=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{E(e,2,3,n,a);const t=e[0],l=Ee(N(Z(e[1],""))),o=C(e[2])?N(e[2]):null;if(e[0]===null)return null;if(!B(e[0]))throw new p(n,"InvalidParameter",a);let m=t._layer;if(m instanceof he&&(m=J(m,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),m===null||S(m)===!1)return null;await m.load();const d=m.serviceUrl(),s=await _e(d,n.spatialReference,!0);if(s.unVersion>=8)return await Xe(m,t,l,o,s,n,a);const r=s.associations;let f=null,c=null,D=!1;if(o!==null&&o!==""&&o!==void 0){for(const F of s.terminals)F.terminalName===o&&(c=F.terminalId);c===null&&(D=!0)}const w=r.getFieldsIndex(),b=w.get("TOGLOBALID").name,x=w.get("FROMGLOBALID").name,A=w.get("TOTERMINALID").name,j=w.get("FROMTERMINALID").name,M=w.get("FROMNETWORKSOURCEID").name,L=w.get("TONETWORKSOURCEID").name,O=w.get("ASSOCIATIONTYPE").name,Fe=w.get("ISCONTENTVISIBLE").name,be=w.get("OBJECTID").name;for(const F of m.fields)if(F.type==="global-id"){f=t.field(F.name);break}let z=null,re=new W(new R({name:"percentalong",alias:"percentalong",type:"double"}),T.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),le=new W(new R({name:"side",alias:"side",type:"string"}),T.create("''",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));const k="globalid",oe="globalId",se={};for(const F in s.lkp)se[F]=s.lkp[F].sourceId;const H=new Ge(new R({name:"classname",alias:"classname",type:"string"}),null,se);let g="";switch(l){case"midspan":{g=`((${b}='${f}') OR ( ${x}='${f}')) AND (${O} IN (5))`,H.codefield=T.create(`CASE WHEN (${b}='${f}') THEN ${M} ELSE ${L} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const F=X(P.findField(r.fields,x));F.name=k,F.alias=k,z=new W(F,T.create(`CASE WHEN (${x}='${f}') THEN ${b} ELSE ${x} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),re=s.unVersion>=4?new te(P.findField(r.fields,w.get("PERCENTALONG").name)):new W(new R({name:"percentalong",alias:"percentalong",type:"double"}),T.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{g=`((${b}='${f}') OR ( ${x}='${f}')) AND (${O} IN (4,6))`,H.codefield=T.create(`CASE WHEN (${b}='${f}') THEN ${M} ELSE ${L} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const F=X(P.findField(r.fields,x));F.name=k,F.alias=k,z=new W(F,T.create(`CASE WHEN (${x}='${f}') THEN ${b} ELSE ${x} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),le=new W(new R({name:"side",alias:"side",type:"string"}),T.create(`CASE WHEN (${O}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let F=`${b}='@T'`,fe=`${x}='@T'`;c!==null&&(F+=` AND ${A}=@A`,fe+=` AND ${j}=@A`),g="(("+F+") OR ("+fe+"))",g=q(g,"@T",f??""),F=q(F,"@T",f??""),c!==null&&(F=q(F,"@A",c.toString()),g=q(g,"@A",c.toString())),H.codefield=T.create("CASE WHEN "+F+` THEN ${M} ELSE ${L} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const Y=X(P.findField(r.fields,x));Y.name=k,Y.alias=k,z=new W(Y,T.create("CASE WHEN "+F+` THEN ${x} ELSE ${b} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"container":g=`${b}='${f}' AND ${O} = 2`,c!==null&&(g+=` AND ${A} = `+c.toString()),H.codefield=M,g="( "+g+" )",z=new Q(P.findField(r.fields,x),k,k);break;case"content":g=`(${x}='${f}' AND ${O} = 2)`,c!==null&&(g+=` AND ${j} = `+c.toString()),H.codefield=L,g="( "+g+" )",z=new Q(P.findField(r.fields,b),k,k);break;case"structure":g=`(${b}='${f}' AND ${O} = 3)`,c!==null&&(g+=` AND ${A} = `+c.toString()),H.codefield=M,g="( "+g+" )",z=new Q(P.findField(r.fields,x),k,oe);break;case"attached":g=`(${x}='${f}' AND ${O} = 3)`,c!==null&&(g+=` AND ${j} = `+c.toString()),H.codefield=L,g="( "+g+" )",z=new Q(P.findField(r.fields,b),k,oe);break;default:throw new p(n,"InvalidParameter",a)}return D&&(g="1 <> 1"),new P({parentfeatureset:r,adaptedFields:[new te(P.findField(r.fields,be)),new te(P.findField(r.fields,Fe)),z,le,H,re],extraFilter:g?T.create(g,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}):null})})},i.signatures.push({name:"featuresetbyassociation",min:2,max:6}),i.functions.groupby=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{if(E(e,3,3,n,a),!S(e[0]))throw new p(n,"InvalidParameter",a);const t=await e[0].load(),l=[],o=[];let m=!1,d=[];if(C(e[1]))d.push(e[1]);else if(e[1]instanceof U)d.push(e[1]);else if(v(e[1]))d=e[1];else{if(!_(e[1]))throw new p(n,"InvalidParameter",a);d=e[1].toArray()}for(const s of d)if(C(s)){const r=T.create(N(s),{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),f=we(r)===!0?N(s):"%%%%FIELDNAME";l.push({name:f,expression:r}),f==="%%%%FIELDNAME"&&(m=!0)}else{if(!(s instanceof U))throw new p(n,"InvalidParameter",a);{const r=s.hasField("name")?s.field("name"):"%%%%FIELDNAME",f=s.hasField("expression")?s.field("expression"):"";if(r==="%%%%FIELDNAME"&&(m=!0),!r)throw new p(n,"InvalidParameter",a);l.push({name:r,expression:T.create(f||r,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(d=[],C(e[2]))d.push(e[2]);else if(v(e[2]))d=e[2];else if(_(e[2]))d=e[2].toArray();else{if(!(e[2]instanceof U))throw new p(n,"InvalidParameter",a);d.push(e[2])}for(const s of d){if(!(s instanceof U))throw new p(n,"InvalidParameter",a);{const r=s.hasField("name")?s.field("name"):"",f=s.hasField("statistic")?s.field("statistic"):"",c=s.hasField("expression")?s.field("expression"):"";if(!(r&&f&&C(f)&&c))throw new p(n,"InvalidParameter",a);o.push({name:r,statistic:f,expression:T.create(c,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(m){const s={};for(const f of t.fields)s[f.name.toLowerCase()]=1;for(const f of l)f.name!=="%%%%FIELDNAME"&&(s[f.name.toLowerCase()]=1);for(const f of o)f.name!=="%%%%FIELDNAME"&&(s[f.name.toLowerCase()]=1);let r=0;for(const f of l)if(f.name==="%%%%FIELDNAME"){for(;s["field_"+r.toString()]===1;)r++;s["field_"+r.toString()]=1,f.name="FIELD_"+r.toString()}}for(const s of l)ie(s.expression,i,n);for(const s of o)ie(s.expression,i,n);return e[0].groupby(l,o)})},i.signatures.push({name:"groupby",min:3,max:3}),i.functions.distinct=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{if(S(e[0])){E(e,2,2,n,a);const t=await e[0].load(),l=[];let o=[];if(C(e[1]))o.push(e[1]);else if(e[1]instanceof U)o.push(e[1]);else if(v(e[1]))o=e[1];else{if(!_(e[1]))throw new p(n,"InvalidParameter",a);o=e[1].toArray()}let m=!1;for(const d of o)if(C(d)){const s=T.create(N(d),{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),r=we(s)===!0?N(d):"%%%%FIELDNAME";l.push({name:r,expression:s}),r==="%%%%FIELDNAME"&&(m=!0)}else{if(!(d instanceof U))throw new p(n,"InvalidParameter",a);{const s=d.hasField("name")?d.field("name"):"%%%%FIELDNAME",r=d.hasField("expression")?d.field("expression"):"";if(s==="%%%%FIELDNAME"&&(m=!0),!s)throw new p(n,"InvalidParameter",a);l.push({name:s,expression:T.create(r||s,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(m){const d={};for(const r of t.fields)d[r.name.toLowerCase()]=1;for(const r of l)r.name!=="%%%%FIELDNAME"&&(d[r.name.toLowerCase()]=1);let s=0;for(const r of l)if(r.name==="%%%%FIELDNAME"){for(;d["field_"+s.toString()]===1;)s++;d["field_"+s.toString()]=1,r.name="FIELD_"+s.toString()}}for(const d of l)ie(d.expression,i,n);return e[0].groupby(l,[])}return Qe(e)})},i.functions.getfeaturesetinfo=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{if(E(e,1,1,n,a),!S(e[0]))return null;const t=await e[0].getFeatureSetInfo();return t?U.convertObjectToArcadeDictionary({layerId:t.layerId,layerName:t.layerName,itemId:t.itemId,serviceLayerUrl:t.serviceLayerUrl,webMapLayerId:t.webMapLayerId??null,webMapLayerTitle:t.webMapLayerTitle??null,className:null,objectClassId:null},ce(n),!1,!1):null})},i.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),i.functions.filterbysubtypecode=function(n,a){return i.standardFunctionAsync(n,a,async(I,h,e)=>{if(E(e,2,2,n,a),S(e[0])){const t=await e[0].load(),l=e[1];if(!Ne(l))throw new p(n,"InvalidParameter",a);if(t.subtypeField){const m=T.create(`${t.subtypeField}= ${e[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new ne({parentfeatureset:e[0],whereclause:m})}if(t.typeIdField===null||t.typeIdField==="")throw new p(n,"FeatureSetDoesNotHaveSubtypes",a);const o=T.create(`${t.typeIdField}= ${e[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new ne({parentfeatureset:e[0],whereclause:o})}throw new p(n,"InvalidParameter",a)})},i.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{vn as registerFunctions};
