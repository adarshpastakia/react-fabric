import{eU as y,b8 as te,fd as B,sA as Q,hn as S,gD as Qt,gE as Ft,gC as Pt,fW as he,bJ as p,fe as G,fa as ue,GB as Xt,GC as Kt,GM as Ve,go as pe,fi as P,g2 as We,bK as X,bL as k,b6 as Me,a5 as He,fb as q,fV as Yt,gQ as Be,hi as Jt,E as l,F as d,V as ie,mB as ye,bl as F,f0 as At,GN as be,wl as Et,sC as Se,bI as K,wN as ze,bM as Zt,bj as M,b5 as x,mY as Le,gM as ei,t6 as Ie,sz as Ue,wQ as Je,p5 as me,GO as N,wL as ti,qc as ve,h9 as ii,qh as si,mt as ai,bo as le,bx as ri,f8 as je,FU as oi,yW as ni,g8 as Ze,f7 as li,h$ as hi,ar as ci,hy as di,fz as qe,er as we,bk as Ht,ui as et,yk as ui,ha as pi,bn as vi,zu as wi,l9 as fi,l8 as mi,yj as gi,hl as zt,ed as _i,qf as Vi,sQ as bi,ms as tt,dF as Mi,GP as it,GQ as yi,GR as Si,GS as Di,ap as Oi,EV as Ti,GT as $i,GU as xi,GV as Ri,wn as Lt,ob as It,F1 as ke,mX as st,wh as Ci,GW as Fi,GX as Pi,GY as Ai,GZ as Ei,FA as at,Gc as Oe,FC as Te,F3 as Hi,F4 as rt,G_ as ot,G$ as zi,H0 as Li,F5 as Ii,F6 as Ui,H1 as ji,F7 as ki,Gu as Gi,Fc as Ni,H2 as Wi,O as Bi,H3 as $e,mC as qi,nb as Qi,mV as Xi,na as nt,gz as Ki,l as Yi,ec as Ji,kh as Zi,gL as es,me as ts,uD as is,f6 as ss,H4 as as}from"./ShadowCastClear.glsl.js";import{s as rs,I as os}from"./featureReferenceUtils.js";import{e as ns}from"./AnalysisView3D.js";import{w as ls,j as hs,t as re,Y as De,g as cs,o as ds,p as se,a as us}from"./ShadedColorMaterial.glsl.js";import{P as lt,D as ps}from"./dragEventPipeline3D.js";import{u as vs}from"./Viewshed.js";import{y as Ut,o as jt,a as ws,p as fs}from"./MoveManipulation.js";import{p as _e,R as ms,h as xe,f as gs}from"./InteractiveToolBase.js";import{s as Qe}from"./sliceToolConfig.js";import{m as kt}from"./ColorMaterial.glsl.js";import{g as _s}from"./EditGeometryOperations.js";import{b as Vs}from"./settings.js";import{G as bs}from"./ExtendedLineVisualElement.js";import{c as Ms}from"./LaserlinePath.glsl.js";import{o as ys,m as Ss,f as Ds,d as ht}from"./analysisViewUtils.js";import{o as Os}from"./ToolIntersector.js";import{x as Ts}from"./PointVisualElement.js";import{h as $s}from"./lineStippleUtils.js";import{b6 as xs}from"./iframe-DpfJK_wQ.js";import"./index.js";import"./Viewport.js";import"./debounce.js";import"./index2.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";import"./AnalysisView.js";import"./VisualElement.js";import"./line.js";import"./TriangleMaterial.js";import"./geometry2dUtils.js";import"./rotate.js";import"./curveOperationUtils.js";import"./EngineVisualElement.js";const ct=2,Rs=4,Gt=y(2),Cs=1.5;let Fs=class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=Rs,this.fovFocusedArcWidth=ct*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=ct/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(t){return t?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(t){return this.scaleOrientArrowTipLength*(t?this.scaleOrientArrowTipFocusMultiplier:1)}};const H=new Fs;class Ps{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new te([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:te.toUnitRGBA(new te([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:1,cullFace:2,writeDepth:!1}}}const J=new Ps;function Xe({tiltedUpVector:i,rightVector:t,observerRenderSpace:e},s){const a=ls(i,t,e,s);return a[12]=0,a[13]=0,a[14]=0,a}function Ge(i,t,e,s){const a=p(),r=Qt(e.plane),o=As(t,r);let n;if(Math.abs(o)>H.viewAngleThreshold)n=i.next(lt(t,e.plane));else{const c=Ft(s.targetRenderSpace,e.basis1,Pt()),h=he(Nt,e.basis1),u=he(Es,e.basis2);n=i.next(lt(t,c)).next(v=>{const w=T=>{const D=pe(P(dt,T,e.origin),u),R=Math.acos(We(D/s.farDistanceRenderSpace,-1,1)),A=Math.sin(R)*s.farDistanceRenderSpace;return X(p(),e.origin,X(p(),k(dt,h,A),k(Hs,u,D)))},f=w(v.renderStart),m=w(v.renderEnd);return{...v,renderStart:f,renderEnd:m}})}return n.next(c=>{c.action==="start"&&G(a,c.renderStart);const h=ue(hs(a,c.renderEnd,e.origin,r));return{...c,deltaAngle:h}})}function As(i,t){const e=Nt;i.renderCoordsHelper.toRenderCoords(i.camera.position,e);const s=Xt(i,e,i.camera.heading,i.camera.tilt,Kt()).direction;return ue(Ve(s,t))-90}function ee(i,t,e,s){return Q(ut,e,s),B(i,t,ut)}const Nt=p(),Es=p(),dt=p(),Hs=p(),ut=S();var Ne;let g=Ne=class extends Me{constructor(i){super(i),this.observerRenderSpaceOverride=null,this.needUpdateByFeature=!1}get observer(){return this.viewshed.observer??new He}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,p())}get target(){const i=this.targetRenderSpace;return this.renderSpaceToPoint(i,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const i=P(p(),this.targetRenderSpace,this.observerRenderSpace);return he(i,i)}get tiltedUpVector(){const i=ee(p(),this.upVector,-y(this.tiltParallelToSurface),this.leftVector);return he(i,i)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,S())}get upVector(){const i=this._basis;return q(i[8],i[9],i[10])}get northVector(){const i=this._basis;return q(i[4],i[5],i[6])}get leftVector(){const i=this.upVector,t=ee(p(),this.northVector,-y(this.heading),i);return Yt(t,i,t)}get rightVector(){return Be(p(),this.leftVector)}clone(){return new Ne({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}get valid(){return this.viewshed.valid}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(i,t,e){const{observerRenderSpace:s,targetRenderSpace:a}=this,r=P(Re,a,s);return ee(r,r,-y(t),this.leftVector),ee(r,r,-y(i),this.tiltedUpVector),X(e,r,s)}cornerPoints(i){const t=this.horizontalFieldOfView/2,e=this.verticalFieldOfView/2;this.pointOnSphere(-t,e,i.topLeft),this.pointOnSphere(t,e,i.topRight),this.pointOnSphere(-t,-e,i.bottomLeft),this.pointOnSphere(t,-e,i.bottomRight)}arcCentersPoints(i){const t=this.horizontalFieldOfView/2,e=this.verticalFieldOfView/2;this.pointOnSphere(0,e,i.top),this.pointOnSphere(0,-e,i.bottom),this.pointOnSphere(-t,0,i.left),this.pointOnSphere(t,0,i.right)}parallelCenterPoints(i){const t=this.observerRenderSpace,e=this.farDistanceRenderSpace*Math.sin(y(this.verticalFieldOfView/2)),s=k(Re,this.tiltedUpVector,e);X(i.top,t,s),P(i.bottom,t,s)}renderSpaceToPoint(i,t){const e=Re;return this.renderCoordsHelper.fromRenderCoords(i,e,t),new He(e[0],e[1],e[2],t)}_pointToRenderSpace(i,t){const e=Jt(i.toArray());return this.renderCoordsHelper.toRenderCoords(e,i.spatialReference,t),t}_computeTargetRenderSpace(i){const{leftVector:t,northVector:e,upVector:s}=this,a=this.farDistanceRenderSpace,r=p();return k(r,e,a),ee(r,r,-y(this.heading),s),ee(r,r,-y(this.tiltParallelToSurface),t),X(r,i,r),r}};l([d()],g.prototype,"renderCoordsHelper",void 0),l([d()],g.prototype,"viewshed",void 0),l([d()],g.prototype,"observerRenderSpaceOverride",void 0),l([d()],g.prototype,"needUpdateByFeature",void 0),l([d()],g.prototype,"observer",null),l([d()],g.prototype,"effectiveObserverRenderSpace",null),l([d()],g.prototype,"effectiveObserver",null),l([d()],g.prototype,"effectiveTargetRenderSpace",null),l([d()],g.prototype,"farDistance",null),l([d()],g.prototype,"farDistanceRenderSpace",null),l([d()],g.prototype,"heading",null),l([d()],g.prototype,"tilt",null),l([d()],g.prototype,"feature",null),l([d()],g.prototype,"tiltParallelToSurface",null),l([d()],g.prototype,"horizontalFieldOfView",null),l([d()],g.prototype,"verticalFieldOfView",null),l([d()],g.prototype,"observerRenderSpace",null),l([d()],g.prototype,"target",null),l([d()],g.prototype,"targetRenderSpace",null),l([d()],g.prototype,"targetDirection",null),l([d()],g.prototype,"tiltedUpVector",null),l([d()],g.prototype,"_basis",null),l([d()],g.prototype,"upVector",null),l([d()],g.prototype,"northVector",null),l([d()],g.prototype,"leftVector",null),l([d()],g.prototype,"rightVector",null),l([d()],g.prototype,"valid",null),l([d()],g.prototype,"metersPerUnit",null),g=Ne=l([ie("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],g);const Re=p();let zs=class extends Ut{constructor(t){super(),this._handles=new ye,this._tool=t.tool,this._view=t.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles=F(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(t,e){const s=Object.values(this._manipulators);return At(s.map(({manipulator:a,side:r})=>_e(a,(o,n,c,h,u)=>{const v=Gs(r,e),w=n.next(m=>({...m,manipulatorType:2,side:r})),f=Ge(w,this._view,v,e);t(o,f,c)})))}updateManipulatorsTransform(t){t.arcCentersPoints(pt),this._forEachManipulatorInfo(e=>this._updateArcManipulatorTransform(e,t,pt[e.side]))}updateManipulatorVisuals(t){this._forEachManipulatorInfo(e=>this._updateArcManipulatorVisuals(e,t))}_updateArcManipulatorVisuals({manipulator:t,side:e},s){const a=[];if(s!=null){const[r,o]=Ls(e,s,this._unfocusedArcMaterial);a.push(new re(r,1),new re(r.instantiate({material:this._focusedArcMaterial}),2)),t.collisionType={type:"line",paths:[o]}}t.renderObjects=a,t.radius=H.collisionRadius}_updateArcManipulatorTransform({manipulator:t,side:e},s,a){const r=s.horizontalFieldOfView,o=y(s.verticalFieldOfView/2),n=y(r/2),c=fe(e);t.renderLocation=a;const h=S(),u=T=>{Le(h,T,h)};u(be(oe,y(-90))),c||u(Et(oe,o));const v=s.farDistanceRenderSpace;let w,f;u(Se(oe,K(Wt,v,v,v))),u(ze(oe,js(e))),u(Xe(s,oe)),c?(w=n,f=s.tiltedUpVector):(f=s.rightVector,w=o),w*=e==="right"||e==="bottom"?-1:1;const m=Q(oe,w,f);m!=null&&u(m),t.modelTransform=h}_createManipulators(){const t=this._createArcManipulator("left"),e=this._createArcManipulator("right"),s=this._createArcManipulator("top"),a=this._createArcManipulator("bottom");this._manipulators={left:t,right:e,top:s,bottom:a},[[a.manipulator,s.manipulator],[t.manipulator,e.manipulator]].forEach(([r,o])=>{r.metadata={pairedManipulator:o},o.metadata={pairedManipulator:r}})}_createArcManipulator(t){const e=new De({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),s={manipulator:e,side:t};return this._updateArcManipulatorVisuals(s),this._handles.add(e.events.on(["focus-changed","grab-changed"],a=>{var o;const r=(o=e.metadata)==null?void 0:o.pairedManipulator;r!=null&&(r.hovering!==e.hovering&&(r.hovering=e.hovering),r.grabbing!==e.grabbing&&(r.grabbing=e.grabbing))})),s}_createArcMaterial(t){const e=H.getFovArcWidth(t),s=new Zt({renderOccluded:4,isDecoration:!0,width:e},this._view.state.isGlobal);return this._handles.add(M(()=>te.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>s.setParameters({color:a}),x)),s}forEachManipulator(t){Object.values(this._manipulators).forEach(({manipulator:e})=>t(e,2))}_forEachManipulatorInfo(t){Object.values(this._manipulators).forEach(e=>t(e))}get test(){return{manipulators:this._manipulators}}};function Ls(i,t,e){const{horizontalFieldOfView:s,verticalFieldOfView:a}=t,r=fe(i),o=y(We((r?a:s)/2,0,15)),n=Is(-o/2,o/2,r?1:Math.max(Math.sin(y(90-a/2)),.1));return[ei(e,n),n]}function Is(i,t,e,s=10){Ie(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const a=t-i;if(a<=0||e<=0)return[q(0,0,.01),q(0,0,-.01)];const r=[],o=a/s;for(let n=0;n<s;n++){let c=i+n*o;n===s-1&&(c=t);const h=Math.cos(c)*e,u=Math.sin(c)*e,v=q(h-e,0,u);r.push(v)}return r}function Us(i){switch(i){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function js(i){return Us(i)*Ns}function fe(i){return i==="left"||i==="right"}function ks(i){return i==="left"?"right":i==="right"?"left":i==="top"?"bottom":"top"}function Gs(i,{observerRenderSpace:t,targetRenderSpace:e,tiltedUpVector:s,rightVector:a,farDistanceRenderSpace:r}){const o=P(Wt,e,t),n=fe(i)?a:s,c=k(Ws,n,r);return Ue(t,o,c)}const Ns=Math.PI/2,oe=S(),Wt=p(),Ws=p(),pt={top:p(),bottom:p(),left:p(),right:p()};let Ce=class extends De{constructor(t,e){super({view:t,autoScaleRenderObjects:!1,worldSized:!1,radius:H.collisionRadius}),this._handles=new ye,this._setupManipulatorVisual(e)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(t){const e=this._createMaterial(),s=1,a=[q(0,0,0),q(0,0,s)],r=Je(e,a,t,16,!1),o=Je(e,a,t*Qe,16,!1),n=vt(!1,e,t),c=vt(!0,e,t),h=S();me(h,a[a.length-1]),N(h,h,Et(wt,Math.PI/2)),N(h,h,be(wt,Math.PI/2)),n.transformation=h,c.transformation=h,this.renderObjects=[new re(r,1),new re(o,2),new re(n,1),new re(c,2)];const u=q(0,H.getScaleOrientArrowTipLength(!0),0),v=B(u,u,h),w=[...a,v];this.collisionType={type:"line",paths:[w]}}_createMaterial(){const t=new kt({cullFace:2,renderOccluded:4,isDecoration:!0});return this._handles.add(M(()=>te.toUnitRGBA(this.view.effectiveTheme.accentColor),e=>t.setParameters({color:e}),x)),t}};function vt(i,t,e){const s=H.getScaleOrientArrowTipLength(i);let a=2*e;i&&(a*=Qe);const r=s/2;return ti(t,s,r,r,a,0)}const wt=S();let Bs=class extends Ut{constructor(t){super(),this._handles=new ye,this._tool=t.tool,this._view=t.view;const e=H.scaleOrientHandleRadius;this._manipulatorHeading=new Ce(this._view,e),this._manipulatorTilt=new Ce(this._view,e),this._manipulatorDistance=new Ce(this._view,e),this.forEachManipulator(s=>this._tool.manipulators.add(s))}destroy(){this._handles.destroy(),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(t,e){return _e(this._manipulatorHeading,(s,a,r,o,n)=>{const c=this._view,{tiltParallelToSurface:h,farDistanceRenderSpace:u,upVector:v,observerRenderSpace:w,targetRenderSpace:f,rightVector:m}=e,T=Math.sin(y(h))*u,D=X(ge,w,k(Fe,v,T)),R=P(Fe,f,D),A=k(qs,m,ve(R)),C=Ue(D,R,A),z=Ge(a,c,C,e).next(L=>({...L,manipulatorType:3}));t(s,z,r)})}createTiltDragPipeline(t,e){return _e(this._manipulatorTilt,(s,a,r,o,n)=>{const{observerRenderSpace:c,farDistanceRenderSpace:h,upVector:u,targetDirection:v}=e,w=pe(v,u),f=ii(ge,v,u,-w);k(f,he(f,f),h);const m=k(Fe,u,h),T=Ue(c,f,m),D=Ge(a,this._view,T,e).next(R=>({...R,manipulatorType:3}));t(s,D,r)})}createDistanceDragPipeline(t,e){return _e(this._manipulatorDistance,(s,a,r,o,n)=>{const c=si(e.observerRenderSpace,e.targetDirection),h=a.next(ms(this._view,s.location)).next(ps(this._view,c)).next(u=>({...u,manipulatorType:2}));t(s,h,r)})}updateManipulators(t){const{targetRenderSpace:e}=t;this._manipulatorHeading.renderLocation=e,this._manipulatorTilt.renderLocation=e,this._manipulatorDistance.renderLocation=e;const s=S(),a=u=>{Le(s,u,s)},r=H.scaleOrientSize*(jt/ws);a(Se(ce,K(ge,r,r,r))),a(Xe(t,ce));const o=H.scaleOrientHandleRadius*Qe*r,n=k(ge,t.targetDirection,o);a(me(ce,n));const c=ze(ce,-Pe);N(c,c,be(ft,-Pe)),this._manipulatorHeading.modelTransform=N(S(),s,c);const h=be(ce,Pe);N(h,h,ze(ft,Math.PI)),this._manipulatorTilt.modelTransform=Le(S(),s,h),this._manipulatorDistance.modelTransform=s}forEachManipulator(t){t(this._manipulatorHeading,3),t(this._manipulatorTilt,3),t(this._manipulatorDistance,2)}};const ce=S(),ft=S(),ge=p(),Fe=p(),qs=p(),Pe=Math.PI/2;let Bt=class extends De{constructor(t,e){super({view:t,autoScaleRenderObjects:!1,worldSized:!1,radius:H.observerSize,interactive:!1}),this._handles=new ye;const s=cs(this._color);this.renderObjects=[new re(ai(s,H.observerSize,32,32))],e.manipulators.add(this),this._handles.add([M(()=>this._color,a=>{s.setParameters({color:a})},x)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return te.toUnitRGBA(this.view.effectiveTheme.accentColor)}};l([d()],Bt.prototype,"_color",null);const mt=Symbol("dragHandles"),gt=Symbol("hideManipulators"),_t=Symbol("hideFoVManipulators"),Vt=Symbol("hideObserverManipulator");let I=class extends Me{constructor(t){super(t),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new zs({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Bs({view:this.view,tool:this.parentTool}),this._observerManipulator=new Bt(this.view,this.parentTool),this.addHandles([M(()=>{var e;return(e=this.viewshedComputedData)==null?void 0:e.observerRenderSpace},e=>{e!=null&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)},le),M(()=>{var e;return(e=this.viewshedComputedData)==null?void 0:e.heading},e=>{e&&(this._moveManipulation.angle=y(90-e))},x),M(()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e==null?void 0:e.observer}},({viewshedComputedData:e,observer:s},a)=>{this._grabbing&&s!==(a==null?void 0:a.observer)||(this.removeHandles(mt),e!=null&&e.valid&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(ri),mt))},x),M(()=>{const e=this.viewshedComputedData;return e!=null&&e.valid?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)},x),M(()=>{const e=this.viewshedComputedData;return e!=null&&e.valid?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)},x),M(()=>{var a;const e=this.analysisViewData.visible&&(((a=this.viewshedComputedData)==null?void 0:a.valid)??!1),s=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||s)}},({fovManipulationAvailable:e,nonFOVManipulationAvailable:s})=>{this._moveManipulation.available=s,this._scaleOrientManipulation.available=s,this._observerManipulator.available=s,this._fieldOfViewManipulation.available=e},x),M(()=>{const e=this.viewshedComputedData;if(!(e!=null&&e.valid))return null;const{observer:s,target:a,verticalFieldOfView:r,horizontalFieldOfView:o}=e;return{viewshedCompData:e,observer:s,target:a,verticalFieldOfView:r,horizontalFieldOfView:o}},e=>{e!=null&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)},x)]);const t=e=>{const s=this.analysisViewData;this.addHandles([e.events.on("focus-changed",()=>{const a=this._someManipulatorHovering();a&&this.parentTool.subToolHandles.forEach(({subTool:r})=>{r._resetHoveringTask()}),this._someManipulatorSelected()||a||(this._forceHoveringTask=li(async r=>{await(this._forceHoveringTestPromise??hi(H.hoverTimeoutMilliseconds,r)),ci(r),this._forceHoveringTask=null,this._updateManipulatorVisibility()}))}),e.events.on("grab-changed",a=>{var r;this._grabbing=a.action==="start",a.action==="end"&&((r=s.tool)==null||r.updateInteractionVisualsVisibility()),this.parentTool.subToolHandles.forEach(({subTool:o})=>{o!==this&&o._setInteractive(!this._grabbing)}),this._setInteractive(o=>o.hasManipulator(e)||!this._grabbing)}),e.events.on("drag",a=>{var r;a.action==="start"&&((r=s.tool)==null||r.updateInteractionVisualsVisibility())})])};this._forEachManipulator(t)}destroy(){this._forceHoveringTask=je(this._forceHoveringTask),this._moveManipulation=F(this._moveManipulation),this._fieldOfViewManipulation=F(this._fieldOfViewManipulation),this._scaleOrientManipulation=F(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=F(this._observerManipulator)}get viewshed(){var t;return(t=this.viewshedComputedData)==null?void 0:t.viewshed}get grabbing(){return this._grabbing}get observer(){var t;return(t=this.viewshed)==null?void 0:t.observer}set observer(t){const e=this.viewshed;e!=null&&(e.observer=t)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:t,grabbing:e}=this._moveManipulation;return{dragging:t,grabbing:e}}get scaleOrientInteractionState(){const{dragging:t,grabbing:e}=this._scaleOrientManipulation;return{dragging:t,grabbing:e}}_setInteractive(t){const e=typeof t=="boolean";this._forEachManipulation(s=>s.interactive=e?t:t(s))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),!this._someManipulatorSelected()&&(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(t){let e=!1;return this._forEachManipulator(s=>{e=e||s===t}),e}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new fs({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:jt})}_buildObserverDragPipeline(t){const e={mode:"absolute-height",offset:0},s=t.observer;if(s==null)return null;const a=this.view.spatialReference;return this._moveManipulation.createDragPipeline((r,o,n,c,h)=>{c=c.next(xe(this,["observer"]));const u=oi(s,a);if(u==null)return{steps:n,cancel:c};const v=_s.fromGeometry(u,ni(this.view.viewingMode));return{steps:n.next(gs({operations:v})).next(w=>(this.observer=v.data.geometry,w)),cancel:c}},e,a,void 0)}_buildFOVDragPipeline(t){let e=0,s=0;return this._fieldOfViewManipulation.createDragPipeline((a,r,o)=>{if(t==null)return{steps:r,cancel:o};const n=t.viewshed;let c=null;return o=o.next(xe(n,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next(h=>{h.action==="start"&&(c=null,e=t.horizontalFieldOfView,s=t.verticalFieldOfView);const u=h.deltaAngle;if(c==null&&u!==0){const f=h.side==="bottom"||h.side==="left"?u>0:u<0;c=fe(h.side)?e===0&&f||e===360&&!f:s===0&&f}const v=c?ks(h.side):h.side;let w=0;switch(v){case"left":w=e/2-u;break;case"right":w=e/2+u;break;case"top":w=s+2*u;break;case"bottom":w=s-2*u}return fe(v)?(w=Ze.normalize(w),w=w>270?0:w>180?180:w,n.horizontalFieldOfView=2*w):n.verticalFieldOfView=w,h}),cancel:o}},t)}_buildScaleOrientDragPipeline(t){let e=0,s=0;const a=(r,o)=>(n,c,h)=>{if(t==null)return{steps:c,cancel:h};const u=t.viewshed;return h=h.next(xe(u,[r])),{steps:c=c.next(o(u,t)),cancel:h}};return At([this._scaleOrientManipulation.createHeadingDragPipeline(a("heading",(r,o)=>n=>(n.action==="start"&&(s=t.heading),r.heading=Ze.normalize(s+n.deltaAngle),n)),t),this._scaleOrientManipulation.createTiltDragPipeline(a("tilt",(r,o)=>n=>{n.action==="start"&&(e=t.tilt);let c=e+n.deltaAngle;return c<-90?c=180:c>270&&(c=0),r.tilt=Xs.clamp(c),n}),t),this._scaleOrientManipulation.createDistanceDragPipeline(a("farDistance",(r,o)=>n=>{const c=P(Qs,n.renderEnd,o.observerRenderSpace),h=ve(c)*o.metersPerUnit,u=pe(c,o.targetDirection)<0?H.scaleOrientMinDistance:h;return r.farDistance=u,n}),t)])}_updateManipulatorVisibility(){const t=this._someManipulatorSelected(),e=this._forceHoveringTask!=null||this._someManipulatorHovering(),s=this._fieldOfViewManipulation.hovering,a=this.parentTool.creating;let r=[];const o=n=>{r.push(n.disableDisplay())};t||!a&&e?this.removeHandles(gt):(this._scaleOrientManipulation.forEachManipulator(o),this._moveManipulation.forEachManipulator(o),this.addHandles(r,gt),r=[]),t||!a&&e||a&&s?this.removeHandles(_t):(this._fieldOfViewManipulation.forEachManipulator(o),this.addHandles(r,_t)),t||!a?this.removeHandles(Vt):this.addHandles(this._observerManipulator.disableDisplay(),Vt)}_resetHoveringTask(){this._forceHoveringTask=je(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(t){this._forEachManipulation(e=>{e.forEachManipulator(t)}),t(this._observerManipulator)}_forEachManipulation(t){t(this._moveManipulation),t(this._fieldOfViewManipulation),t(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:t=>{this._forceHoveringTestPromise=t}}}};l([d({constructOnly:!0})],I.prototype,"analysis",void 0),l([d({constructOnly:!0})],I.prototype,"analysisViewData",void 0),l([d({constructOnly:!0})],I.prototype,"parentTool",void 0),l([d({constructOnly:!0,nonNullable:!0})],I.prototype,"view",void 0),l([d()],I.prototype,"viewshed",null),l([d()],I.prototype,"_grabbing",void 0),l([d()],I.prototype,"grabbing",null),l([d()],I.prototype,"viewshedComputedData",void 0),l([d()],I.prototype,"observer",null),I=l([ie("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],I);const Qs=p(),Xs=new di(0,180),Ae=Symbol("interactionVisuals");let O=class extends ys{constructor(i){super(i),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._placementMode=yt,this._creationState=!1,this._interactionVisualElements=null,this._settings=new Vs({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=Os(this.view.state.viewingMode),this._createInteractionVisuals();const i=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=qe(()=>i,({viewshedComputedData:t})=>{const e=new I({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:t});return{subTool:e,remove:()=>{this.selectedViewshed===t.viewshed&&(this.selectedViewshed=null),e.destroy()}}}),this.addHandles([we(()=>this._valid,()=>this.finishToolCreation(),le),M(()=>this._stagedViewshed,t=>{var s;const e=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=t!=null&&e!=null?(s=this._findSubTool(t))==null?void 0:s.viewshedComputedData:null},le),this.analysis.viewsheds.on("after-remove",t=>{const e=this._stagedViewshed;e!=null&&t.item===e&&this.analysis.viewsheds.add(e)}),M(()=>this.firstGrabbedManipulator,t=>{var e,s;if(t!=null){const a=(e=this._findSubTool(t))==null?void 0:e.viewshed;this.selectedViewshed=a,this._selectManipulator(t)}else(s=this._selectedSubTool)==null||s.onManipulatorSelectionChanged()},Ht),M(()=>this.view.activeTool,t=>{t!==this&&t!=null&&(this.selectedViewshed=null)}),we(()=>{const t=this.selectedViewshedComputedData;return t==null?null:{subTool:this._selectedSubTool,observer:t.observerRenderSpace,target:t.targetRenderSpace}},t=>{const{subTool:e,observer:s,target:a}=t;e!=null&&e.moveInteractionState.dragging?this._updateInteractionVisualsLocation(s,!0):e!=null&&e.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(a,!1)},x),M(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),M(()=>this.selectedViewshed,t=>{const e=this._selectedManipulator,s=this._selectedSubTool;t==null?this._selectManipulator(null):e!=null&&s.hasManipulator(e)||this._selectManipulator(s.discManipulator)},x)])}destroy(){this.subToolHandles=F(this.subToolHandles),this.removeHandles(Ae)}onDeactivate(){this.removeStaged(),this._creationState=!1}get _valid(){var i;return((i=this.analysisViewData.viewshedComputedDataHandles)==null?void 0:i.some(t=>t.viewshedComputedData.valid))??!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(i){var e,s;const t=this._selectedManipulator;t!==i&&(this._selectedManipulator=i,t!=null&&(t.selected=!1),i!=null&&(i.selected=!0),(e=this._findSubTool(t))==null||e.onManipulatorSelectionChanged(),(s=this._selectedSubTool)==null||s.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(i){this.analysisViewData.selectedViewshed=i}get selectedViewshedComputedData(){var i;return(i=this._selectedSubTool)==null?void 0:i.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:i})=>i.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return this._creationState==="placing-target"}place(i){this.selectedViewshed=null,this._placementMode=i,this._creationState="placing-observer",this._finishToolCreationIfValid()}onManipulatorSelectionChanged(){this.subToolHandles.forEach(i=>i.subTool.onManipulatorSelectionChanged())}onInputEvent(i){switch(i.type){case"immediate-double-click":this._doubleClickHandler(i);break;case"pointer-move":this._pointerMoveHandler(i);break;case"key-down":et.cancel===i.key?this._cancelKeyHandler(i):et.delete.includes(i.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(i){i.type==="immediate-click"&&this._clickPlacementHandler(i)}onActivate(){this._placementMode=yt}_clickPlacementHandler(i){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(i,Mt);if(t!=null){if(this._creationState==="placing-observer"){t.mapPoint.z=(t.mapPoint.z??0)+Cs;const e=new vs({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if(this._creationState==="placing-target"){this._updateStagedViewshed(t.scenePoint);const e=this._stagedViewshed;this._stagedViewshed=null,this._placementMode==="multiple"?this._creationState="placing-observer":(this._creationState=!1,this._stagedViewshed=null,this._finishToolCreationIfValid(),this.view.activeTool=null),this.selectedViewshed=e}i.stopPropagation()}}_doubleClickHandler(i){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,i.stopPropagation())}_pointerMoveHandler(i){if(!this.creating)return;const t=this._intersectScreen(i,Mt);t!=null&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(i){this.creating?this._onCancelWhileCreating(i):this.grabbing||(this.selectedViewshed=null,i.stopPropagation())}_onCancelWhileCreating(i){const t=this.removeStaged();this._finishToolCreationIfValid(),t?(this._creationState="placing-observer",this.selectedViewshed=null,this._placementMode==="multiple"&&i.stopPropagation()):this._creationState=!1}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_finishToolCreationIfValid(){this._valid&&this.finishToolCreation()}_updateStagedViewshed(i){const t=this._stagedViewshed,e=this._stagedViewshedComputedData;if(t==null||e==null)return;const{heading:s,tilt:a,farDistance:r}=Ks(this.view,e,i);t.farDistance=r,t.tilt=a,t.heading=s}removeStaged(){const i=this._stagedViewshed;return i!=null&&(this._stagedViewshed=null,this.analysis.viewsheds.remove(i),!0)}_intersectScreen(i,t){const e=ui(i);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const s=this._intersector.results.min,a=t.scenePoint;if(!s.getIntersectionPoint(a))return null;const r=t.mapPoint;return r.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(a,r),r==null?null:(t.feature=pi(s,this.view),t)}_createInteractionVisuals(){this.removeHandles(Ae);const i=this._settings.visualElements,t=new Ms({view:this.view,attached:!1,style:{glowWidth:i.heightPlane.glowWidth,innerWidth:i.heightPlane.innerWidth},isDecoration:!0}),e=new bs({view:this.view,extensionType:i.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:4,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:e},this.addHandles([M(()=>i.zVerticalLine,s=>s.apply(e),le),M(()=>i.heightPlane,s=>s.apply(t),le),vi(()=>{t.destroy(),e.destroy(),this._interactionVisualElements=null})],Ae)}updateInteractionVisualsVisibility(i=!1){const t=this.creating,e=this.analysisViewData.visible,s=this._selectedSubTool,a=this.selectedViewshedComputedData,r=(v,w)=>{const f=this._interactionVisualElements;f!=null&&(f.verticalLine.attached=w,f.laserline.attached=v)};if(t)return void r(e,!1);if(s==null||a==null)return void r(!1,!1);const o=s.moveInteractionState,n=i?o.grabbing:o.dragging,c=s.scaleOrientInteractionState,h=i?c.grabbing:c.dragging,u=e&&(n||h);if(r(u,n),u){const v=n?a.observerRenderSpace:a.targetRenderSpace;this._updateInteractionVisualsLocation(v,n)}}_updateInteractionVisualsLocation(i,t){const e=this._interactionVisualElements;if(e==null)return;const{laserline:s,verticalLine:a}=e;s.heightManifoldTarget=i,s.intersectsWorldUpAtLocation=t?i:null,i!=null&&a.setStartEndFromWorldDownAtLocation(i)}_findSubTool(i){var e,s;if(i==null)return null;const t=i instanceof De?a=>a.subTool.hasManipulator(i):a=>a.subTool.viewshed===i;return(s=(e=this.subToolHandles)==null?void 0:e.find(t))==null?void 0:s.subTool}get test(){}};function Ks(i,t,e){const s=t.observerRenderSpace,a=P(Ys,e,s),r=ve(a)*t.metersPerUnit,o=i.renderCoordsHelper.basisMatrixAtPosition(s,ea),n=K(Js,o[8],o[9],o[10]),c=Ft(s,n,ta),h=wi(c,e,Zs),u=P(h,h,s),v=(ve(u)<1e-4?90:ue(Ve(a,u)))*(pe(n,a)<0?-1:1)+90,w=K(bt,o[4],o[5],o[6]),f=ue(Ve(w,u)),m=K(bt,o[0],o[1],o[2]);return{heading:pe(u,m)<0?360-f:f,tilt:v,farDistance:r}}l([d({constructOnly:!0})],O.prototype,"view",void 0),l([d()],O.prototype,"analysisViewData",void 0),l([d()],O.prototype,"removeIncompleteOnCancel",void 0),l([d()],O.prototype,"automaticManipulatorSelection",void 0),l([d({constructOnly:!0})],O.prototype,"analysis",void 0),l([d()],O.prototype,"subToolHandles",void 0),l([d()],O.prototype,"_stagedViewshed",void 0),l([d()],O.prototype,"_stagedViewshedComputedData",void 0),l([d()],O.prototype,"_placementMode",void 0),l([d()],O.prototype,"_creationState",void 0),l([d()],O.prototype,"_valid",null),l([d({readOnly:!0})],O.prototype,"cursor",null),l([d()],O.prototype,"_selectedManipulator",void 0),l([d()],O.prototype,"_selectedSubTool",null),l([d()],O.prototype,"selectedViewshed",null),l([d()],O.prototype,"selectedViewshedComputedData",null),l([d()],O.prototype,"stagedViewshed",null),l([d()],O.prototype,"grabbing",null),l([d()],O.prototype,"creating",null),l([d()],O.prototype,"isPlacingTarget",null),O=l([ie("esri.views.3d.analysis.Viewshed.ViewshedTool")],O);const Ys=p(),Js=p(),Zs=p(),bt=p(),ea=S(),ta=Pt(),Mt={mapPoint:new He,scenePoint:p(),feature:null},yt="multiple";let ia=class extends ds{constructor(t){super(t),this._material=null,this._viewshedComputedData=null,this._material=new kt({...J.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(t)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(t){this._viewshedComputedData=t,this.updateTransform()}updateTransform(){const t=this._viewshedComputedData;if(t==null)return;const e=S(),s=t.farDistanceRenderSpace;Se(e,q(s,s,s)),Xe(t,de),N(e,de,e),me(de,this._viewshedComputedData.observerRenderSpace),N(e,de,e),this.transform=e}createExternalResources(){}destroyExternalResources(){}forEachMaterial(t){t(this._material)}createGeometries(t){const{_material:e,viewshedComputedData:s}=this;s==null||e==null||!s.valid||sa(e,s).forEach(a=>t.addGeometry(a))}};function sa(i,t){const{horizontalFieldOfView:e,verticalFieldOfView:s}=t,a=K(aa,0,0,1),r=K(Dt,0,1,0),o=K(Ot,1,0,0);ee(a,a,y(s/2),r),ee(a,a,y(e/2),o);const n=b=>Math.ceil(Math.abs(b)/Gt)+1,c=y(e),h=G(ra,o),u=n(c),v=St(-c/(u-1)),w=Q(de,v,h),f=y(-s),m=n(f),T=St(f/(m-1)),D=G(Dt,r),R=Q(Tt,y(e)/2,o);B(D,D,R);const A=Tt,C=[],z=G(Ot,a);for(let b=0;b<u;b++){Q(A,T,D);for(let _=0;_<m;_++){const V=3*(_*u+b);C[V]=z[0],C[V+1]=z[1],C[V+2]=z[2],B(z,z,A)}B(D,D,w),B(a,a,w),G(z,a)}const L=u*m;C[3*L]=0,C[3*L+1]=0,C[3*L+2]=0;const W=[];for(let b=0;b<u-1;b++)for(let _=0;_<m-1;_++){const V=6*(_*(u-1)+b);W[V]=_*u+b,W[V+1]=(_+1)*u+b,W[V+2]=_*u+b+1,W[V+3]=_*u+b+1,W[V+4]=(_+1)*u+b,W[V+5]=(_+1)*u+b+1}const Y=[W];if(e!==360&&s!==0){const b=[],_=[];for(let V=0;V<m-1;V++){const $=3*V;b[$]=L,b[$+1]=(V+1)*u,b[$+2]=V*u,_[$]=L,_[$+1]=V*u+u-1,_[$+2]=(V+1)*u+u-1}Y.push(b,_)}if(s!==180&&e!==0){const b=[],_=[];for(let V=0;V<u-1;V++){const $=3*V;b[$]=L,b[$+1]=V,b[$+2]=V+1,_[$]=L,_[$+1]=V+(m-1)*u+1,_[$+2]=V+(m-1)*u}Y.push(b,_)}return Y.map(b=>{const _=[["position",new fi(C,b,3,!0)]];return new mi(i,_)})}function St(i){return isNaN(i)?1:i}const aa=p(),Dt=p(),Ot=p(),ra=p(),de=S(),Tt=S();let U=class extends Me{constructor(i){super(i),this.visible=!0,this._viewshedCorners={topLeft:p(),topRight:p(),bottomLeft:p(),bottomRight:p()},this._arcCenterPoints={top:p(),bottom:p(),left:p(),right:p()},this._parallelCenters={top:p(),bottom:p()}}initialize(){const i={view:this.view,isDecoration:!0},t={...i,color:this._color,renderOccluded:4},e={...t,stipplePattern:$s(2)};this._observerVisualElement=new Ts({...i,...J.observerPointConfiguration}),this._shapeVisualElement=new ia({...i,isDecoration:this.isDecoration}),this._frameLinesVisualElement=new se(t),this._leftArcVisualElement=new se(t),this._rightArcVisualElement=new se(t),this._topArcVisualElement=new se(t),this._bottomArcVisualElement=new se(t),this._centralLongitude=new se(e),this._centralLatitude=new se(e),this.addHandles([M(()=>{const s=this.viewshedComputedData;if(!(s!=null&&s.valid))return null;const a=this._viewshedCorners,r=this._arcCenterPoints,o=this._parallelCenters;return s.cornerPoints(a),s.arcCentersPoints(r),s.parallelCenterPoints(o),{viewshedComputedData:s,corners:a,arcCenters:r,parallelCenters:o,interactive:this.analysisViewData.interactive,selected:this._selected}},s=>{const a=s!=null;this._forEachVisualElement(r=>r.attached=a),a&&this._updateVisualElements(s)},{initial:!0,equals:gi}),M(()=>{const{viewshedComputedData:s}=this,{horizontalFieldOfView:a,verticalFieldOfView:r}=s??{};return{viewshedComputedData:s,horizontalFieldOfView:a,verticalFieldOfView:r}},({viewshedComputedData:s})=>{const{_shapeVisualElement:a}=this;s!==a.viewshedComputedData&&(a.viewshedComputedData=s),this._shapeVisualElement.recreateGeometry()},x),M(()=>{var a;const{interactive:s}=this.analysisViewData;return{visible:this.visible,selected:s&&this._selected,staged:s&&this._staged,horFovNot360:((a=this.viewshedComputedData)==null?void 0:a.horizontalFieldOfView)!==360}},({visible:s,selected:a,staged:r,horFovNot360:o})=>{const n=a||r;this._shapeVisualElement.visible=s,this._topArcVisualElement.visible=s,this._bottomArcVisualElement.visible=s,this._frameLinesVisualElement.visible=s&&o;const c=s&&(a||o);this._leftArcVisualElement.visible=c,this._rightArcVisualElement.visible=c,this._forEachLineVisualElement(h=>{h.width=n?J.frameWidthSelected:J.frameWidthNotSelected,h.renderOccluded=a?4:1}),[this._centralLatitude,this._centralLongitude].forEach(h=>{h.width=2*(n?J.frameWidthSelected:J.frameWidthNotSelected),h.visible=s&&a})},x),M(()=>{const{analysisViewData:{interactive:s,tool:a},_selected:r,visible:o}=this,n=this.view.activeTool,c=!(a!=null&&a.active)&&n instanceof O&&n.creating;return{observerVisible:o&&!r&&(!s||((a==null?void 0:a.creating)??!1)||c),color:this._color}},({observerVisible:s,color:a})=>{this._observerVisualElement.visible=s,this._forEachLineVisualElement(r=>r.color=a)},x)])}get _color(){var o,n;const{viewshedComputedData:i,_selected:t,analysisViewData:e}=this;if(i==null)return te.toUnitRGBA(J.frameColor);const s=((o=e.tool)==null?void 0:o.active)||e.interactive,a=i.viewshed===((n=e.tool)==null?void 0:n.stagedViewshed),r=s&&(t||a)?this.view.effectiveTheme.accentColor:J.frameColor;return te.toUnitRGBA(r)}get _selected(){const{viewshedComputedData:i,analysisViewData:{selectedViewshedComputedData:t}}=this;return i!=null&&i===t}get _staged(){const{analysisViewData:{tool:i},viewshedComputedData:t}=this;return i!=null&&i.creating&&i.stagedViewshed===(t==null?void 0:t.viewshed)}destroy(){this._observerVisualElement=F(this._observerVisualElement),this._shapeVisualElement=F(this._shapeVisualElement),this._frameLinesVisualElement=F(this._frameLinesVisualElement),this._leftArcVisualElement=F(this._leftArcVisualElement),this._rightArcVisualElement=F(this._rightArcVisualElement),this._topArcVisualElement=F(this._topArcVisualElement),this._bottomArcVisualElement=F(this._bottomArcVisualElement),this._centralLongitude=F(this._centralLongitude),this._centralLatitude=F(this._centralLatitude)}_forEachLineVisualElement(i){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(i)}_forEachVisualElement(i){this._forEachLineVisualElement(i),i(this._observerVisualElement),i(this._shapeVisualElement)}_updateVisualElements(i){const{viewshedComputedData:t,corners:e,arcCenters:s,parallelCenters:a}=i,r=zt(t.observerRenderSpace);this._observerVisualElement.geometry=t.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(r,e),this._updateFrameArcs(t,e,a),this._updateCentralHelperArcs(t,s)}_updateFrameLines(i,t){this._frameLinesVisualElement.geometry=[[i,t.topLeft],[i,t.topRight],[i,t.bottomLeft],[i,t.bottomRight]]}_updateFrameArcs(i,t,e){const{observerRenderSpace:s,rightVector:a,horizontalFieldOfView:r,tiltedUpVector:o}=i,n=y(r),c=p(),h=S();Q(h,n/2,o),B(c,a,h),ne(this._leftArcVisualElement,s,t.bottomLeft,t.topLeft,"forward",c),Q(h,-n/2,o),K(c,0,0,0),B(c,a,h),ne(this._rightArcVisualElement,s,t.bottomRight,t.topRight,"forward",c);const u=r>180?"backward":"forward";ne(this._topArcVisualElement,e.top,t.topRight,t.topLeft,u,o),ne(this._bottomArcVisualElement,e.bottom,t.bottomRight,t.bottomLeft,u,o)}_updateCentralHelperArcs(i,t){const e=i.observerRenderSpace,s=i.horizontalFieldOfView>=180?"backward":"forward";ne(this._centralLatitude,e,t.right,t.left,s,i.tiltedUpVector),ne(this._centralLongitude,e,t.top,t.bottom,"forward",i.leftVector)}get test(){}};function ne(i,t,e,s,a,r,o=Gt){const n=p();P(n,e,t);const c=ve(n),h=p();P(h,s,t),he(h,h),k(h,h,c);let u=Ve(n,h);const v=zt(r);a==="backward"&&(Be(v,v),u=-(2*Math.PI-u));const w=[],f=Math.ceil(Math.abs(u)/o),m=S();Q(m,u/f,v);const T=p();G(T,n);const D=p();G(D,e);for(let R=0;R<f;R++){const A=p();G(A,D),B(T,T,m),X(D,t,T);const C=p();G(C,D),w.push([A,C])}i.geometry=w}l([d()],U.prototype,"view",void 0),l([d({constructOnly:!0})],U.prototype,"isDecoration",void 0),l([d()],U.prototype,"analysisViewData",void 0),l([d()],U.prototype,"viewshedComputedData",void 0),l([d()],U.prototype,"visible",void 0),l([d()],U.prototype,"_color",null),l([d()],U.prototype,"_selected",null),l([d()],U.prototype,"_staged",null),U=l([ie("esri.views.3d.analysis.Viewshed.ViewshedSubVisualization")],U);let ae=class extends Me{get visible(){return this.analysisViewData.visible}constructor(i){super(i)}initialize(){const i=this.analysisViewData,t=qe(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:e})=>{const s=new U({view:this.view,viewshedComputedData:e,analysisViewData:i,isDecoration:this.isDecoration});return{visualization:s,remove:()=>s.destroy()}});this._subVisualizations=t,this.addHandles([_i(t),M(()=>this.visible,e=>this._subVisualizations.forEach(({visualization:s})=>s.visible=e),x)])}get test(){}};l([d({constructOnly:!0})],ae.prototype,"analysisViewData",void 0),l([d({constructOnly:!0,nonNullable:!0})],ae.prototype,"view",void 0),l([d({constructOnly:!0})],ae.prototype,"isDecoration",void 0),l([d()],ae.prototype,"visible",null),ae=l([ie("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],ae);let Z=class extends Vi{constructor(){super(...arguments),this.sectionAngles=bi()}get sectionAnglesDeg(){return tt(this.sectionAngles.map(t=>ue(t)))}set sectionAnglesDeg(t){this.sectionAngles=tt(t.map(e=>y(e)))}get projectionMatrix(){return N(S(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const t=this.sectionAngles[0],e=this.sectionAngles[1],s=this.sectionAngles[2],a=this.sectionAngles[3];Ie(t<=e),Ie(s<=a);const r=2*Math.tan(this.fovX/2),o=2*Math.tan(this.fovY/2),n=Math.tan(t),c=Math.tan(e),h=Math.tan(s),u=c-n,v=Math.tan(a)-h,w=r/u,f=o/v,m=-(n+u/2)/r*2,T=-(h+v/2)/o*2,D=S();me(D,[m,T,0]);const R=S();Se(R,[w,f,1]);const A=S();return N(A,R,D)}get _sectionRatioX(){const t=Math.tan(this.sectionAngles[0]),e=Math.tan(this.sectionAngles[1]),s=2*Math.tan(this.fovX/2);return Math.min(1,(e-t)/s)}setViewport(t,e){const s=e*this._sectionRatioX;return this.viewport=[t[0],t[1],s,e],s}};l([d()],Z.prototype,"sectionAngles",void 0),l([d()],Z.prototype,"sectionAnglesDeg",null),l([d()],Z.prototype,"projectionMatrix",null),l([d()],Z.prototype,"sectionMatrix",null),l([d()],Z.prototype,"_sectionRatioX",null),Z=l([ie("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Z);class oa{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(t){const e=t?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*e}textureResizeModulo(t){return Math.ceil(t/this.textureSizeMultiple)*this.textureSizeMultiple}}const $t=["front","left","right","back","top","bottom"];function na(i){return!["top","bottom"].includes(i)}class la{constructor(t){this._fbos=t,this._faces={},this._width=0,this._height=0,this.settings=new oa,this._maxTextureSize=Math.min(Mi("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}get depthTexture(){var t;return(t=this._handle)==null?void 0:t.getTexture(it)}get ready(){return this.depthTexture!=null&&this._width!==0&&this._height!==0}get nearFar(){const t=this.faces;return t.length===0?null:t[0].nearFar}get numActiveFaces(){const t=this._faces;let e=0;return Object.keys(t).forEach(s=>{t[s]&&(e+=1)}),e}get faces(){const t=this._faces,e=[];for(const s of $t){const a=t[s];a&&e.push(a)}return e}get atlasRegions(){return this.faces.map(t=>[t.x/this._width,(t.x+t.width)/this._width,t.y/this._height,(t.y+t.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(t=>t.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(t=>t.viewMatrix)}_setupFaceCamera(t,e,s,a){const{effectiveObserverRenderSpace:r,tiltedUpVector:o,targetRenderSpace:n,farDistanceRenderSpace:c,horizontalFieldOfView:h,verticalFieldOfView:u}=e,v=p();P(v,n,r);const w=p(),f=p(),m=(_,V)=>{const $=p(),Ye=S();return Q(Ye,_,V),B($,v,Ye),X($,r,$),$};let T,D=o;const R=Math.min(90,h),A=Math.min(90,Math.max(0,(h-90)/2));let C=-45,z=45,L=-45,W=45;if(na(t)){const _=V=>We(V,-45,45);L=_(-u/2)-this.settings.toleranceBottomTop,W=_(+u/2)+this.settings.toleranceBottomTop}switch(t){case"front":T=n,C=-R/2,z=R/2;break;case"left":T=m(Math.PI/2,o),C=45-A;break;case"right":T=m(-Math.PI/2,o),z=-45+A;break;case"top":T=X(w,r,o),D=Be(f,v);break;case"bottom":T=P(w,r,o),D=v;break;case"back":T=m(Math.PI,o)}const Y=new Z({center:T,eye:r,up:D,far:c});Y.sectionAnglesDeg=[C-this.settings.toleranceSides,z+this.settings.toleranceSides,L,W],Y.fovY=Math.PI/2;const b=Y.setViewport(s,a);return this._faces[t]=Y,b}isActive(t){return this._computeActiveFaces(t).size>0}_computeActiveFaces(t){const e=new Set,{horizontalFieldOfView:s,verticalFieldOfView:a}=t,r=-a/2,o=a/2;return s===0||a===0||(r<=45&&o>=-45&&e.add("front"),s>90&&(e.add("left"),e.add("right")),s>270&&e.add("back"),o>45-this.settings.toleranceBottomTop&&e.add("top"),r<-45+this.settings.toleranceBottomTop&&e.add("bottom")),e}_computeBaseTextureSize({pixelRatio:t,fullWidth:e,fullHeight:s},a,r,o){const n=a/t,c=this.settings.textureSizeModifier(r);return yi(Math.max(e,s)*n*c,this._maxTextureSize/o)}_ensureFBO(t){var r,o,n,c;const e=this._width,s=this._height,a=(r=this._handle)==null?void 0:r.fbo;a&&a.width===e&&a.height===s&&t===Si(((n=(o=a.depthStencilTexture)==null?void 0:o.descriptor)==null?void 0:n.internalFormat)??Di.DEPTH_COMPONENT16)||((c=this._handle)==null||c.release(),this._handle=this._allocateFBO(t))}_allocateFBO(t){var o;const{_width:e,_height:s}=this,a=t?13:12,r=this._fbos.acquire(e,s,"viewshed shadow map",a);return(o=r.getTexture(it))==null||o.setShadowFiltering(!1),r}clearFBO(t){var s;const e=this._fbos.rctx;this._ensureFBO(t),e.bindFramebuffer((s=this._handle)==null?void 0:s.fbo),e.setClearColor(1,1,1,1),e.clear(16640)}dispose(){this._debugFBO||(this._handle=Oi(this._handle))}start(t,e,s,a,r=!1){this._faces={};const o=this._computeActiveFaces(e),n=o.size;if(n===0)return!1;const c=this._computeBaseTextureSize(t,a,s,n);let h=0,u=0,v=0;return $t.filter(w=>o.has(w)).forEach(w=>{const f=ha(w,n);f>u&&(v=Math.max(v,h),h=0),u=f;const m=f*c;h+=this._setupFaceCamera(w,e,[h,m],c)}),v=Math.max(v,h),this._width=this.settings.textureResizeModulo(v),this._height=ca(n)*c,this.clearFBO(r),!0}finish(){}get test(){}}function ha(i,t){if(t<4)return 0;const e=i==="front"||i==="left";return t===4?e?0:1:e||i==="right"?0:1}function ca(i){return i<4?1:2}class da extends Ti{constructor(){super(...arguments),this.localOrigin=$i()}}function ua(i){i.include(xi),i.fragment.uniforms.add(new Ri("inverseViewMatrix",(t,e)=>{const s=Lt(S(),e.camera.viewMatrix,t.localOrigin);return It(s,s)})).code.add(ke`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}let Ke=class extends da{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=st.flat(),this.viewMatrices=st.flat(),this.volumeOffset=0}};function qt(){const i=new Ci,t=i.fragment;return i.include(Fi),i.include(ua),t.include(Pi),t.include(Ai),t.uniforms.add(new Ei("depthTexture",e=>{var s;return(s=e.depth)==null?void 0:s.attachment}),new at("inverseProjectionMatrix",e=>e.camera.inverseProjectionMatrix),new at("inverseViewNormalMatrix",({camera:e})=>It(pa,e.viewInverseTransposeMatrix)),new Oe("viewshedObserverOffset",e=>e.observerOffset),new Oe("viewshedTargetVector",e=>e.targetVector),new Oe("viewshedUpVector",e=>e.upVector),new Te("viewshedFOVs",e=>e.fovs),new Te("viewshedHeadingAndTilt",e=>e.headingAndTilt),new Te("viewshedNearFar",e=>e.shadowMap.nearFar??[1,100]),new Hi("viewshedVolumeOffset",e=>e.volumeOffset),new rt("viewshedShadowMap",e=>e.shadowMap.depthTexture),new ot("viewshedProjectionMatrices",e=>e.projectionMatrices,6),new ot("viewshedViewMatrices",e=>e.viewMatrices,6),new zi("viewshedNumFaces",e=>e.shadowMap.numActiveFaces),new Li("viewshedAtlasRegions",e=>e.shadowMap.atlasRegions.flat(),24),new rt("normalMap",e=>e.normals)),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add(ke`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float viewshedReadShadowMapDepth(sampler2D _viewshedShadowmap, ivec2 uv) {
return texelFetch(_viewshedShadowmap, uv, 0).r;
}
float viewshedFilterShadow(sampler2D _viewshedShadowmap, vec2 uv) {
vec2 uvScaled = uv * vec2(textureSize(_viewshedShadowmap, 0));
vec2 st    = fract(uvScaled);
ivec2 base = ivec2(uvScaled);
float s00 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y    ));
float s10 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y    ));
float s11 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y + 1));
float s01 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y + 1));
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float viewshedTextureAtlasLookup(sampler2D _viewshedShadowmap, vec2 uv, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(uv) * atlasScale + atlasRegion.xy;
return viewshedFilterShadow(_viewshedShadowmap, uvAtlas);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return viewshedTextureAtlasLookup(viewshedShadowMap, uv, atlasRegion);
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec4 normal4 = texture(normalMap, uv);
vec3 normalN = normalize(normal4.xyz * 2.0 - 1.0);
vec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);
vec3 viewingDir = normalize(localPosition);
return dot(normal, viewingDir);
}`),t.main.add(ke`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = -0.01;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),i}const pa=S(),va=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Ke,build:qt},Symbol.toStringTag,{value:"Module"}));class xt extends Ii{constructor(t,e){super(t,e,new Ui(va,()=>xs(()=>Promise.resolve().then(()=>Va),void 0,import.meta.url)),ji)}initializePipeline(){return ki({colorWrite:Ni,blending:Gi})}}let j=class extends Wi{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(i=>ma(this.view,i))}constructor(i){super(i),this.isDecoration=!1,this._passParameters=new Ke,this._viewsheds=new Bi,this._shadowMap=null,this.consumes={required:[$e.VIEWSHED,"normals"]},this.produces=$e.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new la(this.fboCache),this.addHandles([M(()=>this.view.resolutionScale,i=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=i)},x),we(()=>!this.hasViewsheds,()=>{var i;return(i=this._shadowMap)==null?void 0:i.dispose()}),M(()=>this._viewshedsInView.map(i=>[i.observerRenderSpace,i.heading,i.tilt,i.farDistance,i.horizontalFieldOfView,i.verticalFieldOfView]),()=>this.requestRender(1),Ht)])}destroy(){this._shadowMap=qi(this._shadowMap)}precompile(){var i;if(this.hasViewsheds){this.techniques.precompile(xt);for(const t of this._viewshedsInView)if((i=this._shadowMap)!=null&&i.isActive(t))return void this.view.stage.renderer.precompileViewshedShadowMap()}}render(i){var o,n,c;const t=this.bindParameters,e=this.renderingContext,s=i.find(({name:h})=>h===$e.VIEWSHED);if(!this.hasViewsheds||!t.depth||this.isDecoration&&!t.decorations)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=(o=i.find(({name:h})=>h==="normals"))==null?void 0:o.getTexture();const a=this.techniques.get(xt);if(!(a!=null&&a.compiled))return this.requestRender(1),s;const r=this.view.stage.renderer.isFeatureEnabled(7);for(const h of this._viewshedsInView){if(!this._renderShadowCubeMap(t,h,r)||!((n=this._shadowMap)!=null&&n.ready))continue;const u=this._setupViewshedParameters(h,t.camera);e.bindTechnique(a,t,u),e.bindFramebuffer(s.fbo),e.screen.draw()}return(c=this.shadowMap)==null||c.dispose(),s}updateViewsheds(i){const t=this._viewsheds,{removes:e,adds:s}=i;if(e&&(Array.isArray(e)?t.removeMany(e):t.remove(e)),s)if(Array.isArray(s)){const a=s.filter(r=>!t.includes(r));t.addMany(a)}else t.includes(s)||t.add(s)}_renderShadowCubeMap(i,t,e){const s=this._shadowMap;if(!s)return!1;const a=this.view.basemapTerrain.hasStencilEnabledExtents,r=s.start(i.camera,t,e,this._contentPixelRatio,a);return r&&s.faces.forEach(o=>this.view.stage.renderer.renderViewshedShadowMap(o)),s.finish(),r}_setupViewshedParameters(i,t){var c;const e=this._shadowMap;if(!e)return this._passParameters;const s=this._passParameters,a=i.effectiveObserverRenderSpace;s.localOrigin=a,s.observerOffset=P(_a,i.observerRenderSpace,i.effectiveObserverRenderSpace),s.fovs=[y(i.horizontalFieldOfView),y(i.verticalFieldOfView)],s.headingAndTilt=[y(i.heading),y(i.tiltParallelToSurface)],s.upVector=i.tiltedUpVector;const r=wa(i.targetRenderSpace,a);s.targetVector=r;const o=new Array,n=new Array;for(let h=0;h<e.numActiveFaces;h++)Lt(Ee,e.viewshedViewMatrices[h],a),o.push(...Ee),fa(e.viewshedProjectionMatrices[h],Ee,Rt),n.push(...Rt);return s.viewMatrices=o,s.projectionMatrices=n,s.volumeOffset=((c=this.selectedViewshed)==null?void 0:c.call(this))===i.viewshed?ga(i,this.view,t.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function wa(i,t){const e=p();return P(e,i,t)}function fa(i,t,e){const s=q(.5,.5,.5);return me(e,s),Xi(e,e,s),N(e,e,i),N(e,e,t),e}function ma(i,t){const e=Qi(t.observerRenderSpace,t.farDistanceRenderSpace);return!!i.ready&&i.frustum.intersectsSphere(e)}function ga(i,t,e){if(i==null)return 0;const{observerRenderSpace:s,targetRenderSpace:a}=i,r=nt(e,s)>nt(e,a)?i.observer:i.target;return t.pixelSizeAt(r)}l([d()],j.prototype,"selectedViewshed",void 0),l([d()],j.prototype,"isDecoration",void 0),l([d()],j.prototype,"shadowMap",null),l([d()],j.prototype,"hasViewsheds",null),l([d()],j.prototype,"_contentPixelRatio",null),l([d()],j.prototype,"_viewshedsInView",null),l([d()],j.prototype,"consumes",void 0),l([d()],j.prototype,"produces",void 0),j=l([ie("esri.views.3d.webgl-engine.lib.Viewshed")],j);const _a=p(),Ee=S(),Rt=S();let E=class extends ns{constructor(i){super(i),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this.userOperation=null,this._viewshedRenderNode=null,this._intersector=null}get visible(){return super.visible}set visible(i){super.visible=i}get interactive(){return super.interactive}set interactive(i){super.interactive=i}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(i){this._unselectOtherViewsheds(i),this._selectedViewshed=i}get selectedViewshedComputedData(){var i;return(i=this.tool)==null?void 0:i.selectedViewshedComputedData}get _isDecoration(){return!this.parent}initialize(){const i=this.view;this._viewshedRenderNode=new j({view:i,selectedViewshed:()=>{var t;return this.selectedViewshed??((t=this.tool)==null?void 0:t.stagedViewshed)},isDecoration:this._isDecoration}),this._intersector=new Ki(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0,this.viewshedComputedDataHandles=qe(()=>this.analysis.viewsheds,t=>{const e=new g({renderCoordsHelper:i.renderCoordsHelper,viewshed:t}),s=Symbol();return this.addHandles([M(()=>{var a;return{valid:e.valid,canProject:Ji((a=e.observer)==null?void 0:a.spatialReference,this.view.spatialReference)||Zi()}},({valid:a,canProject:r},o)=>{this.visible&&(a&&r?this._addViewshedsToRenderer(e):o!=null&&o.valid&&(o!=null&&o.canProject)&&this._removeViewshedsFromRenderer(e),r||us(this.analysis,e.observer.spatialReference,Yi.getLogger(this)))},x),...this._createFeatureReferenceHandles(e)],s),{viewshedComputedData:e,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(e),e.destroy()}}}),this._visualization=new ae({view:i,analysisViewData:this,isDecoration:this._isDecoration}),this.addHandles([M(()=>this.visible,t=>{const e=this.viewshedComputedDataHandles;if(e==null)return;t||(this.selectedViewshed=null);const s=e.map(a=>a.viewshedComputedData).filter(a=>a.valid).toArray();t?this._addViewshedsToRenderer(s):this._removeViewshedsFromRenderer(s)}),M(()=>i.renderCoordsHelper,t=>{var e;(e=this.viewshedComputedDataHandles)==null||e.forEach(({viewshedComputedData:s})=>s.renderCoordsHelper=t)}),Ss(this,O),we(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},le)])}destroy(){this.userOperation=je(this.userOperation),Ds(this),this._visualization=F(this._visualization);const i=this.viewshedComputedDataHandles;i!=null&&this._removeViewshedsFromRenderer(i.map(t=>t.viewshedComputedData).toArray())}_createFeatureReferenceHandles(i){const{view:t}=this;return[M(()=>[t.state.camera,t.slice.plane,i.viewshed.observer,i.targetRenderSpace,i.verticalFieldOfView,i.horizontalFieldOfView,i.feature],()=>{this._updateObserverFromFeature(t,i)},x),this._createElevationUpdateHandle(i),we(()=>i.needUpdateByFeature,()=>{this._updateObserverFromFeature(t,i),i.needUpdateByFeature=!1})]}_createElevationUpdateHandle(i){const t=(e,s)=>{const{view:a}=this,{observer:r}=i;if(r==null)return;const o=ts(r,a.spatialReference);if(o.pending!=null)return void o.pending.finally(()=>t(e,s));const n=o.geometry;n!=null&&(is(e,s,Ct,a.spatialReference),as(Ct,[n.x,n.y])&&(i.needUpdateByFeature=!0))};return this.view.elevationProvider.on("elevation-change",({extent:e,spatialReference:s})=>t(e,s))}async createViewsheds(i){await ht(this,{placementOptions:i,onToolActivated:t=>t.place("multiple")})}place(i){return ht(this,{placementOptions:i,onToolActivated:t=>t.place("single")})}_addViewshedsToRenderer(i){this._viewshedRenderNode.updateViewsheds({adds:i})}_removeViewshedsFromRenderer(i){this._viewshedRenderNode.updateViewsheds({removes:i})}_updateObserverFromFeature(i,t){const e=t.observerRenderSpace,s=t.targetRenderSpace,a=G(p(),e),r={observer:e,observerSurfaceNormal:null,observerAdjusted:a,observerFeatureId:rs(t.feature),target:s,targetSurfaceNormal:null,targetAdjusted:G(p(),s),targetFeatureId:null};os(i,this._intersector,r,o=>Math.min(o,.05*t.farDistanceRenderSpace)),t.observerRenderSpaceOverride=es(a,e)?null:a}_unselectOtherViewsheds(i){if(i!=null)for(const t of this.view.tools.items)t!==this.tool&&t instanceof O&&(t.analysisViewData.selectedViewshed=null)}get test(){}};l([d({readOnly:!0})],E.prototype,"type",void 0),l([d({constructOnly:!0,nonNullable:!0})],E.prototype,"analysis",void 0),l([d()],E.prototype,"tool",void 0),l([d()],E.prototype,"_selectedViewshed",void 0),l([d()],E.prototype,"selectedViewshed",null),l([d()],E.prototype,"selectedViewshedComputedData",null),l([d()],E.prototype,"viewshedComputedDataHandles",void 0),l([d()],E.prototype,"userOperation",void 0),l([d()],E.prototype,"_visualization",void 0),l([d()],E.prototype,"_viewshedRenderNode",void 0),E=l([ie("esri.views.3d.analysis.ViewshedAnalysisView3D")],E);const ur=E,Ct=ss(),Va=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Ke,build:qt},Symbol.toStringTag,{value:"Module"}));export{ur as default};
