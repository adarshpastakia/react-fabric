import{eY as v,ec as w,l as x,bJ as S,eZ as j,e_ as k}from"./ShadowCastClear.glsl.js";class I{constructor(o,e,n,r,p,u){this.layout=o,this.interleavedVertexData=e,this.indices=n,this.hasColors=r,this.hasModifications=p,this.positionData=u}}class L{constructor(o,e,n,r,p,u,f){this.componentOffsets=o,this.featureIds=e,this.anchorIds=n,this.anchors=r,this.transformedGeometry=p,this.globalTrafo=u,this.obb=f}}class N extends j{constructor(o){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},o,{hasInitialize:!0})}setModifications(o,e,n){const r={context:o,modifications:e,isGeodetic:n};return this.broadcast(r,"setModifications")}setLegacySchema(o,e){const n=JSON.stringify(e);return this.broadcast({context:o,jsonSchema:n},"setLegacySchema")}destroyContext(o){return this.broadcast(o,"destroyContext")}async destroyContextAndSelf(o){await this.destroyContext(o),this.destroy()}project(o,e){return this.invokeMethod("project",o,e)}transformNormals(o,e){return this.invokeMethod("transformNormals",o,e)}}const s=new v({deallocator:null}),l=S();function $(t,o,e){s.clear();let n=1/0,r=1/0,p=-1/0,u=-1/0,f=!1;for(const h of o){const m=h.type==="clip"?2:h.type==="mask"?1:0,a=h.geometry;let d=i=>i;if(a.spatialReference){if(!w(a.spatialReference,e)){x.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-projection-failed","Can't project modification polygon into layer spatial reference, ignoring modification",{polygon:a});continue}d=i=>(k(i,a.spatialReference,l,e),l)}else a.hasZ||(l[2]=0,d=i=>(l[0]=i[0],l[1]=i[1],l));f=f||m===1;const y=a.rings.length,M=a.rings.some(i=>i.length<3);if(y===0||M)x.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-invalid-polygon","Ignoring invalid modification polygon (no rings or rings with less than 3 vertices).",{polygon:a});else{s.push(m),s.push(y);for(const i of a.rings){s.push(i.length);for(const b of i){const c=d(b);s.push(c[0]),s.push(c[1]),s.push(c[2]),n=Math.min(n,c[0]),r=Math.min(r,c[1]),p=Math.max(p,c[0]),u=Math.max(u,c[1])}}}}t!=null&&(f?(s.push(2),s.push(2),s.push(4),s.push(n-1e-4),s.push(r-1e-4),s.push(0),s.push(p+1e-4),s.push(r-1e-4),s.push(0),s.push(p+1e-4),s.push(u+1e-4),s.push(0),s.push(n-1e-4),s.push(u+1e-4),s.push(0),s.push(4),s.push(t[0]),s.push(t[1]),s.push(0),s.push(t[2]),s.push(t[1]),s.push(0),s.push(t[2]),s.push(t[3]),s.push(0),s.push(t[0]),s.push(t[3]),s.push(0)):(s.push(1),s.push(1),s.push(4),s.push(t[0]),s.push(t[1]),s.push(0),s.push(t[2]),s.push(t[1]),s.push(0),s.push(t[2]),s.push(t[3]),s.push(0),s.push(t[0]),s.push(t[3]),s.push(0))),s.push(3);const g=new Float64Array(s.length);for(let h=0;h<s.length;++h)g[h]=s.at(h);return g}export{N as a,L as h,I as n,$ as u};
