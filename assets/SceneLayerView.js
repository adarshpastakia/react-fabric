const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./intersectsOperator.js","./ProjectionTransformation.js","./Point2D.js","./Envelope2D.js","./Transformation2D.js","./ShadowCastClear.glsl.js","./iframe-DwvN93Ge.js","./iframe-CGchYWp9.css","./index.js","./Viewport.js","./Section.js","./ErrorBoundary.js","./createClass.js","./Global.js","./useIsDark.js","./debounce.js","./index2.js","./ShadowCastClear-Cq39gfL_.css","./OperatorDefinitions.js","./jsonConverter.js","./OperatorIntersects.js","./apiConverter.js","./simplifyOperator2.js","./operatorSimplify.js","./unionOperator2.js","./operatorUnion.js"])))=>i.map(i=>d[i]);
import{i as U,se as V,sf as z,sg as C,bz as $,eK as D,E as p,F as y,V as L,b4 as H,e$ as G,b5 as Q,l as E,b6 as k,lX as B,lZ as J,eB as K,bx as W,ec as X,ef as R,f as S,rb as P,kh as Y,ki as Z,f8 as ee}from"./ShadowCastClear.glsl.js";import{b8 as A}from"./iframe-DwvN93Ge.js";import{a as te,n as re,b as ie}from"./TemporalSceneLayerView.js";import{d as ne}from"./LayerView.js";const oe={setAttribute(){},rollback(){},commit(){}};function he(e,r){const t=r.attributes[e.objectIdField];if(t==null)return oe;const i=e.sessions.get(t);if(i)return i;const s=U(r.attributes),d=new Set,c=e.i3sOverrides.createInteractiveEditSession(t),o=new Map,g=(a,l)=>{const f=o.get(a);if(f==null){const m=l.indexOf(t);return o.set(a,m),m}return f};let u=0;const n={setAttribute(a,l){if(u!==0)return;const f=e.fieldsIndex.get(a);if(!f)return;const m=e.attributeStorageInfo.findIndex(F=>F.name===f.name);if(m<0)return;if(!(a in s))throw new Error(`Attribute "${a}" is not an attribute of the edited feature.`);c.setAttribute(m,l);const w=e.attributeStorageInfo[m];let b=!1;d.add(a),e.forEachNode((F,I)=>{const x=g(F,I);if(x===-1)return;const v=e.getAttributeData(F.index);if(v){const O=v[w.name];O&&(O[x]=l,e.setAttributeData(F.index,v,r),b=!0)}}),b&&e.clearMemCache()},rollback(){if(u===0){for(const a of d)this.setAttribute(a,s[a]);c.remove(),u=1,e.sessions.delete(t)}},commit(){u===0&&(c.remove(),u=2,e.sessions.delete(t))}};return e.sessions.set(t,n),n}function se(e,r,t){const{gidToFeatureInfo:i,oidToFeatureInfo:s,fieldsIndex:d,objectIdField:c,globalIdField:o,featureOrIdentifierList:g}=t;if(!t.featuresResolved&&g!=null){for(const u of g){const n={feature:null,oid:-1,gid:null};if("attributes"in u){n.feature=u;const a=u.attributes;if(a!=null)for(const l in a){if(n.oid!==-1&&n.gid!=null)break;const f=d.normalizeFieldName(l);f===c&&(n.oid=a[l]??-1),f===o&&(n.gid=a[l])}}else n.oid=u.objectId??-1,n.gid=u.globalId;n.gid!=null&&i.set(n.gid,n),n.oid!==-1&&s.set(n.oid,n)}t.featuresResolved=!0}return(e!==-1?s.get(e):null)??(r!=null?i.get(r):null)}function j(e,r,t,i,s=null,d=!0){const c=[],o={gidToFeatureInfo:new Map,oidToFeatureInfo:new Map,featuresResolved:t==null,fieldsIndex:e.fieldsIndex,objectIdField:e.objectIdField,globalIdField:e.globalIdField,featureOrIdentifierList:t};for(const g of r){if(g.error!=null)continue;const u=g.objectId??-1,n=g.globalId,a=(u===-1||d?se(u,n,o):null)??{feature:null,oid:u,gid:n},l={oid:u===-1?a.oid:u,gid:n??a.gid,feature:a.feature,result:g};c.push(l);const f=l.gid?V(l.gid):null;if(l.oid===-1&&f!=null&&s!=null&&(l.oid=s.get(f)??-1),l.oid===-1&&f!=null){let m=i.get(f);m==null&&(m={gid:l.gid,edits:[]},i.set(f,m)),m.edits.push(l)}}return c}async function be(e,r){var c,o,g;const t=new Map,i=j(e,r.addedFeatures,(c=r.edits)==null?void 0:c.addFeatures,t),s=j(e,r.updatedFeatures,(o=r.edits)==null?void 0:o.updateFeatures,t),d=j(e,r.deletedFeatures,(g=r.edits)==null?void 0:g.deleteFeatures,t,r.globalIdToObjectId,!1);return t.size>0&&await le(e,t),{adds:i.filter(u=>u.oid!==-1),updates:s.filter(u=>u.oid!==-1),deletes:d.filter(u=>u.oid!==-1)}}async function le(e,r){const t=e.i3sOverrides.layer.associatedLayer;if((t==null?void 0:t.globalIdField)==null)return;const i=t.createQuery(),{objectIdField:s,globalIdField:d}=t;i.where=Array.from(r.values()).map(({gid:g})=>`${d}='${g}'`).join(" OR "),i.returnGeometry=!1,i.outFields=[s,d],i.cacheHint=!1;const c=await z(C(t,i));if(!c.ok)return;const o=c.value.features;for(const g of o){const u=g.attributes[d],n=g.attributes[s];if(u==null||n==null||n===-1)continue;const a=r.get(V(u));if(a!=null)for(const l of a.edits)l.oid=n}}function Fe(e,r){const t=new Map,i=s=>{for(const{oid:d,feature:c}of s){const o=c==null?void 0:c.geometry;(o==null?void 0:o.type)==="mesh"&&t.set(d,o)}};i(r.adds),i(r.updates);for(const s of r.deletes)t.set(s.oid,null);for(const[s,d]of t)e.i3sOverrides.updateGeometry(s,d)}function we(e,r){var l;const t=de(e,r),i=ae(e,r);if(t.size===0&&i.size===0)return;const s=new Map;for(let f=0;f<e.attributeStorageInfo.length;f++)s.set(e.attributeStorageInfo[f].name,f);let d=!1;t.forEach((f,m)=>{const w=e.getAttributeData(m);let b=!1;f.forEach((F,I)=>{const x=w!=null?w[I]:null,v=s.get(I);for(const{featureIndex:O,value:N,featureId:T}of F)x&&(x[O]=N,b=!0,d=!0),e.i3sOverrides.updateAttributeValue(T,v,N)}),b&&e.setAttributeData(m,w,null)}),d&&e.clearMemCache();const{fieldsIndex:c,i3sOverrides:o,objectIdField:g,globalIdField:u}=e,n=(l=o.layer.associatedLayer)==null?void 0:l.infoFor3D,a=new Set(n?[...Object.values(n.assetMapFieldRoles),...Object.values(n.transformFieldRoles)]:[]);for(const[f,m]of i){o.featureAdded(f);const{attributes:w}=m;for(const b in w){if(b!==g&&b!==u&&a.has(b))continue;const F=c.normalizeFieldName(b),I=F!=null?s.get(F):null;if(I==null)continue;const x=w[b];o.updateAttributeValue(f,I,x)}}}function ae(e,r){var s;const t=new Map,i=r.adds;if(!i||i.length===0||e.globalIdField==null)return t;for(const d of i){const c=d.oid,o=d.feature;((s=o==null?void 0:o.geometry)==null?void 0:s.type)==="mesh"&&t.set(c,o)}return t}function de(e,r){const t=r.updates;if(!t||t.length===0)return new M;const i=new M,s=new Map;for(let d=0;d<e.attributeStorageInfo.length;d++)s.set(e.attributeStorageInfo[d].name,d);return e.forEachNode((d,c)=>{for(const o of t){if(o.feature==null)continue;const g=o.feature,u=o.oid,n=c.indexOf(u);for(const a in g.attributes){const l=e.fieldsIndex.normalizeFieldName(a),f=ue(i,d.index,l),m=g.attributes[a];f.push({featureIndex:n,featureId:u,value:m})}}}),i}function ue(e,r,t){const i=ce(e,r),s=t!=null&&i.get(t);if(s)return s;const d=new Array;return i.set(t,d),d}function ce(e,r){const t=e.get(r);if(t)return t;const i=new fe;return e.set(r,i),i}const fe=Map,M=Map;function _e(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:r},requiredFields:t}=this;return e.outFields?$(r,[...D(r,e.outFields),...t]):$(r,t)}}}}const q=e=>{const r=e;let t=class extends r{constructor(){super(...arguments),this._updatingHandles=new H,this._numUpdating=0}get updating(){return this._numUpdating>0||this._updatingHandles.updating}destroy(){this._updatingHandles.destroy()}autoUpdateAsync(i,s){const d=G(async c=>{++this._numUpdating;try{const o=await c;this.destroyed||this._set(i,o)}catch{E.getLogger(this).warn(`Async update of "${String(i)}" failed. Async update functions should not throw exceptions.`)}--this._numUpdating});return this._updatingHandles.add(s,d,Q)}};return p([y()],t.prototype,"_updatingHandles",void 0),p([y({readOnly:!0})],t.prototype,"updating",null),p([y()],t.prototype,"_numUpdating",void 0),t=p([L("esri.core.AsyncUpdate")],t),t};q(k);let _=class extends q(k){get layer(){return this.layerView.layer}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:r},rendererFields:t,labelingFields:i,viewFilterFields:s}=this;return $(e,[...r??[],...t??[],...i??[],...s??[]])}constructor(e){super(e)}initialize(){this.addHandles([this.autoUpdateAsync("rendererFields",async()=>{const{fieldsIndex:e,renderer:r}=this.layer;return r?this._getFieldsAsync(t=>r.collectRequiredFields(t,e)):null}),this.autoUpdateAsync("labelingFields",async()=>{const{layer:e}=this;return e.labelsVisible?this._getFieldsAsync(r=>B(r,e)):null}),this.autoUpdateAsync("viewFilterFields",()=>{const{layer:e,mergedFilter:r}=this.layerView;return this._getFieldsAsync(t=>J(t,e,r))})])}async _getFieldsAsync(e){const r=new Set;try{return await e(r),Array.from(r).sort()}catch(t){return E.getLogger(this).error(t),null}}};p([y()],_.prototype,"layerView",void 0),p([y()],_.prototype,"layer",null),p([y()],_.prototype,"requiredFields",null),p([y()],_.prototype,"rendererFields",void 0),p([y()],_.prototype,"labelingFields",void 0),p([y()],_.prototype,"viewFilterFields",void 0),_=p([L("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],_);let h=class extends ne{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryOperators=null,this._projectionEngineLoaded=!1,this._abortController=new AbortController}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}get layerFilter(){return te(this._layerFilter)}get _layerFilter(){var u;const e=(u=this.layer)==null?void 0:u.filter;if(e==null||e.geometries.length<1)return null;if(!this._geometryOperators||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return re;const[r,t,i]=this._geometryOperators,s=e.geometries.at(0).spatialReference,d=e.geometries.toArray().map(n=>{let a;try{a=t.execute(n)}catch{return E.getLogger(this).warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(!a)return null;if(a.spatialReference.equals(s))return a;try{return K(a,s)}catch{return E.getLogger(this).warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}}).filter(W).sort((n,a)=>n.extent.xmin-a.extent.xmin),c=new Set,o=new Array,g=new Array;for(let n of d){const a=n.extent.xmin;if(o.length=0,c.forEach(l=>{if(a>=l.extent.xmax)return g.push(l),void c.delete(l);n.extent.ymin<=l.extent.ymax&&n.extent.ymax>=l.extent.ymin&&r.execute(n,l)&&o.push(l)}),o.length>0){let l;o.push(n);try{l=i.executeMany(o)}catch{E.getLogger(this).warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}o.pop(),l&&(o.forEach(f=>c.delete(f)),n=l)}c.add(n)}return c.forEach(n=>g.push(n)),g.length>0?{spatialRelationship:e.spatialRelationship,geometries:g}:null}get _filterNeedsProjectionEngine(){const e=this.layer.filter;if(e==null||e.geometries.length<=1)return!1;const r=e.geometries.at(0).spatialReference;return e.geometries.some(({spatialReference:t})=>!t.equals(r)&&!X(t,r))}get layerFilterUpdating(){return ie(this._layerFilter)}initialize(){const{signal:e}=this._abortController;R(()=>{var r,t,i;return this.destroyed||!this._geometryOperators&&((i=(t=(r=this.layer)==null?void 0:r.filter)==null?void 0:t.geometries)==null?void 0:i.length)},e).then(async()=>{S(e),this._geometryOperators=await Promise.all([A(()=>import("./intersectsOperator.js").then(r=>r.i),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21]),import.meta.url),A(()=>import("./simplifyOperator2.js").then(r=>r.s),__vite__mapDeps([22,2,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,23,21]),import.meta.url),A(()=>import("./unionOperator2.js").then(r=>r.u),__vite__mapDeps([24,2,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,25,21]),import.meta.url)])}).catch(P),this._projectionEngineLoaded=Y(),R(()=>this.destroyed||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine,e).then(async()=>{S(e),await Z(),this._projectionEngineLoaded=!0}).catch(P)}destroy(){this._abortController=ee(this._abortController)}highlight(e,r){throw new Error("Not implemented")}queryFeatures(e,r){throw new Error("Not implemented")}queryObjectIds(e,r){throw new Error("Not implemented")}queryFeatureCount(e,r){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,r){throw new Error("Not implemented")}};p([y()],h.prototype,"layer",void 0),p([y()],h.prototype,"availableFields",null),p([y()],h.prototype,"maximumNumberOfFeatures",null),p([y({readOnly:!0})],h.prototype,"maximumNumberOfFeaturesExceeded",null),p([y()],h.prototype,"filter",void 0),p([y({readOnly:!0})],h.prototype,"layerFilter",null),p([y({readOnly:!0})],h.prototype,"_layerFilter",null),p([y()],h.prototype,"_geometryOperators",void 0),p([y()],h.prototype,"_projectionEngineLoaded",void 0),p([y()],h.prototype,"_filterNeedsProjectionEngine",null),p([y()],h.prototype,"layerFilterUpdating",null),h=p([L("esri.views.layers.SceneLayerView")],h);export{_ as a,we as b,_e as c,Fe as d,h as f,he as i,be as u};
