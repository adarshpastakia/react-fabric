import{b6 as V,bD as F,bj as x,f$ as S,E as l,F as p,V as k,bJ as g,gC as b,bK as N,bL as m,ux as L,uy as G,uz as D,uA as q,b$ as E,uB as j,gO as W,gN as K,uC as J,kC as X,lz as Y,hn as H,hs as Q,fT as Z,b9 as O,e_ as ee,fd as $,fU as te,cf as ie,bI as u,uD as se,b_ as re,n7 as ne,qd as R,go as T,bk as ae,b5 as oe,oU as he,bn as B}from"./ShadowCastClear.glsl.js";import{a as ce}from"./ExtentSet.js";let _=class extends V{constructor(e){super(e),this._dirtyExtents=new ce,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new F}initialize(){var i;const e=this.elevationProvider,t=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=t.registerTask(A((i=this.graphicsCore.layer.elevationInfo)==null?void 0:i.mode),this),this.addHandles([e.on("elevation-change",n=>this._elevationChanged(n)),x(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,x(()=>{var n;return A((n=this.graphicsCore.layer.elevationInfo)==null?void 0:n.mode)},n=>this._task.priority=n)])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null,this._dirtyExtents.destroy()}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){this.graphicsCoreOwner.suspended===!0?this._updateElevation=!1:this.graphicsCoreOwner.suspended===!1&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.readyToRun}get readyToRun(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(e){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run(()=>this._dirtyExtents.merge(e));this.readyToRun&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.notifyChange("updating")}_updateDirtyGraphics(e){var n;const t=this.graphicsCoreOwner.view.renderCoordsHelper,i=this.graphicsCore.effectiveUpdatePolicy===0;for(const s of this._dirtyGraphicsSet.keys()){const a=this.graphicsCore.getGraphics3DGraphicById(s);if(this._dirtyGraphicsSet.delete(s),a!=null&&(a.alignWithElevation(this.elevationProvider,t,i),(n=this.graphicsCore.deconflictor)==null||n.setDirty(),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this._dirtyExtents.empty&&!e.done;){const t=this._dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});const n=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,i,s=>{const a=this.graphicsCore.getGraphics3DGraphicById(s);a!=null&&a.needsElevationUpdates()&&this._dirtyGraphicsSet.add(s)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-n)+.9*this._averageExtentUpdateSize,e.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((e,t)=>this._dirtyGraphicsSet.add(t))}_elevationChanged(e){if(e.context==="scene"&&(!this.graphicsCore.layer.elevationInfo||this.graphicsCore.layer.elevationInfo.mode!=="relative-to-scene"))return;const t=e.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const i=this.graphicsCore.computedExtent;i&&t[2]>i.xmin&&t[0]<i.xmax&&t[3]>i.ymin&&t[1]<i.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",e)}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange("updating")}};function A(r){return r==null?S.ELEVATION_ALIGNMENT:r==="relative-to-scene"?S.ELEVATION_ALIGNMENT_SCENE:S.ELEVATION_ALIGNMENT}l([p()],_.prototype,"graphicsCoreOwner",void 0),l([p()],_.prototype,"graphicsCore",void 0),l([p()],_.prototype,"queryGraphicUIDsInExtent",void 0),l([p()],_.prototype,"elevationProvider",void 0),l([p({readOnly:!0})],_.prototype,"updating",null),l([p({readOnly:!0})],_.prototype,"updatingRemaining",null),_=l([k("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],_);const z=.5*Math.PI,le=z/Math.PI*180;class de{constructor(e){this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:g(),direction:g()},this._renderCoordsHelper=e.renderCoordsHelper;for(let t=0;t<4;t++)this._extent[t]={origin:g(),direction:g(),cap:{next:null,direction:g()}},this._planes[t]=b();this._planes[4]=b(),this._planes[5]=b(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,i,n=!0){const s=this._extent;this._toRenderBoundingExtent(e,t,i),N(this._center.origin,s[0].origin,s[2].origin),m(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),n||m(this._center.direction,this._center.direction,-1);for(let a=0;a<4;a++){const h=s[a];this._renderCoordsHelper.worldUpAtPosition(h.origin,h.direction);const f=s[a===3?0:a+1];h.cap.next=f.origin,L(h.cap.direction,h.origin,f.origin),G(h.direction,h.cap.direction,h.origin,this._planes[a]),n||m(h.direction,h.direction,-1)}G(s[0].cap.direction,s[1].cap.direction,s[0].origin,this._planes[4]),n?D(this._planes[4],this._planes[5]):(q(this._planes[5],this._planes[4]),D(this._planes[4],this._planes[4])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*E(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,i=!1){if(e==null)return!1;if(this._renderCoordsHelper.viewingMode===1){const s=this._maxSpanSpatialReference.isGeographic?le:z*t;if(this._maxSpan>s)return!0;if(e.altitude!=null&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(this._maxSpan===0){const s=this._extent[0];return!(i||!e.intersectsRay(j(s.origin,s.direction)))}for(let s=0;s<this._extent.length;s++){const a=this._extent[s];if(!i&&e.intersectsRay(j(a.origin,a.direction))||e.intersectsLineSegment(W(a.origin,a.cap.next,ue),a.cap.direction))return!0}const n=i?this._planes:this._planesWithoutFar;for(let s=0;s<e.lines.length;s++){const a=e.lines[s];if(J(n,a.origin,a.endpoint,a.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,i){X(e,c),c[2]=i,Y(t,c,C,this._renderCoordsHelper.spatialReference),Q(U,C),Z(o);for(const{x0:s,x1:a,y0:h,y1:f}of pe)for(let v=0;v<5;v++){const I=v/4;c[0]=O(e[s],e[a],I),c[1]=O(e[h],e[f],I),c[2]=i,ee(c,t,c,this._renderCoordsHelper.spatialReference),$(c,c,U),te(o,c)}u(this._extent[0].origin,o[0],o[1],o[2]),u(this._extent[1].origin,o[3],o[1],o[2]),u(this._extent[2].origin,o[3],o[4],o[2]),u(this._extent[3].origin,o[0],o[4],o[2]);for(let s=0;s<4;++s)$(this._extent[s].origin,this._extent[s].origin,C)}_toRenderBoundingExtentLocal(e,t,i){se(e,t,d,this._renderCoordsHelper.spatialReference),u(this._extent[0].origin,d[0],d[1],i),u(this._extent[1].origin,d[2],d[1],i),u(this._extent[2].origin,d[2],d[3],i),u(this._extent[3].origin,d[0],d[3],i)}_toRenderBoundingExtent(e,t,i){switch(this._renderCoordsHelper.viewingMode){case 1:this._toRenderBoundingExtentGlobal(e,t,i);break;case 2:this._toRenderBoundingExtentLocal(e,t,i);break;default:ne(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if(R(e.planes[4],this._center.origin)<0&&T(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const i=this._extent[t];if(R(e.planes[4],i.origin)<0&&T(i.direction,e.direction)<0)return!0}return!1}}const pe=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],c=g(),C=H(),U=H(),o=ie(),d=re(),ue=K(),_e=1.2;let y=class extends V{constructor(r){super(r),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:r}=this;this._extentIntersection=new de({renderCoordsHelper:r.view.renderCoordsHelper});const e=r.view,t=e.basemapTerrain,i=e.resourceController.scheduler;this.addHandles([e.on("resize",()=>this._viewChange()),x(()=>e.state.camera,()=>this._viewChange(),ae),i.registerTask(S.FRUSTUM_VISIBILITY,this),x(()=>t.visibleElevationBounds,()=>this._elevationBoundsChange())]),e.viewingMode==="local"?this._isVisibleBelowSurface=!0:this.addHandles([x(()=>{var n,s,a;return[t.baseOpacity,t.wireframe,(a=(s=(n=e.map)==null?void 0:n.ground)==null?void 0:s.navigationConstraint)==null?void 0:a.type]},()=>this._updateIsVisibleBelowSurface(),oe)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(r){this._extent=r,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(r){this._isVisibleBelowSurfaceInternal=r,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){var n,s;const r=this.graphicsCoreOwner.view,e=r.basemapTerrain,t=r.viewingMode==="local",i=((s=(n=r.map.ground)==null?void 0:n.navigationConstraint)==null?void 0:s.type)==="none";this._isVisibleBelowSurface=t||!e.opaque||i}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const r=this.graphicsCoreOwner.view;let e;if(this._isVisibleBelowSurfaceInternal)e=-.3*E(r.spatialReference).radius;else{const{min:t,max:i}=r.basemapTerrain.visibleElevationBounds;e=t-Math.max(1,(i-t)*(_e-1))}this._extentIntersection.update(this._extent,r.spatialReference,e)}get readyToRun(){return this.updating}runTask(r){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),he;this._updateExtentIntersection();const e=this.graphicsCoreOwner.view.frustum,t=E(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(e,t)),r.madeProgress()}};l([p({readOnly:!0})],y.prototype,"suspended",void 0),l([p({constructOnly:!0})],y.prototype,"graphicsCoreOwner",void 0),l([p({readOnly:!0})],y.prototype,"updating",void 0),y=l([k("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],y);class w{}class ge extends w{constructor(e,t){super(),this.objectStateId=e,this.object=t}remove(){this.object.removeStateID(this.objectStateId)}}let ye=class extends w{constructor(e,t,i){super(),this.objectStateId=e,this.object=t,this.owner=i}remove(){this.owner.removeRenderGeometryObjectState(this.object,this.objectStateId)}};class xe extends w{constructor(e,t){super(),this.objectStateId=e,this._removeCallback=t,this.object=null}remove(){this._removeCallback(this.objectStateId)}}class P{constructor(){this._items=[]}addObject(e,t){this._items.push(new ge(t,e))}addRenderGeometry(e,t,i){this._items.push(new ye(t,e,i))}addExternal(e,t){this._items.push(new xe(t,e))}remove(e){this._remove(t=>t.objectStateId===e)}removeByObject(e){this._remove(t=>t.object===e)}removeAll(){this._items.forEach(e=>e.remove()),this._items=[]}_remove(e){const{_items:t}=this;for(let i=t.length-1;i>=0;--i){const n=t[i];e(n)&&(n.remove(),t.splice(i,1))}}}let fe=class extends P{constructor(){super(...arguments),this.stateType=1}},Se=class extends P{constructor(e){super(),this.highlightName=e,this.stateType=0}};class M{constructor(e){this.objectIdField=e,this.ids=new Set,this.paused=!1}hasGraphic(e){const t=this.objectIdField?e.graphic.attributes[this.objectIdField]:e.graphic.uid;return this.ids.has(t)}}class ve extends M{constructor(e){super(e),this.stateType=1,this.objectStateSet=new fe}}class be extends M{constructor(e,t){super(t),this.highlightName=e,this.stateType=0,this.objectStateSet=new Se(e)}}class De{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(e=>e.objectStateSet.removeAll()),this._stateSets.length=0)}acquireOccludeeSet(e){const t=new ve(e);this._stateSets.push(t);const i=B(()=>this.releaseSet(t));return{set:t,handle:i}}acquireHighlightSet(e,t){const i=new be(e,t);this._stateSets.push(i);const n=B(()=>this.releaseSet(i));return{set:i,handle:n}}releaseSet(e){e.objectStateSet.removeAll();const t=this._stateSets?this._stateSets.indexOf(e):-1;t!==-1&&this._stateSets.splice(t,1)}setUid(e,t){e.ids.add(t);const i=this._graphicsCore.graphics3DGraphics.get(t);i&&i.addObjectStateSet(e.objectStateSet)}setUids(e,t){t.forEach(i=>this.setUid(e,i))}setObjectIds(e,t){t.forEach(i=>e.ids.add(i)),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach(t=>{!t.paused&&t.hasGraphic(e)&&e.addObjectStateSet(t.objectStateSet)})}removeGraphic(e){this._stateSets.forEach(t=>{t.hasGraphic(e)&&e.removeObjectState(t.objectStateSet)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(e=>e.objectStateSet.removeAll())}_initializeSet(e){const t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach(i=>{i&&e.hasGraphic(i)&&i.addObjectStateSet(e.objectStateSet)}):e.ids.forEach(i=>{const n=t.get(i);n&&n.addObjectStateSet(e.objectStateSet)})}get test(){}}export{De as a,_ as h,y as u};
