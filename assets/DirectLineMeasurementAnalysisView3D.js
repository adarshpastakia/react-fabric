import{b6 as rt,bj as P,bo as O,l as Et,ye as lt,yd as zt,ga as D,E as n,F as r,V as W,wh as At,EW as xt,F3 as q,F1 as F,FW as U,r1 as Q,eF as Tt,F5 as Gt,F6 as Ht,lu as Rt,F7 as Ft,Fc as jt,FG as Wt,Fh as kt,Fj as It,Fk as ut,eC as Qt,Fi as ht,Fo as Bt,bE as N,Fp as qt,bI as Y,bJ as C,fW as J,fc as Mt,fV as St,na as Ut,fd as K,hn as Nt,sQ as dt,GA as st,bG as ct,mB as Yt,bl as S,h0 as k,GB as Jt,GC as Kt,fe as Xt,gM as Zt,fi as te,qc as ee,h6 as pt,xZ as Vt,h3 as nt,h4 as gt,ym as ie,b5 as B,bL as se,bK as ne,GD as ae,FX as re,hw as oe,yn as le,p1 as Ot,fF as mt,o_ as ot,eU as ue,b8 as _t,gO as he,Gh as de,mt as ce,b4 as pe,kP as ge,er as me,pW as vt,FT as _e,gJ as ve,a5 as ye,f8 as we,yg as be}from"./ShadowCastClear.glsl.js";import{e as fe}from"./AnalysisView3D.js";import{r as Pe,a as Le,o as Ce,p as I,Y as yt,g as Me,t as Se}from"./ShadedColorMaterial.glsl.js";import{aa as Ve,Y as Oe,I as X,W as $e,g as De}from"./euclideanLengthMeasurementUtils.js";import{d as Z,T as Ee,D as wt,V as ze,w as bt}from"./quantityFormatUtils.js";import{f as tt,_ as ft,m as j,C as Pt}from"./Segment.js";import{b6 as Ae}from"./iframe-DpfJK_wQ.js";import{a as xe,w as Te}from"./SnappingVisualizer3D.js";import{h as et}from"./lineStippleUtils.js";import{w as Ge}from"./measurementUtils.js";import{G as He,O as Re}from"./dragEventPipeline3D.js";import{c as Fe}from"./LaserlinePath.glsl.js";import{o as je,m as We,f as ke,d as Ie}from"./analysisViewUtils.js";import{g as Qe,w as Be,a as qe}from"./EditGeometryOperations.js";import{p as Ue,h as Ne}from"./InteractiveToolBase.js";import{e as Ye}from"./SnappingContext.js";import{f as Je}from"./SnappingDragPipelineStep.js";import{a as Ke}from"./SnappingManagerPool.js";import"./index.js";import"./Viewport.js";import"./debounce.js";import"./index2.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";import"./AnalysisView.js";import"./VisualElement.js";import"./line.js";import"./ColorMaterial.glsl.js";import"./TriangleMaterial.js";import"./geometry2dUtils.js";import"./geodeticLengthOperator.js";import"./geodeticCurveType.js";import"./TextOverlayItem.js";import"./ExtendedLineVisualElement.js";import"./EngineVisualElement.js";import"./PointVisualElement.js";import"./rotate.js";import"./curveOperationUtils.js";import"./PointSnappingHint.js";import"./dehydratedFeatureComparison.js";import"./allLayerSnapping.js";let T=class extends rt{constructor(e){super(e)}initialize(){this.addHandles([P(()=>({viewData:this.viewData,startPoint:this.analysis.startPoint}),({viewData:e,startPoint:i})=>{e.elevationAlignedStartPoint=this._applyProjectionAndElevationAlignment(i)},O),P(()=>({viewData:this.viewData,endPoint:this.analysis.endPoint}),({viewData:e,endPoint:i})=>{e.elevationAlignedEndPoint=this._applyProjectionAndElevationAlignment(i)},O),P(()=>({result:this._computedResult,viewData:this.viewData}),({result:e,viewData:i})=>{i.result=e},O)])}_applyProjectionAndElevationAlignment(e){if(e==null)return e;const{spatialReference:i,elevationProvider:s}=this.view;return Pe(e,i,s)??(Le(this.analysis,e.spatialReference,Et.getLogger(this)),null)}get _computedResult(){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,measurementMode:s,unit:o}=this.viewData;if(e==null||i==null)return null;const a=Ve(e,i),c=this.geodesicLengthMeasurementUtils.geodesicDistanceBetweenPoints(e,i);if(a==null)return null;let p,h;switch(s){case 0:h=c!=null?"geodesic":"euclidean",p=c??a.horizontal;break;case 2:if(c==null)return null;h="geodesic",p=c;break;case 1:h="euclidean",p=a.horizontal}let l=a.direct,u=a.vertical;const d=lt(l.value,l.unit,o),g=lt(p.value,p.unit,o),m=zt(u.value,u.unit,o);return l=D(l,d),p=D(p,g),u=D(u,m),{mode:h,directDistance:l,horizontalDistance:p,verticalDistance:u}}};n([r({constructOnly:!0})],T.prototype,"view",void 0),n([r({constructOnly:!0})],T.prototype,"analysis",void 0),n([r({constructOnly:!0})],T.prototype,"viewData",void 0),n([r({constructOnly:!0})],T.prototype,"geodesicLengthMeasurementUtils",void 0),n([r()],T.prototype,"_computedResult",null),T=n([W("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementController")],T);function $t(t){const e=new At,{vertex:i,fragment:s}=e;xt(i,t),i.uniforms.add(new q("width",a=>a.width)),e.attributes.add("position","vec3"),e.attributes.add("normal","vec3"),e.attributes.add("uv0","vec2"),e.attributes.add("length","float"),e.varyings.add("vtc","vec2"),e.varyings.add("vlength","float"),e.varyings.add("vradius","float"),i.main.add(F`vec3 bitangent = normal;
vtc = uv0;
vlength = length;
vradius = 0.5 * width;
vec4 pos = view * vec4(position + vradius * bitangent * uv0.y, 1.0);
gl_Position = proj * pos;`),s.uniforms.add(new q("outlineSize",a=>a.outlineSize),new U("outlineColor",a=>a.outlineColor),new q("stripeLength",a=>a.stripeLength),new U("stripeEvenColor",a=>a.stripeEvenColor),new U("stripeOddColor",a=>a.stripeOddColor));const o=1/Math.sqrt(2);return s.code.add(F`
    const float INV_SQRT2 = ${F.float(o)};

    vec4 arrowColor(vec2 tc, float len) {
      float d = INV_SQRT2 * (tc.x - abs(tc.y));
      d = min(d, INV_SQRT2 * (len - tc.x - abs(tc.y)));
      d = min(d, 1.0 - abs(tc.y));

      if (d < 0.0) {
        return vec4(0.0);
      }
      if (d < outlineSize) {
        return outlineColor;
      }
      return fract(0.5 / stripeLength * tc.x * vradius) >= 0.5 ? stripeOddColor : stripeEvenColor;
    }`),s.main.add(F`
    vec2 ntc = vec2(vtc.x / vradius, vtc.y);
    vec4 color = arrowColor(ntc, vlength / vradius);
    if (color.a < ${F.float(Q)}) {
      discard;
    }
    fragColor = color;`),e}const Xe=Object.freeze(Object.defineProperty({__proto__:null,build:$t},Symbol.toStringTag,{value:"Module"}));class Ze extends Gt{constructor(e,i){super(e,i,new Ht(Xe,()=>Ae(()=>Promise.resolve().then(()=>yi),void 0,import.meta.url)),Dt.locations),this.primitiveType=Rt.TRIANGLE_STRIP}initializePipeline(e){return Ft({blending:e.transparent?kt(e.oitPass):null,polygonOffset:e.polygonOffsetEnabled?{factor:0,units:-4}:null,depthTest:{func:513},depthWrite:Wt,colorWrite:jt})}}const Dt=Tt().vec3f("position").vec3f("normal").vec2f("uv0").f32("length");class at extends It{constructor(){super(...arguments),this.polygonOffsetEnabled=!1,this.transparent=!1}}n([ut()],at.prototype,"polygonOffsetEnabled",void 0),n([ut()],at.prototype,"transparent",void 0);class ti extends Qt{constructor(e){super(e,ii),this._configuration=new at,this.intersectDraped=void 0,this.produces=new Map([[2,i=>!this._transparent&&ht(i)],[8,i=>this._transparent&&ht(i)]])}getConfiguration(e,i){return super.getConfiguration(e,i,this._configuration),this._configuration.polygonOffsetEnabled=this.parameters.polygonOffset,this._configuration.transparent=this._transparent,this._configuration.oitPass=i.oitPass,this._configuration}get visible(){const{outlineColor:e,stripeEvenColor:i,stripeOddColor:s}=this.parameters;return e[3]>=Q||i[3]>=Q||s[3]>=Q}intersect(){}createGLMaterial(e){return new ei(e)}createBufferWriter(){return new li}get _transparent(){const{parameters:e}=this;return e.outlineColor[3]<1||e.stripeEvenColor[3]<1||e.stripeOddColor[3]<1}}let ei=class extends qt{beginSlot(e){return this.getTechnique(Ze,e)}};class ii extends Bt{constructor(){super(...arguments),this.width=32,this.outlineSize=.2,this.outlineColor=N(1,.5,0,1),this.stripeEvenColor=N(1,1,1,1),this.stripeOddColor=N(1,.5,0,1),this.stripeLength=1,this.polygonOffset=!1}}const si=C(),ni=C(),ai=C(),ri=C(),oi=C();class li{constructor(){this.layout=Dt}elementCount(e){return 2*(e.get("position").indices.length/2+1)}write(e,i,s,o,a,c){const{data:p,indices:h}=s.get("position"),l=s.get("normal").data,u=p.length/3;h&&h.length!==2*(u-1)&&console.warn("MeasurementArrowMaterial does not support indices");const d=si,g=ni,m=ai,b=ri,V=oi,$=a.position,E=a.normal,z=a.uv0;let A=0;for(let M=0;M<u;++M){const G=3*M;if(Y(d,p[G],p[G+1],p[G+2]),M<u-1){const H=3*(M+1);Y(g,p[H],p[H+1],p[H+2]),Y(V,l[H],l[H+1],l[H+2]),J(V,V),Mt(m,g,d),J(m,m),St(b,V,m),J(b,b)}const x=Ut(d,g);e&&i&&(K(d,d,e),K(g,g,e),K(b,b,i));const f=c+2*M,L=f+1;$.setVec(f,d),$.setVec(L,d),E.setVec(f,b),E.setVec(L,b),z.set(f,0,A),z.set(f,1,-1),z.set(L,0,A),z.set(L,1,1),M<u-1&&(A+=x)}const R=a.length;for(let M=0;M<2*u;++M)R.set(c+M,A);return null}}class ui extends Ce{constructor(e){super(e),this._arrowWidth=16,this._arrowSubdivisions=128,this._origin=C(),this._originTransform=Nt(),this._arrowCenter=C(),this._renderOccluded=4,this._geometry=null,this._stripeLength=1,this._stripesEnabled=!0,this._color=dt(),this._contrastColor=dt(),this.applyProperties(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){var i;e!==this._renderOccluded&&(this._renderOccluded=e,(i=this._arrowMaterial)==null||i.setParameters({renderOccluded:e}))}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this._geometryChanged()}get stripeLength(){return this._stripeLength}set stripeLength(e){this._stripeLength=e,this.attached&&this._arrowMaterial.setParameters({stripeLength:this._stripeLength})}get stripesEnabled(){return this._stripesEnabled}set stripesEnabled(e){if(this._stripesEnabled=e,this.attached){const i=this._stripesEnabled?this._contrastColor:this._color;this._arrowMaterial.setParameters({stripeEvenColor:i})}}get color(){return this._color}set color(e){st(e,this._color)||(ct(this._color,e),this._updateArrowColor())}get contrastColor(){return this._contrastColor}set contrastColor(e){st(e,this._color)||(ct(this._contrastColor,e),this._updateArrowColor())}createExternalResources(){const e=this._color,i=this._contrastColor,s=this._stripesEnabled?i:e;this._arrowMaterial=new ti({outlineColor:e,stripeEvenColor:s,stripeOddColor:e,renderOccluded:this.renderOccluded,polygonOffset:!0,isDecoration:this.isDecoration}),this._handles=new Yt,this._handles.add(P(()=>this.view.state.camera,()=>{this._viewChanged()}))}destroyExternalResources(){this._arrowMaterial=null,this._handles=S(this._handles)}forEachMaterial(e){e(this._arrowMaterial)}createGeometries(e){var s;if(((s=this._geometry)==null?void 0:s.startRenderSpace)==null||this._geometry.endRenderSpace==null)return;const i=this._createArrowGeometry(this._geometry.startRenderSpace,this._geometry.endRenderSpace,this._origin,this._geometry);i.transformation=this._originTransform,e.addGeometry(i),this._viewChanged()}_createArrowGeometry(e,i,s,o){const a=this.view,c=a.renderCoordsHelper,p=[],h=[],l=(u,d)=>{const g=k.get();Mt(g,u,s),p.push(g),h.push(d)};if(o.type==="euclidean"){o.eval(.5,this._arrowCenter);const u=k.get();if(c.worldUpAtPosition(this._arrowCenter,u),hi(e,i,u)){const{heading:d,tilt:g}=a.camera,{direction:m}=Jt(a,e,d,g,di);Xt(u,m)}l(e,u),l(i,u)}else{o.eval(.5,this._arrowCenter);const u=this._arrowSubdivisions+1&-2;for(let d=0;d<u;++d){const g=d/(u-1),m=k.get(),b=k.get();o.eval(g,m),c.worldUpAtPosition(m,b),l(m,b)}}return Zt(this._arrowMaterial,p,h)}_geometryChanged(){this.recreateGeometry()}_viewChanged(){if(this.view.ready&&this.attached&&this._geometry!=null){const e=this.view.state.camera.computeScreenPixelSizeAt(this._arrowCenter);this._arrowMaterial.setParameters({width:this._arrowWidth*e})}}_updateArrowColor(){if(!this.attached)return;const e=this._color,i=this._contrastColor,s=this._stripesEnabled?i:e,o=e,a=e;this._arrowMaterial.setParameters({stripeEvenColor:s,outlineColor:o,stripeOddColor:a})}}function hi(t,e,i){const s=te(Lt,e,t),o=St(Lt,s,i);return ee(o)===0}const Lt=C(),di=Kt();let w=class extends rt{get _parameters(){const t=this.view.effectiveTheme,{accentColor:e,textColor:i}=t,s=pt(e),o=Vt(e,.75),a=pt(nt(e)),c=nt(i,160);return{accentColor:s,contrastColor:a,translucentAccentColor:o,triangleLineWidth:3,geodesicProjectionLineWidth:2,guideLineWidth:2,guideStippleLengthPixels:3,directLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12,textColor:i,textBackgroundColor:gt(c,.6),textCalloutColor:gt(c,.5)}}get visible(){return this.analysisView.visible}get viewMode(){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}=this.analysisView;if(t==null||e==null||t.equals(e))return 0;const i=this.analysisView.result;if(i==null)return 1;if(this.actualVisualizedMeasurement==="geodesic")return this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition)?3:1;const{verticalDistance:s,horizontalDistance:o}=i,a=D(s,"meters").value,c=D(o,"meters").value;return Math.min(a/c,c/a)<this.triangleCollapseRatioThreshold?1:2}get actualVisualizedMeasurement(){const{measurementMode:t,result:e}=this.analysisView;switch(t){case 0:return e!=null&&D(e.horizontalDistance,"meters").value>Oe?"geodesic":"euclidean";case 1:return"euclidean";case 2:return"geodesic"}}get allowVisualElementsOrientationChange(){return this._triangleOrientationOverride==null}set allowVisualElementsOrientationChange(t){this._triangleOrientationOverride==null!==t&&(this._triangleOrientationOverride==null?this._triangleOrientationOverride=this._actualVisualElementsOrientation:this._triangleOrientationOverride=null)}get labels(){return this.actualVisualizedMeasurement==="geodesic"?{direct:null,horizontal:this._segmentLabel,vertical:this._verticalLabel}:{direct:this._segmentLabel,horizontal:this._horizontalLabel,vertical:this._verticalLabel}}constructor(t){super(t),this._segmentVisualElement=null,this._triangleVisualElement=null,this._rightAngleQuad=null,this._projectedGeodesicLine=null,this._geodesicStartHint=null,this._geodesicEndHint=null,this._segmentLabel=null,this._verticalLabel=null,this._horizontalLabel=null,this._startPosition=C(),this._endPosition=C(),this._cornerPosition=C(),this._startPositionAtSeaLevel=C(),this._endPositionAtSeaLevel=C(),this._triangleOrientationOverride=null,this.messages=null,this.loadingMessages=!0,this.visualElementOrientation=0,this.triangleCollapseRatioThreshold=.03}initialize(){const t={attached:!0,view:this.view,isDecoration:!0},{guideLineWidth:e,guideStippleLengthPixels:i,triangleLineWidth:s,geodesicProjectionLineWidth:o,directLabelFontSize:a,verticalLabelFontSize:c,horizontalLabelFontSize:p}=this._parameters;this._segmentVisualElement=new ui({...t,geometry:null,renderOccluded:4}),this._triangleVisualElement=new I({...t,width:s,renderOccluded:4}),this._rightAngleQuad=new xe({...t,renderOccluded:4});const h={...t,polygonOffset:!0,renderOccluded:4};this._projectedGeodesicLine=new I({...h,width:o,stipplePattern:et(i)}),this._geodesicStartHint=new I({...h,width:e,stipplePattern:et(i)}),this._geodesicEndHint=new I({...h,width:e,stipplePattern:et(i)}),this._segmentLabel=new tt({...t,fontSize:a}),this._verticalLabel=new tt({...t,fontSize:c}),this._horizontalLabel=new tt({...t,fontSize:p}),this.addHandles([P(()=>{const{elevationAlignedStartPoint:l,elevationAlignedEndPoint:u}=this.analysisView,d=this.view;return{view:d,camera:d.state.camera,viewMode:this.viewMode,elevationAlignedStartPoint:l,elevationAlignedEndPoint:u,orientation:this._actualVisualElementsOrientation,visualizedMeasurement:this.actualVisualizedMeasurement,stripeLength:this._measurementArrowStripeLength}},l=>this._updateGeometryAndViewMode(l),O),P(()=>({visible:this.visible,viewMode:this.viewMode}),l=>this._updateVisualElementVisibility(l),O),P(()=>({text:this._labelsText,visualizedMeasurement:this.actualVisualizedMeasurement}),l=>this._updateLabelText(l),O),P(()=>({visible:this.visible,viewMode:this.viewMode}),l=>this._updateLabelVisibility(l),O),P(()=>this._measurementArrowStripeLength,l=>this._updateSegmentStripeLength(l),O),ie(()=>this._updateMessageBundle()),P(()=>this._parameters,({textBackgroundColor:l,textCalloutColor:u,textColor:d,translucentAccentColor:g,accentColor:m,contrastColor:b})=>{const{_segmentLabel:V,_verticalLabel:$,_horizontalLabel:E,_triangleVisualElement:z,_rightAngleQuad:A,_projectedGeodesicLine:R,_geodesicStartHint:M,_geodesicEndHint:G,_segmentVisualElement:x}=this;V.backgroundColor=l,V.calloutColor=u,V.textColor=d,$.backgroundColor=l,$.calloutColor=u,$.textColor=d,E.backgroundColor=l,E.calloutColor=u,E.textColor=d,z.color=g,A.color=g,R.color=g,M.color=g,G.color=g,x.color=m,x.contrastColor=b},B)]),this._updateMessageBundle()}destroy(){this._segmentVisualElement=S(this._segmentVisualElement),this._triangleVisualElement=S(this._triangleVisualElement),this._rightAngleQuad=S(this._rightAngleQuad),this._projectedGeodesicLine=S(this._projectedGeodesicLine),this._geodesicStartHint=S(this._geodesicStartHint),this._geodesicEndHint=S(this._geodesicEndHint),this._segmentLabel=S(this._segmentLabel),this._verticalLabel=S(this._verticalLabel),this._horizontalLabel=S(this._horizontalLabel),this.set("view",null)}_updateVisualElementVisibility({visible:t,viewMode:e}){if(this._segmentVisualElement.visible=!1,this._triangleVisualElement.visible=!1,this._rightAngleQuad.visible=!1,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1,t)switch(e){case 0:break;case 1:this._segmentVisualElement.visible=!0;break;case 2:this._segmentVisualElement.visible=!0,this._triangleVisualElement.visible=!0,this._rightAngleQuad.visible=!0;break;case 3:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}}_updateGeometryAndViewMode({view:t,camera:e,viewMode:i,elevationAlignedStartPoint:s,elevationAlignedEndPoint:o,orientation:a,visualizedMeasurement:c,stripeLength:p}){const h=t.renderCoordsHelper;if(h==null||s==null||o==null||s.equals(o))return;let l=this._startPosition,u=this._endPosition;h.toRenderCoords(s,l),h.toRenderCoords(o,u);const d=a===1?1:-1,g=d*(h.getAltitude(u)-h.getAltitude(l));g<0&&(l=this._endPosition,u=this._startPosition);const m=c==="geodesic"?new ft(this._startPosition,this._endPosition,h.spatialReference):new j(this._startPosition,this._endPosition);switch(this._segmentVisualElement.geometry=m,this._updateSegmentStripeLength(p),i){case 1:this._updateSegment(m,a);break;case 2:this._updateSegmentAndTriangle({view:t,camera:e,segment:m,orientation:a,startPosition:l,endPosition:u,deltaSign:d,altitudeDelta:g});break;case 3:this._updateSegmentAndProjection({view:t,orientation:a,startPosition:l,endPosition:u})}}_updateSegment(t,e){this._segmentLabel.anchor=e===1?"top":"bottom",this._segmentLabel.geometry={type:"segment",segment:t,sampleLocation:"center"}}_updateSegmentAndTriangle({view:{renderCoordsHelper:t},camera:e,segment:i,orientation:s,startPosition:o,endPosition:a,deltaSign:c,altitudeDelta:p}){const h=this._cornerPosition;t.worldUpAtPosition(o,h),se(h,h,c*Math.abs(p)),ne(h,h,o),this._triangleVisualElement.geometry=[[[o[0],o[1],o[2]],[h[0],h[1],h[2]],[a[0],a[1],a[2]]]],this._rightAngleQuad.geometry={previous:o,center:h,next:a};const l=new j(o,h),u=new j(h,a),d=ci(o,a,h,s,e);d&&(this._segmentLabel.anchor=d.segment,this._segmentLabel.geometry={type:"segment",segment:i,sampleLocation:"center"},this._verticalLabel.geometry={type:"segment",segment:l,sampleLocation:"center"},this._verticalLabel.anchor=d.vertical,this._horizontalLabel.geometry={type:"segment",segment:u,sampleLocation:"center"},this._horizontalLabel.anchor=d.horizontal)}_updateSegmentAndProjection({view:{renderCoordsHelper:t},orientation:e,startPosition:i,endPosition:s}){t.setAltitude(this._startPositionAtSeaLevel,0,i),t.setAltitude(this._endPositionAtSeaLevel,0,s);const o=new ft(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,t.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(o),this._geodesicStartHint.setGeometryFromSegment(new j(this._startPositionAtSeaLevel,i)),this._geodesicEndHint.setGeometryFromSegment(new j(this._endPositionAtSeaLevel,s)),this._segmentLabel.geometry={type:"segment",segment:o,sampleLocation:"center"},this._segmentLabel.anchor=e===1?"top":"bottom"}_updateLabelText({text:t,visualizedMeasurement:e}){t!=null?(this._segmentLabel.text=e==="euclidean"?t.directDistance:t.horizontalDistance,this._horizontalLabel.text=t.horizontalDistance,this._verticalLabel.text=t.verticalDistance):(this._segmentLabel.text=null,this._horizontalLabel.text=null,this._verticalLabel.text=null),this.notifyChange("labels")}_updateLabelVisibility({visible:t,viewMode:e}){const i=this._segmentLabel,s=this._horizontalLabel,o=this._verticalLabel;if(i.visible=!1,s.visible=!1,o.visible=!1,t)switch(e){case 1:case 3:i.visible=!0;break;case 2:i.visible=!0,s.visible=!0,o.visible=!0}}get _labelsText(){if(this.destroyed)return null;const t=this.messages,e=this.analysisView.result;if(e==null||t==null)return null;const{directDistance:i,horizontalDistance:s,verticalDistance:o}=e,a=this.analysisView.unit,c=p=>({directDistance:"",horizontalDistance:"",verticalDistance:"",...p});switch(a){case"metric":return c({directDistance:i&&bt(t,i),horizontalDistance:s&&bt(t,s),verticalDistance:o&&ze(t,o)});case"imperial":return c({directDistance:i&&wt(t,i),horizontalDistance:s&&wt(t,s),verticalDistance:o&&Ee(t,o)});default:return c({directDistance:i&&Z(t,i,a),horizontalDistance:s&&Z(t,s,a),verticalDistance:o&&Z(t,o,a)})}}_updateSegmentStripeLength(t){const e=this._segmentVisualElement;t!=null?(e.stripeLength=t,e.stripesEnabled=!0):e.stripesEnabled=!1}get _actualVisualElementsOrientation(){if(this._triangleOrientationOverride!=null)return this._triangleOrientationOverride;const t=this.visualElementOrientation;return t===0?this.view.state.camera.aboveGround?1:2:t}_requiresGeodesicGuideAt(t){const e=this.view;if(!(e!=null&&e.state))return!1;const i=e.state.camera,s=e.renderCoordsHelper;if(!s)return!1;const o=i.computeScreenPixelSizeAt(t);return s.getAltitude(t)/o>=10}get _measurementArrowStripeLength(){const{result:t,unit:e}=this.analysisView;if(t==null)return null;let i=null;const s=t.directDistance;switch(e){case"metric":i=s&&D(s,"meters");break;case"imperial":i=s&&D(s,ae(s.value,s.unit));break;default:i=s&&D(s,e)}return i==null?null:re(i.value/30)*oe(1,i.unit,"meters")}_updateMessageBundle(){this.loadingMessages=!0,le("esri/core/t9n/Units").then(t=>{this.messages=t}).finally(()=>{this.loadingMessages=!1})}get testData(){}};function ci(t,e,i,s,o){const a=X(t,i,o,mi),c=X(t,e,o,_i);if(a==null||c==null)return null;const p=o.projectToRenderScreen(i,pi),h=o.projectToRenderScreen(e,gi),l={segment:"bottom",horizontal:"top",vertical:p==null||h==null||p[0]<h[0]?"left":"right"};if(mt(a,c)>=Ct){const u=Math.sign(a[1])===Math.sign(c[1]);l.segment=u?Pt(l.vertical):l.vertical}else{const u=vi;X(i,e,o,u),mt(u,c)>=Ct&&(l.segment=Math.sign(u[0])===Math.sign(c[0])?Pt(l.horizontal):l.horizontal)}if(s===2){const u=d=>d==="top"?"bottom":"top";l.segment=u(l.segment),l.horizontal=u(l.horizontal),l.vertical=u(l.vertical)}return l}n([r()],w.prototype,"_parameters",null),n([r()],w.prototype,"_triangleOrientationOverride",void 0),n([r()],w.prototype,"messages",void 0),n([r()],w.prototype,"view",void 0),n([r()],w.prototype,"analysis",void 0),n([r()],w.prototype,"analysisView",void 0),n([r()],w.prototype,"loadingMessages",void 0),n([r()],w.prototype,"visible",null),n([r()],w.prototype,"viewMode",null),n([r()],w.prototype,"actualVisualizedMeasurement",null),n([r()],w.prototype,"visualElementOrientation",void 0),n([r()],w.prototype,"triangleCollapseRatioThreshold",void 0),n([r()],w.prototype,"allowVisualElementsOrientationChange",null),n([r()],w.prototype,"labels",null),n([r()],w.prototype,"_labelsText",null),n([r()],w.prototype,"_actualVisualElementsOrientation",null),n([r()],w.prototype,"_measurementArrowStripeLength",null),w=n([W("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementVisualization")],w);const Ct=Math.cos(ue(12)),pi=Ot(),gi=Ot(),mi=ot(),_i=ot(),vi=ot();let v=class extends rt{constructor(t){super(t),this.cursorPoint=null,this._visible=!1,this._laserLine=null,this.laserLineEnabled=!0,this._lastDraggedHandle=null}initialize(){this._laserLine=new Fe({view:this.view,attached:!0,isDecoration:!0}),this._updateVisibility(this._visible),this._connectToAnalysisView(),this.addHandles(P(()=>this._params,({laserLineGlowColor:t,laserLineInnerColor:e,laserLineGlobalAlpha:i})=>{const s=this._laserLine,o=s.style;s.style={...o,innerColor:e,glowColor:t,globalAlpha:i}}))}destroy(){this._laserLine=S(this._laserLine)}get _params(){const{accentColor:t}=this.view.effectiveTheme;return{laserLineGlowColor:_t.toUnitRGB(t),laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:_t.toUnitRGB(nt(t)),laserLineInnerWidth:.75,laserLineGlobalAlpha:.75*t.a,handleColor:Vt(t,.5),handleRadius:5}}get visible(){return this._visible}set visible(t){t?this.show():this.hide()}get testData(){}get _cursorPosition(){const t=C(),e=this.cursorPoint;return e&&this.view.renderCoordsHelper.toRenderCoords(e,t),t}get _startPosition(){const t=C(),e=this.analysis.startPoint;return e&&this.view.renderCoordsHelper.toRenderCoords(e,t),t}get _endPosition(){const t=C(),e=this.analysis.endPoint;return e&&this.view.renderCoordsHelper.toRenderCoords(e,t),t}get _laserLineParams(){const t=this._focusPosition,{active:e,lineState:i}=this.toolState,s=this.analysisViewData,o=this.laserLineEnabled&&!!t&&i!=="measured"&&e;if(!o||!this.visible||s==null||s.destroyed)return{heightManifoldTarget:null,pointDistanceLine:null,lineVerticalPlaneSegment:null};const a=s.actualVisualizedMeasurement,c=this.view.viewingMode!=="local"&&o&&!!this.analysis.startPoint&&a==="geodesic",p=o&&s.viewMode===2;return{heightManifoldTarget:a==="euclidean"?t:null,pointDistanceLine:c?this._pointDistanceLine:null,lineVerticalPlaneSegment:p?he(this._startPosition,this._endPosition):null}}get _focusPosition(){const{lineState:t}=this.toolState,e=this.analysisViewData,i=e!=null&&!e.destroyed&&e.measurementMode===1&&e.viewMode===1;switch(t){case"drawing":return i?this._startPosition:this.analysis.endPoint?this._endPosition:this._startPosition;case"editing":return i?this._lastDraggedHandle==="start"?this._endPosition:this._startPosition:this._lastDraggedHandle==="start"?this._startPosition:this._endPosition;default:return this.cursorPoint!=null?this._cursorPosition:null}}get _pointDistanceLine(){return{origin:this.toolState.lineState==="drawing"||this._lastDraggedHandle==="end"?this._startPosition:this._endPosition,target:this._focusPosition}}createManipulators(){const t=this._params,{view:e}=this,i=()=>{const d=Me(t.handleColor),g=[new Se(ce(d,1,32,32))],m=new yt({view:e,renderObjects:g});return m.available=!1,m.radius=t.handleRadius,[m,d]},[s,o]=i(),[a,c]=i(),p=new yt({view:this.view,available:!1,interactive:!1});this.analysis.startPoint!=null&&(s.location=this.analysis.startPoint,s.available=!0),this.analysis.endPoint!=null&&(a.location=this.analysis.endPoint,a.available=!0);const h=()=>{let d=this._lastDraggedHandle;s.grabbing&&!a.grabbing&&(d="start"),a.grabbing&&!s.grabbing&&(d="end"),s.grabbing||a.grabbing||(d=null),this._lastDraggedHandle=d},l=s.events.on("grab-changed",h),u=a.events.on("grab-changed",h);return this.addHandles([l,u,P(()=>de(this._params.handleColor),d=>{o.setParameters({color:d}),c.setParameters({color:d})},{equals:st})],"manipulators"),{start:s,end:a,cursor:p}}show(){this.destroyed||this._visible||this._updateVisibility(!0)}hide(){!this.destroyed&&this._visible&&this._updateVisibility(!1)}_connectToAnalysisView(){this.removeHandles("analysis-view"),this.addHandles([P(()=>{var t;return(t=this.analysisViewData)==null?void 0:t.destroyed},t=>{t&&this.removeHandles("analysis-view")},B),P(()=>[this.toolState.lineState==="measured",this.analysisViewData],([t,e])=>{e==null||e.destroyed||(e.allowVisualElementsOrientationChange=!t)},B),P(()=>this._laserLineParams,t=>{const e=this._laserLine;e.heightManifoldTarget=t.heightManifoldTarget,e.pointDistanceLine=t.pointDistanceLine,e.lineVerticalPlaneSegment=t.lineVerticalPlaneSegment},B)],"analysis-view")}_updateVisibility(t){this.initialized&&(this._visible=t,t&&(this._laserLine.style={innerColor:this._params.laserLineInnerColor,innerWidth:this._params.laserLineInnerWidth,glowColor:this._params.laserLineGlowColor,glowWidth:this._params.laserLineGlowWidth,glowFalloff:this._params.laserLineGlowFalloff,globalAlpha:this._params.laserLineGlobalAlpha}),this._laserLine.visible=t)}};n([r({constructOnly:!0})],v.prototype,"view",void 0),n([r()],v.prototype,"_params",null),n([r({constructOnly:!0})],v.prototype,"analysis",void 0),n([r({constructOnly:!0})],v.prototype,"analysisViewData",void 0),n([r()],v.prototype,"cursorPoint",void 0),n([r()],v.prototype,"toolState",void 0),n([r()],v.prototype,"visible",null),n([r()],v.prototype,"testData",null),n([r()],v.prototype,"_visible",void 0),n([r()],v.prototype,"_laserLine",void 0),n([r({constructOnly:!0})],v.prototype,"laserLineEnabled",void 0),n([r()],v.prototype,"_cursorPosition",null),n([r()],v.prototype,"_startPosition",null),n([r()],v.prototype,"_endPosition",null),n([r()],v.prototype,"_lastDraggedHandle",void 0),n([r()],v.prototype,"_laserLineParams",null),n([r()],v.prototype,"_focusPosition",null),n([r()],v.prototype,"_pointDistanceLine",null),v=n([W("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DView")],v);let y=class extends je{constructor(t){super(t),this._updatingHandles=new pe,this._snappingManagerResult=null,this._emulatedDrag=null,this.lineState="initial",this.removeIncompleteOnCancel=!1,this.startPointSurfaceLocation=null,this.endPointSurfaceLocation=null,this.cursorPointSurfaceLocation=null,this.startManipulator=null,this.endManipulator=null,this.cursorManipulator=null,this._getSnappingContext=ge(e=>new Ye({elevationInfo:{mode:"absolute-height",offset:0},pointer:e,editGeometryOperations:new Qe(new Be("point",qe(!0,!1,this.view.spatialReference)),this.view.state.viewingMode),visualizer:new Te}))}initialize(){const{view:t,analysis:e,analysisViewData:i,visible:s}=this;this.measurementView=new v({toolState:this,view:t,analysis:e,analysisViewData:i,visible:s});const{start:o,end:a,cursor:c}=this.measurementView.createManipulators(),p=(h,l,u)=>{const d=Ue(h,(g,m,b,V)=>{const $=He(g),E=this._ensureSnappingManager(),z=this._getSnappingContext(V),A=this._updatingHandles,{lineState:R}=this;b=b.next($).next(Ne(this,[u,l])).next(f=>{if(l!=="cursorPoint"){const L=this.analysis[l];L!=null&&(g.location=L)}return f});const M=Re(this.view),G=f=>{const L=M(f);return L||this.lineState!=="drawing"&&this.lineState!=="initial"||(this[l]=null,this[u]=null),L};let x=m.next($).next(G);if(V!=="touch"||R==="editing"){const{snappingStep:f,cancelSnapping:L}=Je({snappingManager:E,snappingContext:z,updatingHandles:A});b=b.next(L),x=x.next(...f)}x.next(f=>f.action!=="start"?f:null).next(f=>{const L=ve(f.mapEnd,new ye);this[l]=L,g.location=L,this[u]=this._surfaceLocation(L,f.surfaceType)})});return l==="cursorPoint"?[d]:[d,h.events.on("grab-changed",()=>{const g=o.grabbing||a.grabbing;this.lineState=g?"editing":"measured"}),P(()=>this.analysis[l],g=>{g&&(h.location=g)})]};this.startManipulator=o,this.endManipulator=a,this.cursorManipulator=c,this.manipulators.add(o),this.manipulators.add(a),this.manipulators.add(c),this.addHandles([...p(o,"startPoint","startPointSurfaceLocation"),...p(a,"endPoint","endPointSurfaceLocation"),...p(c,"cursorPoint","cursorPointSurfaceLocation"),me(()=>this.state==="measured",()=>{this.finishToolCreation(),this.active&&(this.view.activeTool=null)},O),P(()=>({startPointAvailable:this.startPoint!=null,endPointAvailable:this.endPoint!=null}),({startPointAvailable:h,endPointAvailable:l})=>{this.startManipulator.available=h,this.endManipulator.available=l},O)]),$e(this)}destroy(){this._updatingHandles=S(this._updatingHandles),this.measurementView=S(this.measurementView)}get _snappingManager(){var t;return(t=this._snappingManagerResult)==null?void 0:t.snappingManager}_ensureSnappingManager(){if(this._snappingManagerResult==null){const t=Ke(this.view);this._snappingManagerResult=t,this.addHandles(t)}return this._snappingManagerResult.snappingManager}get state(){const{analysis:t}=this;if(t.startPoint==null&&t.endPoint==null)return"ready";const{lineState:e}=this;return this.validMeasurement&&e!=="editing"&&e!=="drawing"?"measured":"measuring"}get cursor(){return!this.active||this.state!=="ready"&&this.lineState==="measured"?null:"crosshair"}get startPoint(){return this.analysis.startPoint}set startPoint(t){this.analysis.startPoint=t}get endPoint(){return this.analysis.endPoint}set endPoint(t){this.analysis.endPoint=t}get cursorPoint(){return this.measurementView.cursorPoint}set cursorPoint(t){this.measurementView.cursorPoint=t}get snappingOptions(){var t;return(t=this._snappingManager)==null?void 0:t.options}get validMeasurement(){return this.analysis.startPoint!=null&&this.analysis.endPoint!=null}get updating(){var t;return this._updatingHandles.updating||!!((t=this._snappingManager)!=null&&t.updating)}resetCreated(){super.resetCreated(),this.lineState="initial",this.cursorPoint=null,this.state==="measured"&&this.finishToolCreation()}onShow(){this.measurementView.show()}onHide(){this.measurementView.hide()}onDeactivate(){var t;(t=this._emulatedDrag)==null||t.cancel(),this._emulatedDrag=null}onInputEvent(t){switch(t.type){case"immediate-click":this._handleImmediateClick(t);break;case"pointer-move":this._handlePointerMove(t)}}_handlePointerMove(t){var p,h;if(!this.active||this.view.navigating)return;const{pointerType:e}=t;if(e!=="mouse")return;const i=vt(t),{lineState:s,cursorManipulator:o,endManipulator:a}=this;let c=!1;this.cursorPoint==null&&((p=this._emulatedDrag)==null||p.cancel(),this._emulatedDrag=it(o,e,i),c=!0),s==="initial"&&((h=this._emulatedDrag)==null||h.update(i),c=!0),s==="drawing"&&(a.events.emit("drag",{action:"update",start:i,screenPoint:i}),c=!0),c&&t.stopPropagation()}_handleImmediateClick(t){var h,l,u,d,g;if(!this.active||!Ge(t))return;const e=vt(t),{pointerType:i}=t,{cursorManipulator:s,startManipulator:o,endManipulator:a,lineState:c}=this;let p=!1;switch(this.cursorPoint==null&&((h=this._emulatedDrag)==null||h.cancel(),this._emulatedDrag=it(s,i,e)),c){case"initial":if((l=this._emulatedDrag)==null||l.update(e),this.cursorPoint!=null){(u=this._emulatedDrag)==null||u.end(e),this._emulatedDrag=null,this.endPoint=null;const{cursorPoint:m}=this;this.startPoint=m,this.startPointSurfaceLocation=this.cursorPointSurfaceLocation,o.location=m,o.interactive=!1,a.interactive=!1,this.lineState="drawing",this._emulatedDrag=it(a,i,e),p=!0}break;case"drawing":(d=this._emulatedDrag)==null||d.update(e),this.endPoint!=null&&((g=this._emulatedDrag)==null||g.end(e),this._emulatedDrag=null,o.interactive=!0,a.interactive=!0,this.lineState="measured",p=!0)}p&&t.stopPropagation()}_surfaceLocation(t,e){return e===0?"on-the-surface":(t.z??0)>=this._getElevation(t)?"above-the-surface":"below-the-surface"}_getElevation(t){return this.view.basemapTerrain.ready?_e(this.view.elevationProvider,t)??0:0}get test(){}};function it(t,e,i){return t.events.emit("drag",{action:"start",pointerType:e,start:i,screenPoint:i}),{update:s=>t.events.emit("drag",{action:"update",start:s,screenPoint:s}),end:s=>t.events.emit("drag",{action:"end",start:s,screenPoint:s}),cancel:()=>t.events.emit("drag",{action:"cancel"})}}n([r()],y.prototype,"_snappingManagerResult",void 0),n([r()],y.prototype,"_snappingManager",null),n([r({readOnly:!0})],y.prototype,"state",null),n([r()],y.prototype,"lineState",void 0),n([r({readOnly:!0})],y.prototype,"cursor",null),n([r()],y.prototype,"startPoint",null),n([r()],y.prototype,"endPoint",null),n([r()],y.prototype,"cursorPoint",null),n([r({constructOnly:!0})],y.prototype,"analysis",void 0),n([r({constructOnly:!0})],y.prototype,"analysisViewData",void 0),n([r()],y.prototype,"measurementView",void 0),n([r()],y.prototype,"removeIncompleteOnCancel",void 0),n([r({constructOnly:!0})],y.prototype,"view",void 0),n([r({readOnly:!0})],y.prototype,"validMeasurement",null),n([r({value:null})],y.prototype,"startPointSurfaceLocation",void 0),n([r({value:null})],y.prototype,"endPointSurfaceLocation",void 0),n([r({value:null})],y.prototype,"cursorPointSurfaceLocation",void 0),n([r()],y.prototype,"updating",null),y=n([W("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DTool")],y);let _=class extends fe{constructor(t){super(t),this.type="direct-line-measurement-view-3d",this.analysis=null,this.tool=null,this.result=null,this.measurementMode=0,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null,this.userOperation=null}initialize(){const{analysis:t,view:e}=this;this._analysisVisualization=new w({view:e,analysis:t,analysisView:this}),this.addResolvingPromise(De().then(i=>{this.destroyed||(this._analysisController=new T({view:e,analysis:t,viewData:this,geodesicLengthMeasurementUtils:i}))})),this.addHandles(We(this,y))}destroy(){ke(this),this.userOperation=we(this.userOperation),this._analysisController=S(this._analysisController),this._analysisVisualization=S(this._analysisVisualization)}get updating(){var t;return!!((t=this._analysisVisualization)!=null&&t.loadingMessages)}get visible(){return super.visible}set visible(t){super.visible=t}get interactive(){return super.interactive}set interactive(t){super.interactive=t}get viewMode(){return this._analysisVisualization.viewMode}get actualVisualizedMeasurement(){return this._analysisVisualization.actualVisualizedMeasurement}get visualElementOrientation(){return this._analysisVisualization.visualElementOrientation}set visualElementOrientation(t){this._analysisVisualization.visualElementOrientation=t}get allowVisualElementsOrientationChange(){return this._analysisVisualization.allowVisualElementsOrientationChange}set allowVisualElementsOrientationChange(t){this._analysisVisualization.allowVisualElementsOrientationChange=t}get triangleCollapseRatioThreshold(){return this._analysisVisualization.triangleCollapseRatioThreshold}set triangleCollapseRatioThreshold(t){this._analysisVisualization.triangleCollapseRatioThreshold=t}get directLabelText(){var t;return((t=this._analysisVisualization.labels.direct)==null?void 0:t.text)??""}get horizontalLabelText(){var t;return((t=this._analysisVisualization.labels.horizontal)==null?void 0:t.text)??""}get verticalLabelText(){var t;return((t=this._analysisVisualization.labels.vertical)==null?void 0:t.text)??""}get unit(){return this.analysis.unit??be(this.view)}get testData(){}place(t){return Ie(this,{placementOptions:t})}};n([r()],_.prototype,"_analysisVisualization",void 0),n([r()],_.prototype,"_analysisController",void 0),n([r()],_.prototype,"updating",null),n([r({readOnly:!0})],_.prototype,"type",void 0),n([r({constructOnly:!0,nonNullable:!0})],_.prototype,"analysis",void 0),n([r()],_.prototype,"tool",void 0),n([r()],_.prototype,"result",void 0),n([r()],_.prototype,"measurementMode",void 0),n([r()],_.prototype,"elevationAlignedStartPoint",void 0),n([r()],_.prototype,"elevationAlignedEndPoint",void 0),n([r({readOnly:!0})],_.prototype,"viewMode",null),n([r({readOnly:!0})],_.prototype,"actualVisualizedMeasurement",null),n([r()],_.prototype,"visualElementOrientation",null),n([r()],_.prototype,"allowVisualElementsOrientationChange",null),n([r()],_.prototype,"triangleCollapseRatioThreshold",null),n([r({readOnly:!0})],_.prototype,"directLabelText",null),n([r({readOnly:!0})],_.prototype,"horizontalLabelText",null),n([r({readOnly:!0})],_.prototype,"verticalLabelText",null),n([r()],_.prototype,"unit",null),n([r()],_.prototype,"userOperation",void 0),_=n([W("esri.views.3d.analysis.DirectLineMeasurementAnalysisView3D")],_);const ds=_,yi=Object.freeze(Object.defineProperty({__proto__:null,build:$t},Symbol.toStringTag,{value:"Module"}));export{ds as default};
