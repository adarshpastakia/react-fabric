const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./loader.js","./ShadowCastClear.glsl.js","./iframe-DwvN93Ge.js","./iframe-CGchYWp9.css","./index.js","./Viewport.js","./Section.js","./ErrorBoundary.js","./createClass.js","./Global.js","./useIsDark.js","./debounce.js","./index2.js","./ShadowCastClear-Cq39gfL_.css","./resourceUtils.js"])))=>i.map(i=>d[i]);
import{b8 as re}from"./iframe-DwvN93Ge.js";import{pu as se,pv as oe,fJ as O,fL as H,mh as D,pw as ne,px as ae,py as ie,hs as le,hn as ue,bJ as C,fd as k,fc as ce,pz as z,gF as me,fW as fe,p4 as de,mN as N,pA as Q,fT as pe,n_ as P,fU as J,n2 as he,pB as L,pC as xe,pD as Te,pE as ge,lc as _,n1 as be,l9 as M,mQ as ye,kq as we,lK as K,lL as W,mR as Re,pF as $e,pG as ve,pH as q,pI as Be,pJ as Me,l8 as Se,ot as Ae,pK as Ee,pL as _e}from"./ShadowCastClear.glsl.js";import{a as Fe}from"./devEnvironmentUtils.js";import{o as Ie,d as G}from"./vec4.js";import{o as Oe,n as Ce}from"./indexUtils.js";import{t as F}from"./resourceUtils.js";function S(t){if(t==null)return null;const r=t.offset!=null?t.offset:se,o=t.rotation!=null?t.rotation:0,s=t.scale!=null?t.scale:oe,c=O(1,0,0,0,1,0,r[0],r[1],1),f=O(Math.cos(o),-Math.sin(o),0,Math.sin(o),Math.cos(o),0,0,0,1),a=O(s[0],0,0,0,s[1],0,0,0,1),i=H();return D(i,f,a),D(i,c,i),i}class Le{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class Pe{constructor(r,o,s){this.name=r,this.lodThreshold=o,this.pivotOffset=s,this.stageResources=new Le,this.numberOfVertices=0}}async function Ve(t,r){var u;const o=X(Fe(t));if(o.fileType==="wosr"){const d=await(r.cache?r.cache.loadWOSR(o.url,r):ne(o.url,r)),{engineResources:h,referenceBoundingBox:p}=ae(d,r);return{lods:h,referenceBoundingBox:p,isEsriSymbolResource:!1,isWosr:!0}}let s;if(r.cache)s=await r.cache.loadGLTF(o.url,r,!!r.usePBR);else{const{loadGLTF:d}=await re(()=>import("./loader.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]),import.meta.url);s=await d(new ie(r.streamDataRequester),o.url,r,r.usePBR)}const c=(u=s.model.meta)==null?void 0:u.ESRI_proxyEllipsoid,f=s.meta.isEsriSymbolResource&&c!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";f&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,ze(s,c));const a=!!r.usePBR,i=s.meta.isEsriSymbolResource?{usePBR:a,isSchematic:!1,treeRendering:f,mrrFactors:Ee}:{usePBR:a,isSchematic:!1,treeRendering:!1,mrrFactors:_e},l={...r.materialParameters,treeRendering:f},{engineResources:e,referenceBoundingBox:n}=je(s,i,l,r,o.specifiedLodIndex,f);return{lods:e,referenceBoundingBox:n,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function X(t){const r=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return r?{fileType:"gltf",url:r[1],specifiedLodIndex:r[4]!=null?Number(r[4]):null}:t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function je(t,r,o,s,c,f){const a=t.model,i=new Array,l=new Map,e=new Map,n=a.lods.length,u=pe();return a.lods.forEach((d,h)=>{const p=s.skipHighLods===!0&&(n>1&&h===0||n>3&&h===1)||s.skipHighLods===!1&&c!=null&&h!==c;if(p&&h!==0)return;const m=new Pe(d.name,d.lodThreshold,[0,0,0]);d.parts.forEach(x=>{const T=p?new P({},s):Ue(a,x,m,r,o,l,e,s,f),{geometry:g,vertexCount:b}=De(x,T??new P({},s)),R=g.boundingInfo;R!=null&&h===0&&(J(u,R.bbMin),J(u,R.bbMax)),T!=null&&(m.stageResources.geometries.push(g),m.numberOfVertices+=b)}),p||i.push(m)}),{engineResources:i,referenceBoundingBox:u}}function Ue(t,r,o,s,c,f,a,i,l){var b,R;const e=t.materials.get(r.material);if(e==null)return null;const{normal:n,color:u,texCoord0:d,tangent:h}=r.attributes,p=r.material+(n?"_normal":"")+(u?"_color":"")+(d?"_texCoord0":"")+(h?"_tangent":""),m=r.attributes.texCoord0!=null,x=r.attributes.normal!=null,T=ke(e.alphaMode);if(!f.has(p)){if(m){const B=(E,Z=!1,ee=!1)=>{if(E!=null&&!a.has(E)){const I=t.textures.get(E);if(I){const w=I.data,te=Z&&!F(w)?i.compressionOptions:void 0;a.set(E,new Ae(F(w)?w.data:w,{...I.parameters,preMultiplyAlpha:!F(w)&&ee,encoding:F(w)?w.encoding:void 0,compressionOptions:te}))}}},Y=T!==1&&!l;B(e.colorTexture,Y,T!==1),B(e.normalTexture),B(e.occlusionTexture,!0),B(e.emissiveTexture),B(e.metallicRoughnessTexture,!0)}const y=L(e.color[0]),v=L(e.color[1]),V=L(e.color[2]),A=e.colorTexture!=null&&m?a.get(e.colorTexture):null,j=xe(e),U=((b=e.normalTextureTransform)==null?void 0:b.scale)!=null?(R=e.normalTextureTransform)==null?void 0:R.scale:Te;f.set(p,new P({...s,customDepthTest:1,textureAlphaMode:T,textureAlphaCutoff:e.alphaCutoff,diffuse:[y,v,V],ambient:[y,v,V],opacity:e.alphaMode==="OPAQUE"?1:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?0:2,hasVertexColors:!!r.attributes.color,hasVertexTangents:!!r.attributes.tangent,normalType:x?0:2,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclusion,textureId:A!=null?A.id:void 0,colorMixMode:e.colorMixMode,normalTextureId:e.normalTexture!=null&&m?a.get(e.normalTexture).id:void 0,textureAlphaPremultiplied:A!=null&&!!A.parameters.preMultiplyAlpha,occlusionTextureId:e.occlusionTexture!=null&&m?a.get(e.occlusionTexture).id:void 0,emissiveTextureId:e.emissiveTexture!=null&&m?a.get(e.emissiveTexture).id:void 0,metallicRoughnessTextureId:e.metallicRoughnessTexture!=null&&m?a.get(e.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[e.emissiveFactor[0],e.emissiveFactor[1],e.emissiveFactor[2]],mrrFactors:j?ge:[e.metallicFactor,e.roughnessFactor,s.mrrFactors[2]],isSchematic:j,colorTextureTransformMatrix:S(e.colorTextureTransform),normalTextureTransformMatrix:S(e.normalTextureTransform),scale:[U[0],U[1]],occlusionTextureTransformMatrix:S(e.occlusionTextureTransform),emissiveTextureTransformMatrix:S(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:S(e.metallicRoughnessTextureTransform),...c},i))}const g=f.get(p);if(o.stageResources.materials.push(g),m){const y=v=>{v!=null&&o.stageResources.textures.push(a.get(v))};y(e.colorTexture),y(e.normalTexture),y(e.occlusionTexture),y(e.emissiveTexture),y(e.metallicRoughnessTexture)}return g}function De(t,r){const o=t.attributes.position.count,s=Oe(t.indices||o,t.primitiveType),c=_(3*o),{typedBuffer:f,typedBufferStride:a}=t.attributes.position;be(c,f,t.transform,3,a);const i=[["position",new M(c,s,3,!0)]];if(t.attributes.normal!=null){const e=_(3*o),{typedBuffer:n,typedBufferStride:u}=t.attributes.normal;ye($,t.transform),we(e,n,$,3,u),K($)&&W(e,e),i.push(["normal",new M(e,s,3,!0)])}if(t.attributes.tangent!=null){const e=_(4*o),{typedBuffer:n,typedBufferStride:u}=t.attributes.tangent;Re($,t.transform),Ie(e,n,$,4,u),K($)&&W(e,e,4),i.push(["tangent",new M(e,s,4,!0)])}if(t.attributes.texCoord0!=null){const e=_(2*o),{typedBuffer:n,typedBufferStride:u}=t.attributes.texCoord0;Ce(e,n,2,u),i.push(["uv0",new M(e,s,2,!0)])}const l=t.attributes.color;if(l!=null){const e=new Uint8Array(4*o);l.elementCount===4?l instanceof Q?G(e,l,1,255):(l instanceof $e||l instanceof ve)&&G(e,l,1/255,255):(e.fill(255),l instanceof N?q(e,l.typedBuffer,1,255,4,l.typedBufferStride):(t.attributes.color instanceof Be||t.attributes.color instanceof Me)&&q(e,l.typedBuffer,1/255,255,4,t.attributes.color.typedBufferStride)),i.push(["color",new M(e,s,4,!0)])}return{geometry:new Se(r,i),vertexCount:o}}const $=H();function ke(t){switch(t){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":case null:case void 0:return 1}}function ze(t,r){for(let o=0;o<t.model.lods.length;++o){const s=t.model.lods[o];for(const c of s.parts){const f=c.attributes.normal;if(f==null)return;const a=c.attributes.position,i=a.count,l=C(),e=C(),n=C(),u=new Float32Array(4*i),d=new Float32Array(3*i),h=le(ue(),c.transform);let p=0,m=0;for(let x=0;x<i;x++){a.getVec(x,e),f.getVec(x,l),k(e,e,c.transform),ce(n,e,r.center),z(n,n,r.radius);const T=n[2],g=me(n),b=Math.min(.45+.55*g*g,1)**he;z(n,n,r.radius),h!==null&&k(n,n,h),fe(n,n),o+1!==t.model.lods.length&&t.model.lods.length>1&&de(n,n,l,T>-1?.2:Math.min(-4*T-3.8,1)),d[p]=n[0],d[p+1]=n[1],d[p+2]=n[2],p+=3,u[m]=b,u[m+1]=b,u[m+2]=b,u[m+3]=1,m+=4}c.attributes.normal=new N(d.buffer),c.attributes.color=new Q(u.buffer)}}}const Ne=Object.freeze(Object.defineProperty({__proto__:null,fetch:Ve,parseUrl:X},Symbol.toStringTag,{value:"Module"}));export{Ne as o,S as s,Ve as z};
