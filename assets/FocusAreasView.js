import{EV as Q,ac as be,wh as Y,GW as $e,F4 as I,G$ as Pe,F3 as Ee,F1 as x,F5 as ee,F6 as te,H1 as Fe,F7 as se,Fc as re,H2 as oe,H3 as v,bj as b,GP as ie,E as h,F as d,V as O,oO as Re,FA as xe,Fz as Oe,wn as Ce,hn as M,t3 as Se,Hl as ae,Hm as L,Hn as Te,lu as W,sW as Me,ls as Ve,b6 as ne,b5 as R,bl as B,b8 as Z,bR as ke,O as qe,fz as De,a5 as Ne,hP as ze,b$ as He,eS as Ge,km as je,bJ as Ue,eB as Ie,kn as Le,o2 as We,lz as Be,bO as Ze,bU as J,n1 as Je,l as Xe,b as Ke}from"./ShadowCastClear.glsl.js";import{e as Qe}from"./earcut.js";import{t as Ye}from"./operatorDensify.js";import{e as et}from"./operatorSimplify.js";import{fromSpatialReference as tt,fromPolygon as st,toPolygon as rt}from"./apiConverter.js";import{r as ot,X as it}from"./Graphics3DExtrudeSymbolLayer.js";import{b8 as le}from"./iframe-DwvN93Ge.js";import{R as at}from"./OutlineVisualElement.js";import"./index.js";import"./Viewport.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";import"./debounce.js";import"./index2.js";import"./ProjectionTransformation.js";import"./Point2D.js";import"./Envelope2D.js";import"./Transformation2D.js";import"./OperatorDefinitions.js";import"./jsonConverter.js";import"./SnappingCandidate.js";import"./renderingInfoUtils.js";import"./triangulationUtils.js";import"./deduplicate.js";import"./EngineVisualElement.js";import"./VisualElement.js";import"./LaserlinePath.glsl.js";import"./line.js";import"./line2.js";class V extends Q{constructor(){super(...arguments),this.effect=0,this.fadeFactor=be(1)}}function ce(){const e=new Y;return e.include($e),e.outputs.add("fragColor","vec4",0),e.fragment.uniforms.add(new I("colorTexture",t=>t.color),new I("focusArea",t=>t.focusArea),new Pe("focusAreaEffectMode",t=>t.effect),new Ee("fadeFactor",t=>t.fadeFactor.value)).main.add(x`
      float mask = texture( focusArea, uv, 0.0 ).r;
      vec4 color = texture( colorTexture, uv, 0.0 );
      vec4 colorDeSaturate = vec4(color.r * 0.25 + color.g * 0.5 + color.b * 0.25);
      if (focusAreaEffectMode == ${x.int(0)}) {
        fragColor = mask > 0.0 ? color : mix(color, 0.55 * colorDeSaturate + 0.45, fadeFactor);
      } else {
        fragColor = mask > 0.0 ? color : mix(color, 0.33 * color, fadeFactor);
      }
  `),e}const nt=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaColorPassParameters:V,build:ce},Symbol.toStringTag,{value:"Module"}));let X=class extends ee{constructor(t,r){super(t,r,new te(nt,()=>le(()=>Promise.resolve().then(()=>pt),void 0,import.meta.url)),Fe)}initializePipeline(){return se({colorWrite:re})}},g=class extends oe{constructor(t){super({...t,view:t.focusAreasView.view}),this.consumes={required:[v.FOCUSAREA_COLOR,v.FOCUSAREA]},this.produces=v.FOCUSAREA_COLOR,this._fadeDirection=0,this._passParameters=new V}precompile(){this.techniques.precompile(X)}fadeOut(t){this.removeAllHandles(),this._startTime=null,this._fadeDirection=1,this.addHandles(b(()=>this._passParameters.fadeFactor.value,r=>{r===0&&(this.removeAllHandles(),t())})),this.requestRender(2)}render(t){var m,$;const r=this.techniques.get(X),l=t.find(({name:A})=>A===this.produces);if(!r.compiled)return this.requestRender(1),l;const n=this.focusAreasView.style,a=this.bindParameters,i=a.camera,s=i.fullViewport[2],o=i.fullViewport[3];this._startTime??(this._startTime=(m=this.view.stage)==null?void 0:m.renderer.renderContext.time);const p=this.view.qualitySettings.fadeDuration,c=p>0?Math.min(p,(($=this.view.stage)==null?void 0:$.renderer.renderContext.time)-this._startTime)/p:1,f=t.find(({name:A})=>A===v.FOCUSAREA),u=this.fboCache.acquire(s,o,this.produces),_=this.renderingContext;return _.bindFramebuffer(u.fbo),this._passParameters.color=l.getTexture(),this._passParameters.focusArea=f.getTexture(),this._passParameters.effect=lt[n],this._passParameters.fadeFactor.value=this._fadeDirection===0?c:1-c,_.bindTechnique(r,a,this._passParameters),_.screen.draw(),u.attachDepth(l.getAttachment(ie)),c<1&&this.requestRender(2),u}};h([d()],g.prototype,"consumes",void 0),h([d()],g.prototype,"produces",void 0),h([d({constructOnly:!0})],g.prototype,"focusAreasView",void 0),g=h([O("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaColorNode")],g);const lt={bright:0,dark:1};let k=class extends Q{constructor(){super(...arguments),this.origin=Re}};function ue(){const e=new Y;return e.attributes.add("position","vec3"),e.outputs.add("fragColor","vec4",0),e.vertex.uniforms.add(new xe("proj",t=>t.camera.projectionMatrix),new Oe("view",(t,r)=>Ce(ct,r.camera.viewMatrix,t.origin))).main.add(x`gl_Position = proj * view * vec4(position, 1.0);
gl_Position.z = min(gl_Position.z, gl_Position.w);`),e.fragment.main.add(x`fragColor = vec4(1., 0., 0., 0.);`),e}const ct=M(),ut=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaMaskDrawParameters:k,build:ue},Symbol.toStringTag,{value:"Module"}));class K extends ee{constructor(t,r){super(t,r,new te(ut,()=>le(()=>Promise.resolve().then(()=>ft),void 0,import.meta.url)),Se(ae))}initializePipeline(){return se({colorWrite:re,depthTest:{func:515}})}}let w=class extends oe{constructor(e){super({...e,view:e.focusAreasView.view}),this.consumes={required:[L.TRANSPARENT]},this.produces=v.FOCUSAREA,this._vaos=new Array,this._counts=new Array,this._origins=new Array,this._maskParameters=new k}initialize(){this.updateGeometries()}destroy(){this._vaos.forEach(e=>e.dispose()),this._vaos.length=this._counts.length=this._origins.length=0}precompile(){this.techniques.precompile(K)}render(e){const t=this.techniques.get(K),r=this.bindParameters,l=r.camera,n=l.fullViewport[2],a=l.fullViewport[3];if(!t.compiled||!this._vaos)return void this.requestRender(1);const i=e.find(({name:c})=>c===L.TRANSPARENT),s=this.renderingContext,o=this.fboCache.acquire(n,a,v.FOCUSAREA,2);this.view.stage.renderer.occludedRequiresStencil?(o.acquireDepth(13),s.blitFramebuffer(i.fbo,o.fbo,256)):o.attachDepth(i.getAttachment(ie)),s.bindFramebuffer(o.fbo),s.setClearColor(0,0,0,1),s.clear(17408),s.setViewport(0,0,n,a);const p=s.bindTechnique(t,r);s.setFaceCullingEnabled(!1),s.setStencilTestEnabled(!0),s.setStencilOpSeparate(1028,7680,34055,7680),s.setStencilOpSeparate(1029,7680,34056,7680),s.setDepthWriteEnabled(!1);for(let c=0;c<this._vaos.length;c++){const f=this._vaos[c],u=this._counts[c];this._maskParameters.origin=this._origins[c],p.bindDraw(r,Te,this._maskParameters),s.bindVAO(f),s.setDepthTestEnabled(!0),s.setStencilWriteMask(255),s.setStencilFunction(519,0,255),s.setColorMask(!1,!1,!1,!1),s.drawArrays(W.TRIANGLES,0,u),s.setDepthTestEnabled(!1),s.setStencilWriteMask(0),s.setStencilFunction(517,0,255),s.setColorMask(!0,!0,!0,!0),s.drawArrays(W.TRIANGLES,0,u)}return o}updateGeometries(){this.view.stage&&(this._vaos.forEach(e=>e.dispose()),this._vaos.length=this._counts.length=this._origins.length=0,this.focusAreasView.volumes.forEach(e=>{const t=new Array;let r=0,l=0;e.geometryVolumes.forEach(a=>{const i=a.indicesBottom;r+=i.length;for(let o=0;o<i.length;o++)t.push(a.positions[3*(i[o]-1)]),t.push(a.positions[3*(i[o]-1)+1]),t.push(a.positions[3*(i[o]-1)+2]);const s=a.indicesExtruded;l+=s.length;for(let o=0;o<s.length;o++)t.push(a.positions[3*s[o]]),t.push(a.positions[3*s[o]+1]),t.push(a.positions[3*s[o]+2])});const n=new Me(this.renderingContext,new Ve(this.renderingContext,ae,new Float32Array(t)));this._vaos.push(n),this._counts.push(r+l),this._origins.push(e.origin)}),this.requestRender(1))}};h([d()],w.prototype,"consumes",void 0),h([d()],w.prototype,"produces",void 0),h([d({constructOnly:!0})],w.prototype,"focusAreasView",void 0),w=h([O("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaMaskNode")],w);let y=class extends ne{constructor(e){super(e)}initialize(){this.addHandles([b(()=>this.area.enabled,()=>this._ensureElement(),R),b(()=>{var e;return(e=this.area.outline)==null?void 0:e.color},e=>this._updateColor(e),R),b(()=>this.area.geometries,e=>this._updateGeometries(e),R)])}destroy(){this.removeAllHandles(),this._outlineElement=B(this._outlineElement)}_ensureElement(){var e,t;this.area.enabled&&((e=this.area.outline)!=null&&e.color)?this._outlineElement??(this._outlineElement=new at({view:this.view,geometry:this._mergePolygons(this.area.geometries),isDraped:!0,attached:!0,isDecoration:!1,color:Z.toUnitRGBA((t=this.area.outline)==null?void 0:t.color),renderOccluded:4,width:3})):this._outlineElement=B(this._outlineElement)}_updateGeometries(e){this._ensureElement(),this._outlineElement&&(this._outlineElement.geometry=this._mergePolygons(e))}_updateColor(e){this._ensureElement(),this._outlineElement&&e&&(this._outlineElement.color=Z.toUnitRGBA(e))}_mergePolygons(e){if(!e||e.length===0)return null;const t=e.at(0).clone();return t.rings.length=0,e.forEach(r=>t.rings.push(...r.rings)),t}};h([d({constructOnly:!0})],y.prototype,"view",void 0),h([d({constructOnly:!0})],y.prototype,"area",void 0),y=h([O("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaOutlineItem")],y);const ht=2e4;let F=class extends ne{constructor(e){super(e),this._volumes=new Map,this._elevationContext=new ke,this._outlineMap=new qe}initialize(){this.addHandles([b(()=>{var e;return{polygons:this.polygons,ready:(e=this.view.basemapTerrain)==null?void 0:e.ready}},({polygons:e,ready:t})=>{t&&this._updateVolumes(e)},R)]),this._outlineMap=De(()=>{var e;return(e=this.areas)==null?void 0:e.areas},e=>new y({area:e,view:this.view}),{recycleItems:!0})}destroy(){this.removeAllHandles(),this._outlineMap.destroy()}get areas(){var e;return(e=this.view.map)==null?void 0:e.focusAreas}get enabledAreas(){var e;return((e=this.areas)==null?void 0:e.areas.toArray().filter(({enabled:t})=>t))??[]}get style(){var e;return((e=this.areas)==null?void 0:e.style)??"bright"}get polygons(){return this.enabledAreas.reduce((e,t)=>e.concat(t.geometries.toArray()),new Array)}containsGeometry(e){if(this.polygons.length===0)return!0;const t=new Ne(e);return this.polygons.some(r=>r.contains(t))}_updateVolumes(e){this._extrude(e),this._ensureRenderNodes()}_extrude(e){var f;if(!this.view.renderCoordsHelper||ze(Array.from(this._volumes.keys()),e))return;const t=this.view.renderCoordsHelper,r=Ue(),l=t.viewingMode===1,n=M(),a=M(),i=this.view.spatialReference,s=tt(i),o=He(i).radius/Ge.radius,p=je(5e5*o,"meters",i,!0);l||t.worldUpAtPosition([0,0,0],r);const c=new Map;for(const u of e){const _=this._volumes.get(u);if(_)c.set(u,_);else try{const m=i.equals(u.spatialReference)?u:Ie(u,i),$=Math.max(m.extent.width,m.extent.height),A=Le($,i,"meters",!0),C=Math.max(5*A,ht*o),he=l?o/10:o,q=this._reduceGeometryHeight(m,C,he),S=We(q);if(S==null)continue;const D=st(q),de=et(D,s,!1)??D,me=Ye(de,p,0,0),N=rt(me,i);if(N==null)continue;Be(i,[S.x,S.y,0],n,t.spatialReference),a[12]=-n[12],a[13]=-n[13],a[14]=-n[14];const pe=ot(N,this.view.elevationProvider,t,this._elevationContext),{polygons:fe,mapPositions:_e,position:ge}=pe,z=new Array,we=new dt(z,[n[12],n[13],n[14]]);for(const P of fe){const ve=P.count,T=Qe(P.mapPositions,P.holeIndices,3);if(T.length===0)continue;const H=T.length,G=6*ve,Ae=G+H,E=Ze(3*G),j=J(Ae),U=J(H);it(ge,_e,T,P,E,null,null,null,j,U,C,r,l),Je(E,E,a);const ye=new mt(E,U,j,C);z.push(ye)}c.set(u,we)}catch(m){Xe.getLogger(this).error(new Ke("focusareasview:projection-failed","Failed to project focus area geometry to view spatial reference",{geometry:u,error:m}))}}this._volumes=c,this.volumes.size!==0&&((f=this._maskRenderNode)==null||f.updateGeometries())}_ensureRenderNodes(){if(this.view.stage)if(this.volumes.size===0){const{_maskRenderNode:e,_colorRenderNode:t}=this;this._maskRenderNode=this._colorRenderNode=null,t==null||t.fadeOut(()=>{e==null||e.destroy(),t==null||t.destroy()})}else this._maskRenderNode??(this._maskRenderNode=new w({focusAreasView:this})),this._colorRenderNode??(this._colorRenderNode=new g({focusAreasView:this})),this.view.stage.renderView.requestRender()}_reduceGeometryHeight(e,t,r){const l=-12e5*r,n=Math.max(-t/2,l),a=e.rings.map(s=>s.map(o=>[o[0],o[1],n])),i=e.clone();return i.rings=a,i.hasZ=!0,i}get volumes(){return this._volumes}};h([d()],F.prototype,"_volumes",void 0),h([d({constructOnly:!0})],F.prototype,"view",void 0),F=h([O("esri.views.3d.FocusAreasView")],F);class dt{constructor(t,r){this.geometryVolumes=t,this.origin=r}}class mt{constructor(t,r,l,n){this.positions=t,this.indicesBottom=r,this.indicesExtruded=l,this.height=n}}const pt=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaColorPassParameters:V,build:ce},Symbol.toStringTag,{value:"Module"})),ft=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaMaskDrawParameters:k,build:ue},Symbol.toStringTag,{value:"Module"}));export{F as FocusAreasView};
