import{iZ as v,bx as M,K as c,i_ as d,bP as g,i$ as h,j0 as y,j1 as I,j2 as w,hu as S}from"./ShadowCastClear.glsl.js";import{u as x,c as m,i as j,f as F}from"./PointCloudWorkerUtil.js";import"./iframe-DwvN93Ge.js";import"./index.js";import"./Viewport.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";import"./debounce.js";import"./index2.js";import"./PointCloudUniqueValueRenderer.js";import"./I3SBinaryReader.js";class O{transform(t){const a=this._transform(t),r=[a.points.buffer,a.rgb.buffer];a.pointIdFilterMap!=null&&r.push(a.pointIdFilterMap.buffer);for(const n of a.attributes)"buffer"in n.values&&v(n.values.buffer)&&n.values.buffer!==a.rgb.buffer&&r.push(n.values.buffer);return Promise.resolve({result:a,transferList:r})}_transform(t){const a=x(t.schema,t.geometryBuffer);let r=a.length/3,n=null;const f=new Array,o=m(t.primaryAttributeData,a,r);t.primaryAttributeData!=null&&o&&f.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:o});const s=m(t.modulationAttributeData,a,r);t.modulationAttributeData!=null&&s&&f.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:s});let e=j(t.rendererInfo,o,s,r);if(t.filterInfo&&t.filterInfo.length>0&&t.filterAttributesData!=null){const l=t.filterAttributesData.filter(M).map(i=>{const D=m(i,a,r),p={attributeInfo:i.attributeInfo,values:D};return f.push(p),p});n=new Uint32Array(r),r=F(a,e,n,t.filterInfo,l)}for(const l of t.userAttributesData){const i=m(l,a,r);f.push({attributeInfo:l.attributeInfo,values:i})}3*r<e.length&&(e=new Uint8Array(e.buffer.slice(0,3*r))),_(a,r,t.elevationOffset);const b=N(a,r,d.fromData(t.obbData),c.fromJSON(t.inSR),c.fromJSON(t.outSR));return{obbData:t.obbData,points:b,rgb:e,attributes:f,pointIdFilterMap:n}}}function N(u,t,a,r,n){if(!g(u,r,0,u,n,0,t))throw new Error("Can't reproject");const f=h(a.center),o=I(),s=I(),e=h(a.halfSize);y(A,a.quaternion);const b=new Float32Array(3*t);for(let l=0;l<t;l++){let i=3*l;o[0]=u[i]-f[0],o[1]=u[i+1]-f[1],o[2]=u[i+2]-f[2],w(s,o,A),e[0]=Math.max(e[0],Math.abs(s[0])),e[1]=Math.max(e[1],Math.abs(s[1])),e[2]=Math.max(e[2],Math.abs(s[2])),b[i++]=o[0],b[i++]=o[1],b[i]=o[2]}return a.halfSize=e,b}function _(u,t,a){if(a!==0)for(let r=0;r<t;r++)u[3*r+2]+=a}const A=S();function $(){return new O}export{$ as default};
