import{my as st,B as bt}from"./ShadowCastClear.glsl.js";import{c as C}from"./PixelBlock.js";import{u as ut}from"./pixelRangeUtils.js";const ot=9,Ut="PixelID";function D(t){var n;return t!=null&&((n=t.pixels)==null?void 0:n.length)>0}function qt(t){var u;if(!(t!=null&&t.length)||t.some(o=>!D(o)))return null;if(t.length===1)return((u=t[0])==null?void 0:u.clone())??null;const n=t,{width:e,height:i,pixelType:s}=n[0];if(n.some(o=>o.width!==e||o.height!==i))return null;const l=n.map(({mask:o})=>o).filter(o=>o!=null);let a=null;l.length&&(a=new Uint8Array(e*i),a.set(l[0]),l.length>1&&mt(l.slice(1),a));const f=[];n.forEach(({pixels:o})=>f.push(...o));const h=n.map(({statistics:o})=>o).filter(o=>o==null?void 0:o.length),r=[];return h.forEach(o=>r.push(...o)),new C({pixelType:s,width:e,height:i,mask:a,pixels:f,statistics:r.length?r:null})}function Jt(t){if(!t)return;const n=t.colormap;if(!n||n.length===0)return;const e=n.sort((h,r)=>h[0]-r[0]),i=e[0][0]<0?e[0][0]:0,s=Math.max(256,e[e.length-1][0]-i+1),l=new Uint8Array(4*s),a=[],f=e[0].length===5;if(s>65536)return e.forEach(h=>{a[h[0]-i]=f?h.slice(1):h.slice(1).concat([255])}),{indexed2DColormap:a,offset:i,alphaSpecified:f};if(t.fillUnspecified){let h=e[0];for(let r=h[0]-i,u=0;r<s;r++)l[4*r]=h[1],l[4*r+1]=h[2],l[4*r+2]=h[3],l[4*r+3]=f?h[4]:255,r===h[0]-i&&(h=u===e.length-1?h:e[++u])}else for(let h=0;h<e.length;h++){const r=e[h],u=4*(r[0]-i);l[u]=r[1],l[u+1]=r[2],l[u+2]=r[3],l[u+3]=f?r[4]:255}return{indexedColormap:l,offset:i,alphaSpecified:f}}function Vt(t,n){if(!D(t)||!n||!n.indexedColormap&&!n.indexed2DColormap)return t;const e=t.clone(),i=e.pixels;let s=e.mask;const l=e.width*e.height;if(i.length!==1)return t;const{indexedColormap:a,indexed2DColormap:f,offset:h,alphaSpecified:r}=n,u=i[0],o=new Uint8Array(u.length),m=new Uint8Array(u.length),p=new Uint8Array(u.length);let c,d=0;if(a){const x=a.length-1;if(s!=null)for(let g=0;g<l;g++)s[g]&&(d=4*(u[g]-h),d<h||d>x?s[g]=0:(o[g]=a[d],m[g]=a[d+1],p[g]=a[d+2],s[g]=a[d+3]));else{s=new Uint8Array(l);for(let g=0;g<l;g++)d=4*(u[g]-h),d<h||d>x?s[g]=0:(o[g]=a[d],m[g]=a[d+1],p[g]=a[d+2],s[g]=a[d+3]);e.mask=s}}else if(f)if(s!=null)for(let x=0;x<l;x++)s[x]&&(c=f[u[x]],o[x]=c[0],m[x]=c[1],p[x]=c[2],s[x]=c[3]);else{s=new Uint8Array(l);for(let x=0;x<l;x++)c=f[u[x]],o[x]=c[0],m[x]=c[1],p[x]=c[2],s[x]=c[3];e.mask=s}return e.pixels=[o,m,p],e.statistics=null,e.pixelType="u8",e.maskIsAlpha=r,e}function jt(t,n){if(!D(t))return null;const{pixels:e,mask:i}=t,s=e.length;let l=n.lut;const{offset:a}=n;l&&l[0].length===1&&(l=e.map(()=>l));const f=[],h=n.outputPixelType||"u8";for(let u=0;u<s;u++){const o=pt(e[u],i,l[u],a||0,h);f.push(o)}const r=new C({width:t.width,height:t.height,pixels:f,mask:i,pixelType:h});return r.updateStatistics(),r}function pt(t,n,e,i,s){const l=t.length,a=C.createEmptyBand(s,l);if(n)for(let f=0;f<l;f++)n[f]&&(a[f]=e[t[f]-i]);else for(let f=0;f<l;f++)a[f]=e[t[f]-i];return a}function zt(t,n,e){if(!D(t))return;const{width:i,height:s,pixels:l,mask:a}=t,f=i*s,h=new Uint8Array(f);for(let o=1;o<=e.length;o++){const{bandId:m,ranges:p}=e[o-1],c=l[m];if(!c)continue;const d=p.length===1,[x,g]=p[0];for(let y=0;y<f;y++)if(!a||a[y]){const k=c[y];if(d)k>=x&&k<=g&&(h[y]=o);else for(let M=0;M<p.length;M++){const[w,A]=p[M];if(k>=w&&k<=A){h[y]=o;break}}}}const{pixels:r}=n;r.length===1&&(r[1]=r[0].slice(),r[2]=r[0].slice());const u=e.map(o=>o.color);if(n.mask){const o=n.mask;for(let m=0;m<f;m++)if(o[m]){o[m]=255;const p=h[m];if(p){const c=u[p-1];r[0][m]=c[0],r[1][m]=c[1],r[2][m]=c[2],o[m]=c[3]}}}else{const o=new Uint8Array(f).fill(255);for(let m=0;m<f;m++){const p=h[m];if(p){const c=u[p-1];r[0][m]=c[0],r[1][m]=c[1],r[2][m]=c[2],o[m]=c[3]}}n.mask=o}n.maskIsAlpha=!0}function Lt(t,n){if(!D(t))return null;const e=t.clone(),{pixels:i}=e,s=e.width*e.height,l=n.length,a=Math.floor(l/2),f=n[Math.floor(a)],h=i[0],r=new Uint8Array(s),u=new Uint8Array(s),o=new Uint8Array(s);let m=e.mask;const p=n[0].mappedColor.length===4;m||(m=new Uint8Array(s),m.fill(p?255:1),e.mask=m);for(let c=0;c<s;c++)if(m[c]){const d=h[c];let x=!1,g=a,y=f,k=0,M=l-1;for(;M-k>1;){if(d===y.value){x=!0;break}d>y.value?k=g:M=g,g=Math.floor((k+M)/2),y=n[Math.floor(g)]}x||(d===n[k].value?(y=n[k],x=!0):d===n[M].value?(y=n[M],x=!0):d<n[k].value?x=!1:d>n[k].value&&(d<n[M].value?(y=n[k],x=!0):M===l-1?x=!1:(y=n[M],x=!0))),x?(r[c]=y.mappedColor[0],u[c]=y.mappedColor[1],o[c]=y.mappedColor[2],m[c]=y.mappedColor[3]):r[c]=u[c]=o[c]=m[c]=0}return e.pixels=[r,u,o],e.mask=m,e.pixelType="u8",e.maskIsAlpha=p,e}function Xt(t,n,e=!1){const s=new Float32Array(3*ot),l=n.length;for(let a=0;a<ot;a++)s[3*a]=t[2*a]??st-1,s[3*a+1]=t[2*a+1]??st,s[3*a+2]=n[a]??0,a<l&&(a>0&&(s[3*a]-=1e-5),t[2*a+1]!==t[2*a]&&(a<l-1||!e)&&(s[3*a+1]-=1e-5));return s}function Ht(t,n){if(!D(t))return null;const{width:e,height:i}=t,{inputRanges:s,outputValues:l,outputPixelType:a,noDataRanges:f,allowUnmatched:h,replacementValue:r,isLastInputRangeInclusive:u}=n,o=t.pixels[0],m=C.createEmptyBand(a,o.length),p=t.mask,c=new Uint8Array(e*i);p?c.set(p):c.fill(255);const d=t.pixelType.startsWith("f")?1e-6:0,x=s.map(w=>w-d);x[0]=s[0],x[x.length-1]=s[s.length-1]+(u?1e-6:0);const g=s.length/2,[y,k]=ut(a);for(let w=0;w<i;w++)for(let A=0;A<e;A++){const P=w*e+A;if(c[P]){const U=o[P];let T=!1;for(let v=g-1;v>=0;v--)if(U===s[2*v]||U>x[2*v]&&U<x[2*v+1]){m[P]=l[v],T=!0;break}T||(h?m[P]=U>k?k:U<y?y:r??U:c[P]=0)}}const M=f==null?void 0:f.length;if(M)for(let w=0;w<i;w++)for(let A=0;A<e;A++){const P=w*e+A;if(!p||p[P]){const U=o[P];for(let T=0;T<M;T+=2)if(U>=f[T]&&U<=f[T+1]){m[P]=0,c[P]=0;break}}}return new C({width:e,height:i,pixelType:a,pixels:[m],mask:c})}function at(t,n,e,i){const s=e!=null&&e.length>=2?new Set(e):null,l=(e==null?void 0:e.length)===1?e[0]:null,a=!!(n!=null&&n.length);for(let f=0;f<t.length;f++)if(i[f]){const h=t[f];if(a){let r=!1;for(let u=0;u<n.length;u+=2)if(h>=n[u]&&h<=n[u+1]){r=!0;break}r||(i[f]=0)}i[f]&&(h===l||s!=null&&s.has(h))&&(i[f]=0)}}function ht(t,n){const e=t[0].length;for(let i=0;i<e;i++)if(n[i]){let s=!1;for(let l=0;l<t.length;l++)if(t[l][i]){s=!0;break}s||(n[i]=0)}}function mt(t,n){const e=t[0].length;for(let i=0;i<e;i++)if(n[i]){let s=!1;for(let l=0;l<t.length;l++)if(t[l][i]===0){s=!0;break}s&&(n[i]=0)}}function Kt(t,n){if(!D(t))return null;const{width:e,height:i,pixels:s}=t,l=e*i,a=new Uint8Array(l);t.mask?a.set(t.mask):a.fill(255);const f=s.length,{includedRanges:h,noDataValues:r,outputPixelType:u,matchAll:o,lookups:m}=n;if(m){const p=[];for(let c=0;c<f;c++){const d=m[c],x=pt(s[c],a,d.lut,d.offset||0,"u8");p.push(x)}p.length===1?a.set(p[0]):o?ht(p,a):mt(p,a)}else if(o){const p=[];for(let c=0;c<f;c++){const d=new Uint8Array(l);d.set(a),at(s[c],h==null?void 0:h.slice(2*c,2*c+2),r==null?void 0:r[c],d),p.push(d)}p.length===1?a.set(p[0]):ht(p,a)}else for(let p=0;p<f;p++)at(s[p],h==null?void 0:h.slice(2*p,2*p+2),r==null?void 0:r[p],a);return new C({width:e,height:i,pixelType:u,pixels:s,mask:a})}function Gt(t){const{srcPixelType:n,inputRanges:e,outputValues:i,allowUnmatched:s,noDataRanges:l,isLastInputRangeInclusive:a,outputPixelType:f}=t;if(n!=="u8"&&n!=="s8"&&n!=="u16"&&n!=="s16")return null;const h=n.includes("16")?65536:256,r=n.includes("s")?-h/2:0,u=C.createEmptyBand(f,h),o=new Uint8Array(h);s&&o.fill(255);const[m,p]=ut(f);if(e!=null&&e.length&&(i!=null&&i.length)){const d=e.map(x=>x-1e-6);d[0]=e[0],a&&(d[d.length-1]=e[e.length-1]);for(let x=0;x<d.length;x++){const g=i[x]>p?p:i[x]<m?m:i[x],y=Math.ceil(d[2*x]-r),k=e[2*x+1]===e[2*x]?y:Math.floor(d[2*x+1]-r);for(let M=y;M<=k;M++)u[M]=g,o[M]=255}}if(l!=null&&l.length)for(let c=0;c<l.length;c++){const d=Math.ceil(l[2*c]-r),x=Math.floor(l[2*c+1]-r);for(let g=d;g<=x;g++)o[g]=0}return{lut:u,offset:r,mask:o}}function Qt(t,n,e){if(t!=="u8"&&t!=="s8"&&t!=="u16"&&t!=="s16")return null;const i=t.includes("16")?65536:256,s=t.includes("s")?-i/2:0,l=new Uint8Array(i);if(n)for(let a=0;a<n.length;a++){const f=Math.ceil(n[2*a]-s),h=Math.floor(n[2*a+1]-s);for(let r=f;r<=h;r++)l[r]=255}else l.fill(255);if(e)for(let a=0;a<e.length;a++)l[e[a]-s]=0;return{lut:l,offset:s}}function Pt(t,n,e,i,s,l,a,f){return{xmin:s<=e*t?0:s<e*t+t?s-e*t:t,ymin:l<=i*n?0:l<i*n+n?l-i*n:n,xmax:s+a<=e*t?0:s+a<e*t+t?s+a-e*t:t,ymax:l+f<=i*n?0:l+f<i*n+n?l+f-i*n:n}}function Yt(t,n){if(!t||t.length===0)return null;const e=t.find(c=>c.pixelBlock);if((e==null?void 0:e.pixelBlock)==null)return null;const i=(e.extent.xmax-e.extent.xmin)/e.pixelBlock.width,s=(e.extent.ymax-e.extent.ymin)/e.pixelBlock.height,l=.01*Math.min(i,s),a=t.sort((c,d)=>Math.abs(c.extent.ymax-d.extent.ymax)>l?d.extent.ymax-c.extent.ymax:Math.abs(c.extent.xmin-d.extent.xmin)>l?c.extent.xmin-d.extent.xmin:0),f=Math.min.apply(null,a.map(c=>c.extent.xmin)),h=Math.min.apply(null,a.map(c=>c.extent.ymin)),r=Math.max.apply(null,a.map(c=>c.extent.xmax)),u=Math.max.apply(null,a.map(c=>c.extent.ymax)),o={x:Math.round((n.xmin-f)/i),y:Math.round((u-n.ymax)/s)},m={width:Math.round((r-f)/i),height:Math.round((u-h)/s)},p={width:Math.round((n.xmax-n.xmin)/i),height:Math.round((n.ymax-n.ymin)/s)};return Math.round(m.width/e.pixelBlock.width)*Math.round(m.height/e.pixelBlock.height)!==a.length||o.x<0||o.y<0||m.width<p.width||m.height<p.height?null:{extent:n,pixelBlock:vt(a.map(c=>c.pixelBlock),m,{clipOffset:o,clipSize:p})}}function et(t,n,e,i,s,l){const{width:a,height:f}=e.block,{x:h,y:r}=e.offset,{width:u,height:o}=e.mosaic,m=Pt(a,f,i,s,h,r,u,o);let p=0,c=0;if(l){const d=l.hasGCSSShiftTransform?360:l.halfWorldWidth??0,x=a*l.resolutionX,g=l.startX+i*x;g<d&&g+x>d?c=l.rightPadding:g>=d&&(p=l.leftMargin-l.rightPadding,c=0)}if(m.xmax-=c,typeof n!="number")for(let d=m.ymin;d<m.ymax;d++){const x=(s*f+d-r)*u+(i*a-h)+p,g=d*a;for(let y=m.xmin;y<m.xmax;y++)t[x+y]=n[g+y]}else for(let d=m.ymin;d<m.ymax;d++){const x=(s*f+d-r)*u+(i*a-h)+p;for(let g=m.xmin;g<m.xmax;g++)t[x+g]=n}}function vt(t,n,e={}){var v;const{clipOffset:i,clipSize:s,alignmentInfo:l,blockWidths:a}=e;if(a)return St(t,n,{blockWidths:a});const f=t.find(S=>D(S));if(f==null)return null;const h=s?s.width:n.width,r=s?s.height:n.height,u=f.width,o=f.height,m=n.width/u,p=n.height/o,c={offset:i||{x:0,y:0},mosaic:s||n,block:{width:u,height:o}},d=f.pixelType,x=C.getPixelArrayConstructor(d),g=f.pixels.length,y=[];let k,M;for(let S=0;S<g;S++){M=new x(h*r);for(let b=0;b<p;b++)for(let $=0;$<m;$++){const _=t[b*m+$];D(_)&&(k=_.pixels[S],et(M,k,c,$,b,l))}y.push(M)}const w=t.some(S=>S==null||S.mask!=null&&S.mask.length>0),A=t.some(S=>(S==null?void 0:S.bandMasks)&&S.bandMasks.length>1),P=w?new Uint8Array(h*r):void 0,U=A?[]:void 0;if(P){for(let S=0;S<p;S++)for(let b=0;b<m;b++){const $=t[S*m+b],_=$!=null?$.mask:null;et(P,_??($?255:0),c,b,S,l)}if(U)for(let S=0;S<g;S++){const b=new Uint8Array(h*r);for(let $=0;$<p;$++)for(let _=0;_<m;_++){const B=t[$*m+_],I=((v=B==null?void 0:B.bandMasks)==null?void 0:v[S])??(B==null?void 0:B.mask);et(b,I??(B?255:0),c,_,$,l)}U.push(b)}}const T=new C({width:h,height:r,pixels:y,pixelType:d,bandMasks:U,mask:P});return T.updateStatistics(),T}function St(t,n,e){var x;const i=t.find(g=>g!=null);if(i==null)return null;const s=t.some(g=>g==null||!!g.mask),{width:l,height:a}=n,f=s?new Uint8Array(l*a):null,{blockWidths:h}=e,r=[],u=i.getPlaneCount(),o=C.getPixelArrayConstructor(i.pixelType);if(s)for(let g=0,y=0;g<t.length;y+=h[g],g++){const k=t[g];if(!D(k))continue;const M=k.mask;for(let w=0;w<a;w++)for(let A=0;A<h[g];A++)f[w*l+A+y]=M==null?255:M[w*k.width+A]}const m=t.some(g=>(g==null?void 0:g.bandMasks)&&g.bandMasks.length>1),p=m?[]:void 0,c=l*a;for(let g=0;g<u;g++){const y=new o(c),k=m?new Uint8Array(c):void 0;for(let M=0,w=0;M<t.length;w+=h[M],M++){const A=t[M];if(!D(A))continue;const P=A.pixels[g];if(P!=null){for(let U=0;U<a;U++)for(let T=0;T<h[M];T++)y[U*l+T+w]=P[U*A.width+T];if(k){const U=((x=A.bandMasks)==null?void 0:x[g])??A.mask;for(let T=0;T<a;T++)for(let v=0;v<h[M];v++)k[T*l+v+w]=U?U[T*A.width+v]:255}}}r.push(y),p&&k&&p.push(k)}const d=new C({width:l,height:a,mask:f,bandMasks:p,pixels:r,pixelType:i.pixelType});return d.updateStatistics(),d}function Zt(t,n,e){if(!D(t))return null;const{width:i,height:s}=t,l=n.x,a=n.y,f=e.width+l,h=e.height+a;if(l<0||a<0||f>i||h>s||l===0&&a===0&&f===i&&h===s)return t;t.mask||(t.mask=new Uint8Array(i*s));const r=t.mask;for(let u=0;u<s;u++){const o=u*i;for(let m=0;m<i;m++)r[o+m]=u<a||u>=h||m<l||m>=f?0:1}return t.updateStatistics(),t}function Tt(t){if(!D(t))return null;const n=t.clone(),{width:e,height:i,pixels:s}=t,l=s[0],a=n.pixels[0],f=t.mask;for(let h=2;h<i-1;h++){const r=new Map;for(let o=h-2;o<h+2;o++)for(let m=0;m<4;m++){const p=o*e+m;X(r,l[p],f?f[p]:1)}a[h*e]=ft(r),a[h*e+1]=a[h*e+2]=a[h*e];let u=3;for(;u<e-1;u++){let o=(h-2)*e+u+1;X(r,l[o],f?f[o]:1),o=(h-1)*e+u+1,X(r,l[o],f?f[o]:1),o=h*e+u+1,X(r,l[o],f?f[o]:1),o=(h+1)*e+u+1,X(r,l[o],f?f[o]:1),o=(h-2)*e+u-3,K(r,l[o],f?f[o]:1),o=(h-1)*e+u-3,K(r,l[o],f?f[o]:1),o=h*e+u-3,K(r,l[o],f?f[o]:1),o=(h+1)*e+u-3,K(r,l[o],f?f[o]:1),a[h*e+u]=ft(r)}a[h*e+u+1]=a[h*e+u]}for(let h=0;h<e;h++)a[h]=a[e+h]=a[2*e+h],a[(i-1)*e+h]=a[(i-2)*e+h];return n.updateStatistics(),n}function ft(t){if(t.size===0)return 0;let n=0,e=-1,i=0;const s=t.keys();let l=s.next();for(;!l.done;)i=t.get(l.value),i>n&&(e=l.value,n=i),l=s.next();return e}function K(t,n,e){if(e===0)return;const i=t.get(n);i===1?t.delete(n):t.set(n,i-1)}function X(t,n,e){e!==0&&t.set(n,t.has(n)?t.get(n)+1:1)}function xt(t,n,e){let{x:i,y:s}=n;const{width:l,height:a}=e;if(i===0&&s===0&&a===t.height&&l===t.width)return t;const{width:f,height:h}=t,r=Math.max(0,s),u=Math.max(0,i),o=Math.min(i+l,f),m=Math.min(s+a,h);if(o<0||m<0||!D(t))return null;i=Math.max(0,-i),s=Math.max(0,-s);const{pixels:p}=t,c=l*a,d=p.length,x=[];for(let M=0;M<d;M++){const w=p[M],A=C.createEmptyBand(t.pixelType,c);for(let P=r;P<m;P++){const U=P*f;let T=(P+s-r)*l+i;for(let v=u;v<o;v++)A[T++]=w[U+v]}x.push(A)}const g=new Uint8Array(c),y=t.mask;for(let M=r;M<m;M++){const w=M*f;let A=(M+s-r)*l+i;for(let P=u;P<o;P++)g[A++]=y?y[w+P]:1}const k=new C({width:e.width,height:e.height,pixelType:t.pixelType,pixels:x,mask:g});return k.updateStatistics(),k}function dt(t,n=!0){if(!D(t))return null;const{pixels:e,width:i,height:s,mask:l,pixelType:a}=t,f=[],h=Math.round(i/2),r=Math.round(s/2),u=s-1,o=i-1;for(let p=0;p<e.length;p++){const c=e[p],d=C.createEmptyBand(a,h*r);let x=0;for(let g=0;g<s;g+=2)for(let y=0;y<i;y+=2){const k=c[g*i+y];if(n){const M=y===o?k:c[g*i+y+1],w=g===u?k:c[g*i+y+i],A=y===o?w:g===u?M:c[g*i+y+i+1];d[x++]=(k+M+w+A)/4}else d[x++]=k}f.push(d)}let m=null;if(l!=null){m=new Uint8Array(h*r);let p=0;for(let c=0;c<s;c+=2)for(let d=0;d<i;d+=2){const x=l[c*i+d];if(n){const g=d===o?x:l[c*i+d+1],y=c===u?x:l[c*i+d+i],k=d===o?y:c===u?g:l[c*i+d+i+1];m[p++]=x*g*y*k?1:0}else m[p++]=x}}return new C({width:h,height:r,pixelType:a,pixels:f,mask:m})}function te(t,n,e=0,i=!0){if(!D(t))return null;const{width:s,height:l}=n;let{width:a,height:f}=t;const h=new Map,r={x:0,y:0},u=1+e;let o=t;for(let m=0;m<u;m++){const p=Math.ceil(a/s),c=Math.ceil(f/l);for(let d=0;d<c;d++){r.y=d*l;for(let x=0;x<p;x++){r.x=x*s;const g=xt(o,r,n);h.set(`${m}/${d}/${x}`,g)}}m<u-1&&(o=dt(o,i)),a=Math.round(a/2),f=Math.round(f/2)}return h}function ee(t){const{pixelBlock:n,tileSize:e,level:i,row:s,col:l,useBilinear:a}=t;if(!D(n))return null;const{width:f,height:h}=e,r=2**i,u=r*f,o=r*h;let m=xt(n,{y:s*o,x:l*u},{width:u,height:o});if(!m)return null;for(let p=i;p>0;p--)m=dt(m,a);return m}function gt(t,n,e,i,s=0){const{width:l,height:a}=t,{width:f,height:h}=n,r=i.cols,u=i.rows,o=Math.ceil(f/r-.1/r),m=Math.ceil(h/u-.1/u);let p,c,d,x,g,y,k;const M=o*r,w=M*m*u,A=new Float32Array(w),P=new Float32Array(w),U=new Uint32Array(w),T=new Uint32Array(w);let v,S,b=0;for(let $=0;$<m;$++)for(let _=0;_<o;_++){p=12*($*o+_),c=e[p],d=e[p+1],x=e[p+2],g=e[p+3],y=e[p+4],k=e[p+5];for(let B=0;B<u;B++){b=($*u+B)*M+_*r,S=(B+.5)/u;for(let I=0;I<B;I++)v=(I+.5)/r,A[b+I]=(c*v+d*S+x)*l+s,P[b+I]=(g*v+y*S+k)*a+s,U[b+I]=Math.floor(A[b+I]),T[b+I]=Math.floor(P[b+I])}p+=6,c=e[p],d=e[p+1],x=e[p+2],g=e[p+3],y=e[p+4],k=e[p+5];for(let B=0;B<u;B++){b=($*u+B)*M+_*r,S=(B+.5)/u;for(let I=B;I<r;I++)v=(I+.5)/r,A[b+I]=(c*v+d*S+x)*l+s,P[b+I]=(g*v+y*S+k)*a+s,U[b+I]=Math.floor(A[b+I]),T[b+I]=Math.floor(P[b+I])}}return{offsets_x:A,offsets_y:P,offsets_xi:U,offsets_yi:T,gridWidth:M}}function ne(t,n){const{coefficients:e,spacing:i}=n,{offsets_x:s,offsets_y:l,gridWidth:a}=gt(t,t,e,{rows:i[0],cols:i[1]}),{width:f,height:h}=t,r=new Float32Array(f*h),u=180/Math.PI;for(let o=0;o<h;o++)for(let m=0;m<f;m++){const p=o*a+m,c=o===0?p:p-a,d=o===h-1?p:p+a,x=s[c]-s[d],g=l[d]-l[c];if(isNaN(x)||isNaN(g))r[o*f+m]=90;else{let y=Math.atan2(g,x)*u;y=(360+y)%360,r[o*f+m]=y}}return r}function le(t,n,e,i,s="nearest"){if(!D(t))return null;s==="majority"&&(t=Tt(t));const{pixels:l,mask:a,bandMasks:f,pixelType:h}=t,r=t.width,u=t.height,o=C.getPixelArrayConstructor(h),m=l.length,{width:p,height:c}=n;let d=!1;for(let b=0;b<e.length;b+=3)e[b]===-1&&e[b+1]===-1&&e[b+2]===-1&&(d=!0);const{offsets_x:x,offsets_y:g,offsets_xi:y,offsets_yi:k,gridWidth:M}=gt({width:r,height:u},n,e,i,s==="majority"?.5:0);let w;const A=(b,$,_,B)=>{const I=b instanceof Float32Array||b instanceof Float64Array?0:.5;for(let N=0;N<c;N++){w=N*M;for(let R=0;R<p;R++){if(x[w]<0||g[w]<0)b[N*p+R]=0;else if(B)b[N*p+R]=$[y[w]+k[w]*r];else{const W=Math.floor(x[w]),O=Math.floor(g[w]),V=Math.ceil(x[w]),j=Math.ceil(g[w]),E=x[w]-W,z=g[w]-O;if(!_||_[W+O*r]&&_[V+O*r]&&_[W+j*r]&&_[V+j*r]){const H=(1-E)*$[W+O*r]+E*$[V+O*r],L=(1-E)*$[W+j*r]+E*$[V+j*r];b[N*p+R]=(1-z)*H+z*L+I}else b[N*p+R]=$[y[w]+k[w]*r]}w++}}},P=[];let U;const T=(f==null?void 0:f.length)===m,v=[];for(let b=0;b<m;b++){if(T){const $=new Uint8Array(p*c);A($,f[b],f[b],!0),v.push($)}U=new o(p*c),A(U,l[b],T?f[b]:a,s==="nearest"||s==="majority"),P.push(U)}const S=new C({width:p,height:c,pixelType:h,pixels:P,bandMasks:T?v:void 0});if(a!=null)S.mask=new Uint8Array(p*c),A(S.mask,a,a,!0);else if(d){S.mask=new Uint8Array(p*c);for(let b=0;b<p*c;b++)S.mask[b]=x[b]<0||g[b]<0?0:1}return S.updateStatistics(),S}function ie(t){const{pixelBlock:n,extent:e,fieldNames:i,skipFactor:s,skipSpatialReference:l=!1,pixelIdOffset:a=0}=t,f=[],{width:h,height:r,pixels:u,mask:o}=n,m=t.imageRowSize??h,p=e.width/h,c=e.height/r,d=u.length,x=Math.floor(s/2),{xmin:g,ymax:y}=e,k=l?void 0:e.spatialReference.toJSON();for(let M=x;M<r;M+=s)for(let w=x;w<h;w+=s){const A=M*h+w;if(!o||o[A]){const P={x:g+(w+.5)*p,y:y-(M+.5)*c,spatialReference:k},U={[Ut]:a+M*m+w};for(let T=0;T<d;T++)U[i[T+1]]=u[T][A];f.push({geometry:P,attributes:U})}}return f}const J=new Map;J.set("meter-per-second",1),J.set("kilometer-per-hour",.277778),J.set("knots",.514444),J.set("feet-per-second",.3048),J.set("mile-per-hour",.44704);const lt=180/Math.PI,it=5,Q=new bt({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function rt(t,n){return J.get(t)/J.get(n)||1}function wt(t){return(450-t)%360}function yt(t,n="geographic"){const[e,i]=t,s=Math.sqrt(e*e+i*i);let l=Math.atan2(i,e)*lt;return l=(360+l)%360,n==="geographic"&&(l=wt(l)),[s,l]}function $t(t,n="geographic"){let e=t[1];n==="geographic"&&(e=wt(e)),e%=360;const i=t[0];return[i*Math.cos(e/lt),i*Math.sin(e/lt)]}function re(t,n,e,i="geographic"){if(!D(t)||e==null)return t;const s=n==="vector-magdir"?t.clone():ct(t,n),l=s.pixels[1];for(let a=0;a<l.length;a++)l[a]=i==="geographic"?(l[a]+e[a]+270)%360:(l[a]+360-e[a])%360;return n==="vector-magdir"?s:ct(s,"vector-magdir")}function ct(t,n,e="geographic",i=1){if(!D(t))return t;const{pixels:s,width:l,height:a}=t,f=l*a,h=s[0],r=s[1],u=t.pixelType.startsWith("f")?t.pixelType:"f32",o=C.createEmptyBand(u,f),m=C.createEmptyBand(u,f);let p=0;for(let d=0;d<a;d++)for(let x=0;x<l;x++)n==="vector-uv"?([o[p],m[p]]=yt([h[p],r[p]],e),o[p]*=i):([o[p],m[p]]=$t([h[p],r[p]],e),o[p]*=i,m[p]*=i),p++;const c=new C({pixelType:u,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[o,m]});return c.updateStatistics(),c}function se(t,n,e=1){if(e===1||!D(t))return t;const i=t.clone(),{pixels:s,width:l,height:a}=i,f=s[0];s[1];let h=0;for(let r=0;r<a;r++)for(let u=0;u<l;u++)f[h]*=e,h++;return i.updateStatistics(),i}function oe(t,n,e,i,s){if(s==null||!s.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(n/i),height:Math.round(e/i),resolution:t.width/n};const l=s.xmin,a=s.ymax,f=(t.xmax-t.xmin)/n*i,h=(t.ymax-t.ymin)/e*i,r=(f+h)/2;return t.xmin=l+Math.floor((t.xmin-l)/f)*f,t.xmax=l+Math.ceil((t.xmax-l)/f)*f,t.ymin=a+Math.floor((t.ymin-a)/h)*h,t.ymax=a+Math.ceil((t.ymax-a)/h)*h,{extent:t,width:Math.round(t.width/f),height:Math.round(t.height/h),resolution:r}}const It=kt(0,0,0);function kt(t=0,n=0,e=Math.PI,i=!0){i&&(e=(2*Math.PI-e)%(2*Math.PI));const s=i?-1:1,l=13*s,a=-7*s,f=-2*s,h=-16*s,r=21.75,[u,o]=F(0,n+l,e,r),[m,p]=F(t-5.5,n+a,e,r),[c,d]=F(t+5.5,n+a,e,r),[x,g]=F(t-1.5,n+f,e,r),[y,k]=F(t+1.5,n+f,e,r),[M,w]=F(t-1.5,n+h,e,r),[A,P]=F(t+1.5,n+h,e,r);return[u,o,m,p,x,g,y,k,c,d,M,w,A,P]}function _t(t=0,n=Math.PI,e=!0){e&&(n=(2*Math.PI-n)%(2*Math.PI));const i=10,s=e?-1:1,l=5*s,a=20*s,f=25*s,h=45,r=0,u=0,o=2,m=0,p=o*s,c=e?1:-1,d=i/2*c;let[x,g]=[r+d,u-a],[y,k]=[x+o*c,g],[M,w]=[y-m*c,k+p],[A,P]=[r-d,u-f],[U,T]=[A+m*c,P-p],v=Math.ceil(t/it),S=Math.floor(v/10);v-=8*S;const b=[],$=[];for(let E=0;E<v/2;E++,S--){S<=0&&v%2==1&&E===(v-1)/2&&(A=r,U=A+m*c,P=(P+g)/2,T=P-p);const[z,H]=F(A,P,n,h);if(S>0){const[L,Y]=F(y,P,n,h),[Z,tt]=F(x,g,n,h);b.push(L),b.push(Y),b.push(z),b.push(H),b.push(Z),b.push(tt)}else{const[L,Y]=F(y,k,n,h),[Z,tt]=F(M,w,n,h),[Mt,At]=F(U,T,n,h);$.push(z),$.push(H),$.push(Mt),$.push(At),$.push(Z),$.push(tt),$.push(L),$.push(Y)}P+=l,g+=l,k+=l,w+=l,T+=l}const[_,B]=F(r+d,u+a,n,h),I=(i/2+o)*c,[N,R]=F(r+I,u+a,n,h),[W,O]=F(r+d,u-f,n,h),[V,j]=F(r+I,u-f,n,h);return{pennants:b,barbs:$,shaft:[_,B,N,R,W,O,V,j]}}function F(t,n,e,i=1){const s=Math.sqrt(t*t+n*n)/i,l=(2*Math.PI+Math.atan2(n,t))%(2*Math.PI);return[s,(2*Math.PI+l-e)%(2*Math.PI)]}const G=[0,1,3,6,10,16,21,27,33,40,47,55,63],Bt=[0,.5,1,1.5,2],Ct=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function q(t,n,e,i){const s=rt(i||"knots",e);let l;for(l=1;l<n.length;l++)if(l===n.length-1){if(t<n[l]*s)break}else if(t<=n[l]*s)break;return Math.min(l-1,n.length-2)}function Dt(t,n,e,i,s){let l=0;switch(n){case"beaufort_kn":l=q(t,G,"knots",e);break;case"beaufort_km":l=q(t,G,"kilometer-per-hour",e);break;case"beaufort_ft":l=q(t,G,"feet-per-second",e);break;case"beaufort_m":l=q(t,G,"meter-per-second",e);break;case"classified_arrow":l=q(t,s??[],i,e);break;case"ocean_current_m":l=q(t,Bt,"meter-per-second",e);break;case"ocean_current_kn":l=q(t,Ct,"knots",e)}return l}function Ft(t,n){const{style:e,inputUnit:i,outputUnit:s,breakValues:l}=n,a=Q.fromJSON(i),f=Q.fromJSON(s),h=7*6,r=15;let u=0,o=0;const{width:m,height:p,mask:c}=t,d=t.pixels[0],x=t.pixels[1],g=c!=null?c.filter(w=>w>0).length:m*p,y=new Float32Array(g*h),k=new Uint32Array(r*g),M=n.invertDirection?kt(0,0,0,!1):It;for(let w=0;w<p;w++)for(let A=0;A<m;A++){const P=w*m+A;if(!c||c[w*m+A]){const U=(x[P]+360)%360/180*Math.PI,T=Dt(d[P],e,a,f,l);for(let S=0;S<M.length;S+=2)y[u++]=(A+.5)/m,y[u++]=(w+.5)/p,y[u++]=M[S],y[u++]=M[S+1]+U,y[u++]=T,y[u++]=d[P];const v=7*(u/h-1);k[o++]=v,k[o++]=v+1,k[o++]=v+2,k[o++]=v+0,k[o++]=v+4,k[o++]=v+3,k[o++]=v+0,k[o++]=v+2,k[o++]=v+3,k[o++]=v+2,k[o++]=v+5,k[o++]=v+3,k[o++]=v+5,k[o++]=v+6,k[o++]=v+3}}return{vertexData:y,indexData:k}}const nt=[];function Nt(t,n){if(nt.length===0)for(let p=0;p<30;p++)nt.push(_t(5*p,0,!n.invertDirection));const e=rt(Q.fromJSON(n.inputUnit),"knots"),{width:i,height:s,mask:l}=t,a=t.pixels[0],f=t.pixels[1],h=6,r=[],u=[];let o=0,m=0;for(let p=0;p<s;p++)for(let c=0;c<i;c++){const d=p*i+c,x=a[d]*e;if((!l||l[p*i+c])&&x>=it){const g=(f[d]+360)%360/180*Math.PI,{pennants:y,barbs:k,shaft:M}=nt[Math.min(Math.floor(x/5),29)];if(y.length+k.length===0)continue;let w=r.length/h;const A=(c+.5)/i,P=(p+.5)/s;for(let U=0;U<y.length;U+=2)r[o++]=A,r[o++]=P,r[o++]=y[U],r[o++]=y[U+1]+g,r[o++]=0,r[o++]=x;for(let U=0;U<k.length;U+=2)r[o++]=A,r[o++]=P,r[o++]=k[U],r[o++]=k[U+1]+g,r[o++]=0,r[o++]=x;for(let U=0;U<M.length;U+=2)r[o++]=A,r[o++]=P,r[o++]=M[U],r[o++]=M[U+1]+g,r[o++]=0,r[o++]=x;for(let U=0;U<y.length/6;U++)u[m++]=w,u[m++]=w+1,u[m++]=w+2,w+=3;for(let U=0;U<k.length/8;U++)u[m++]=w,u[m++]=w+1,u[m++]=w+2,u[m++]=w+1,u[m++]=w+2,u[m++]=w+3,w+=4;u[m++]=w+0,u[m++]=w+1,u[m++]=w+2,u[m++]=w+1,u[m++]=w+3,u[m++]=w+2,w+=4}}return{vertexData:new Float32Array(r),indexData:new Uint32Array(u)}}function Rt(t,n){let i=0,s=0;const{width:l,height:a,mask:f}=t,h=t.pixels[0],r=[],u=[],o=rt(Q.fromJSON(n.inputUnit),"knots"),m=n.style==="wind_speed"?it:Number.MAX_VALUE;for(let p=0;p<a;p++)for(let c=0;c<l;c++){const d=h[p*l+c]*o;if((!f||f[p*l+c])&&d<m){for(let g=0;g<4;g++)r[i++]=(c+.5)/l,r[i++]=(p+.5)/a,r[i++]=g<2?-.5:.5,r[i++]=g%2==0?-.5:.5,r[i++]=0,r[i++]=d;const x=4*(i/24-1);u[s++]=x,u[s++]=x+1,u[s++]=x+2,u[s++]=x+1,u[s++]=x+2,u[s++]=x+3}}return{vertexData:new Float32Array(r),indexData:new Uint32Array(u)}}function ae(t,n){return n.style==="simple_scalar"?Rt(t,n):n.style==="wind_speed"?Nt(t,n):Ft(t,n)}function he(t,n,e,i=[0,0],s=.5){const{width:l,height:a,mask:f}=t,[h,r]=t.pixels,[u,o]=i,m=Math.round((l-u)/e),p=Math.round((a-o)/e),c=m*p,d=new Float32Array(c),x=new Float32Array(c),g=new Uint8Array(c);for(let k=0;k<p;k++)for(let M=0;M<m;M++){let w=0;const A=k*m+M,P=Math.max(0,k*e+o),U=Math.max(0,M*e+u),T=Math.min(a,P+e),v=Math.min(l,U+e);for(let S=P;S<T;S++)for(let b=U;b<v;b++){const $=S*l+b;if(!f||f[$]){w++;const _=[h[$],r[$]],[B,I]=_;d[A]+=B,x[A]+=I}}if(w>=(T-P)*(v-U)*(1-s)){g[A]=1;const[S,b]=yt([d[A]/w,x[A]/w]);d[A]=S,x[A]=b}else g[A]=0,d[A]=0,x[A]=0}const y=new C({width:m,height:p,pixels:[d,x],mask:g});return y.updateStatistics(),y}export{ne as D,ee as E,xt as I,Qt as M,le as N,he as S,vt as T,Yt as U,te as W,Rt as _,re as a,ae as b,rt as c,Lt as d,jt as e,ct as f,Jt as g,Vt as h,ot as i,ie as j,Gt as k,yt as l,oe as m,pt as n,D as o,se as p,Ht as q,qt as r,Q as s,zt as u,Zt as v,Kt as w,Xt as x};
