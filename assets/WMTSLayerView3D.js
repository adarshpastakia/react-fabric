import{ef as d,g7 as m,O as p,l as n,E as o,F as a,V as f}from"./ShadowCastClear.glsl.js";import{l as u}from"./LayerView3D.js";import{p as c}from"./TiledLayerView3D.js";import{i as g}from"./fetchTile.js";import{d as y}from"./LayerView.js";import{i as I}from"./RefreshableLayerView.js";import"./iframe-qDaPDssc.js";import"./index.js";import"./Viewport.js";import"./debounce.js";import"./index2.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";let r=class extends I(c(u(y))){constructor(){super(...arguments),this.type="wmts-3d"}initialize(){this._getCompatibleTileInfoMatrixSet(t=>this._getTileInfoSupportError(t.tileInfo,t.fullExtent));const e=d(()=>{var t,i;return(i=(t=this.view)==null?void 0:t.basemapTerrain)==null?void 0:i.tilingSchemeLocked}).then(()=>{const t=this._getCompatibleTileInfoMatrixSet(i=>this._getTileInfoError(i.tileInfo,i.fullExtent));t!=null&&(t.id!==null&&this.layer.activeLayer.tileMatrixSetId!==t.id&&(this.layer.activeLayer.tileMatrixSetId=t.id),t.tileInfo&&(this.tileInfo=t.tileInfo),this.layer.fullExtent=t.fullExtent)});this.addResolvingPromise(e),this.when(()=>this._postInitialize())}refresh(){this.emit("data-changed")}canResume(){if(!super.canResume())return!1;const e=this.layer.activeLayer.tileMatrixSet;return e!=null&&!this._getTileInfoError(e.tileInfo,e.fullExtent)}async fetchTile(e,t){return g(this,e,t)}async doRefresh(){this.suspended||this.emit("data-changed")}_postInitialize(){this._updatingHandles.add(()=>{var e,t;return(t=(e=this.layer)==null?void 0:e.activeLayer)==null?void 0:t.styleId},()=>this.refresh()),this._updatingHandles.add(()=>{var e;return(e=this.layer)==null?void 0:e.activeLayer},e=>{const t=this._getCompatibleTileInfoMatrixSet(i=>this._getTileInfoError(i.tileInfo,i.fullExtent),!0);t&&t.id!=null&&e.tileMatrixSetId!==t.id&&(this.layer.activeLayer.tileMatrixSetId=t.id),this.notifyChange("suspended"),this.canResume()&&this.refresh()})}_getCompatibleTileInfoMatrixSet(e,t=!1){const i=m(this.layer);if(i!=null){if(p.isCollection(i))return i.find(h=>{const s=e(h);return s!=null&&(t?n.getLogger(this).error("The selected tile matrix set is not compatible with the view",s):this.addResolvingPromise(Promise.reject(s))),s==null});const l=e(i);return l!=null&&(t?n.getLogger(this).error("The selected tile matrix set is not compatible with the view",l):this.addResolvingPromise(Promise.reject(l))),i}return null}_getTileInfoError(e,t){return this._getTileInfoSupportError(e,t)||this._getTileInfoCompatibilityError(e,this.view.basemapTerrain.tilingScheme)}};o([a()],r.prototype,"layer",void 0),o([a()],r.prototype,"suspended",void 0),o([a()],r.prototype,"tileInfo",void 0),r=o([f("esri.views.3d.layers.WMTSLayerView3D")],r);const V=r;export{V as default};
