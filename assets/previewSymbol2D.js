import{cK as H,cL as I,b8 as A,cM as D,aa as b,cN as W,b as G,cq as J,cO as Z,cP as V,cQ as X,cn as Y,cR as _,cS as P}from"./ShadowCastClear.glsl.js";import{y as T}from"./densifyCurvedGeometry.js";import{t as tt,h as q}from"./previewUtils.js";import"./iframe-DpfJK_wQ.js";import"./index.js";import"./Viewport.js";import"./debounce.js";import"./index2.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";const K="picture-fill",nt="picture-marker",at="simple-fill",ot="simple-line",it="simple-marker",et="text",lt="Aa",st=22,L=120,rt=80,R=50,N=225,ht=document.createElement("canvas");function O(n,t,s){const{extent:o}=n;if(!o)return"";const p=o.width||1,h=o.height||1;if(n.type==="polygon"){const r=n.clone();Z(r)&&(r.rings=T(r,{minSegmentsPerCurve:128}).rings),V({originPosition:"upperLeft",scale:[p/t,h/s],translate:[o.xmin,o.ymax]},r,r);let e="";for(let l=0;l<r.rings.length;l++){const u=r.rings[l];for(let c=0;c<u.length;c++){const f=u[c][0],i=u[c][1],a=c===0?"M":"l",x=c===u.length-1?" Z":"";e+=`${e!==""?" ":""}${a}${f.toString()} ${i.toString()}${x}`}}return e}if(n.type==="polyline"){const r=n.clone();Z(r)&&(r.paths=T(r,{minSegmentsPerCurve:128}).paths),X({originPosition:"upperLeft",scale:[p/t,h/s],translate:[o.xmin,o.ymax]},r,r);let e="";for(let l=0;l<r.paths.length;l++){const u=r.paths[l];for(let c=0;c<u.length;c++){const f=u[c][0],i=u[c][1];e+=`${e!==""?" ":""}${c===0?"M":"l"}${f.toString()} ${i.toString()}`}}return e}return""}function Q(n,t){const s=ht.getContext("2d"),o=[];t&&(t.weight&&o.push(t.weight),t.size&&o.push(t.size+"px"),t.family&&o.push(t.family)),s.font=o.join(" ");const{width:p,actualBoundingBoxLeft:h,actualBoundingBoxRight:r,actualBoundingBoxAscent:e,actualBoundingBoxDescent:l}=s.measureText(n);return{width:Math.ceil(Math.max(p,h+r)),height:Math.ceil(e+l),x:Math.floor(h),y:Math.floor((e-l)/2)}}function S(n){const t=n==null?void 0:n.size;return{width:t!=null&&typeof t=="object"&&"width"in t?b(t.width):null,height:t!=null&&typeof t=="object"&&"height"in t?b(t.height):null}}async function ct(n,t){const s=t.fill,o=n.color;if((s==null?void 0:s.type)==="pattern"&&o&&n.type!==K){const p=await Y(s.src,o.toCss(!0));s.src=p,t.fill=s}}async function ut(n,t,s,o){var r,e,l;if(!("font"in n)||!n.font||t.shape.type!=="text")return;try{await _(n.font)}catch{}const{width:p,height:h}=S(o);if(!/[\uE600-\uE6FF]/.test(t.shape.text)){const{width:u,height:c,x:f,y:i}=Q(t.shape.text,{weight:(r=t.font)==null?void 0:r.weight,size:(e=t.font)==null?void 0:e.size,family:(l=t.font)==null?void 0:l.family});s[0]=p??u,s[1]=h??c,t.shape.x=f,t.shape.y=i;let a="angle"in n?n.angle:null;if((o==null?void 0:o.rotation)!=null&&(a=(a??0)+o.rotation),a){const x=a*(Math.PI/180),z=Math.abs(Math.sin(x)),C=Math.abs(Math.cos(x));s[1]=s[0]*z+s[1]*C}}}function mt(n,t,s,o,p){var h;if(n.haloColor!=null&&n.haloSize!=null){p.masking??(p.masking=s.map(()=>[]));const r=b(n.haloSize);o[0]+=r,o[1]+=r,s.unshift([{...t,fill:null,stroke:{color:n.haloColor,width:2*r,join:"round",cap:"round"}}]),p.masking.unshift([{shape:{type:"rect",x:0,y:0,width:o[0]+2*P,height:o[1]+2*P},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}n.backgroundColor==null&&n.borderLineColor==null||(o[0]+=2*P,o[1]+=2*P,s.unshift([{shape:{type:"rect",x:0,y:0,width:o[0],height:o[1]},fill:n.backgroundColor,stroke:{color:n.borderLineColor,width:b(n.borderLineSize)}}]),(h=p.masking)==null||h.unshift([]))}function U(n,t){return n>t?"dark":"light"}function pt(n,t){var z,C,E,$,j;const s=typeof(t==null?void 0:t.size)=="number"?t==null?void 0:t.size:null,o=s!=null?b(s):null,p=(t==null?void 0:t.maxSize)!=null?b(t.maxSize):null;let h="angle"in n?n.angle:null;(t==null?void 0:t.rotation)!=null&&(h=(h??0)+t.rotation);const r=H(n);let e=I(n);dt(n,245)!=="dark"||t!=null&&t.ignoreWhiteSymbols||(e={width:.75,...e,color:"#bdc3c7"});let l=null;const u={shape:null,fill:r,stroke:e,offset:[0,0]};e!=null&&e.width&&(e.width=Math.min(e.width,rt));const c=(e==null?void 0:e.width)||0;let f=(t==null?void 0:t.size)!=null&&((t==null?void 0:t.scale)==null||(t==null?void 0:t.scale)),i=0,a=0,x=!1;switch(n.type){case it:{const g=n.style,{width:d,height:m}=S(t);let v=d===m&&d!=null?d:o??Math.min(b(n.size),p||L);if((t==null?void 0:t.useMarkerSymbolSize)===!0&&d!==null&&m!==null){const y=Math.min(b(n.size),p||L);v=y>d&&y>m?Math.min(d,m):y}switch(i=v,a=v,g){case"circle":u.shape={type:"circle",cx:0,cy:0,r:.5*v},f||(i+=c,a+=c);break;case"cross":u.shape={type:"path",path:[{command:"M",values:[0,.5*a]},{command:"L",values:[i,.5*a]},{command:"M",values:[.5*i,0]},{command:"L",values:[.5*i,a]}]};break;case"diamond":u.shape={type:"path",path:[{command:"M",values:[0,.5*a]},{command:"L",values:[.5*i,0]},{command:"L",values:[i,.5*a]},{command:"L",values:[.5*i,a]},{command:"Z",values:[]}]},f||(i+=c,a+=c);break;case"square":u.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[i,0]},{command:"L",values:[i,a]},{command:"L",values:[0,a]},{command:"Z",values:[]}]},f||(i+=c,a+=c),h&&(x=!0);break;case"triangle":u.shape={type:"path",path:[{command:"M",values:[.5*i,0]},{command:"L",values:[i,a]},{command:"L",values:[0,a]},{command:"Z",values:[]}]},f||(i+=c,a+=c),h&&(x=!0);break;case"x":u.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[i,a]},{command:"M",values:[i,0]},{command:"L",values:[0,a]}]},h&&(x=!0);break;case"path":u.shape={type:"path",path:n.path||""},f||(i+=c,a+=c),h&&(x=!0),f=!0}break}case ot:{const{width:g,height:d}=S(t),m=W(e).reduce((M,k)=>M+k,0),v=m&&Math.ceil(R/m),y=d??o??c,w=g??(m*v||R);if(f=!0,((z=t==null?void 0:t.geometry)==null?void 0:z.type)==="polyline"&&((C=t==null?void 0:t.geometry)==null?void 0:C.extent)){i=w,a=d??i;const M=1e3,k=.15*M;l=[i,a],a=l[0]>l[1]?M*l[1]/l[0]:M,i=l[0]>l[1]?M:M*l[0]/l[1],e!=null&&e.width&&(e.width=e.width*M/(l[1]>l[0]?l[1]:l[0]),e.width>k&&(e.width=k)),u.shape={type:"path",path:O(t.geometry,i,a)}}else i=(t==null?void 0:t.maxSize)!=null?Math.min(w,t.maxSize):w,a=y,e&&(e.width=y),u.shape={type:"path",path:[{command:"M",values:[y/2,a/2]},{command:"L",values:[i-y/2,a/2]}]};break}case K:case at:{const g=typeof(t==null?void 0:t.symbolConfig)=="object"&&!!((E=t==null?void 0:t.symbolConfig)!=null&&E.isSquareFill),{width:d,height:m}=S(t);i=!g&&d!==m||d==null?o??st:d,a=!g&&d!==m||m==null?i:m,f||(i+=c,a+=c),f=!0,($=t==null?void 0:t.geometry)!=null&&$.extent&&((j=t==null?void 0:t.geometry)==null?void 0:j.type)==="polygon"?(l=[i,a],a=l[0]>l[1]?1e3*l[1]/l[0]:1e3,i=l[0]>l[1]?1e3:1e3*l[0]/l[1],u.shape={type:"path",path:O(t.geometry,i,a)}):u.shape=g?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[i,0]},{command:"L",values:[i,a]},{command:"L",values:[0,a]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:tt.fill[0];break}case nt:{const g=Math.min(b(n.width),p||L),d=Math.min(b(n.height),p||L),{width:m,height:v}=S(t),y=m===v&&m!=null?m:o??Math.max(g,d),w=n.width/n.height;i=w<=1?Math.ceil(y*w):y,a=w<=1?y:Math.ceil(y/w),u.shape={type:"image",x:-Math.round(i/2),y:-Math.round(a/2),width:i,height:a,src:n.url||""},h&&(x=!0);break}case et:{const g=n,d=(t==null?void 0:t.overrideText)||g.text||lt,m=g.font,{width:v,height:y}=S(t),w=y??o??Math.min(b(m.size),p||L),{width:M,height:k}=Q(d,{weight:m.weight,size:w,family:m.family}),B=/[\uE600-\uE6FF]/.test(d);i=v??(B?w:M),a=B?w:k;let F=.5*(B?w:k);B&&(F+=5),u.shape={type:"text",text:d,x:g.xoffset||0,y:g.yoffset||F,align:"middle",alignBaseline:g.verticalAlignment,decoration:m&&m.decoration,rotated:g.rotated,kerning:g.kerning},u.font=m&&{size:w,style:m.style,decoration:m.decoration,weight:m.weight,family:m.family};break}}return{shapeDescriptor:u,size:[i,a],outputSize:l,renderOptions:{node:t==null?void 0:t.node,scale:f,opacity:t==null?void 0:t.opacity,rotations:[h],useRotationSize:x,cssEffectFilter:t==null?void 0:t.cssEffectFilter,ariaLabel:t==null?void 0:t.ariaLabel,clipBloomEffect:t==null?void 0:t.clipBloomEffect}}}async function Bt(n,t){var l,u,c,f,i;const{shapeDescriptor:s,size:o,renderOptions:p,outputSize:h}=pt(n,t);if(!s.shape)throw new G("symbolPreview: renderPreviewHTML2D","symbol not supported.");await ct(n,s),await ut(n,s,o,t);const r=[[s]];if(typeof(t==null?void 0:t.symbolConfig)=="object"&&((l=t==null?void 0:t.symbolConfig)!=null&&l.applyColorModulation)){const a=.6*o[0];r.unshift([{...s,offset:[-a,0],fill:q(s.fill,-.3)}]),r.push([{...s,offset:[a,0],fill:q(s.fill,.3)}]),o[0]+=2*a,p.scale=!1}n.type==="text"&&mt(n,s,r,o,p);const e=J(r,o,p);if(h&&e){const a=e.nodeName.toLowerCase()==="img"?e:e.firstChild;a.nodeName.toLowerCase()==="svg"&&a.setAttribute("viewBox",`0 0 ${o[0].toString()} ${o[1].toString()}`),a.setAttribute("width",h[0].toString()),a.setAttribute("height",h[1].toString()),h.length>2&&(a.style.setProperty("padding-left",((u=h[2])==null?void 0:u.toString())+"px"),a.style.setProperty("padding-right",((c=h[2])==null?void 0:c.toString())+"px"),a.style.setProperty("padding-top",((f=h[3])==null?void 0:f.toString())+"px"),a.style.setProperty("padding-bottom",((i=h[3])==null?void 0:i.toString())+"px"),a.style.setProperty("box-sizing","border-box"))}return e}function dt(n,t=N){const s=H(n),o=I(n),p=!s||"type"in s?null:new A(s),h=o!=null&&o.color?new A(o==null?void 0:o.color):null,r=p?U(D(p),t):null,e=h?U(D(h),t):null;return e?r?r===e?r:t>=N?"light":"dark":e:r}export{dt as getContrastingBackgroundTheme,pt as getRenderSymbolParameters,Bt as previewSymbol2D};
