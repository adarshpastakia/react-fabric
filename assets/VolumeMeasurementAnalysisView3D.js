import{b8 as b,b6 as Y,bJ as y,b_ as mt,mb as gt,ma as ye,md as fe,bI as me,HQ as Ht,oy as _t,E as a,F as u,V as O,b as zt,HR as ae,ga as Ut,HS as yt,Hr as qt,Fk as It,EV as J,wh as ee,GW as Fe,GX as Bt,F4 as B,F1 as A,F5 as te,F6 as ie,H1 as Pe,F7 as se,Fc as re,oO as ft,fB as Wt,hn as H,EX as Nt,HT as Xt,GV as De,wn as vt,FC as Qt,HU as Zt,FG as Kt,H2 as wt,Hm as bt,H3 as ge,dF as Yt,mC as I,lu as q,lr as Jt,lg as Se,qf as ei,HV as ti,eF as Ct,ls as Vt,ix as xt,sW as Ft,b4 as Pt,b5 as S,bj as w,er as ii,bo as W,bk as $t,me as si,l as ri,fb as Tt,bR as ve,bS as we,bO as be,lz as Rt,n1 as Gt,f6 as $e,gr as oi,bl as $,uD as ni,eH as ai,FT as li,yf as Ee,sQ as ui,F3 as ci,FW as hi,FA as pi,Fz as di,t3 as mi,Hl as gi,HW as je,t2 as _i,HX as ke,HY as le,GP as _e,Hn as yi,fe as fi,ym as vi,hP as wi,tQ as Ae,bU as He,yn as ze,fW as N,fc as Z,fV as Ue,vC as bi,GH as Ci,go as qe,Af as Ce,vE as Vi,hi as Ie,h0 as ue,p4 as xi,sB as Fi,D8 as Pi,eU as $i,hl as Be,hw as Ve,kM as Ti,es as We,b7 as Ri,bn as Ne,eo as Gi,_ as Mi,yg as Oi,a5 as Xe}from"./ShadowCastClear.glsl.js";import{e as Li}from"./AnalysisView3D.js";import{e as Mt}from"./earcut.js";import{a as Di,p as ce,w as Si}from"./ShadedColorMaterial.glsl.js";import{r as xe,X as Ei}from"./Graphics3DExtrudeSymbolLayer.js";import{b6 as oe}from"./iframe-DpfJK_wQ.js";import{_ as Qe,a6 as Ze}from"./euclideanLengthMeasurementUtils.js";import{d as ji}from"./quantityFormatUtils.js";import{f as Ke,m as ki}from"./Segment.js";import{R as Ye}from"./OutlineVisualElement.js";import{h as Ai}from"./lineStippleUtils.js";import{_ as Hi,S as zi}from"./SlicePlaneMaterial.glsl.js";import{T as Ui}from"./dragEventPipeline3D.js";import{r as qi,p as Ii,j as Bi}from"./InteractiveToolBase.js";import{l as Ot,a as Je}from"./SketchOptions.js";import{r as Wi,R as Ni,H as Xi}from"./SketchTooltipInfo.js";import{h as Qi}from"./TooltipInfoWithCoordinates.js";import{s as Zi}from"./ExclusiveOperationManager.js";import{a as Ki}from"./allLayerSnapping.js";import{d as Yi}from"./SketchViewModel.js";import"./index.js";import"./Viewport.js";import"./debounce.js";import"./index2.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";import"./AnalysisView.js";import"./VisualElement.js";import"./line.js";import"./ColorMaterial.glsl.js";import"./TriangleMaterial.js";import"./SnappingCandidate.js";import"./renderingInfoUtils.js";import"./triangulationUtils.js";import"./deduplicate.js";import"./geometry2dUtils.js";import"./geodeticLengthOperator.js";import"./geodeticCurveType.js";import"./TextOverlayItem.js";import"./EngineVisualElement.js";import"./LaserlinePath.glsl.js";import"./line2.js";import"./sliceToolConfig.js";import"./SlicePlane.js";import"./DefaultLayouts.js";import"./EditGeometryOperations.js";import"./rotate.js";import"./curveOperationUtils.js";import"./MeshTransform.js";import"./angularMeasurementUtils.js";import"./automaticAreaMeasurementUtils.js";import"./geodesicAreaMeasurementUtils.js";import"./automaticLengthMeasurementUtils.js";const et=new b("black");let Ji=class{constructor(){this.geometryOutlineWidth=1.5,this.geometryOutlineColor=new b("rgb(128,128,128)"),this.cutColor=new b("rgba(153, 198, 111, 0.75)"),this.fillColor=new b("rgba(200, 200, 230, 0.75)"),this.cutColorMuted=new b("rgba(176, 176, 176, 0.75)"),this.fillColorMuted=new b("rgba(194, 194, 194, 0.75)"),this.cutProjectionLineColor=b.blendColors(this.cutColor,et,.4),this.fillProjectionLineColor=b.blendColors(this.fillColor,et,.4),this.projectionLineWidth=2,this.projectionLineStippleSize=4,this.labelDistance=40,this.labelPrecisions={"cubic-millimeters":0,"cubic-centimeters":0,"cubic-decimeters":1,"cubic-meters":2,"cubic-kilometers":6,"cubic-inches":0,"cubic-feet":2,"cubic-yards":2,"cubic-miles":6,liters:2},this.maxVolumeExtentSizeVw=.7,this.minVolumeExtentSizePixels=250,this.minTargetElevation=-11e3,this.maxTargetElevation=9e3,this.targetElevationRange=this.maxTargetElevation-this.minTargetElevation,this.maxPerimeterLocalWebMercator=1e4,this.maxPerimeterGlobal=5e4}};const M=new Ji;let V=class extends Y{constructor(t){super(t),this.rawResult=null}get localOriginRenderSpace(){const{extent:t,localOrigin:i,renderCoordsHelper:s}=this,r=y();return s.toRenderCoords(i,t.spatialReference,r),r}get cameraPositionRenderSpace(){const{localOriginRenderSpace:t,renderCoordsHelper:i}=this,s=y(),r=1/i.unitInMeters;return i.setAltitude(s,ts*r,t),s}get boundingRect(){const{extent:t,renderCoordsHelper:i}=this,s=mt();return i.viewingMode===2?gt(t,s):(this._expandBoundingRect(t.xmin,t.ymin,s),this._expandBoundingRect(t.xmax,t.ymin,s),this._expandBoundingRect(t.xmin,t.ymax,s),this._expandBoundingRect(t.xmax,t.ymax,s)),s}get cameraDimensions(){const{boundingRect:t}=this;return{width:fe(t),height:ye(t)}}get cameraNearFar(){const{renderCoordsHelper:{unitInMeters:t}}=this,i=1/t;return{near:is*i,far:ss*i}}get upVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,2,y())}get northVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,1,y())}get eastVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,0,y())}_expandBoundingRect(t,i,s){const{extent:r,eastVector:l,northVector:n,upVector:c,renderCoordsHelper:h}=this,p=r.center.z??0;me(he,t,i,p),h.toRenderCoords(he,r.spatialReference,he),Ht(he,l,n,c,tt),_t(s,tt,s)}};a([u()],V.prototype,"renderCoordsHelper",void 0),a([u()],V.prototype,"extent",void 0),a([u()],V.prototype,"localOrigin",void 0),a([u()],V.prototype,"localOriginRenderSpace",null),a([u()],V.prototype,"cameraPositionRenderSpace",null),a([u()],V.prototype,"boundingRect",null),a([u()],V.prototype,"cameraDimensions",null),a([u()],V.prototype,"upVector",null),a([u()],V.prototype,"northVector",null),a([u()],V.prototype,"eastVector",null),a([u()],V.prototype,"rawResult",void 0),V=a([O("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillComputation")],V);const he=y(),tt=y(),es=100,ts=M.maxTargetElevation,is=0,ss=M.targetElevationRange+es;let ne=class extends zt{constructor(t,i,s){super(t,i,s),this.name="unknown",this.name=t}};class it extends ne{constructor(){super("perimeter-too-large","The input geometry's perimeter is too large for the current viewing mode and spatial reference.")}}let rs=class extends ne{constructor(){super("distance-too-far","The measurement geometry is too far from the camera.")}},os=class extends ne{constructor(){super("distance-too-close","The measurement geometry is too close to the camera.")}};class ns extends ne{constructor(){super("unsupported-coordinate-system","The coordinate system of the view (viewing mode and spatial reference) is not supported.")}}let as=class extends ne{constructor(){super("unsupported-layer-transparency","The volume measurement analysis does not support transparent layers.")}};function ls(e,t,i="cubic-meters"){const s=e-t,r=e+t;return{cutVolume:ae(e,i),fillVolume:ae(t,i),netVolume:ae(s,i),totalVolume:ae(r,i)}}function pe(e,t){return e?Ut(e,yt(e.value,e.unit,t)):null}let R=class extends Y{constructor(t){super(t)}get cutVolume(){return pe(this.rawResult.cutVolume,this.unit)}get fillVolume(){return pe(this.rawResult.fillVolume,this.unit)}get netVolume(){return pe(this.rawResult.netVolume,this.unit)}get totalVolume(){return pe(this.rawResult.totalVolume,this.unit)}};a([u({constructOnly:!0})],R.prototype,"measureType",void 0),a([u()],R.prototype,"cutVolume",null),a([u()],R.prototype,"fillVolume",null),a([u()],R.prototype,"netVolume",null),a([u()],R.prototype,"totalVolume",null),a([u({constructOnly:!0})],R.prototype,"rawResult",void 0),a([u({constructOnly:!0})],R.prototype,"unit",void 0),R=a([O("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementResult")],R);class Lt extends qt{constructor(){super(...arguments),this.output=0}}a([It({count:11})],Lt.prototype,"output",void 0);let Te=class extends J{};function Dt(){const e=new ee;return e.include(Fe),e.fragment.include(Bt),e.fragment.uniforms.add(new B("cutFillReferenceDepthTexture",t=>t.referenceDepthTexture),new B("cutFillTargetDepthTexture",t=>t.targetDepthTexture)),e.fragment.code.add(A`bool outsideFar(float depth) {
return depth >= 1.0;
}`),e.fragment.main.add(A`float referenceDepth = depthFromTexture(cutFillReferenceDepthTexture, uv);
float targetDepth = depthFromTexture(cutFillTargetDepthTexture, uv);
if (outsideFar(targetDepth)) {
discard;
}
float depth = referenceDepth - targetDepth;
float cut = min(0.0, depth);
float fill = max(0.0, depth);
fragColor = vec4(cut, fill, 0.0, 0.0);`),e}const us=Object.freeze(Object.defineProperty({__proto__:null,CutFillDepthParameters:Te,build:Dt},Symbol.toStringTag,{value:"Module"}));let st=class extends te{constructor(t,i){super(t,i,new ie(us,()=>oe(()=>Promise.resolve().then(()=>$s),void 0,import.meta.url)),Pe)}initializePipeline(){return se({colorWrite:re})}},Re=class extends J{};function St(){const e=new ee;return e.include(Fe),e.fragment.uniforms.add(new B("cutFillDepthTexture",t=>t.depthTexture)),e.fragment.main.add(A`ivec2 iuv = ivec2(gl_FragCoord.xy) * 2;
vec2 sum = vec2(0.0);
for (int dx = 0; dx < 2; dx++) {
for (int dy = 0; dy < 2; dy++) {
sum += texelFetch(cutFillDepthTexture, iuv + ivec2(dx, dy), 0).rg;
}
}
fragColor = vec4(sum.r, sum.g, 0.0, 0.0);`),e}const cs=Object.freeze(Object.defineProperty({__proto__:null,CutFillReductionParameters:Re,build:St},Symbol.toStringTag,{value:"Module"}));class rt extends te{constructor(t,i){super(t,i,new ie(cs,()=>oe(()=>Promise.resolve().then(()=>Ts),void 0,import.meta.url)),Pe)}initializePipeline(){return se({colorWrite:re})}}let Ge=class extends J{constructor(){super(...arguments),this.origin=ft,this.cutFillCamera={projectionMatrix:H(),viewMatrix:H(),nearFar:Wt()}}};function Et(e){const t=new ee,{vertex:i,fragment:s,varyings:r,attributes:l}=t;return t.include(Nt),t.include(Xt,e),l.add("position","vec3"),r.add("depth","float",{invariant:!0}),i.uniforms.add(new De("proj",n=>n.cutFillCamera.projectionMatrix),new De("view",n=>vt(hs,n.cutFillCamera.viewMatrix,n.origin)),new Qt("nearFar",n=>n.cutFillCamera.nearFar)),i.main.add(A`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, depth);`),s.main.add(A`fragColor = vec4(1.0);
outputDepth(depth);`),t}const hs=H(),ps=Object.freeze(Object.defineProperty({__proto__:null,CutFillTargetDepthParameters:Ge,build:Et},Symbol.toStringTag,{value:"Module"}));let ot=class extends te{constructor(t,i){super(t,i,new ie(ps,()=>oe(()=>Promise.resolve().then(()=>Rs),void 0,import.meta.url)),Zt)}initializePipeline(){return se({colorWrite:re,depthWrite:Kt,depthTest:{func:519}})}},E=class extends wt{constructor(t){super(t),this.consumes={required:[bt.TRANSPARENT]},this.produces=ge.CUTFILL_DEPTH,this._cutFillTargetDepthConfiguration=new Lt,this._cutFillTargetDepthParameters=new Ge,this._cutFillDepthParameters=new Te,this._cutFillReductionParameters=new Re,this.needsRender=!1,this.done=!0,this._localOrigin=y(),this._maxTextureSize=4096,this._width=0,this._height=0,this._reducedWidth=0,this._reducedHeight=0,this._depthFormat=13,this._colorFormat=10,this._targetVao=null}initialize(){this._maxTextureSize=Math.min(Yt("esri-mobile")?1024:this._maxTextureSize,this.fboCache.rctx.parameters.maxTextureSize),this._cutFillTargetDepthConfiguration.output=8}destroy(){this._targetVao=I(this._targetVao)}precompile(){this.techniques.precompile(ot,this._cutFillTargetDepthConfiguration),this.techniques.precompile(st),this.techniques.precompile(rt),this.view.stage.renderer.precompileCutFill()}render(t){var C;const i=t.find(({name:x})=>x===ge.CUTFILL_DEPTH);if(!this._orthographicCamera||!this._targetVao||!this.needsRender)return i;const s=this.techniques.get(ot,this._cutFillTargetDepthConfiguration),r=this.techniques.get(st),l=this.techniques.get(rt);if(!s.compiled||!r.compiled||!l.compiled)return this.requestRender(1),i;this.needsRender=!1;const n=this.renderingContext,c=this.fboCache,h=n.getViewport(),p=c.acquire(this._width,this._height,"cutfill reference depth",this._depthFormat);n.bindFramebuffer(p.fbo),n.setViewport(0,0,this._width,this._height),n.clear(1280),this.view.stage.renderer.renderCutFillReferenceDepth(this._orthographicCamera);const o=c.acquire(this._width,this._height,"cutfill target depth",this._depthFormat);n.bindFramebuffer(o.fbo),n.setViewport(0,0,this._width,this._height),n.setClearDepth(1),n.clear(256),this._cutFillTargetDepthParameters.origin=this._localOrigin,this._cutFillTargetDepthParameters.cutFillCamera=this._orthographicCamera,n.bindTechnique(s,this.bindParameters,this._cutFillTargetDepthParameters),n.bindVAO(this._targetVao),n.drawArrays(q.TRIANGLES,0,this._targetVao.vertexCount("geometry"));let d=c.acquire(this._width,this._height,"cutfill reduction even",this._colorFormat),m=c.acquire(this._width,this._height,"cutfill reduction odd",this._colorFormat);this._cutFillDepthParameters.referenceDepthTexture=p.depthTexture,this._cutFillDepthParameters.targetDepthTexture=o.depthTexture,n.bindFramebuffer(d.fbo),n.bindTechnique(r,this.bindParameters,this._cutFillDepthParameters),n.setClearColor(0,0,0,0),n.clear(16384),n.screen.draw(),p.release(),o.release();let f=this._width,v=this._height;const _=Math.ceil(Math.log2(Math.min(f,v)));for(let x=0;x<_;x++)f=Math.ceil(f/2),v=Math.ceil(v/2),this._cutFillReductionParameters.depthTexture=d.getTexture(),this._prepareFBO(m,f,v),n.bindTechnique(l,this.bindParameters,this._cutFillReductionParameters),n.screen.draw(),[d,m]=[m,d];return this._buffer=new Float32Array(f*v*2),(C=d.fbo)==null||C.readPixels(0,0,f,v,33319,Jt.FLOAT,this._buffer),this._reducedWidth=f,this._reducedHeight=v,d.release(),m.release(),n.setViewport(h.x,h.y,h.width,h.height),this.done=!0,i}setup(t,i){const s=this.renderingContext,{cameraDimensions:{width:r,height:l},localOriginRenderSpace:n}=t,c=this._maxTextureSize,h=l/r,p=r>l?c:c/h,o=r>l?c*h:c;this._width=Se(p),this._height=Se(o);const d=[this._width,this._height];this._orthographicCamera=this._createCamera(t,d),this._targetVao=I(this._targetVao),this._targetVao=ds(s,i),this._localOrigin=n,this.done=!1}start(){this._width!==0&&this._height!==0&&(this.needsRender=!0)}getDepth(){var s,r;let t=0,i=0;for(let l=0;l<this._reducedWidth;l++)for(let n=0;n<this._reducedHeight;n++){const c=l+n*this._reducedHeight;t+=((s=this._buffer)==null?void 0:s[2*c])??0,i+=((r=this._buffer)==null?void 0:r[2*c+1])??0}return{cut:t,fill:i}}get width(){return this._width}get height(){return this._height}get updating(){return this.needsRender||!this.done}_prepareFBO(t,i,s){const r=this.renderingContext;r.bindFramebuffer(t.fbo),r.setViewport(0,0,i,s),r.setClearColor(0,0,0,0),r.clear(16384)}_createCamera(t,i){const{cameraPositionRenderSpace:s,localOriginRenderSpace:r,northVector:l,cameraDimensions:{width:n,height:c},cameraNearFar:{near:h,far:p}}=t,o=new ei({eye:s,center:r,up:l,near:h,far:p});return o.viewport=[0,0,i[0],i[1]],ti(o.projectionMatrix,-n/2,n/2,-c/2,c/2,h,p),o}};a([u()],E.prototype,"consumes",void 0),a([u()],E.prototype,"produces",void 0),a([u()],E.prototype,"needsRender",void 0),a([u()],E.prototype,"done",void 0),a([u()],E.prototype,"updating",null),E=a([O("esri.views.3d.webgl-engine.lib.CutFillDepth")],E);const nt=Ct().vec3f("position").freeze();function ds(e,t){const{positions:i,indices:s}=t,r=nt.createBuffer(s.length),l=r.position;for(let c=0;c<s.length;++c){const h=3*s[c];l.set(c,0,i[h]),l.set(c,1,i[h+1]),l.set(c,2,i[h+2])}const n=new Vt(e,xt(nt),r.buffer);return new Ft(e,n)}let ms=class{constructor(t,i){this.positions=t,this.indices=i}},g=class extends Y{constructor(e){super(e),this._getElevationProvider=()=>this.view.elevationProvider,this._updatingHandles=new Pt,this._computationValue=null}initialize(){const e=this.view;this._renderer=new E({view:e}),this._updatingHandles.add(()=>({computation:this._computation,renderGeometry:this._targetGeometryRenderInfo}),({computation:t,renderGeometry:i})=>{t&&i&&(this._renderer.setup(t,i),this._renderer.start())},S),this.addHandles([this._createElevationUpdateHandle(),w(()=>this._targetGeometry,t=>this.analysisViewData.targetGeometry=t,W),w(()=>this._elevationAlignedGeometry,t=>this.analysisViewData.elevationAlignedGeometry=t,W),w(()=>{var t;return{computation:this._computation,extent:(t=this._projectedGeometry)==null?void 0:t.extent,localOrigin:this._localOrigin}},({computation:t,extent:i,localOrigin:s})=>{t&&i&&s&&(t.extent=i,t.localOrigin=s)},$t),ii(()=>this._renderer.done,()=>this._updateResult())])}destroy(){this._updatingHandles.destroy(),this._renderer.destroy()}get _projectedGeometry(){if(!this.analysis.valid)return null;const e=this.analysis.geometry,t=si(e,this.view.spatialReference);return t.pending?(this._updatingHandles.addPromise(t.pending),null):(e&&!t.geometry&&Di(this.analysis,e.spatialReference,ri.getLogger(this)),t.geometry)}get _localOrigin(){var t;const e=(t=this._projectedGeometry)==null?void 0:t.extent;return e?Tt(e.center.x,e.center.y,0):null}get _elevationAlignedGeometry(){const e=this._projectedGeometry;if(!e)return null;const t=e.clone();return gs(this._getElevationProvider(),t),t}get _targetGeometry(){const e=this._elevationAlignedGeometry;if(!e)return null;const t=this.analysis.measureType,{effectiveTargetElevation:i}=this.analysisViewData;if(t==="stockpile"||i==null)return e;const s=e.clone();return s.rings[0].forEach(r=>r[2]=i),s}get _targetGeometryRenderInfo(){var m;const e=this._targetGeometry,t=(m=this._projectedGeometry)==null?void 0:m.extent,i=this._localOrigin;if(!e||!t||!i)return null;const{elevationProvider:s,renderCoordsHelper:r}=this.view,l=xe(e,s,r,ve.fromElevationInfo(new we({mode:"absolute-height"}))),{polygons:n}=l,c=n[0],h=Mt(c.position,c.holeIndices,3),p=be(3*c.count),o=H(),d=H();return Rt(t.spatialReference,i,o,r.spatialReference),d[12]=-o[12],d[13]=-o[13],d[14]=-o[14],Gt(p,c.position,d),new ms(p,h)}get updating(){return this._renderer.updating||this._updatingHandles.updating}get result(){var t;const e=(t=this._computation)==null?void 0:t.rawResult;return e?new R({measureType:this.analysis.measureType,rawResult:e,unit:this.analysisViewData.effectiveDisplayUnits.volume}):null}get error(){return this._unsupportedCoordinateSystemError??this._unsupportedLayerTransparencyError??this._perimeterTooLargeError??this._tooNearFarError}get _tooNearFarError(){const e=this._elevationAlignedGeometry;if(!e)return null;const{view:t}=this,{elevationProvider:i,renderCoordsHelper:s}=t,{camera:r}=t.state,l=xe(e,i,s,ve.fromElevationInfo(new we({mode:"absolute-height"}))),{polygons:n}=l,c=n[0].position;$e(X);for(let m=0;m<c.length;m+=3)r.projectToScreen(me(vs,c[m],c[m+1],c[m+2]),ut),_t(X,ut,X);const h=fe(X),p=ye(X),{maxVolumeExtentSizeVw:o,minVolumeExtentSizePixels:d}=M;return h>r.width/r.pixelRatio*o||p>r.height/r.pixelRatio*o?new os:Math.max(h,p)<d?new rs:null}get _perimeterTooLargeError(){return this._perimeterTooLargeLocalError??this._perimeterTooLargeGlobalError}get _perimeterTooLargeLocalError(){const{spatialReference:e,state:{isLocal:t}}=this.view;if(!t||!e.isWebMercator)return null;const i=this._perimeter,{maxPerimeterLocalWebMercator:s}=M;return i!=null&&i>s?new it:null}get _perimeterTooLargeGlobalError(){if(!this.view.state.isGlobal)return null;const e=this._perimeter,{maxPerimeterGlobal:t}=M;return e!=null&&e>t?new it:null}get _unsupportedCoordinateSystemError(){return this.view.state.isLocal&&this.view.spatialReference.isGeographic?new ns:null}get _unsupportedLayerTransparencyError(){var e;return(((e=this.view.map)==null?void 0:e.ground.opacity)??1)<1?new as:null}get _perimeter(){var i;const e=(i=this._targetGeometryRenderInfo)==null?void 0:i.positions,t=e?ys(fs(e)):null;return t!=null?t/this.view.renderCoordsHelper.unitInMeters:null}get _enabled(){return!this.error}get _computation(){var s;const e=(s=this._projectedGeometry)==null?void 0:s.extent;if(!e||!this._enabled)return this._computationValue=$(this._computationValue),null;if(this._computationValue)return this._computationValue;const t=this._localOrigin;if(!t)return null;const{renderCoordsHelper:i}=this.view;return this._computationValue=new V({extent:e,localOrigin:t,renderCoordsHelper:i}),this._computationValue}_createElevationUpdateHandle(){const e=t=>{var s;const i=(s=this._projectedGeometry)==null?void 0:s.extent;t.context==="ground"&&i&&(ni(t.extent,t.spatialReference,at,this.view.spatialReference),gt(i,lt),ai(at,lt)&&(this._getElevationProvider=()=>this.view.elevationProvider))};return this.view.elevationProvider.on("elevation-change",t=>e(t))}_updateResult(){if(!this._computation)return;const{spatialReference:e,viewingMode:t}=this.view,{extent:i,boundingRect:s,cameraNearFar:{near:r,far:l}}=this._computation,{width:n,height:c}=this._renderer;let h,p;t==="local"&&e.isWebMercator?{width:h,height:p}=_s(i):(h=fe(s),p=ye(s));const o=h/n*(p/c),d=this._renderer.getDepth(),m=_=>_*(l-r)+r,f=m(d.cut)*o,v=m(d.fill)*o;this._computation.rawResult=ls(Math.abs(f),v)}};function gs(e,t){t.rings[0].forEach(i=>{i[2]=li(e,i,"ground")??0})}function _s(e){const t=Qe([e.xmin,e.ymin,0],[e.xmax,e.ymin,0],e.spatialReference),i=Qe([e.xmin,e.ymin,0],[e.xmin,e.ymax,0],e.spatialReference);return{width:(t==null?void 0:t.value)??0,height:(i==null?void 0:i.value)??0}}function ys(e){if(!e)return null;let t=null,i=null,s=0;for(const r of e)t||(t=[r[0],r[1],r[2]??0]),i?s+=Ee(i,r):i=[0,0,0],i[0]=r[0],i[1]=r[1],i[2]=r[2];return t&&i&&(s+=Ee(i,t)),Math.sqrt(s)}function*fs(e){const t=y();for(let i=0;i<e.length;i+=3)t[0]=e[i],t[1]=e[i+1],t[2]=e[i+2],yield t}a([u()],g.prototype,"_projectedGeometry",null),a([u()],g.prototype,"_localOrigin",null),a([u()],g.prototype,"_getElevationProvider",void 0),a([u()],g.prototype,"_elevationAlignedGeometry",null),a([u()],g.prototype,"_targetGeometry",null),a([u()],g.prototype,"_targetGeometryRenderInfo",null),a([u({constructOnly:!0})],g.prototype,"analysis",void 0),a([u({constructOnly:!0})],g.prototype,"analysisViewData",void 0),a([u({constructOnly:!0})],g.prototype,"view",void 0),a([u()],g.prototype,"updating",null),a([u()],g.prototype,"result",null),a([u()],g.prototype,"error",null),a([u()],g.prototype,"_tooNearFarError",null),a([u()],g.prototype,"_perimeterTooLargeError",null),a([u()],g.prototype,"_perimeterTooLargeLocalError",null),a([u()],g.prototype,"_perimeterTooLargeGlobalError",null),a([u()],g.prototype,"_unsupportedCoordinateSystemError",null),a([u()],g.prototype,"_unsupportedLayerTransparencyError",null),a([u()],g.prototype,"_perimeter",null),a([u()],g.prototype,"_enabled",null),a([u()],g.prototype,"_renderer",void 0),a([u({readOnly:!0})],g.prototype,"_updatingHandles",void 0),a([u()],g.prototype,"_computation",null),g=a([O("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillController")],g);const at=$e(),lt=$e(),vs=y(),X=mt(),ut=oi();let Me=class extends J{constructor(){super(...arguments),this.borderColor=ui()}};function jt(){const e=new ee;return e.include(Fe),e.outputs.add("fragColor","vec4",0),e.fragment.uniforms.add(new B("colorTexture",t=>t.color),new B("cutFillVolumes",t=>t.cutFillVolumes),new B("cutFillMask",t=>t.cutFillMask),new ci("pixelRatio",(t,i)=>i.camera.pixelRatio),new hi("borderColor",t=>t.borderColor)).main.add(A`vec4 color = texture(colorTexture, uv, 0.0);
vec4 volumesColor = texture(cutFillVolumes, uv, 0.0);
ivec2 iuv = ivec2(uv * vec2(textureSize(cutFillMask, 0)));
vec2 m0 = texelFetch(cutFillMask, iuv, 0).rg;
vec2 m1 = texelFetch(cutFillMask, iuv + ivec2(-1, 0), 0).rg;
vec2 m2 = texelFetch(cutFillMask, iuv + ivec2(1, 0), 0).rg;
vec2 m3 = texelFetch(cutFillMask, iuv + ivec2(0, -1), 0).rg;
vec2 m4 = texelFetch(cutFillMask, iuv + ivec2(0, 1), 0).rg;
float d = (
step(1.5, abs(m0.r - m1.r) + abs(m0.g - m1.g))
+ step(1.5, abs(m0.r - m2.r) + abs(m0.g - m2.g))
+ step(1.5, abs(m0.r - m3.r) + abs(m0.g - m3.g))
+ step(1.5, abs(m0.r - m4.r) + abs(m0.g - m4.g))
) * 0.25 * pixelRatio;
vec4 base = mix(color, volumesColor, max(m0.r, m0.g) * volumesColor.a);
fragColor = mix(base, borderColor, d);`),e}const ws=Object.freeze(Object.defineProperty({__proto__:null,CutFillCompositionPassParameters:Me,build:jt},Symbol.toStringTag,{value:"Module"}));let ct=class extends te{constructor(t,i){super(t,i,new ie(ws,()=>oe(()=>Promise.resolve().then(()=>Gs),void 0,import.meta.url)),Pe)}initializePipeline(){return se({colorWrite:re})}};class Oe extends J{constructor(){super(...arguments),this.origin=ft}}function kt(){const e=new ee;return e.attributes.add("position","vec3"),e.outputs.add("fragColor","vec4",0),e.vertex.uniforms.add(new pi("proj",t=>t.camera.projectionMatrix),new di("view",(t,i)=>vt(bs,i.camera.viewMatrix,t.origin))).main.add(A`gl_Position = proj * view * vec4(position, 1.0);
gl_Position.z = min(gl_Position.z, gl_Position.w);`),e.fragment.main.add(A`fragColor = vec4(1, 1, 0, 0);`),e}const bs=H(),Cs=Object.freeze(Object.defineProperty({__proto__:null,CutFillMaskDrawParameters:Oe,build:kt},Symbol.toStringTag,{value:"Module"}));class ht extends te{constructor(t,i){super(t,i,new ie(Cs,()=>oe(()=>Promise.resolve().then(()=>Ms),void 0,import.meta.url)),mi(gi))}initializePipeline(){return se({colorWrite:re,depthTest:{func:515}})}}let j=class extends wt{constructor(e){super(e),this.consumes={required:[bt.OPAQUE]},this.produces=ge.CUTFILL_COLOR,this._vaoCut=null,this._vaoFill=null,this._countCut=0,this._countFill=0,this._maskParameters=new Oe,this._cutVolumeParameters=new je,this._fillVolumeParameters=new je,this._compositeParameters=new Me,this._drawParameters=new _i;const t=e.view.state.viewingMode===1;this._cutVolumeTechniqueConfiguration=new ke(t),this._cutVolumeTechniqueConfiguration.customDepthTest=2,this._cutVolumeTechniqueConfiguration.writeDepth=!1,this._cutVolumeTechniqueConfiguration.cullFace=1,this._cutVolumeTechniqueConfiguration.doubleSidedMode=1,this._fillVolumeTechniqueConfiguration=new ke(t),this._fillVolumeTechniqueConfiguration.cullFace=2}initialize(){this.addHandles([w(()=>[this.cutColor,this.fillColor],()=>this._updateColors(),W)])}destroy(){this._vaoCut=I(this._vaoCut),this._vaoFill=I(this._vaoFill)}precompile(){this.techniques.precompile(le,this._cutVolumeTechniqueConfiguration),this.techniques.precompile(le,this._fillVolumeTechniqueConfiguration),this.techniques.precompile(ht),this.techniques.precompile(ct)}render(e){const t=this.techniques.get(le,this._cutVolumeTechniqueConfiguration),i=this.techniques.get(le,this._fillVolumeTechniqueConfiguration),s=this.techniques.get(ht),r=this.techniques.get(ct),l=e.find(({name:_})=>_===this.produces);if(!this._vaoCut||!this._vaoFill)return l;if(!(t&&i&&s.compiled&&r.compiled))return this.requestRender(1),l;const n=this.bindParameters,c=n.camera,h=c.fullViewport[2],p=c.fullViewport[3],o=this.renderingContext,d=this.fboCache,m=d.acquire(h,p,"cutfill color mask",2);m.attachDepth(l.getAttachment(_e)),o.bindFramebuffer(m.fbo),o.setClearColor(0,0,0,1),o.clear(17408),o.setViewport(0,0,h,p),o.bindTechnique(s,n,yi,this._maskParameters),o.setFaceCullingEnabled(!1),o.setStencilTestEnabled(!0),o.setStencilOpSeparate(1028,7680,34055,7680),o.setStencilOpSeparate(1029,7680,34056,7680),o.setDepthWriteEnabled(!1),o.bindVAO(this._vaoCut),o.setDepthTestEnabled(!0),o.setStencilWriteMask(255),o.setStencilFunction(519,0,255),o.setColorMask(!1,!1,!1,!1),o.drawArrays(q.TRIANGLES,0,this._countCut),o.setDepthTestEnabled(!1),o.setStencilWriteMask(0),o.setStencilFunction(517,0,255),o.setColorMask(!0,!1,!1,!1),o.drawArrays(q.TRIANGLES,0,this._countCut),o.bindVAO(this._vaoFill),o.setDepthTestEnabled(!0),o.setStencilWriteMask(255),o.setStencilFunction(519,0,255),o.setColorMask(!1,!0,!1,!1),o.drawArrays(q.TRIANGLES,0,this._countFill);const f=d.acquire(h,p,"cutfill color volumes",5);f.attachDepth(l.getAttachment(_e)),o.bindFramebuffer(f.fbo),o.setClearColor(0,0,0,0),o.clear(16384),o.setColorMask(!0,!0,!0,!0),o.bindTechnique(t,this.bindParameters,this._cutVolumeParameters,this._drawParameters),o.setPolygonOffset(1,1),o.setPolygonOffsetFillEnabled(!0),o.bindVAO(this._vaoCut),o.drawArrays(q.TRIANGLES,0,this._countCut),o.bindTechnique(i,this.bindParameters,this._fillVolumeParameters,this._drawParameters),o.setPolygonOffset(0,0),o.setPolygonOffsetFillEnabled(!1),o.bindVAO(this._vaoFill),o.drawArrays(q.TRIANGLES,0,this._countFill);const v=this.fboCache.acquire(h,p,this.produces);return o.bindFramebuffer(v.fbo),this._compositeParameters.color=l.getTexture(),this._compositeParameters.cutFillVolumes=f.getTexture(),this._compositeParameters.cutFillMask=m.getTexture(),b.toUnitRGBA(this.borderColor,this._compositeParameters.borderColor),o.bindTechnique(r,n,this._compositeParameters),o.screen.draw(),m.release(),f.release(),v.attachDepth(l.getAttachment(_e)),v}enable(){this.produces=ge.CUTFILL_COLOR,this.requestRender(1)}disable(){this.produces="disabled",this.requestRender(1)}updateGeometries(e,t,i){this._vaoCut=I(this._vaoCut),this._vaoCut=this._createVao(e),this._countCut=e.indicesBottom.length+e.indicesExtruded.length,this._vaoFill=I(this._vaoFill),this._vaoFill=this._createVao(t),this._countFill=t.indicesBottom.length+t.indicesExtruded.length,this._maskParameters.origin=i,fi(this._drawParameters.origin,i),this.requestRender(1)}_updateColors(){this._cutVolumeParameters.diffuse=b.toUnitRGB(this.cutColor),this._cutVolumeParameters.opacity=this.cutColor.a,this._fillVolumeParameters.diffuse=b.toUnitRGB(this.fillColor),this._fillVolumeParameters.opacity=this.fillColor.a,this.requestRender(1)}_createVao(e){const t=this.renderingContext,{vertices:i,normals:s,indicesBottom:r,indicesExtruded:l}=e,n=pt.createBuffer(r.length+l.length),{position:c,normal:h}=n;for(let o=0;o<r.length;o++){const d=3*r[o];c.set(o,0,i[d]),c.set(o,1,i[d+1]),c.set(o,2,i[d+2]),h.set(o,0,s[d]),h.set(o,1,s[d+1]),h.set(o,2,s[d+2])}for(let o=0;o<l.length;o++){const d=o+r.length,m=3*l[o];c.set(d,0,i[m]),c.set(d,1,i[m+1]),c.set(d,2,i[m+2]),h.set(d,0,s[m]),h.set(d,1,s[m+1]),h.set(d,2,s[m+2])}const p=new Vt(t,xt(pt),n.buffer);return new Ft(t,p)}};a([u()],j.prototype,"consumes",void 0),a([u()],j.prototype,"produces",void 0),a([u()],j.prototype,"cutColor",void 0),a([u()],j.prototype,"fillColor",void 0),a([u()],j.prototype,"borderColor",void 0),j=a([O("esri.views.3d.webgl-engine.lib.CutFillColor")],j);const pt=Ct().vec3f("position").vec3f("normal").freeze();class Vs{constructor(t,i,s,r){this.vertices=t,this.indicesBottom=i,this.indicesExtruded=s,this.normals=r}}let P=class extends Y{get visible(){return this.analysisViewData.visible&&this.analysisViewData.elevationAlignedGeometry!=null&&this.analysisViewData.targetGeometry!=null}get updating(){return this.loadingMessages}get hasUnsupportedError(){const{error:e}=this.analysisViewData;return!!e&&["unsupported-coordinate-system","unsupported-layer-transparency"].includes(e.name)}constructor(e){super(e),this.unitsMessages=null,this.messages=null,this.loadingMessages=!0,this._elevationContext=ve.fromElevationInfo(new we({mode:"absolute-height"})),this._extrusionHeight=M.targetElevationRange,this._projectionLines=[]}initialize(){const{view:e}=this,t={view:e,isDecoration:!0},i=M,s={...t,width:i.geometryOutlineWidth};this._elevationAlignedGeometry=new Ye({...s,isDraped:!0,color:b.toUnitRGBA(i.geometryOutlineColor)}),this._targetGeometry=new Ye(s);const r={...t,attached:!0,width:i.projectionLineWidth,renderOccluded:4,polygonOffset:!0},l={...r,stipplePattern:Ai(i.projectionLineStippleSize)},n=b.toUnitRGBA(i.cutProjectionLineColor),c=b.toUnitRGBA(i.fillProjectionLineColor);this._cutProjectionLines=new ce({...r,color:n}),this._occludedCutProjectionLines=new ce({...l,color:n}),this._fillProjectionLines=new ce({...r,color:c}),this._occludedFillProjectionLines=new ce({...l,color:c});const h={...t,attached:!0};this._cutVolumeLabel=new Ke(h),this._fillVolumeLabel=new Ke(h),this._cutFillRenderNode=new j({view:e,cutColor:i.cutColor,fillColor:i.fillColor,borderColor:i.geometryOutlineColor}),this.addHandles([w(()=>({elevationAlignedGeometry:this.analysisViewData.elevationAlignedGeometry,targetGeometry:this.analysisViewData.targetGeometry}),({elevationAlignedGeometry:p,targetGeometry:o})=>{this._elevationAlignedGeometry.geometry=p,this._targetGeometry.geometry=o},S),w(()=>({interactive:this.analysisViewData.interactive,measureType:this.analysis.measureType,visible:this.visible}),({visible:p,interactive:o,measureType:d})=>{this._elevationAlignedGeometry.visible=p&&!o,this._targetGeometry.visible=p&&d==="cut-fill"},S),w(()=>({elevationAlignedGeometry:this.analysisViewData.elevationAlignedGeometry,targetGeometry:this.analysisViewData.targetGeometry,visible:this.visible}),({elevationAlignedGeometry:p,targetGeometry:o,visible:d})=>this._updateProjectionLines(p,o,d),S),w(()=>({interactive:this.analysisViewData.interactive,accentColor:this.view.effectiveTheme.accentColor,hasResult:!!this.analysisViewData.result}),({interactive:p,accentColor:o,hasResult:d})=>{this._updateColors(p,o,d)},S),w(()=>this.analysisViewData.targetGeometry,()=>this._updateCutFillGeometry(),S),w(()=>this.visible&&!this.hasUnsupportedError,p=>this._updateCutFillVisibility(p),S),w(()=>{const{messages:p,unitsMessages:o,visible:d,analysisViewData:m}=this;return{labelAnchors:m.labelAnchors,effectiveDisplayUnits:m.effectiveDisplayUnits,messages:p,unitsMessages:o,result:m.result,visible:d&&!!m.result}},p=>this._updateLabels(p)),w(()=>this.view.state.camera,p=>this._updateProjectionLineOcclusion(p),S),vi(()=>this._updateMessageBundle())]),this._updateMessageBundle()}destroy(){this._elevationAlignedGeometry=$(this._elevationAlignedGeometry),this._targetGeometry=$(this._targetGeometry),this._cutProjectionLines=$(this._cutProjectionLines),this._occludedCutProjectionLines=$(this._occludedCutProjectionLines),this._fillProjectionLines=$(this._fillProjectionLines),this._occludedFillProjectionLines=$(this._occludedFillProjectionLines),this._cutVolumeLabel=$(this._cutVolumeLabel),this._fillVolumeLabel=$(this._fillVolumeLabel),this._cutFillRenderNode.destroy()}_updateProjectionLines(e,t,i){if(this._cutProjectionLines.visible=i,this._occludedCutProjectionLines.visible=i,this._fillProjectionLines.visible=i,this._occludedFillProjectionLines.visible=i,!e||!t)return;const{renderCoordsHelper:s}=this.view,r=[],l=e.spatialReference,n=e.rings[0],c=n.length>1&&wi(n[0],n[n.length-1]),h=n.length-(c?1:0);for(let _=0;_<h;++_){const C=n[_],x=me(y(),C[0],C[1],C[2]);s.toRenderCoords(x,l,x);const L=t.rings[0][_],T=me(y(),L[0],L[1],L[2]);s.toRenderCoords(T,l,T);const U=new ki(x,T);r.push(U)}e.isClockwise(n)||r.reverse();const p=[],o=[],d=[],m=[],f=[],v=this.view.state.camera;for(let _=0;_<r.length;++_){const C=r[_],x=r[_===0?r.length-1:_-1],L=r[_===r.length-1?0:_+1],T=e.rings[0][_],U=t.rings[0][_],z=T[2]>U[2],D=new xs(C,x,L,z);p.push(D),D.updateOccluded(v);const Le=D.isOccluded;z?(Le?d:o).push(C):(Le?f:m).push(C)}this._projectionLines=p,this._cutProjectionLines.setGeometryFromSegments(o),this._occludedCutProjectionLines.setGeometryFromSegments(d),this._fillProjectionLines.setGeometryFromSegments(m),this._occludedFillProjectionLines.setGeometryFromSegments(f)}_updateProjectionLineOcclusion(e){const t=[],i=[],s=[],r=[];let l=!1,n=!1;for(const c of this._projectionLines){c.updateOccluded(e)&&(l||(l=c.isCut),n||(n=!c.isCut));const h=c.isOccluded;(c.isCut?h?i:t:h?r:s).push(c.segment)}n&&(this._fillProjectionLines.setGeometryFromSegments(s),this._occludedFillProjectionLines.setGeometryFromSegments(r)),l&&(this._cutProjectionLines.setGeometryFromSegments(t),this._occludedCutProjectionLines.setGeometryFromSegments(i))}_updateColors(e,t,i){const{geometryOutlineColor:s,cutColor:r,fillColor:l,cutColorMuted:n,fillColorMuted:c,cutProjectionLineColor:h,fillProjectionLineColor:p}=M;if(this._cutFillRenderNode.cutColor=i?r:n,this._cutFillRenderNode.fillColor=i?l:c,e){const o=b.toUnitRGBA(t);this._targetGeometry.color=o,this._cutProjectionLines.color=o,this._occludedCutProjectionLines.color=o,this._fillProjectionLines.color=o,this._occludedFillProjectionLines.color=o,this._cutFillRenderNode.borderColor=t}else{this._targetGeometry.color=b.toUnitRGBA(s);const o=b.toUnitRGBA(i?h:n);this._cutProjectionLines.color=o,this._occludedCutProjectionLines.color=o;const d=b.toUnitRGBA(i?p:c);this._fillProjectionLines.color=d,this._occludedFillProjectionLines.color=d,this._cutFillRenderNode.borderColor=s}}_updateLabels(e){const{labelDistance:t}=M,{effectiveDisplayUnits:i,labelAnchors:s,messages:r,unitsMessages:l,result:n,visible:c}=e;if(this._cutVolumeLabel.visible=c,this._fillVolumeLabel.visible=c,this._cutVolumeLabel.geometry=s.cut?{type:"point",point:s.cut,callout:{distance:t,offset:0}}:null,this._fillVolumeLabel.geometry=s.fill?{type:"point",point:s.fill,callout:{distance:-t,offset:0}}:null,n==null||r==null||l==null)return this._cutVolumeLabel.text="-",void(this._fillVolumeLabel.text="-");const h=i.volume,p=Ae(r.labels.cut,{volume:dt(l,n.cutVolume,h)}),o=Ae(r.labels.fill,{volume:dt(l,n.fillVolume,h)});this._cutVolumeLabel.text=p,this._fillVolumeLabel.text=o}_updateCutFillVisibility(e){e?this._cutFillRenderNode.enable():this._cutFillRenderNode.disable()}_updateCutFillGeometry(){const{renderCoordsHelper:e}=this.view,{targetGeometry:t}=this.analysisViewData;if(!(t!=null&&t.extent))return;const{center:i}=t.extent,s=Tt(i.x,i.y,0),r=y();e.toRenderCoords(s,t.spatialReference,r);const l=this._getExtrudedVolumes(t,this._extrusionHeight,s),n=this._getExtrudedVolumes(t,-this._extrusionHeight,s);this._cutFillRenderNode.updateGeometries(l,n,r)}_getExtrudedVolumes(e,t,i){const{renderCoordsHelper:s,spatialReference:r,elevationProvider:l}=this.view,n=y(),c=s.viewingMode===1;c||s.worldUpAtPosition([0,0,0],n);const h=xe(e,l,s,this._elevationContext),{polygons:p,mapPositions:o,position:d}=h,m=p[0],f=m.count,v=Mt(m.mapPositions,m.holeIndices,3),_=v.length,C=6*f,x=He(C+_),L=He(_),T=be(3*C),U=be(3*C);Ei(d,o,v,m,T,null,U,null,x,L,t,n,c);const z=H(),D=H();return Rt(r,i,z,s.spatialReference),D[12]=-z[12],D[13]=-z[13],D[14]=-z[14],Gt(T,T,D),new Vs(T,L,x,U)}async _updateMessageBundle(){this.loadingMessages=!0;try{this.unitsMessages=await ze("esri/core/t9n/Units"),this.messages=await ze("esri/views/3d/analysis/VolumeMeasurement/t9n/VolumeMeasurementAnalysis")}finally{this.loadingMessages=!1}}};function dt(e,t,i){if(!t||!e)return null;const s=yt(t.value,t.unit,i),r=M.labelPrecisions[s];return ji(e,t,s,r)}a([u({constructOnly:!0})],P.prototype,"view",void 0),a([u({constructOnly:!0})],P.prototype,"analysis",void 0),a([u({constructOnly:!0})],P.prototype,"analysisViewData",void 0),a([u()],P.prototype,"unitsMessages",void 0),a([u()],P.prototype,"messages",void 0),a([u()],P.prototype,"loadingMessages",void 0),a([u({readOnly:!0})],P.prototype,"visible",null),a([u()],P.prototype,"updating",null),a([u()],P.prototype,"hasUnsupportedError",null),P=a([O("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillVisualization")],P);class xs{constructor(t,i,s,r){this.segment=t,this.previous=i,this.next=s,this.isCut=r,this._isOccluded=!1,this._n1=y(),this._n2=y();const l=N(Q,Z(Q,t.endRenderSpace,t.startRenderSpace));N(this._n1,Ue(this._n1,l,N(de,Z(de,i.startRenderSpace,t.startRenderSpace)))),N(this._n2,Ue(this._n2,l,N(de,Z(de,t.startRenderSpace,s.startRenderSpace)))),this._isConvex=bi.normalize(Ci(this._n1,this._n2,l))<0}get isOccluded(){return this._isOccluded}updateOccluded(t){Z(Q,this.segment.startRenderSpace,t.eye);const i=qe(this._n1,Q)<0,s=qe(this._n2,Q)<0,r=this._isOccluded;return this._isOccluded=this._isConvex?i&&s:i||s,this._isOccluded!==r}}const Q=y(),de=y();function Fs(e){return At(e==null?void 0:e.geometry)}function At(e){return e!=null&&e.type==="polygon"}let K=class extends Qi(Wi){constructor(e){super(e),this.type="elevation",this.allFields.forEach(t=>{t.lockable=!1,t.setActual(null)})}get allFields(){return[this.elevation]}};a([u()],K.prototype,"type",void 0),a([u()],K.prototype,"allFields",null),K=a([O("esri.views.interactive.tooltip.infos.ElevationTooltipInfo")],K);let k=class extends qi{constructor(e){super(e),this.sketchOptions=new Ot}initialize(){const{view:e}=this;this._shiftManipulator=new Hi(e,0),this._shiftManipulator.state|=zi,this.manipulators.add(this._shiftManipulator),this.addHandles([this._createDragPipeline(),w(()=>this.analysisViewData.targetGeometry,()=>this._updateManipulatorPosition(),$t),w(()=>[this.analysisViewData.interactive,this.analysisViewData.targetGeometry,this.analysis.measureType],()=>this._updateManipulatorVisibility(),W)]),this._initializeTooltip(),this.finishToolCreation()}_initializeTooltip(){const{view:e}=this;this.tooltip=Ni(()=>({view:e,options:this.sketchOptions.tooltips})),this._tooltipInfo=new K({sketchOptions:this.sketchOptions}),this.sketchOptions.tooltips.placement="trailing",this._updateSketchOptions(),this.addHandles([w(()=>this.analysisViewData.effectiveTargetElevation,()=>this._updateTooltip()),w(()=>this._shouldShowTooltip,t=>{t?this._showTooltip():this._hideTooltip()}),this.tooltip.on("commit",()=>{const t=this._tooltipInfo.elevation.actual,i=Ce(this.view.spatialReference);if(t==null||i==null)return;const s=Vi(t,i);this._updateValue(s,{recordUndo:this.analysis.cutFillOptions.targetElevation})}),w(()=>[this.analysis.displayUnits.elevation,this.analysis.inputUnits.elevation],()=>this._updateSketchOptions(),W)])}destroy(){this._shiftManipulator.destroy(),this.tooltip.destroy()}onInputEvent(e){if(!this.destroyed&&!Xi(e,this.tooltip))return super.onInputEvent(e)}get _shouldShowTooltip(){return this.hasFocusedManipulators||this.tooltip.mode==="input"}_createDragPipeline(){return Ii(this._shiftManipulator,(e,t,i)=>{const s=Be(e.renderLocation),r=this.analysis.inputUnits.elevation??"meters",l=Ce(this.view.spatialReference);let n;t.next(Ui(this.view,s,this.view.spatialReference)).next(Bi()).next(c=>{if(c.action==="start"){const{targetElevation:h}=this.analysis.cutFillOptions;n=h&&l?Ve(h,r,l):void 0}return this._updateValue(n!=null?n+c.translationZ:c.mapEnd.z,c.action==="end"?{recordUndo:n}:void 0),c}),i.next(()=>{this._updateValue(n)})})}_updateManipulatorPosition(){const{targetGeometry:e}=this.analysisViewData,{renderCoordsHelper:t}=this.view;if(!e)return;const i=.5,s=e.rings[0],r=Ie(s[0]),l=Ie(s[1]);t.toRenderCoords(r,e.spatialReference,r),t.toRenderCoords(l,e.spatialReference,l);const n=ue.get();Z(n,l,r);const c=ue.get();xi(c,r,l,i);const h=t.worldBasisAtPosition(c,1,ue.get()),p=t.worldBasisAtPosition(c,0,ue.get()),o=Si(h,p,c,Fi.get()),d=t.headingAtPosition(c,n),m=e.isClockwise(e.rings[0])?-Math.PI/2:Math.PI/2;Pi(o,o,$i(d)+m),o[12]=0,o[13]=0,o[14]=0,this._shiftManipulator.renderLocation=Be(c),this._shiftManipulator.modelTransform=o}_updateManipulatorVisibility(){const{interactive:e,targetGeometry:t}=this.analysisViewData,{measureType:i}=this.analysis,s=e&&t!=null&&i==="cut-fill";this._shiftManipulator.available=s}_updateValue(e,t){const i=Ze(e,this.view.spatialReference);if(i==null)return;const s=this.analysis.inputUnits.elevation??"meters",r=Ve(i.value,i.unit,s),l=n=>{this.analysis.cutFillOptions.targetElevation=n};if(l(r),t&&"recordUndo"in t){const n=t.recordUndo;this.emit("record-undo",{apply:()=>l(r),undo:()=>l(n)})}}_getUpdatedTooltipInfo(){const{effectiveTargetElevation:e}=this.analysisViewData;return e?(this._tooltipInfo.elevation.actual=Ze(e,this.view.spatialReference),this._tooltipInfo):this._tooltipInfo}_updateTooltip(){this._shouldShowTooltip&&(this.tooltip.info=this._getUpdatedTooltipInfo())}_showTooltip(){this._updateTooltip()}_hideTooltip(){var e;(e=this.tooltip)==null||e.clear()}_updateSketchOptions(){const{analysis:e}=this,{displayUnits:t,inputUnits:i}=e;this.sketchOptions.values.inputUnits=new Je({verticalLength:i.elevation}),this.sketchOptions.values.displayUnits=new Je({verticalLength:t.elevation})}};a([u({constructOnly:!0})],k.prototype,"analysis",void 0),a([u({constructOnly:!0})],k.prototype,"view",void 0),a([u({constructOnly:!0})],k.prototype,"analysisViewData",void 0),a([u({constructOnly:!0,type:Ot})],k.prototype,"sketchOptions",void 0),a([u()],k.prototype,"_shouldShowTooltip",null),k=a([O("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementShiftTool")],k);let G=class extends Y{constructor(e){super(e),this._updatingHandles=new Pt,this._operationManager=new Zi,this._onUndoRedo=()=>{this._updateGeometryFromSketchGraphic()}}initialize(){const{analysis:e,analysisViewData:t,view:i}=this;this._graphicsLayer=new Ti({listMode:"hide",internal:!0,elevationInfo:{mode:"on-the-ground"}});const s=Ki(i,{selfEnabled:!0,excludeInternal:!0});this._sketchViewModel=new Yi({layer:this._graphicsLayer,view:i,updateOnGraphicClick:!1,defaultUpdateOptions:{reshapeOptions:{shapeOperation:"none"},enableRotation:!1,enableScaling:!1,enableMoveAllGraphics:!1,enableZ:!1,multipleSelectionEnabled:!1,toggleToolOnClick:!1,tool:"reshape"},polygonSymbol:this._polygonSymbol,snappingOptions:s.options}),this.addHandles([this._sketchViewModel.on(["undo","redo"],this._onUndoRedo),w(()=>({map:i.map,internalGraphicsLayer:this._graphicsLayer,state:this.state}),({map:r,internalGraphicsLayer:l,state:n})=>{switch(Ps(r,l),n){case"idle":case"reshaping-disabled":this._operationManager.stop(),this._graphicsLayer.removeAll(),this._ensureUpdatedSketchGraphic();break;case"reshaping":We(this._startReshape());break;case"awaiting-sketch":this.analysisViewData.interactive=!0}},W),s]),this._shiftTool=new k({analysis:e,view:i,analysisViewData:t}),this.addHandles(this._shiftTool.on("record-undo",r=>{const l=this._sketchViewModel.activeComponent;(l==null?void 0:l.type)==="reshape-3d"&&l.recordUndo(r.apply,r.undo)})),i.tools.add(this._shiftTool),this.addHandles({remove:()=>i.tools.remove(this._shiftTool)})}destroy(){this._operationManager.destroy(),this._sketchViewModel.destroy();const e=this._graphicsLayer;this.view.map.remove(e),e.destroy()}get sketchGraphic(){return this._get("sketchGraphic")}set sketchGraphic(e){e!==this._get("sketchGraphic")&&(this._set("sketchGraphic",e),this._updateGeometryFromSketchGraphic())}get state(){const{geometry:e}=this.analysis,{interactive:t,visible:i}=this.analysisViewData;return i?this._sketchViewModel.createGraphic?this._sketchViewModel.createGraphic===this.sketchGraphic?"sketching":"awaiting-sketch":e?t?"reshaping":"reshaping-disabled":"idle":"idle"}get updating(){return this._sketchViewModel.updating||this._updatingHandles.updating}get _polygonSymbol(){return new Ri({color:[0,0,0,0],outline:{color:[0,0,0,0]}})}place(e){return this._operationManager.start("place",async t=>{const i=this.analysis.clone();this._ensureUpdatedSketchGraphic();const s=this._sketchViewModel.on("create",r=>{switch(r.state){case"start":this._graphicsLayer.removeAll(),this.sketchGraphic=r.graphic;break;case"active":this._updateGeometryFromSketchGraphic();break;case"complete":this._updateGeometryFromSketchGraphic(),t.stop();break;case"cancel":t.stop()}});t.handles.push(s,Ne(()=>(s.remove(),this._sketchViewModel.cancel(),this._updateGeometryFromSketchGraphic(),this.analysis.valid?Gi(e)||i.equals(this.analysis)?t.reject():void t.resolve({}):(this._clearGeometry(),t.reject())))),await this._updatingHandles.addPromise(this._sketchViewModel.create("polygon"))},e)}_startReshape(){return this._operationManager.start("reshape",async e=>{const t=()=>{const s=this._ensureUpdatedSketchGraphic();return s?(this._graphicsLayer.removeAll(),this._graphicsLayer.add(s),this._updatingHandles.addPromise(this._sketchViewModel.update(s,{tool:"reshape"}))):Promise.resolve()};if(!this._ensureUpdatedSketchGraphic())return;const i=this._sketchViewModel.on("update",s=>{this._updateGeometryFromSketchGraphic(),s.state==="complete"&&(this.state==="reshaping"?We(t()):e.resolve())});e.handles.push(i,Ne(()=>{i.remove(),this._sketchViewModel.cancel(),e.resolve()})),await t()})}_ensureUpdatedSketchGraphic(){const{geometry:e}=this.analysis;return At(e)?(this.sketchGraphic??(this.sketchGraphic=new Mi({geometry:e,symbol:this._polygonSymbol})),this.sketchGraphic.geometry=e,this.sketchGraphic):(this.sketchGraphic=null,null)}_clearGeometry(){this.sketchGraphic=null,this.analysis.geometry=null}_updateGeometryFromSketchGraphic(){const e=this.sketchGraphic;this.analysis.geometry=Fs(e)?e.geometry:null}get test(){}};function Ps(e,t){t&&(t.removeFromParent(),e==null||e.add(t))}a([u({constructOnly:!0})],G.prototype,"analysisViewData",void 0),a([u({constructOnly:!0})],G.prototype,"view",void 0),a([u({constructOnly:!0})],G.prototype,"analysis",void 0),a([u()],G.prototype,"sketchGraphic",null),a([u({nonNullable:!0})],G.prototype,"state",null),a([u()],G.prototype,"updating",null),a([u()],G.prototype,"_polygonSymbol",null),G=a([O("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementTool")],G);let F=class extends Li{constructor(e){super(e),this.type="volume-measurement-view-3d",this.analysis=null,this.elevationAlignedGeometry=null,this.targetGeometry=null}initialize(){const{analysis:e,view:t}=this;this._analysisController=new g({view:t,analysis:e,analysisViewData:this}),this._analysisTool=new G({analysis:e,view:t,analysisViewData:this}),this._analysisVisualization=new P({view:t,analysis:e,analysisViewData:this})}destroy(){this._analysisController=$(this._analysisController),this._analysisVisualization=$(this._analysisVisualization),this._analysisTool.destroy()}get error(){var e;return((e=this._analysisController)==null?void 0:e.error)??null}get result(){var e;return(e=this._analysisController)==null?void 0:e.result}get interactive(){return super.interactive}set interactive(e){super.interactive=e}get visible(){return super.visible}set visible(e){super.visible=e}get effectiveTargetElevation(){var n;const{cutFillOptions:e,inputUnits:t}=this.analysis,{targetElevation:i}=e,s=(t==null?void 0:t.elevation)??"meters",r=Ce(this.view.spatialReference);if(i!=null&&r!=null)return Ve(i,s,r);const l=(n=this.elevationAlignedGeometry)==null?void 0:n.extent;return(l==null?void 0:l.zmin)==null||(l==null?void 0:l.zmax)==null?null:(l.zmax+l.zmin)/2}get effectiveDisplayUnits(){const{displayUnits:e}=this.analysis,t=Oi(this.view);return{elevation:e.elevation??t,volume:e.volume??t}}get labelAnchors(){const{elevationAlignedGeometry:e,view:t}=this,{renderCoordsHelper:i}=t;if(!e)return{cut:null,fill:null};let s=e.rings[0][0],r=e.rings[0][0];e.rings[0].forEach(o=>{o[2]>s[2]&&(s=o),o[2]<r[2]&&(r=o)});const{spatialReference:l}=e,n=new Xe({x:s[0],y:s[1],z:s[2],spatialReference:l}),c=new Xe({x:r[0],y:r[1],z:r[2],spatialReference:l}),h=y(),p=y();return i.toRenderCoords(n,h),i.toRenderCoords(c,p),{cut:h,fill:p}}get updating(){return this._analysisController!=null&&this._analysisController.updating||this._analysisTool.updating||this._analysisVisualization.updating}place(e){return this._analysisTool.place(e)}get test(){}};a([u()],F.prototype,"error",null),a([u({readOnly:!0})],F.prototype,"type",void 0),a([u({constructOnly:!0,nonNullable:!0})],F.prototype,"analysis",void 0),a([u({readOnly:!0})],F.prototype,"result",null),a([u()],F.prototype,"elevationAlignedGeometry",void 0),a([u({type:Number})],F.prototype,"effectiveTargetElevation",null),a([u()],F.prototype,"targetGeometry",void 0),a([u()],F.prototype,"effectiveDisplayUnits",null),a([u()],F.prototype,"labelAnchors",null),a([u()],F.prototype,"updating",null),F=a([O("esri.views.3d.analysis.VolumeMeasurementAnalysisView3D")],F);const Zr=F,$s=Object.freeze(Object.defineProperty({__proto__:null,CutFillDepthParameters:Te,build:Dt},Symbol.toStringTag,{value:"Module"})),Ts=Object.freeze(Object.defineProperty({__proto__:null,CutFillReductionParameters:Re,build:St},Symbol.toStringTag,{value:"Module"})),Rs=Object.freeze(Object.defineProperty({__proto__:null,CutFillTargetDepthParameters:Ge,build:Et},Symbol.toStringTag,{value:"Module"})),Gs=Object.freeze(Object.defineProperty({__proto__:null,CutFillCompositionPassParameters:Me,build:jt},Symbol.toStringTag,{value:"Module"})),Ms=Object.freeze(Object.defineProperty({__proto__:null,CutFillMaskDrawParameters:Oe,build:kt},Symbol.toStringTag,{value:"Module"}));export{Zr as default};
