import{b6 as S}from"./iframe-DpfJK_wQ.js";import{co as b,pt as w}from"./ShadowCastClear.glsl.js";import"./index.js";import"./Viewport.js";import"./debounce.js";import"./index2.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";function R(){return T??(T=(async()=>{const t=await S(()=>import("./basis_encoder.js"),[],import.meta.url),e=await t.default({locateFile:r=>b(`esri/libs/basisu/${r}`)});return e.initializeBasis(),e})()),T}let T;function X(){T=null}function M(){return y??(y=(async()=>await(await S(()=>import("./dxt_encoder.js"),[],import.meta.url)).default({locateFile:e=>b(`esri/libs/dxtEncoder/${e}`)}))()),y}let y;function x(){y=null}let A,_,c=null,u=null;class h{constructor(e,r){this.internalFormat=e,this.compressedTexture=r}}function lt(){c=null,A=null,u=null,_=null,X(),x()}async function st(t){var r;let e;e=t.data instanceof ImageBitmap?I(t.data):O(t.data,t.width,t.height,t.components,t.needsFlip);try{if(t.hasS3TC){u||await D();const s=new Uint8Array(e.length);if(u!=null&&u.encode(e,t.width,t.height,t.preMultiplyAlpha,s)){const n=W(s,!0),i=[s.buffer];return{result:new h((n==null?void 0:n.internalFormat)??null,(n==null?void 0:n.textureData)??null),transferList:i}}return{result:new h(null,null)}}if(t.hasETC){if(c||await B(),t.preMultiplyAlpha&&!u&&await D(),t.preMultiplyAlpha){const a=new Uint8ClampedArray(e.length);u==null||u.premultiply(new Uint8Array(e),t.width,t.height,a),e=a}const s=F(e,t.width,t.height,t.hasMipmap),n=s?U(s):null,i=((r=n==null?void 0:n.compressedTexture)==null?void 0:r.levels.map(a=>a.buffer))||[];return{result:new h((n==null?void 0:n.internalFormat)??null,(n==null?void 0:n.compressedTexture)??null),transferList:i}}return{result:new h(null,null)}}finally{e instanceof ImageBitmap&&e.close()}}async function B(){c||(c=await(A??(A=R())),A=null)}async function D(){u||(u=await(_??(_=M())),_=null)}function F(t,e,r,s,n=255,i=0,a=!1,o=!1){if(!c)return null;const l=new c.BasisEncoder;l.setPerceptual(!o),l.setCheckForAlpha(!0),l.setForceAlpha(!1),l.setRenormalize(o),l.setMipGen(s),l.setMipSRGB(!o),l.setCreateKTX2File(!0),l.setKTX2SRGBTransferFunc(!o),l.setQualityLevel(n),l.setCompressionLevel(i);const p=new Uint8Array(t.byteLength);l.setSliceSourceImage(0,new Uint8Array(t),e,r,a);const f=l.encode(p),m=new Uint8Array(p.buffer,0,f),d=new c.KTX2File(new Uint8Array(m));return d.isValid()?(l.delete(),m):(d.close(),d.delete(),l.delete(),null)}function U(t){if(!c)return new h(null,null);const e=new c.KTX2File(new Uint8Array(t));e.startTranscoding();const[r,s]=e.getHasAlpha()?[1,w.COMPRESSED_RGBA8_ETC2_EAC]:[0,w.COMPRESSED_RGB8_ETC2],n=e.getLevels(),i=[];for(let a=0;a<n;a++)i.push(new Uint8Array(e.getImageTranscodedSizeInBytes(a,0,0,r))),e.transcodeImage(i[a],a,0,0,r,0,-1,-1);return e.close(),e.delete(),{internalFormat:s,compressedTexture:{type:"compressed",levels:i}}}function I(t){const e=new OffscreenCanvas(t.width,t.height),r=e.getContext("2d");return r.drawImage(t,0,0),r.getImageData(0,0,e.width,e.height).data}function O(t,e,r,s,n){const i=new Uint8ClampedArray(t).subarray(0,e*r*s);if(!n)return i;const a=new Uint8ClampedArray(i.length),o=e*s;for(let l=0;l<r;l++){const p=l*o,f=(r-l-1)*o;a.set(i.subarray(p,p+o),f)}return a}const v=31,G=1,P=2,L=3,K=4,k=7,z=21,$=131072;function C(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}const V=C("DXT1"),H=C("DXT3"),Q=C("DXT5");function W(t,e){const r=new Int32Array(t.buffer,t.byteOffset,v);let s,n;switch(r[z]){case V:s=8,n=w.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case H:s=16,n=w.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Q:s=16,n=w.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return null}let i=1,a=r[K],o=r[L];(3&a||3&o)&&(a=a+3&-4,o=o+3&-4);const l=a,p=o;let f,m;r[P]&$&&e!==!1&&(i=Math.max(1,r[k]));let d=t.byteOffset+r[G]+4;const E=[];for(let g=0;g<i;++g)m=(a+3>>2)*(o+3>>2)*s,f=new Uint8Array(t.buffer,d,m),E.push(f),d+=m,a=Math.max(1,a>>1),o=Math.max(1,o>>1);return{textureData:{type:"compressed",levels:E},internalFormat:n,width:l,height:p}}export{h as TextureCompressionWorkerOutput,st as compress,F as compressRGBADataToKTX2,U as createTextureDataKTX2,lt as destroy,B as initializeBasisEncoder,D as initializeDXTEncoder};
