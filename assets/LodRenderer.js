import{nc as Q,sP as X,sQ as N,sR as K,hn as W,sS as ee,sT as te,sU as se,sV as ne,ls as ae,ix as k,sW as ie,bx as Y,eo as j,ar as Z,fT as re,fU as A,sX as oe,bJ as E,sY as le,sZ as ce,qf as he,s_ as de,f$ as ue,s$ as _e,br as x,t0 as me,oL as ge,oe as O,qk as fe,fc as w,bl as pe,t1 as L,go as V,b as B,cd as ye,t2 as be,t3 as ve,t4 as D,t5 as Ie,t6 as R,fd as P,t7 as Ce,t8 as Se,E as p,F as y,V as De}from"./ShadowCastClear.glsl.js";class Re extends Q{constructor(e,s){super(n=>X(this._instanceData.view.boundingSphere.getVec(n,Ee)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=s,this._tmpSphere=K(),this._tmpMat4=W()}addInstance(e){const s=this._instanceData.view.boundingSphere,n=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);ee(this._tmpSphere,this._boundingSphere.center,n),this._tmpSphere[3]=this._boundingSphere.radius*te(n),s.setVec(e,se(this._tmpSphere)),this.add([e])}removeInstance(e){this.remove([e])}}const Ee=N();class xe{constructor(e,s){this._worldSpaceRadius=e,this._minScreenSpaceRadii=s}selectLevel(e,s,n){const a=n.computeScreenPixelSizeAt(e),o=this._worldSpaceRadius*s/a;let i=0;for(let l=1;l<this._minScreenSpaceRadii.length;++l)o>=this._minScreenSpaceRadii[l]&&(i=l);return i}}class we{constructor(e,s){this.geometry=s;const n=e.renderContext.rctx,a=s.renderGeometry,{material:o,layout:i,buffer:l}=a;this._materials=e.materials,o.setParameters({instancedDoublePrecision:!0}),this.glMaterials=new ne(o,this._materials),this.vbo=new ae(n,k(i),l),this.vao=new ie(n,this.vbo)}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get material(){return this.geometry.renderGeometry.material}get layout(){return this.geometry.renderGeometry.layout}get boundingInfo(){return this.geometry.boundingInfo}get numTriangles(){return this.numVertices/3}get numVertices(){return this.geometry.renderGeometry.numVertices}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,s,n,a,o,i,l,r){return this.geometry.intersect(e,s,n,a,o,i,l,r)}}class T{static async create(e,s,n){const a=await Promise.allSettled(s.components.map(i=>e.controller.schedule(()=>new we(e,i.geometry),n))),o=a.map(i=>i.status==="fulfilled"?i.value:null).filter(Y);if(j(n)||o.length!==a.length){o.forEach(i=>i.destroy()),Z(n);for(const i of a)if(i.status==="rejected")throw i.reason}return new T(s.minScreenSpaceRadius,o)}constructor(e,s){this.minScreenSpaceRadius=e,this.components=s}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,s,n,a,o,i,l){this.components.forEach(r=>r.intersect(e,s,n,a,o,i,this.boundingSphere,l))}get boundingBox(){if(this._boundingBox==null){const e=re();this.components.forEach(s=>{s.boundingInfo!=null&&(A(e,s.boundingInfo.bbMin),A(e,s.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){const e=this.boundingBox,s=E();oe(e,s),this._boundingSphere={center:s,radius:.5*le(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,s)=>e+s.numTriangles,0)}}const Le=t=>{const e=t.baseBoundingSphere.radius,s=t.levels.map(n=>n.minScreenSpaceRadius);return new xe(e,s)};let g=class extends ce{constructor(t,e){super(t),this.type=3,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDatas=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new he,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[2,s=>this._produces(s)],[4,s=>!!this._hasTransparentLevels()&&this._produces(s)]]),this._instanceData=new de({shaderTransformation:t.shaderTransformation},t.symbol.materialParameters),this.addHandles(e.registerTask(ue.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=_e(this.symbol.materialParameters),this._glInstanceBufferLayout=k(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:t})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)}),this._instanceData.events.on("instance-visibility-changed",({index:t})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDatas.values()]}get _allRenderInstanceDataExceptHighlightShadow(){const t=[this._defaultRenderInstanceData];for(const e of this._highlightRenderInstanceDatas)e[0]!==x&&t.push(e[1]);return t}hasHighlight(t){return this._highlightRenderInstanceDatas.has(t)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmitters(){return this._levels.some(t=>t.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((t,e)=>e.reduce((s,n)=>s+n.usedMemory,t),this._levels.reduce((t,e)=>t+e.components.reduce((s,n)=>s+n.usedMemory,0),0))}get renderStats(){const t=this._instanceData.size,e=[];return this._levels.forEach((s,n)=>{const a=this._allRenderInstanceData[0][n].size+this._allRenderInstanceData[1][n].size,o=s.triangleCount;e.push({renderedInstances:a,renderedTriangles:a*o,trianglesPerInstance:o})}),{totalInstances:t,renderedInstances:e.reduce((s,n)=>s+n.renderedInstances,0),renderedTriangles:e.reduce((s,n)=>s+n.renderedTriangles,0),levels:e}}_createRenderInstanceDataArray(){const{rctx:t}=this._context.renderContext;return this.symbol.levels.map(e=>new me(t,this._instanceBufferLayout))}async initializeRenderContext(t,e){this._context=t,this._defaultRenderInstanceData=this._createRenderInstanceDataArray();const s=await Promise.allSettled(this.symbol.levels.map(a=>T.create(t,a,e))),n=s.map(a=>a.status==="fulfilled"?a.value:null).filter(Y);if(j(e)||n.length!==s.length){n.forEach(a=>a.destroy()),Z(e);for(const a of s)if(a.status==="rejected")throw a.reason}this._levels=n,this._levelSelector=Le(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(t=>t.destroy()),this._defaultRenderInstanceData.forEach(t=>t.destroy()),this._highlightRenderInstanceDatas.forEach(t=>t.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(t=>t.components.some(e=>{const s=e.material.produces.get(4);return s==null?void 0:s(0)}))}hasHighlights(){return ge(this._highlightRenderInstanceDatas,t=>t.some(e=>e.size>0))}_produces(t){return(t!==9||this.hasHighlights())&&(t!==5||this.hasHighlight(x))}prepareRender(t){if(!O.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const e=t.bind.contentCamera.equals(this._camera);this._camera.copyFrom(t.bind.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(fe),this._needFullCycle=!1)}}acquireTechniques(t){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(t.output))return null;const e=this._getInstanceDatas(t);if(!e)return null;const s=new Array,n=this.levels;return e.forEach(a=>n.forEach(({components:o},i)=>o.forEach(l=>s.push(this._beginComponent(t,a[i],l))))),s}render(t,e){const s=this._getInstanceDatas(t);if(!s||e==null)return;let n=0;const a=this.levels;s.forEach(o=>a.forEach(({components:i},l)=>i.forEach(r=>this._renderComponent(t,e[n++],o[l],r,l)))),t.rctx.unbindBuffer(34962),t.rctx.bindVAO(null)}_getInstanceDatas(t){var l;const{output:e,bind:s}=t,n=e===9,a=e===5,o=e!==6;if(!n&&!a)return o?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;const{_highlightRenderInstanceDatas:i}=this;if(o){if(n){const _=(l=s.highlight)==null?void 0:l.name;if(!_)return null;const h=i.get(_);return h?[h]:null}const r=i.get(x);return a?r?[r]:null:Array.from(i.values())}return null}intersect(t,e,s,n){if(!this.baseMaterial.visible||this._octree==null)return;const a=E();w(a,n,s);const o=i=>{this._instanceData.getCombinedModelTransform(i,q),t.transform.set(q),P(H,s,t.transform.inverse),P(z,n,t.transform.inverse);const l=this._instanceData.getState(i),r=this._instanceData.getLodLevel(i),_=this._levels.length;4&l&&(R(!!(18&l),"invalid instance state"),R(r>=0&&r<_,"invaid lod level"),this._levels[r].intersect(t,e,H,z,i,this.metadata,_))};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(o):this._octree.forEachAlongRay(s,a,o)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){var t;if(this._octreeCached==null){const e=this._instanceData,s=(t=e.view)==null?void 0:t.state;if(!s)return null;this._octreeCached=new Re(e,this.baseBoundingSphere);for(let n=0;n<e.capacity;++n)18&s.get(n)&&this._octreeCached.addInstance(n)}return this._octreeCached}_invalidateOctree(){this._octreeCached=pe(this._octreeCached)}queryDepthRange(t){if(this._octree==null)return new L;const e=t.viewForward,s=this._octree.findClosest(e,1,t.frustum),n=this._octree.findClosest(e,-1,t.frustum);if(s==null||n==null)return new L;const a=t.eye,o=this._instanceData.view;o.boundingSphere.getVec(s,f),w(f,f,a);const i=V(f,e)-f[3];o.boundingSphere.getVec(n,f),w(f,f,a);const l=V(f,e)+f[3];return new L(i,l)}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,t&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(t=>t.forEach(e=>e.startUpdateCycle()))}get readyToRun(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(t){const{_enableLevelSelection:e,_camera:s,_levelSelector:n}=this;this._allRenderInstanceData.forEach(u=>u.forEach(c=>c.beginUpdate()));const a=this._instanceData,o=a.view;let i=a.size;const l=a.capacity;let r=this._instanceIndex;const _=Math.ceil(l/500),{_highlightRenderInstanceDatas:h}=this;for(let u=0;u<i&&!t.done;++u){r===this._cycleStartIndex&&this._startUpdateCycle();const c=o.state.get(r);let d=0;if(!(1&c)){r=r+1===l?0:r+1,i++;continue}const I=o.lodLevel.get(r);if(2&c&&this._defaultRenderInstanceData[I].freeTail(),16&c){const m=a.geHighlightOptionsPrev(r);if(m){const b=h.get(m);if(!b)throw new B("internal:lod-renderer","Internal error in lodRenderer");b[I].freeTail(),b.every(S=>S.isEmpty)&&(b.forEach(S=>S.destroy()),h.delete(m))}}if(32&c)a.freeInstance(r);else if(4&c){let m=0;if(e&&(o.modelOrigin.getVec(r,F),m=n.selectLevel(F,a.getCombinedMedianScaleFactor(r),s)),d=-83&c,m>=0)if(8&c){const b=a.getHighlightName(r);if(b){const S=()=>{const M=this._createRenderInstanceDataArray();return M.forEach(J=>J.beginUpdate()),M},$=ye(h,b,S);if(m>=$.length)throw new B("internal:lod-renderer",`LodRenderer internal error - missing lodLevel ${m}`);U($[m],o,r)}d|=16}else U(this._defaultRenderInstanceData[m],o,r),d|=2;o.state.set(r,d),o.lodLevel.set(r,m)}else d=-83&c,o.state.set(r,d);const v=!!(18&c),C=!!(18&d);this._octreeCached!=null&&(!v&&C?this._octreeCached.addInstance(r):v&&!C?this._octreeCached.removeInstance(r):v&&C&&64&c&&(this._octreeCached.removeInstance(r),this._octreeCached.addInstance(r))),r=r+1===l?0:r+1,r%_===0&&t.madeProgress(),v!==C&&this.metadata.notifyGraphicVisibilityChanged(r),C&&64&c&&this.metadata.notifyGraphicGeometryChanged(r)}this._instanceIndex=r,this._allRenderInstanceData.forEach(u=>u.forEach(c=>c.endUpdate())),this._context.requestRender()}_beginComponent(t,e,s){if(e.size===0)return null;const n=s.glMaterials.load(t.rctx,t.bind.slot,t.output);return n==null?void 0:n.beginSlot(t.bind)}_renderComponent(t,e,s,n,a){if(!e)return;const{bind:o,rctx:i}=t;i.runAppleAmdDriverHelper();const l=i.bindTechnique(e,o,n.material.parameters,$e),r=this._glInstanceBufferLayout;l.assertCompatibleVertexAttributeLocations(n.vao,ve(r)),i.bindVAO(n.vao),O.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===0&&(l.setUniform4fv("externalColor",G[Math.min(a,G.length-1)]),l.setUniform1i("symbolColorMixMode",Ie.replace));const _=s.capacity,h=s.headIndex,u=s.tailIndex,c=s.firstIndex,d=(I,v)=>{Ce(i,l.locations,s.buffer,I),i.drawArraysInstanced(e.primitiveType,0,n.numVertices,v-I)};n.material.transparent&&c!=null?h>u?(R(c>=u&&c<=h,"invalid firstIndex"),d(c,h),d(u,c)):h<u&&(c<=h?(R(c>=0&&c<=h,"invalid firstIndex"),d(c,h),d(u,_),d(0,c)):(R(c>=u&&c<=_,"invalid firstIndex"),d(c,_),d(0,h),d(u,c))):h>u?d(u,h):h<u&&(d(0,h),d(u,_))}};function U(t,e,s){const n=t.allocateHead();Te(e,s,t.view,n)}function Te(t,e,s,n){Se(t.modelOrigin,e,s.modelOriginHi,s.modelOriginLo,n),s.model.copyFrom(n,t.model,e),s.modelNormal.copyFrom(n,t.modelNormal,e),t.color&&s.color&&s.color.copyFrom(n,t.color,e),t.olidColor&&s.olidColor&&s.olidColor.copyFrom(n,t.olidColor,e),t.featureAttribute&&s.featureAttribute&&s.featureAttribute.copyFrom(n,t.featureAttribute,e)}p([y({constructOnly:!0})],g.prototype,"symbol",void 0),p([y({constructOnly:!0})],g.prototype,"metadata",void 0),p([y({constructOnly:!0})],g.prototype,"shaderTransformation",void 0),p([y()],g.prototype,"_instanceData",void 0),p([y()],g.prototype,"_cycleStartIndex",void 0),p([y({readOnly:!0})],g.prototype,"_enableLevelSelection",null),p([y()],g.prototype,"_updateCyclesWithStaticCamera",void 0),p([y({readOnly:!0})],g.prototype,"readyToRun",null),g=p([De("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],g);const F=E(),f=N(),q=W(),H=E(),z=E(),G=[D(1,0,1,1),D(0,0,1,1),D(0,1,0,1),D(1,1,0,1),D(1,0,0,1)],$e=new be;export{g as F};
