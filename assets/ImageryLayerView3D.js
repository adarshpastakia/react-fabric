import{e$ as x,er as D,E as o,V as m,bn as H,ed as _,bj as g,bo as S,b5 as v,F as w}from"./ShadowCastClear.glsl.js";import{A as b,m as E}from"./DynamicLayerView3D.js";import{w as V}from"./ImageHighlightHelper3D.js";import{x as I}from"./dataUtils.js";import{r as $}from"./FlowSubView3D.js";import{y as P}from"./ImageryLayerView.js";import"./iframe-qDaPDssc.js";import"./index.js";import"./Viewport.js";import"./debounce.js";import"./index2.js";import"./Section.js";import"./ErrorBoundary.js";import"./createClass.js";import"./Global.js";import"./useIsDark.js";import"./SubView3D.js";import"./ImageMaterial.glsl.js";import"./TriangleMaterial.js";import"./DefaultLayouts.js";import"./LayerView3D.js";import"./LayerView.js";import"./RefreshableLayerView.js";import"./highlightUtils2.js";import"./utils6.js";import"./loadUtils2.js";import"./FeatureTileDescriptor.js";import"./line.js";import"./rasterFieldUtils.js";import"./timeSupport.js";import"./rasterProjectionHelper.js";import"./popupUtils.js";let h=class extends b{constructor(e){super(e),this.redrawDebounced=x(async t=>{this.redraw((i,r)=>this._redrawImage(i,r),t)},2e3)}initialize(){this.addHandles([D(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this.updatingHandles.addPromise(this.redrawDebounced()))])}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}async processResult(e,t,i){t.imageOrCanvasElement?e.image=t.imageOrCanvasElement:(e.image=document.createElement("canvas"),e.pixelData=t.pixelData,await this._redrawImage(e,i))}async _redrawImage(e,t){if(!(e.image instanceof HTMLCanvasElement)||e.pixelData==null)throw new Error;const i=e.image,r=i.getContext("2d"),s=await this.layer.applyRenderer(e.pixelData,{signal:t}),a=this.layer.applyFilter(s).pixelBlock;if(a==null)throw new Error;i.width=a.width,i.height=a.height;const l=r.createImageData(a.width,a.height);l.data.set(a.getAsRGBA()),r.putImageData(l,0,0)}};h=o([m("esri.views.3d.layers.ImagerySubView3D")],h);let p=class extends ${constructor(e){super(e)}initialize(){this.updatingHandles.add(()=>this.renderedTiles,()=>this.triggerLoad()),this.updatingHandles.add(()=>this.elevationInfo.mode,e=>this._updatePopupDrapeSource(e),{initial:!0})}_updatePopupDrapeSource(e){if(e==="on-the-ground")return void this.removeHandles(d);if(this.hasHandles(d))return;const t={destroyed:!1,drapeSourceType:2,updatePolicy:0,layer:this.layer},i=this.layerView.view.overlayManager;i.registerGeometryDrapeSource(t),this.addHandles(H(()=>i.unregisterDrapeSource(t)),d)}async fetchDataAndGenerateStreamlines(e,t){const{needsMagnitude:i,workerHandle:r}=this,s=this.getSimulationSettings(e),{size:a,extent:l,timeExtent:c}=e;if(s==null||r==null)return;const u=await I(this.layer,l,a[0],a[1],c,t);if(u==null)return null;const y={simulationSettings:s,flowExtentInfo:e.flowExtentInfo,flowData:u,needsMagnitude:i,startPositions:this.startPositions(e)},{streamlines:f}=await r.generateStreamlines(y,t);return f}};p=o([m("esri.views.3d.support.flow.FlowSubViewExtent3D")],p);const d=Symbol("popupDrapeSource");let n=class extends P(E){constructor(){super(...arguments),this.type="imagery-3d"}get highlightOptions(){return null}get pixelData(){return null}initialize(){const e=()=>this._updatingHandles.addPromise(this.refreshDebounced());this._updatingHandles.add(()=>{var t,i;return(i=(t=this.layer)==null?void 0:t.exportImageServiceParameters)==null?void 0:i.version},e),this._updatingHandles.add(()=>{var t;return(t=this.layer)==null?void 0:t.renderer},e),this._updatingHandles.add(()=>this.timeExtent,e),this._highlightHelper=new V({view:this.view,layer:this.layer,updatingHandles:this._updatingHandles}),this.addHandles([_(this._highlightHelper),g(()=>this.suspended,t=>this._highlightHelper.suspended=t,S)])}_initSubView(){this.addHandles([g(()=>this.layer.renderer,e=>this._recreateSubView(e),v)])}_recreateSubView(e){var s;const t=(e==null?void 0:e.type)==="flow",i=((s=this.subView)==null?void 0:s.type)==="flow",r=this.subView;r&&t===i||(this.subView=t?new p({layerView:this}):new h({layerView:this}),r==null||r.destroy())}getFetchOptions(){return{timeExtent:this.timeExtent}}highlight(e,t){return this._highlightHelper.highlight(e,t)}isUpdating(){return super.isUpdating()||this._highlightHelper.updating}};o([w()],n.prototype,"highlightOptions",null),o([w()],n.prototype,"pixelData",null),n=o([m("esri.views.3d.layers.ImageryLayerView3D")],n);const de=n;export{de as default};
