import{lP as T,E as a,F as u,lQ as D,g0 as $,V as S,bj as U,ew as m,bo as V,lR as N,bz as R,eK as Q,lS as j,lT as W,lU as G,l as c,lV as A,fn as q,eM as F,lW as H,lX as _,lY as z,lZ as C,l_ as B,l$ as M,m0 as p,m1 as X,m2 as Y,m3 as y,eL as Z,ar as O}from"./ShadowCastClear.glsl.js";import{e as J}from"./FeatureIdInfo.js";import{E as K}from"./constants2.js";import{n as ee,s as te}from"./featurePopupQueryUtils.js";import{o as L}from"./floorFilterUtils.js";import{e as ie}from"./featureServiceUtils.js";import{n as re,p as se}from"./popupUtils.js";class le{constructor(i){this._fieldsIndex=i,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some(i=>i.currentUserRequired)}}visitClientWhereClause(i){i&&this._clauses.push(T(i,this._fieldsIndex))}visitFeatureReduction(i){if(i)switch(i.type){case"binning":case"cluster":this.visitLabelingInfo(i.labelsVisible,i.labelingInfo)}}visitLabelingInfo(i,l){if(i&&l!=null)for(const t of l)this.visitClientWhereClause(t.where)}visitDisplayFilter(i,l){if(i)for(const t of(l==null?void 0:l.filters)??[])this.visitClientWhereClause(t.where)}visitFilter(i){this.visitClientWhereClause(i==null?void 0:i.where)}visitTrackInfo(i){i!=null&&(this.visitLabelingInfo(i==null?void 0:i.latestObservations.labelsVisible,i==null?void 0:i.latestObservations.labelingInfo),this.visitLabelingInfo(i==null?void 0:i.previousObservations.labelsVisible,i==null?void 0:i.previousObservations.labelingInfo),this.visitLabelingInfo(i==null?void 0:i.trackLines.labelsVisible,i==null?void 0:i.trackLines.labelingInfo))}}const pe=g=>{const i=g;let l=class extends i{constructor(...t){super(...t),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([U(()=>{var s,n,f,d,r;const t=this.layer,e=this.view;return[t&&"elevationInfo"in t?(s=t.elevationInfo)==null?void 0:s.featureExpressionInfo:null,t&&"displayField"in t?t.displayField:null,t&&"timeInfo"in t&&t.timeInfo,t&&"renderer"in t&&t.renderer,t&&"labelingInfo"in t&&t.labelingInfo,t&&"floorInfo"in t&&t.floorInfo,((n=e==null?void 0:e.requiredFieldsOptions)==null?void 0:n.featureTitleFields)&&t&&"featureTitleFields"in t&&t.featureTitleFields,((f=e==null?void 0:e.requiredFieldsOptions)==null?void 0:f.utilityNetworkFields)&&N(e,t),t.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,(t==null?void 0:t.type)==="knowledge-graph-sublayer"&&t.parentCompositeLayer.type==="link-chart"&&((r=(d=t.parentCompositeLayer.linkChart)==null?void 0:d.linkChartProperties.nonspatialDataDisplay)==null?void 0:r.mode)]},()=>this._handleChange(),V),m(()=>{var t;return(t=this.view)==null?void 0:t.floors},"change",()=>this._handleChange()),m(()=>{var t;return(t=this.layer.displayFilterInfo)==null?void 0:t.filters},"change",()=>this._handleChange()),m(()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null,"change",()=>this._handleChange())])}get availableFields(){if(!this.layer)return[];const{layer:t,layer:{fieldsIndex:e},requiredFields:s}=this;return"outFields"in t&&t.outFields?R(e,[...Q(e,t.outFields),...s]):R(e,s)}get displayFilterEnabled(){var t,e;return(((t=this.view)==null?void 0:t.displayFilterEnabled)??!0)&&(!("displayFilterEnabled"in this.layer)||(((e=this.layer)==null?void 0:e.displayFilterEnabled)??!0))}get effectiveDisplayFilter(){const t=this.layer;return this.displayFilterEnabled&&t.displayFilterInfo?j(t.displayFilterInfo,this.view):null}get effectiveDisplayFilterClause(){var e;const t=((e=this.effectiveDisplayFilter)==null?void 0:e.where)??null;return t&&this.hasHighlight?W(t,G(this.layer.objectIdField,this.highlightIds)):t}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(t){this._override("featureEffect",t)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(t){c.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){var t;return(t=this.layer)!=null&&t.url?A(this.layer.url):Promise.resolve(null)}highlight(t,e){throw new Error("missing implementation")}createQuery(){var s;const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},e=this.filter!=null?this.filter.createQuery(t):new q(t);return"floorInfo"in this.layer&&this.layer.floorInfo&&(e.where=F(e.where,L(this))),this.displayFilterEnabled&&(e.where=F(e.where,(s=this.effectiveDisplayFilter)==null?void 0:s.where)),this.timeExtent!=null&&(e.timeExtent=e.timeExtent!=null?e.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),e}createAggregateQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new q(t)}queryFeatures(t,e){throw new Error("missing implementation")}queryObjectIds(t,e){throw new Error("missing implementation")}queryFeatureCount(t,e){throw new Error("missing implementation")}queryExtent(t,e){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(t,e){const s=[],n=new Set;for(const d of t){const r=H(d.origin),h=re(r,{...e,checkPopupEnabled:!0});h&&(s.push(d),n.add(h))}if(s.length===0||n.size===0)return[];const f=await this._createPopupQuery(n,e);return await ee(this.layer,s,f,{hasRequiredFields:(d,r)=>this._popupFeatureHasRequiredFields(d,r),...e})}_handleChange(){const t=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then(()=>{});return this._set("_updatingRequiredPromise",t),t.then(()=>{this._updatingRequiredPromise===t&&this._set("_updatingRequiredPromise",null)}),t}async _updateClientWhereClauseRequirements(){var s;if(!this.layer||!this.view)return;const{layer:t}=this,e=new le(t.fieldsIndex);if(e.visitFilter(this.filter),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction),"labelingInfo"in t&&e.visitLabelingInfo(t.labelsVisible,t.labelingInfo),"trackInfo"in t&&e.visitTrackInfo(t.trackInfo),this.view.type==="2d"&&(e.visitFilter((s=this.featureEffect)==null?void 0:s.filter),e.visitDisplayFilter(this.displayFilterEnabled,t.displayFilterInfo),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction)),t.type==="subtype-group")for(const n of t.sublayers)e.visitLabelingInfo(n.labelsVisible,n.labelingInfo);try{const n=await e.finish();this._set("requiresCurrentUser",n.requiresCurrentUser)}catch(n){c.getLogger(this).error(n)}}async _updateRequiredFields(){var I,b,v,w;if(!this.layer||!this.view)return;const t=this.view.type==="3d",{layer:e,layer:{fieldsIndex:s}}=this,n="renderer"in e&&e.renderer,f="orderBy"in e&&e.orderBy,d="featureReduction"in e?e.featureReduction:null,r=new Set,h=[n?n.collectRequiredFields(r,s):null,_(r,e),t&&"elevationInfo"in e?z(r,e):null,this.filter!=null?C(r,e,this.filter):null,t||this.featureEffect==null?null:C(r,e,this.featureEffect.filter),!t&&d?B(r,e,d):null,!t&&f?M(r,e,f):null];if("timeInfo"in e&&e.timeInfo&&this.timeExtent&&p(r,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),"timeInfo"in e&&e.timeInfo&&"trackInfo"in e&&e.trackInfo){const{trackInfo:o}=e;p(r,e.fieldsIndex,[e.timeInfo.trackIdField]),e.type!=="feature"&&o.timeField!=="startTimeField"||p(r,e.fieldsIndex,[e.timeInfo.startField]),o.timeField==="endTimeField"&&p(r,e.fieldsIndex,[e.timeInfo.endField]),await X(r,e)}if("floorInfo"in e&&e.floorInfo&&p(r,e.fieldsIndex,[e.floorInfo.floorField]),"featureTitleFields"in e&&((b=(I=this.view)==null?void 0:I.requiredFieldsOptions)!=null&&b.featureTitleFields)&&e.featureTitleFields&&p(r,e.fieldsIndex,e.featureTitleFields),e.type==="feature"&&e.globalIdField&&((w=(v=this.view)==null?void 0:v.requiredFieldsOptions)!=null&&w.globalIdField)&&p(r,e.fieldsIndex,[e.globalIdField]),this.displayFilterEnabled&&h.push(Y(r,e,e.displayFilterInfo)),e.type==="feature"&&t&&e.infoFor3D!=null&&(e.globalIdField==null&&c.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),p(r,e.fieldsIndex,[e.globalIdField])),e.type==="subtype-group"){y(r,s,e.subtypeField);const o=e.sublayers.map(E=>{var x;return Promise.all([(x=E.renderer)==null?void 0:x.collectRequiredFields(r,s),_(r,E)])});h.push(Promise.all(o))}if(e.type==="catalog-footprint"&&e.parent){const o=e.parent;p(r,s,[o.itemNameField,o.itemSourceField,o.itemTypeField,o.maxScaleField,o.minScaleField])}e.type==="knowledge-graph-sublayer"&&e.parentCompositeLayer.type==="link-chart"&&y(r,s,K);const k=await Promise.allSettled(h);if(t)y(r,s,e.objectIdField);else for(const o of J(ie(e)))y(r,s,o);t&&"displayField"in e&&e.displayField&&y(r,s,e.displayField);for(const o of k)o.status==="rejected"&&c.getLogger(this).error(o.reason);const P=Array.from(r).sort();this._set("requiredFields",P)}_popupFeatureHasRequiredFields(t,e){return Z(t,e)}async _createPopupQuery(t,e){const s=this.layer.createQuery(),n=new Set;let f=this.layer.geometryType==="point";for(const d of t){if(!f){const h=await te(d);O(e),f=(h&&h.arcadeUtils.hasGeometryOperations(d))??!1}const r=await se(this.layer,d);O(e);for(const h of r)n.add(h)}return s.returnGeometry=f,s.returnZ=f,s.returnM=f,s.outFields=Array.from(n),s.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(s.where=F(s.where,L(this))),s}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return a([u()],l.prototype,"_updatingRequiredPromise",void 0),a([u({readOnly:!0})],l.prototype,"availableFields",null),a([u({readOnly:!0})],l.prototype,"displayFilterEnabled",null),a([u({readOnly:!0})],l.prototype,"effectiveDisplayFilter",null),a([u({readOnly:!0})],l.prototype,"effectiveDisplayFilterClause",null),a([u({type:D})],l.prototype,"featureEffect",null),a([u({type:$})],l.prototype,"filter",void 0),a([u()],l.prototype,"layer",void 0),a([u({type:Number})],l.prototype,"maximumNumberOfFeatures",null),a([u({readOnly:!0,type:Boolean})],l.prototype,"maximumNumberOfFeaturesExceeded",null),a([u()],l.prototype,"requiresCurrentUser",void 0),a([u({readOnly:!0})],l.prototype,"requiredFields",void 0),a([u({readOnly:!0})],l.prototype,"signedInUser",null),a([u()],l.prototype,"suspended",void 0),a([u()],l.prototype,"view",void 0),l=a([S("esri.views.layers.FeatureLayerView")],l),l};export{pe as Q};
