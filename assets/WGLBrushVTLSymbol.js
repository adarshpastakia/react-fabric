import{vS as H,dv as K,mC as Z,vT as L,lu as N,ls as J,h as Q,vU as Y,lg as G,lr as b,dq as ee,dA as F,dp as te,vV as $}from"./ShadowCastClear.glsl.js";let z=class{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(i,t){}draw(i,t,e){}drawMany(i,t,e){for(const r of t)r.visible&&this.draw(i,r,e)}};class le extends z{constructor(){super(...arguments),this._color=H(1,0,0,1),this._patternMatrix=K(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao=Z(this._vao)}drawMany(i,t){const{context:e,painter:r,requestRender:l,allowDelayedRender:_}=i;this._loadWGLResources(i);const d=i.displayLevel,s=i.styleLayer,v=s.backgroundMaterial,c=r.vectorTilesMaterialManager,x=s.getPaintValue("background-color",d),p=s.getPaintValue("background-opacity",d),D=s.getPaintValue("background-pattern",d),y=D!==void 0,P=1|window.devicePixelRatio,M=i.spriteMosaic;let E,U;const u=P>Y?2:1,g=this._programOptions;g.pattern=y;const n=c.getMaterialProgram(e,v,g);if(!_||l==null||n.compiled){if(e.bindVAO(this._vao),e.useProgram(n),y){const a=M.getMosaicItemPosition(D,!0);if(a!=null){const{tl:f,br:m,page:o}=a;E=m[0]-f[0],U=m[1]-f[1];const w=M.getPageSize(o);w!=null&&(M.bind(e,9729,o,L),n.setUniform4f("u_tlbr",f[0],f[1],m[0],m[1]),n.setUniform2fv("u_mosaicSize",w),n.setUniform1i("u_texture",L))}n.setUniform1f("u_opacity",p)}else{const a=x[3]*p;this._color[0]=a*x[0],this._color[1]=a*x[1],this._color[2]=a*x[2],this._color[3]=a,n.setUniform4fv("u_color",this._color)}n.setUniform1f("u_depth",s.z||0);for(const a of t){if(n.setUniform1f("u_coord_range",a.rangeX),n.setUniformMatrix3fv("u_dvsMat3",a.transforms.displayViewScreenMat3),y){const f=Math.max(2**(Math.round(d)-a.key.level),1),m=u*a.width*f,o=m/G(E),w=m/G(U);this._patternMatrix[0]=o,this._patternMatrix[4]=w,n.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}e.setStencilFunction(514,0,255),e.drawArrays(N.TRIANGLE_STRIP,0,4)}}else l()}_loadWGLResources(i){if(this._vao)return;const{context:t,styleLayer:e}=i,r=e.backgroundMaterial,l=new Int8Array([0,0,1,0,0,1,1,1]),_=new J(t,r.geometryLayout,l);this._vao=new Q(t,_)}}let ue=class extends z{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(i,t){const{context:e,displayLevel:r,requiredLevel:l,state:_,painter:d,spriteMosaic:s,styleLayerUID:v,requestRender:c,allowDelayedRender:x}=i;if(!t.some(n=>{var a;return((a=n.layerData.get(v))==null?void 0:a.circleIndexCount)??!1}))return;const p=i.styleLayer,D=p.circleMaterial,y=d.vectorTilesMaterialManager,P=1.2,M=p.getPaintValue("circle-translate",r),E=p.getPaintValue("circle-translate-anchor",r),U=this._programOptions,u=y.getMaterialProgram(e,D,U);if(x&&c!=null&&!u.compiled)return void c();e.useProgram(u),u.setUniformMatrix3fv("u_displayMat3",E===1?_.displayMat3:_.displayViewMat3),u.setUniform2fv("u_circleTranslation",M),u.setUniform1f("u_depth",p.z),u.setUniform1f("u_antialiasingWidth",P);let g=-1;for(const n of t){if(!n.layerData.has(v))continue;n.key.level!==g&&(g=n.key.level,D.setDataUniforms(u,r,p,g,s));const a=n.layerData.get(v);if(!a.circleIndexCount)continue;a.prepareForRendering(e);const f=a.vao;f!=null&&(e.bindVAO(f),u.setUniformMatrix3fv("u_dvsMat3",n.transforms.displayViewScreenMat3),l!==n.key.level?e.setStencilFunction(514,n.stencilRef,255):e.setStencilFunction(516,255,255),e.drawElements(N.TRIANGLES,a.circleIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.circleIndexStart),n.triangleCount+=a.circleIndexCount/3)}}};const q=1/65536;let ce=class extends z{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(i,t){const{displayLevel:e,renderPass:r,spriteMosaic:l,styleLayerUID:_}=i;let d=!1;for(const u of t)if(u.layerData.has(_)){const g=u.layerData.get(_);if(g.fillIndexCount>0||g.outlineIndexCount>0){d=!0;break}}if(!d)return;const s=i.styleLayer,v=s.getPaintProperty("fill-pattern"),c=v!==void 0,x=c&&v.isDataDriven;let p;if(c&&!x){const u=v.getValue(e);p=l.getMosaicItemPosition(u,!0)}const D=!c&&s.getPaintValue("fill-antialias",e);let y=!0,P=1;if(!c){const u=s.getPaintProperty("fill-color"),g=s.getPaintProperty("fill-opacity");if(!(u!=null&&u.isDataDriven)&&!(g!=null&&g.isDataDriven)){const n=s.getPaintValue("fill-color",e);P=s.getPaintValue("fill-opacity",e)*n[3],P>=1&&(y=!1)}}if(y&&r==="opaque")return;const M=s.getPaintValue("fill-translate",e),E=s.getPaintValue("fill-translate-anchor",e);(y||r!=="translucent")&&this._drawFill(i,_,s,t,M,E,c,p,x);const U=!s.hasDataDrivenOutlineColor&&s.outlineUsesFillColor&&P<1;D&&r!=="opaque"&&!U&&this._drawOutline(i,_,s,t,M,E)}_drawFill(i,t,e,r,l,_,d,s,v){if(d&&!v&&s==null)return;const{context:c,displayLevel:x,state:p,painter:D,pixelRatio:y,spriteMosaic:P,requestRender:M,allowDelayedRender:E}=i,U=e.fillMaterial,u=D.vectorTilesMaterialManager,g=y>Y?2:1,n=this._fillProgramOptions;n.pattern=d;const a=u.getMaterialProgram(c,U,n);if(E&&M!=null&&!a.compiled)return void M();if(c.useProgram(a),s!=null){const{page:m}=s,o=P.getPageSize(m);o!=null&&(P.bind(c,9729,m,L),a.setUniform2fv("u_mosaicSize",o),a.setUniform1i("u_texture",L))}a.setUniformMatrix3fv("u_displayMat3",_===1?p.displayMat3:p.displayViewMat3),a.setUniform2fv("u_fillTranslation",l),a.setUniform1f("u_depth",e.z+q);let f=-1;for(const m of r){if(!m.layerData.has(t))continue;m.key.level!==f&&(f=m.key.level,U.setDataUniforms(a,x,e,f,P));const o=m.layerData.get(t);if(!o.fillIndexCount)continue;o.prepareForRendering(c);const w=o.fillVAO;if(w!=null){if(c.bindVAO(w),a.setUniformMatrix3fv("u_dvsMat3",m.transforms.displayViewScreenMat3),c.setStencilFunction(514,m.stencilRef,255),d){const h=Math.max(2**(Math.round(x)-m.key.level),1),I=m.rangeX/(g*m.width*h);a.setUniform1f("u_patternFactor",I)}if(v){const h=o.patternMap;if(!h)continue;for(const[I,T]of h){const A=P.getPageSize(I);A!=null&&(P.bind(c,9729,I,L),a.setUniform2fv("u_mosaicSize",A),a.setUniform1i("u_texture",L),c.drawElements(N.TRIANGLES,T[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*T[0]))}}else c.drawElements(N.TRIANGLES,o.fillIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*o.fillIndexStart);m.triangleCount+=o.fillIndexCount/3}}}_drawOutline(i,t,e,r,l,_){const{context:d,displayLevel:s,state:v,painter:c,pixelRatio:x,spriteMosaic:p,requestRender:D,allowDelayedRender:y}=i,P=e.outlineMaterial,M=c.vectorTilesMaterialManager,E=.75/x,U=this._outlineProgramOptions,u=M.getMaterialProgram(d,P,U);if(y&&D!=null&&!u.compiled)return void D();d.useProgram(u),u.setUniformMatrix3fv("u_displayMat3",_===1?v.displayMat3:v.displayViewMat3),u.setUniform2fv("u_fillTranslation",l),u.setUniform1f("u_depth",e.z+q),u.setUniform1f("u_outline_width",E);let g=-1;for(const n of r){if(!n.layerData.has(t))continue;n.key.level!==g&&(g=n.key.level,P.setDataUniforms(u,s,e,g,p));const a=n.layerData.get(t);if(a.prepareForRendering(d),!a.outlineIndexCount)continue;const f=a.outlineVAO;f!=null&&(d.bindVAO(f),u.setUniformMatrix3fv("u_dvsMat3",n.transforms.displayViewScreenMat3),d.setStencilFunction(514,n.stencilRef,255),d.drawElements(N.TRIANGLES,a.outlineIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.outlineIndexStart),n.triangleCount+=a.outlineIndexCount/3)}}};class pe extends z{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(i,t){const{context:e,displayLevel:r,state:l,painter:_,pixelRatio:d,spriteMosaic:s,styleLayerUID:v,requestRender:c,allowDelayedRender:x}=i;if(!t.some(h=>{var I;return((I=h.layerData.get(v))==null?void 0:I.lineIndexCount)??!1}))return;const p=i.styleLayer,D=p.lineMaterial,y=_.vectorTilesMaterialManager,P=p.getPaintValue("line-translate",r),M=p.getPaintValue("line-translate-anchor",r),E=p.getPaintProperty("line-pattern"),U=E!==void 0,u=U&&E.isDataDriven;let g,n;if(U&&!u){const h=E.getValue(r);g=s.getMosaicItemPosition(h)}let a=!1;if(!U){const h=p.getPaintProperty("line-dasharray");if(n=h!==void 0,a=n&&h.isDataDriven,n&&!a){const I=h.getValue(r),T=p.getDashKey(I,p.getLayoutValue("line-cap",r));g=s.getMosaicItemPosition(T)}}const f=1/d,m=this._programOptions;m.pattern=U,m.sdf=n;const o=y.getMaterialProgram(e,D,m);if(x&&c!=null&&!o.compiled)return void c();if(e.useProgram(o),o.setUniformMatrix3fv("u_displayViewMat3",l.displayViewMat3),o.setUniformMatrix3fv("u_displayMat3",M===1?l.displayMat3:l.displayViewMat3),o.setUniform2fv("u_lineTranslation",P),o.setUniform1f("u_depth",p.z),o.setUniform1f("u_antialiasing",f),g&&g!=null){const{page:h}=g,I=s.getPageSize(h);I!=null&&(s.bind(e,9729,h,L),o.setUniform2fv("u_mosaicSize",I),o.setUniform1i("u_texture",L))}let w=-1;for(const h of t){if(!h.layerData.has(v))continue;h.key.level!==w&&(w=h.key.level,D.setDataUniforms(o,r,p,w,s));const I=2**(r-w)/d;o.setUniform1f("u_zoomFactor",I);const T=h.layerData.get(v);if(!T.lineIndexCount)continue;T.prepareForRendering(e);const A=T.vao;if(A!=null){if(e.bindVAO(A),o.setUniformMatrix3fv("u_dvsMat3",h.transforms.displayViewScreenMat3),e.setStencilFunction(514,h.stencilRef,255),u||a){const k=T.patternMap;if(!k)continue;for(const[S,O]of k){const R=s.getPageSize(S);R!=null&&(s.bind(e,9729,S,L),o.setUniform2fv("u_mosaicSize",R),o.setUniform1i("u_texture",L),e.drawElements(N.TRIANGLES,O[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*O[0]))}}else e.drawElements(N.TRIANGLES,T.lineIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*T.lineIndexStart);h.triangleCount+=T.lineIndexCount/3}}}}const ae=256/360,ie=1/Math.LN2;function ne(V,i){return(V%=i)>=0?V:V+i}function B(V){return ne(V*ae,256)}function me(V){return Math.log(V)*ie}const re=1/65536;class ge extends z{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=ee()}dispose(){}drawMany(i,t){const e=i.styleLayer;this._drawIcons(i,e,t),this._drawText(i,e,t)}_drawIcons(i,t,e){const{context:r,displayLevel:l,painter:_,spriteMosaic:d,state:s,styleLayerUID:v,requestRender:c,allowDelayedRender:x}=i,p=t.iconMaterial,D=_.vectorTilesMaterialManager;let y,P=!1;for(const o of e)if(o.layerData.has(v)&&(y=o.layerData.get(v),y.iconPerPageElementsMap.size>0)){P=!0;break}if(!P)return;const M=t.getPaintValue("icon-translate",l),E=t.getPaintValue("icon-translate-anchor",l);let U=t.getLayoutValue("icon-rotation-alignment",l);U===2&&(U=t.getLayoutValue("symbol-placement",l)===0?1:0);const u=U===0,g=t.getLayoutValue("icon-keep-upright",l)&&u,n=y.isIconSDF,a=this._iconProgramOptions;a.sdf=n;const f=D.getMaterialProgram(r,p,a);if(x&&c!=null&&!f.compiled)return void c();r.useProgram(f),f.setUniformMatrix3fv("u_displayViewMat3",U===0?s.displayViewMat3:s.displayMat3),f.setUniformMatrix3fv("u_displayMat3",E===1?s.displayMat3:s.displayViewMat3),f.setUniform2fv("u_iconTranslation",M),f.setUniform1f("u_depth",t.z),f.setUniform1f("u_mapRotation",B(s.rotation)),f.setUniform1f("u_keepUpright",g?1:0),f.setUniform1f("u_level",10*l),f.setUniform1i("u_texture",L),f.setUniform1f("u_fadeDuration",F/1e3),f.setUniform1i("u_isStencilPass",i.stencilSymbols?1:0);let m=-1;for(const o of e){if(!o.layerData.has(v)||(o.key.level!==m&&(m=o.key.level,p.setDataUniforms(f,l,t,m,d)),y=o.layerData.get(v),y.iconPerPageElementsMap.size===0))continue;y.prepareForRendering(r),y.updateOpacityInfo();const w=y.iconVAO;if(w!=null){r.bindVAO(w),f.setUniformMatrix3fv("u_dvsMat3",o.transforms.displayViewScreenMat3),f.setUniform1f("u_time",(performance.now()-y.lastOpacityUpdate)/1e3);for(const[h,I]of y.iconPerPageElementsMap)this._renderIconRange(i,f,I,h,o)}}}_renderIconRange(i,t,e,r,l){const{context:_,spriteMosaic:d}=i;this._spritesTextureSize[0]=d.getWidth(r)/4,this._spritesTextureSize[1]=d.getHeight(r)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),d.bind(_,9729,r,L),this._setStencilState(i,l),_.drawElements(N.TRIANGLES,e[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),l.triangleCount+=e[1]/3}_drawText(i,t,e){const{context:r,displayLevel:l,glyphMosaic:_,painter:d,pixelRatio:s,spriteMosaic:v,state:c,styleLayerUID:x,requestRender:p,allowDelayedRender:D}=i,y=t.textMaterial,P=d.vectorTilesMaterialManager;let M,E=!1;for(const R of e)if(R.layerData.has(x)&&(M=R.layerData.get(x),M.glyphPerPageElementsMap.size>0)){E=!0;break}if(!E)return;const U=t.getPaintProperty("text-opacity");if(U&&!U.isDataDriven&&U.getValue(l)===0)return;const u=t.getPaintProperty("text-color"),g=!u||u.isDataDriven||u.getValue(l)[3]>0,n=t.getPaintProperty("text-halo-width"),a=t.getPaintProperty("text-halo-color"),f=(!n||n.isDataDriven||n.getValue(l)>0)&&(!a||a.isDataDriven||a.getValue(l)[3]>0);if(!g&&!f)return;const m=24/8;let o=t.getLayoutValue("text-rotation-alignment",l);o===2&&(o=t.getLayoutValue("symbol-placement",l)===0?1:0);const w=o===0,h=t.getLayoutValue("text-keep-upright",l)&&w,I=.8*m/s;this._glyphTextureSize||(this._glyphTextureSize=te(_.width/4,_.height/4));const T=t.getPaintValue("text-translate",l),A=t.getPaintValue("text-translate-anchor",l),k=this._sdfProgramOptions,S=P.getMaterialProgram(r,y,k);if(D&&p!=null&&!S.compiled)return void p();r.useProgram(S),S.setUniformMatrix3fv("u_displayViewMat3",o===0?c.displayViewMat3:c.displayMat3),S.setUniformMatrix3fv("u_displayMat3",A===1?c.displayMat3:c.displayViewMat3),S.setUniform2fv("u_textTranslation",T),S.setUniform1f("u_depth",t.z+re),S.setUniform2fv("u_mosaicSize",this._glyphTextureSize),S.setUniform1f("u_mapRotation",B(c.rotation)),S.setUniform1f("u_keepUpright",h?1:0),S.setUniform1f("u_level",10*l),S.setUniform1i("u_texture",$),S.setUniform1f("u_antialiasingWidth",I),S.setUniform1f("u_fadeDuration",F/1e3);let O=-1;for(const R of e){if(!R.layerData.has(x)||(R.key.level!==O&&(O=R.key.level,y.setDataUniforms(S,l,t,O,v)),M=R.layerData.get(x),M.glyphPerPageElementsMap.size===0))continue;M.prepareForRendering(r),M.updateOpacityInfo();const C=M.textVAO;if(C==null)continue;r.bindVAO(C),S.setUniformMatrix3fv("u_dvsMat3",R.transforms.displayViewScreenMat3),this._setStencilState(i,R);const W=(performance.now()-M.lastOpacityUpdate)/1e3;S.setUniform1f("u_time",W),M.glyphPerPageElementsMap.forEach((X,j)=>{this._renderGlyphRange(r,X,j,_,S,f,g,R)})}}_renderGlyphRange(i,t,e,r,l,_,d,s){r.bind(i,9729,e,$),_&&(l.setUniform1f("u_halo",1),i.drawElements(N.TRIANGLES,t[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),s.triangleCount+=t[1]/3),d&&(l.setUniform1f("u_halo",0),i.drawElements(N.TRIANGLES,t[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),s.triangleCount+=t[1]/3)}_setStencilState(i,t){const{context:e,is3D:r,stencilSymbols:l}=i;if(e.setStencilTestEnabled(!0),l)return e.setStencilWriteMask(255),void e.setStencilFunction(519,t.stencilRef,255);e.setStencilWriteMask(0),r?e.setStencilFunction(514,t.stencilRef,255):e.setStencilFunction(516,255,255)}}export{ue as a,pe as b,ge as c,me as e,le as m,ce as r,z as t};
