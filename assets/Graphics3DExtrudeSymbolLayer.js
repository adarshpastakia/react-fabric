import{bO as T,bY as Lt,bP as zt,bX as Mt,bZ as F,b0 as Ot,b2 as Ut,l9 as $,l8 as X,l7 as xt,nZ as Rt,n_ as at,n$ as ot,o0 as Vt,o1 as rt,l1 as Ft,i as J,o2 as Bt,cf as Tt,bJ as P,lz as jt,hn as Q,hs as Gt,mQ as Ht,fL as Wt,o3 as Zt,o4 as kt,bU as lt,n1 as Nt,o5 as Jt,o6 as Kt,o7 as Qt,o8 as Xt,o9 as Yt,bI as U,fi as ct,fV as wt,bK as qt,fW as Y,oa as te,ob as ee,oc as ne,od as se,m9 as ie,oe as ae,fd as W,fe as oe,fc as ut}from"./ShadowCastClear.glsl.js";import{e as St}from"./earcut.js";import{t as re,e as ht}from"./SnappingCandidate.js";import{a as le}from"./renderingInfoUtils.js";import{h as Pt,i as ce}from"./triangulationUtils.js";function ue(n,t,e,s){const i=Pt(n.rings,!!n.hasZ&&s.mode!=="on-the-ground",1,n.spatialReference),a=T(i.position.length),o=Lt(i.position,n.spatialReference,0,a,0,i.position,0,i.position.length/3,t,e,s),r=o!=null;return new de(i.position,a,Ct(i.polygons,i.position,a),vt(i.outlines,i.position,a),r,o)}function ze(n,t){const e=Pt(n.rings,!1,1),s=zt(e.position,n.spatialReference,0,e.position,t,0);for(let i=2;i<e.position.length;i+=3)e.position[i]=Mt;return{position:e.position,polygons:Ct(e.polygons,e.position),outlines:vt(e.outlines,e.position),projectionSuccess:s}}function vt(n,t,e=null){return n.filter(({count:s})=>s>1).map(({index:s,count:i})=>{const a=3*s,o=3*i;return e!=null?new Et(s,i,F(t,a,o),F(e,a,o)):new q(s,i,F(t,a,o))})}function Ct(n,t,e=null){const s=new Array;for(const{index:i,count:a,holeIndices:o,pathLengths:r}of n){if(a<=1)continue;const l=3*i,x=3*a,b=o.map(f=>f-i),m=e!=null?new he(i,a,F(t,3*i,3*a),F(e,l,x),b,r):new pe(i,a,F(t,3*i,3*a),b,r);s.push(m)}return s}let q=class{constructor(t,e,s){this.index=t,this.count=e,this.position=s}};class Et extends q{constructor(t,e,s,i){super(t,e,s),this.mapPositions=i}}class he extends Et{constructor(t,e,s,i,a,o){super(t,e,s,i),this.holeIndices=a,this.pathLengths=o}}class pe extends q{constructor(t,e,s,i,a){super(t,e,s),this.holeIndices=i,this.pathLengths=a}}class de{constructor(t,e,s,i,a,o){this.position=t,this.mapPositions=e,this.polygons=s,this.outlines=i,this.projectionSuccess=a,this.sampledElevation=o}}function Oe(n,t,e){const s=(t.length>0?t[0]:n.length/3)-1,i=ce(n,s,e);if(i!==2){n=n.slice();for(let a=0;a<n.length;a+=3)n[a+i]=n[a+2]}return St(n,t,3)}function Ue(n){const t=[["position",new $(n.attributeData.position,n.indices,3,!0)]],e=xt(n.indices.length);return n.attributeData.colorFeature!=null?t.push(["colorFeatureAttribute",new $([n.attributeData.colorFeature],e,1,!0)]):n.attributeData.color&&t.push(["color",new $(n.attributeData.color,e,4,!0)]),n.attributeData.uvMapSpace&&t.push(["uvMapSpace",new $(n.attributeData.uvMapSpace,n.indices,4,!0)]),n.attributeData.boundingRect&&t.push(["boundingRect",new $(n.attributeData.boundingRect,n.indices,9,!0)]),new X(n.material,t,n.mapPositions,0,n.attributeData.olidColor)}function Re(n,t=null){const e=[["position",new $(n.attributeData.position,n.indices,3,!0)],["uv0",new $(n.attributeData.uv0,n.indices,2,!0)]];return new X(n.material,e,n.mapPositions,0,t)}function ge(n){switch(n.type){case"extent":if(n instanceof Ot)return Ut.fromExtent(n);break;case"polygon":return n}return null}class Ve{constructor(t,e,s){this.renderData=t,this.layerViewUid=e,this.graphicUid=s,this.outGeometries=new Array}}const me=["polygon","extent"];class Fe extends Rt{constructor(t,e,s,i){super(t,e,s,i,xe(e)),this.ensureDrapedStatus(!1)}async doLoad(){var b,m;const t=this.symbolLayer,e=t==null?void 0:t.material,s=(m=(b=this.symbolLayer.material)==null?void 0:b.color)==null?void 0:m.a,i=this.needsDrivenTransparentPass||s!=null&&s!==1,a=e==null?void 0:e.emissive,o=!this._hasDrivenColorOrOpacity&&(s==null||s===0),r={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:ot,diffuse:ot,opacity:o?0:1,layerOpacity:this._getLayerOpacity(),drivenOpacity:i,hasSymbolColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:t.castShadows,emissiveStrength:(a==null?void 0:a.strength)??0,emissiveSource:1,offsetTransparentBackfaces:!0,normalType:1},l=new at(r,this._context),x=new at({...r,cullFace:2},this._context);this._materials[0]=l,this._materials[1]=x,this._updateTransparentDepedentMaterialParameters()}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,me,this.symbolLayer.type))return null;const s=this._getDrivenUInt8ColorWithNaNSupport(t.renderingInfo,this._materialColor,!1);Vt(s,s);const i=this.createElevationContextForGraphic(e);return this._createAs3DShape(e,t.renderingInfo,s,i,e.uid)}layerOpacityChanged(t,e){var i,a;const s=this._getLayerOpacity();(i=this._materials[0])==null||i.setParameters({layerOpacity:s}),(a=this._materials[1])==null||a.setParameters({layerOpacity:s}),this._updateTransparentDepedentMaterialParameters(),t==null||t.forEach(o=>{var r;return(r=e(o))==null?void 0:r.layerOpacityChanged(s,this._context.isAsync)})}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(t,e){return this.updateGraphics3DGraphicElevationInfo(t,e,rt)}slicePlaneEnabledChanged(t,e){var s,i;return(s=this._materials[0])==null||s.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),(i=this._materials[1])==null||i.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t==null||t.forEach(a=>{const o=e(a);o!=null&&o.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){var e,s;const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return(e=this._materials[0])==null||e.setParameters(t),(s=this._materials[1])==null||s.setParameters(t),!0}_getExtrusionSize(t){let e;return e=t.size&&this._drivenProperties.size?le(t.size,2)??0:this._getSymbolSize(),e/=this._context.renderCoordsHelper.unitInMeters,e}applyRendererDiff(t,e){return this._drivenPropertiesChanged(e)?0:1}async queryForSnapping(t,e,s,i){const a=this._getExtrusionSize(s)*this._context.renderCoordsHelper.unitInMeters/Ft(e),{objectId:o,target:r}=t,l=J(r);switch(l.z=(l.z??0)+a,t.type){case"edge":{const{start:x,end:b}=t,m=J(x),f=J(b);return m.z=(m.z??0)+a,f.z=(f.z??0)+a,[ht(o,l,1/0,m,f)]}case"vertex":return[re(o,l,1/0),ht(o,r,1/0,r,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,e,s,i,a){const o=ge(t.geometry);if(o==null)return null;if(o.rings.length===0||!o.rings.some(C=>C.length>0))return this._logGeometryValidationWarnings(o.rings,"rings","ExtrudeSymbol3DLayer"),null;const r=ue(o,this._context.elevationProvider,this._context.renderCoordsHelper,i);this._logGeometryCreationWarnings(r,o.rings,"rings","ExtrudeSymbol3DLayer");const l=Bt(o);if(l==null)return null;const x=new Array,b=new Array,m=Tt(),f=Q(),w=P(),p=this._context.renderCoordsHelper.viewingMode===1;p||this._context.renderCoordsHelper.worldUpAtPosition(null,w),jt(o.spatialReference,[l.x,l.y,0],f,this._context.renderCoordsHelper.spatialReference);const _=Q();Gt(_,f);const g=Wt();Ht(g,_);const{polygons:y,mapPositions:c,position:d}=r,h=new Map,v=this._materials[0];for(const C of y){const z=C.count;if(this._context.clippingExtent&&(Zt(C.mapPositions,m),!kt(m,this._context.clippingExtent)))continue;const M=St(C.mapPositions,C.holeIndices,3);if(M.length===0)continue;const O=M.length,D=6*z,R=lt(D+O),Z=lt(O),j=T(3*D),tt=T(3*D),et=T(3*D),nt=T(D);fe(d,c,M,C,j,et,tt,nt,R,Z,this._getExtrusionSize(e),w,p),Nt(j,j,_);const st=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerViewUid:this._context.layerViewUid}),k=new Ce(j,et,Jt(tt),nt),N=pt(v,R,R.length-Z.length,k,s,st),$t=z,At=z,It=2*C.count,it=new Ee($t,At,It,O/3);Dt(N,it,f),h.set(N,it),x.push(N,pt(this._materials[1],Z,0,k,s,st)),b.push(k.heights)}if(x.length===0)return null;const u=new Kt({geometries:x,layerViewUid:this._context.layerViewUid,graphicUid:a,isElevationSource:!0});u.transformation=f;const A=Qt(this.symbolLayer,{opacity:this._getLayerOpacity()}),I=A?new Xt(this._materials[0],A,this._context.slicePlaneEnabled):null,L=new Yt(this,u,null,(C,z,M,O,D)=>_e(C,z,M,O,D,b,h),i,I);return L.alignedSampledElevation=r.sampledElevation,L.needsElevationUpdates=rt(i.mode),L}get _materialColor(){var t;return(t=this.symbolLayer.material)==null?void 0:t.color}_updateTransparentDepedentMaterialParameters(){const t=this._materials[0];t&&t.setParameters({cullFace:t.transparent?0:2})}}function pt(n,t,e,s,i,a){const o=xt(t.length),r=[["position",new $(s.positions,t,3,!0)],["normalCompressed",new $(s.normals,t,2,!0)],["symbolColor",new $(i,o,4,!0)]];return new X(n,r,s.elevation,0,a,e)}function fe(n,t,e,s,i,a,o,r,l,x,b,m,f){const w=e.length/3;let p=2*s.count;ye(n,t,s.index,s.count,e,0,w,i,a,o,r,l,x,p,b,m,f);let _=0,g=2*s.count;p=0;const y=s.pathLengths[0];dt(i,a,r,o,_,y,s.count,g,l,p,b),g+=4*y,p+=2*y,_+=y;for(let c=1;c<s.pathLengths.length;++c){const d=s.pathLengths[c];dt(i,a,r,o,_,d,s.count,g,l,p,b),g+=4*d,p+=2*d,_+=d}}function ye(n,t,e,s,i,a,o,r,l,x,b,m,f,w,p,_,g){oe(E,_),l??(l=[]),x??(x=[]),b??(b=[]);const y=p>0?1:-1;let c=3*e,d=0,h=3*d,v=s,u=3*v;for(let L=0;L<s;++L){const C=n[c],z=n[c+1],M=n[c+2];g&&(E[0]=C,E[1]=z,E[2]=M,Y(E,E)),r[h+0]=C,r[h+1]=z,r[h+2]=M;const O=t[c+0],D=t[c+1],R=t[c+2];l[h+0]=O,l[h+1]=D,l[h+2]=R,x[h+0]=-y*E[0],x[h+1]=-y*E[1],x[h+2]=-y*E[2],b[d]=0,r[u+0]=C+p*E[0],r[u+1]=z+p*E[1],r[u+2]=M+p*E[2],l[u+0]=O,l[u+1]=D,l[u+2]=R,b[v]=p,h+=3,u+=3,c+=3,d+=1,v+=1}c=3*a,h=0,u=3*w;const A=p<0?_t:bt,I=p<0?bt:_t;for(let L=0;L<o;++L)f[h]=i[c+A[0]],f[h+1]=i[c+A[1]],f[h+2]=i[c+A[2]],m[u]=i[c+I[0]]+s,m[u+1]=i[c+I[1]]+s,m[u+2]=i[c+I[2]]+s,h+=3,u+=3,c+=3}function G(n,t,e,s,i,a,o){s[a]=s[o],o*=3,n[a*=3]=n[o],n[a+1]=n[o+1],n[a+2]=n[o+2],t[a]=t[o],t[a+1]=t[o+1],t[a+2]=t[o+2],e[a]=i[0],e[a+1]=i[1],e[a+2]=i[2]}const B=P();function dt(n,t,e,s,i,a,o,r,l,x,b){t??(t=[]),e??(e=[]),s??(s=[]);let m=i,f=i+1,w=i+o,p=i+o+1,_=r,g=r+1,y=r+2*a,c=r+2*a+1;b<0&&(m=i+o+1,p=i);let d=3*x;for(let h=0;h<a;++h)h===a-1&&(f=i,b>0?p=i+o:m=i+o),be(n,m,f,w,B),G(n,t,s,e,B,_,m),G(n,t,s,e,B,g,f),G(n,t,s,e,B,y,w),G(n,t,s,e,B,c,p),l[d]=_,l[d+1]=y,l[d+2]=c,l[d+3]=_,l[d+4]=c,l[d+5]=g,d+=6,m++,f++,w++,p++,_+=2,g+=2,y+=2,c+=2}const K=P(),gt=P(),mt=P(),ft=P(),yt=P();function be(n,t,e,s,i){t*=3,e*=3,s*=3,U(K,n[t++],n[t++],n[t++]),U(gt,n[e++],n[e++],n[e++]),U(mt,n[s++],n[s++],n[s++]),ut(ft,gt,K),ut(yt,mt,K),wt(i,yt,ft),Y(i,i)}const V=P();function _e(n,t,e,s,i,a,o){const r=n.stageObject,l=r.geometries,x=l.length,b=t.mode!=="absolute-height";let m=0;const f=r.transformation,w=ee(Q(),f);for(let p=0;p<x;p+=2){const _=l[p];if(!ne(_))continue;const g=_.getMutableAttribute("position").data,y=a[p/2],c=new se(_.mapPositions),d=g.length/3;let h=!1,v=0;{let u=0;for(let A=0;A<d;A++){V[0]=g[u],V[1]=g[u+1],V[2]=g[u+2],s(c,H),b&&(v+=H.sampledElevation),ae.TESTS_DISABLE_OPTIMIZATIONS?(U(S,c.array[c.offset],c.array[c.offset+1],H.z+y[u/3]),e!=null&&i.toRenderCoords(S,e,S),W(S,S,w)):(U(S,g[u],g[u+1],g[u+2]),W(S,S,f),i.setAltitude(S,H.z+y[u/3]),W(S,S,w)),g[u]=S[0],g[u+1]=S[1],g[u+2]=S[2];const I=we/i.unitInMeters;(Math.abs(V[0]-g[u])>=I||Math.abs(V[1]-g[u+1])>=I||Math.abs(V[2]-g[u+2])>=I)&&(h=!0),c.offset+=3,u+=3}}if(h){const u=o.get(_);u&&Dt(_,u,f),r.geometryVertexAttributeUpdated(l[p],"normalCompressed"),_.invalidateBoundingInfo(),r.geometryVertexAttributeUpdated(l[p],"position"),l[p+1].invalidateBoundingInfo(),r.geometryVertexAttributeUpdated(l[p+1],"position")}m+=v/d}return m/x}function Dt(n,t,e){const s=n.getMutableAttribute("position"),i=n.getMutableAttribute("normalCompressed").data,a=s.data,o=n.attributes.get("position").indices,{topVertexStart:r,topVertexCount:l,topFaceStart:x,topFaceCount:b}=t,m=x+b,f=r+l,w=Se,p=Pe,_=ve,g=E,y=S;U(y,0,0,0);const c=(d,h)=>{const v=3*d;U(h,a[v+0],a[v+1],a[v+2]),W(h,h,e)};for(let d=x;d<m;++d){const h=3*d;c(o[h+0],w[0]),c(o[h+1],w[1]),c(o[h+2],w[2]),ct(p,w[1],w[0]),ct(_,w[2],w[0]),wt(g,p,_),qt(y,y,g)}Y(y,y);for(let d=r;d<f;++d){const h=y[0],v=y[1],u=y[2];te(i,d,h,v,u)}}function xe(n){var t,e;return(((e=(t=n.material)==null?void 0:t.color)==null?void 0:e.a)??0)===1}const S=P(),E=P(),H=new ie,bt=[0,2,1],_t=[0,1,2],we=.01,Se=[P(),P(),P()],Pe=P(),ve=P();class Ce{constructor(t,e,s,i){this.positions=t,this.elevation=e,this.normals=s,this.heights=i}}class Ee{constructor(t,e,s,i){this.topVertexStart=t,this.topVertexCount=e,this.topFaceStart=s,this.topFaceCount=i}}export{Fe as K,fe as X,Ve as a,Re as c,ge as l,ze as p,ue as r,Ue as s,Oe as u};
